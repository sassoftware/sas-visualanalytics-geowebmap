(this.webpackJsonpgeowebmap=this.webpackJsonpgeowebmap||[]).push([[94],{1012:function(e,t,r){"use strict";r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return i}));var n=r(14),a=r(411),i={type:a.a,json:{origins:{service:{read:{source:["tileInfo","minScale","maxScale","minLOD","maxLOD"],reader:s}}}}};function s(e,t,r,i){if(!e)return null;var s=t.minScale,o=t.maxScale,l=t.minLOD,u=t.maxLOD;if(null!=l&&null!=u)return i&&i.ignoreMinMaxLOD?a.a.fromJSON(e):a.a.fromJSON(Object(n.a)(Object(n.a)({},e),{},{lods:e.lods.filter((function(e){var t=e.level;return null!=t&&t>=l&&t<=u}))}));if(0!==s&&0!==o){var c=function(e){return Math.round(1e4*e)/1e4},f=s?c(s):1/0,h=o?c(o):-1/0;return a.a.fromJSON(Object(n.a)(Object(n.a)({},e),{},{lods:e.lods.filter((function(e){var t=c(e.scale);return t<=f&&t>=h}))}))}return a.a.fromJSON(e)}},1015:function(e,t,r){"use strict";r.d(t,"a",(function(){return z})),r.d(t,"b",(function(){return g})),r.d(t,"c",(function(){return P})),r.d(t,"d",(function(){return M})),r.d(t,"e",(function(){return C})),r.d(t,"f",(function(){return y})),r.d(t,"g",(function(){return I})),r.d(t,"h",(function(){return w})),r.d(t,"i",(function(){return O})),r.d(t,"j",(function(){return F})),r.d(t,"k",(function(){return D}));var n=r(8),a=r.n(n),i=r(31),s=r(15),o=(r(112),r(20)),l=r(2),u=r(79),c=r(53),f=r(68),h=r(61),p=r(56),d=5e-4,m=function(e,t){var r=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||r)},v=function(e,t){var r=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,n=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(r-e[2*t.rows+2]),Math.abs(n-e[2*t.rows+3])]},b={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54050:808820.9223376509,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125};function y(){return x.apply(this,arguments)}function x(){return(x=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(c.h)()&&Object(c.i)()){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,Object(c.j)();case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,t,r){if(!m(e.spatialReference,t))return null;if(!Object(c.h)())throw new o.a("rasterprojectionhelper-projectResolution","projection engine is not loaded");return r?Object(c.f)(t,e.spatialReference,e):Object(c.f)(e.spatialReference,t,e)}function O(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(e.spatialReference.equals(t))return e;var a=m(e.spatialReference,t);if(a&&!Object(c.h)())throw new o.a("rasterprojectionhelper-projectResolution","projection engine is not loaded");var i=r.center,s=new h.a({xmin:i.x-e.x/2,xmax:i.x+e.x/2,ymin:i.y-e.y/2,ymax:i.y+e.y/2,spatialReference:e.spatialReference}),u=a?Object(c.n)(s,t,n):Object(f.d)(s,t);return Object(l.j)(u)?null:{x:u.xmax-u.xmin,y:u.ymax-u.ymin}}function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01;return Object(u.f)(e)?t/Object(u.f)(e):0}function w(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=e.spatialReference;if(a.equals(t))return e;var s=Object(f.d)(e,t);if(Object(l.j)(s)){if(!Object(c.h)())throw new o.a("rasterprojectionhelper-projectResolution","projection engine is not loaded");s=Object(c.n)(e,t,r)}if(n&&t.isGeographic){var u=R(a,!0),h=Object(i.a)(u,2),p=h[0],m=h[1],v=j(a);v&&null!=p&&null!=m&&(Math.abs(e.x-p)<v&&Math.abs(180-s.x)<d?s.x-=360:Math.abs(e.x-m)<v&&Math.abs(180+s.x)<d&&(s.x+=360))}return s}function k(e){var t=S(e[0].spatialReference);if(e.length<2||!Object(l.k)(t))return e[0];for(var r=e[0],n=r.xmin,a=r.xmax,i=r.ymin,s=r.ymax,o=1;o<e.length;o++){var u=e[o];a=u.xmax+t*o,i=Math.min(i,u.ymin),s=Math.max(s,u.ymax)}return new h.a({xmin:n,xmax:a,ymin:i,ymax:s,spatialReference:e[0].spatialReference})}function I(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e.spatialReference.equals(t))return e;var a=C(e),i=S(e.spatialReference,!0);return Object(l.k)(i)&&0!==a?k(e.clone().normalize().map((function(e){return T(e,t,r,n)}))):T(e,t,r,n)}function T(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=e.spatialReference;if(a.equals(t))return e;if(m(a,t)&&!Object(c.h)())throw new o.a("rasterprojectionhelper-projectExtent","projection engine is not loaded");var s=Object(f.d)(e,t);Object(l.j)(s)&&(s=Object(c.n)(e,t,r));var u=R(a,!0),h=Object(i.a)(u,2),v=h[0],b=h[1];if(s&&n&&a.isWebMercator&&t.isGeographic&&null!=v&&null!=b){var y=.001,x=1e3;if(Math.abs(e.xmin-v)<y&&Math.abs(b-e.xmax)>x&&Math.abs(180-s.xmax)<d){s.xmin=-180;var g=[];g.push(new p.a(e.xmax,e.ymin,a)),g.push(new p.a(e.xmax,(e.ymin+e.ymax)/2,a)),g.push(new p.a(e.xmax,e.ymax,a));var O=g.map((function(e){return w(e,t,r)})).filter((function(e){return!isNaN(null==e?void 0:e.x)})).map((function(e){return e.x}));s.xmax=Math.max.apply(null,O)}if(Math.abs(e.xmax-b)<y&&Math.abs(v-e.xmin)>x&&Math.abs(180+s.xmin)<d){s.xmax=180;var k=[];k.push(new p.a(e.xmin,e.ymin,a)),k.push(new p.a(e.xmin,(e.ymin+e.ymax)/2,a)),k.push(new p.a(e.xmin,e.ymax,a));var I=k.map((function(e){return w(e,t,r)})).filter((function(e){return!isNaN(null==e?void 0:e.x)})).map((function(e){return e.x}));s.xmin=Math.min.apply(null,I)}}var T=R(t,!0),S=Object(i.a)(T,2);v=S[0],b=S[1];var _=j(t);return _&&null!=v&&null!=b&&(Math.abs(s.xmin-v)<_&&(s.xmin=v),Math.abs(s.xmax-b)<_&&(s.xmax=b)),s}function S(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*r:e.wkid&&e.isGeographic?360:2*b[e.wkid]||null}function R(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],n=S(e,t);return Object(l.k)(n)&&(r.push(-n/2),r.push(n/2)),r}function _(e,t,r,n){var a=(e-t)/r;return a-Math.floor(a)!=0?a=Math.floor(a):n&&(a-=1),a}function C(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=S(e.spatialReference);if(!Object(l.k)(r))return 0;var n=t?0:-r/2;return _(e.xmax,n,r,!0)-_(e.xmin,n,r,!1)}function M(e){var t=e.storageInfo.origin.x,r=S(e.spatialReference,!0);if(!Object(l.k)(r))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};for(var n=r/2,a=e.nativePixelSize,i=e.storageInfo,s=e.extent,o=i.maximumPyramidLevel,u=i.blockWidth,c=i.pyramidScalingFactor,f=a.x,h=[],p=Object(l.k)(e.transform)&&"gcs-shift"===e.transform.type,d=t+n,m=p?r-t:n-t,v=0;v<=o;v++){var b=(s.xmax-t)/f/u,y=b-Math.floor(b)==0?b:Math.ceil(b),x=(r/2-t)/f/u,g=x-Math.floor(x)==0?x:Math.ceil(x),O=Math.floor(d/f/u),j=Math.round(d/f)%u,w=(u-Math.round(m/f)%u)%u;h.push({resolutionX:f,blockWidth:u,datsetColumnCount:y,worldColumnCountFromOrigin:g,leftMargin:j,rightPadding:w,originColumnOffset:O}),f*=c}return{originX:t,halfWorldWidth:n,pyramidsInfo:h,hasGCSSShiftTransform:p}}function P(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[32,32];if(m(e.spatialReference,t.spatialReference)&&!Object(c.h)())throw new o.a("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&t&&r))return null;var u=e.xmin,f=e.ymin,h=e.xmax,d=e.ymax,b=e.spatialReference,y=t.spatialReference,x=S(y);i=i||"gcs-shift"===(null==a?void 0:a.type);for(var g,O={x:s[0]*r.x,y:s[1]*r.y},j={cols:Math.ceil((h-u)/O.x-.1/s[0])+1,rows:Math.ceil((d-f)/O.y-.1/s[1])+1},k=O.x,I=O.y,T=[],R=!1,_=0;_<j.cols;_++){for(var C=[],M=0;M<j.rows;M++){var P=w(new p.a({x:u+k*_,y:d-I*M,spatialReference:b}),y,n);a&&(P=a.inverseTransform(P)),C.push(P),_>0&&i&&P&&g[M]&&Object(l.k)(x)&&P.x<g[M].x&&(P.x+=x),P?(T.push((P.x-t.xmin)/(t.xmax-t.xmin)),T.push((t.ymax-P.y)/(t.ymax-t.ymin))):(T.push(NaN),T.push(NaN),R=!0)}g=C}for(var F=v(T,j),D=new Float32Array((j.cols-1)*(j.rows-1)*2*6),z=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),B=new Float32Array([-1,1,0,0,-1,1,1,0,0]),A=0;A<j.cols-1;A++){for(var L=0;L<j.rows-1;L++){for(var N=A*j.rows*2+2*L,E=T[N],J=T[N+1],H=T[N+2],q=T[N+3],W=T[N+=2*j.rows],U=T[N+1],G=T[N+2],V=T[N+3],X=0,Y=12*(L*(j.cols-1)+A),K=0;K<3;K++)D[Y++]=z[X++]*E+z[X++]*H+z[X++]*G;X=0;for(var $=0;$<3;$++)D[Y++]=z[X++]*J+z[X++]*q+z[X++]*V;X=0;for(var Q=0;Q<3;Q++)D[Y++]=B[X++]*E+B[X++]*W+B[X++]*G;X=0;for(var Z=0;Z<3;Z++)D[Y++]=B[X++]*J+B[X++]*U+B[X++]*V}if(R)for(var ee=0;ee<D.length;ee++)isNaN(D[ee])&&(D[ee]=-1)}return{offsets:T,error:F,coefficients:D,spacing:s,size:[j.cols-1,j.rows-1]}}function F(e){var t=e.clone().normalize();return 1===t.length?t[0]:k(t)}function D(e,t,r){var n,a=t.storageInfo,i=t.pixelSize,s=!1,o=a.pyramidResolutions;if(Object(l.k)(o)&&o.length){var u=(e.x+e.y)/2,c=o[o.length-1],f=(c.x+c.y)/2,h=(i.x+i.y)/2;if(u<=h)n=0;else if(u>=f)n=o.length,s=u/f>8;else for(var d,m=h,v=1;v<=o.length;v++){if(u<=(d=(o[v-1].x+o[v-1].y)/2)){u===d?n=v:"down"===r?(n=v-1,s=u/m>8):n="up"===r||u-m>d-u||u/m>2?v:v-1;break}m=d}var b=0===n?i:o[n-1];return{pyramidLevel:n,pyramidResolution:new p.a({x:b.x,y:b.y,spatialReference:t.spatialReference}),excessiveReading:s}}var y=Math.log(e.x/i.x)/Math.LN2,x=Math.log(e.y/i.y)/Math.LN2,g=t.storageInfo.maximumPyramidLevel||0;(n="down"===r?Math.floor(Math.min(y,x)):"up"===r?Math.ceil(Math.max(y,x)):Math.round((y+x)/2))<0?n=0:n>g&&(s=n>g+3,n=g);var O=Math.pow(2,n);return{pyramidLevel:n,pyramidResolution:new p.a({x:O*t.nativePixelSize.x,y:O*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:s}}function z(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=e.extent,i=e.spatialReference,s=e.pixelSize,o=O(new p.a({x:s.x,y:s.y,spatialReference:i}),t,a);if(null==o)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};var l=(o.x+o.y)/2,c=Object(u.f)(t),f=l*c*96*39.37,h=t.isGeographic?256/r*295828763.7958547:256/r*591657527.591555,d="vector-magdir"===e.dataType||"vector-uv"===e.dataType,m=I(a,t);d||n&&(t.isGeographic||t.isWebMercator)&&(d=m.xmin*m.xmax<0);var v,b=f,y=1.001;if(d){b=h;var x=t.isGeographic?1341104507446289e-21:.29858214164761665,g=x*(96*c*39.37),j=t.isGeographic?4326:3857;(v=O(new p.a({x:x,y:x,spatialReference:{wkid:j}}),i,m)).x*=b/g,v.y*=b/g}else{v={x:s.x,y:s.y};for(var w=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2),k=0;b<h*(y/2)&&k<w;)k++,b*=2,v.x*=2,v.y*=2;Math.max(b,h)/Math.min(b,h)<=y&&(b=h)}for(var T=[b],S=[{x:v.x,y:v.y}],R=70.5310735,_=Math.min(R,f)/y;b>=_;)b/=2,v.x/=2,v.y/=2,T.push(b),S.push({x:v.x,y:v.y});return{projectedPixelSize:o,scales:T,srcResolutions:S,isCustomTilingScheme:!d}}},1161:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return m})),r.d(t,"d",(function(){return f})),r.d(t,"e",(function(){return v})),r.d(t,"f",(function(){return h})),r.d(t,"g",(function(){return p})),r.d(t,"h",(function(){return x}));r(112);var n=r(2),a=r(3),i=r(4),s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;Object(a.a)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return Object(i.a)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var a=n.get(r);return a.refCount--,a.refCount<=0&&(n.delete(r),a.controller&&a.controller.abort()),a.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var a=n.get(r);return a.ts=Date.now(),a.refCount++,n.delete(r),n.set(r,a),a.block}return null}},{key:"putBlock",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=this._cachedBlocks,i=e+"/"+t;if(a.has(i)){var s=a.get(i);s.ts=Date.now(),s.refCount++}else a.set(i,{block:r,ts:Date.now(),refCount:1,controller:n});this.trim(),this.updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this.trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this.clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),a=0;a<r.length&&r[a][1].ts<=n-e._duration;a++)t.delete(r[a][0]);0===t.size&&e.clearTimer()}),this._interval)}}},{key:"trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),o=r(1015),l=r(56),u=new Map,c=new s;function f(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function h(e,t){var r={extent:null,rasterInfo:t,cache:new Map};if(u.has(e)){var n=u.get(e);return n.push(r),n.length-1}return u.set(e,[r]),0}function p(e,t){if(u.has(e)){var r=u.get(e);r[t]=null,r.some((function(e){return null!=e}))||u.delete(e)}}function d(e,t,r){if(!u.has(e))return null==t?c.decreaseRefCount(e,r):0;var n=u.get(e);if(null==n[t])return c.decreaseRefCount(e,r);var a=n[t].cache;if(a.has(r)){var i=a.get(r);if(i.refCount--,0===i.refCount){a.delete(r);for(var s=0;s<n.length;s++)n[s]&&n[s].cache.has(r)&&n[s].cache.delete(r);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,t,r){if(!u.has(e))return null==t?c.getBlock(e,r):null;var n=u.get(e);if(null==n[t]){for(var a=0;a<n.length;a++)if(n[a]&&n[a].cache.has(r)){var i=n[a].cache.get(r);return i.refCount++,i.block}return c.getBlock(e,r)}var s=n[t].cache;if(s.has(r)){var o=s.get(r);return o.refCount++,o.block}for(var l=0;l<n.length;l++)if(l!==t&&n[l]&&n[l]&&n[l].cache.has(r)){var f=n[l].cache.get(r);return f.refCount++,s.set(r,f),f.block}return null}function v(e,t,r,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(u.has(e)){var i=u.get(e);if(null!=i[t]){var s={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return s.isResolved=!0})).catch((function(){return s.isRejected=!0})),i[t].cache.set(r,s)}else c.putBlock(e,r,n,a)}else null==t&&c.putBlock(e,r,n,a)}function b(e,t,r){if(u.has(e)){var n=u.get(e);null!=n[t]?n[t].cache.delete(r):c.deleteBlock(e,r)}else null==t&&c.deleteBlock(e,r)}function y(e,t){if(!u.has(e))return null;var r=u.get(e);return null==r[t]?null:r[t]}function x(e,t,r,a,i,s){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=y(e,t),f=c.extent,h=c.cache,p=c.rasterInfo;if(!f||f.xmin!==r.xmin||f.xmax!==r.xmax||f.ymin!==r.ymin||f.ymax!==r.ymax){for(var d=r.clone().normalize(),m=p.spatialReference,v=p.transform,b=new Set,x=0;x<d.length;x++){var g=d[x];if(!(g.xmax-g.xmin<=a||g.ymax-g.ymin<=a)){var O=Object(o.g)(g,m,u);Object(n.k)(v)&&(O=v.inverseTransform(O));var j=new l.a({x:a,y:a,spatialReference:g.spatialReference});if(null==i&&!(i=Object(o.i)(j,m,g,u)))return;var w=Object(o.k)(i,p,s||"closest"),k=w.pyramidLevel,I=w.pyramidResolution,T=w.excessiveReading;if(T)return;for(var S=p.storageInfo,R=S.origin,_={x:Math.max(0,Math.floor((O.xmin-R.x)/I.x)),y:Math.max(0,Math.floor((R.y-O.ymax)/I.y))},C=Math.ceil((O.xmax-O.xmin)/I.x-.1),M=Math.ceil((O.ymax-O.ymin)/I.y-.1),P=k>0?S.pyramidBlockWidth:S.blockWidth,F=k>0?S.pyramidBlockHeight:S.blockHeight,D=1,z=Math.max(0,Math.floor(_.x/P)-D),B=Math.max(0,Math.floor(_.y/F)-D),A=Math.floor((_.x+C-1)/P)+D,L=Math.floor((_.y+M-1)/F)+D,N=B;N<=L;N++)for(var E=z;E<=A;E++)b.add("".concat(k,"/").concat(N,"/").concat(E))}}h.forEach((function(e,t){if(!b.has(t)){var r=h.get(t);(null==r||r.isResolved||r.isRejected)&&h.delete(t)}})),c.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}},1204:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return ut}));var n=r(8),a=r.n(n),i=r(15),s=r(14),o=r(3),l=r(4),u=r(47),c=r(44),f=r(6),h=r(7),p=r(0),d=r(269),m=r(1082),v=r(20),b=r(2),y=r(285),x=r(23),g=r(1),O=(r(17),r(18)),j=r(16),w=r(58),k=r(48),I=r(9),T=r(373),S=r(694),R=r(713),_=(r(112),r(69)),C=r(41),M=r(59),P=r(204),F=r(200),D=r(1142),z=r(1187),B=r(411),A=r(995),L=r(1188),N=r(1160),E=r(61),J=r(52),H=j.a.getLogger("esri.layers.mixins.ImageryTileMixin"),q=r(539),W=r(688),U=r(542),G=r(692),V=r(305),X=r(1086),Y=r(1013),K=r(1034),$=r(31),Q=r(35),Z=r(25),ee=r(202),te=r(1161),re=r(1088),ne=r(961),ae=r(1015),ie=r(56),se=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return Object(l.a)(r,[{key:"init",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(ae.f)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){return e&&e.ioConfig&&(e=Object(s.a)(Object(s.a)({},e),{},{ioConfig:Object(s.a)({resolution:null,bandIds:null,sampling:"closest",tileInfo:B.a.create()},e.ioConfig)})),e}},{key:"url",set:function(e){this._set("url",Object(P.h)(e,j.a.getLogger(this.declaredClass)))}},{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new v.a("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=u.length>3&&void 0!==u[3]?u[3]:{},s=i.tileInfo,o=s.lodAt(t),l=this.getTileExtent({x:o.resolution,y:o.resolution},r,n,s.origin,s.spatialReference,s.size),e.abrupt("return",(i=this._getRequestOptionsWithSliceId(i),this.fetchPixels(l,s.size[0],s.size[1],i)));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,O,j,w,k=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=k.length>1&&void 0!==k[1]?k[1]:{},r=this._getRequestOptionsWithSliceId(r),n=this.rasterInfo,i=n.spatialReference,s=n.extent,o=r.datumTransformation,l=Object(ae.h)(t,i,o),s.intersects(l)){e.next=6;break}return e.abrupt("return",{location:l,value:null});case 6:if(!Object(b.k)(this.rasterInfo.transform)){e.next=11;break}if(u=this.rasterInfo.transform.inverseTransform(l),this.rasterInfo.nativeExtent.intersects(u)){e.next=10;break}return e.abrupt("return",{location:u,value:null});case 10:l=u;case 11:if(c=0,!r.srcResolution){e.next=16;break}c=Object(ae.k)(r.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel,e.next=21;break;case 16:return e.next=18,this.computeBestPyramidLevelForLocation(t,r);case 18:if(null!=(c=e.sent)){e.next=21;break}return e.abrupt("return",{location:l,value:null});case 21:if(null!==(f=this.identifyPixelLocation(l,c,null))){e.next=24;break}return e.abrupt("return",{location:l,value:null});case 24:return h=f.row,p=f.col,d=f.rowOffset,m=f.colOffset,v=Object(te.d)(this.url,r.sliceId),y="".concat(c,"/").concat(h,"/").concat(p),x=Object(te.c)(v,null,y),Object(b.j)(x)&&(x=this.fetchRawTile(c,h,p,r),Object(te.e)(v,null,y,x)),e.next=29,x;case 29:if(g=e.sent,!Object(b.j)(g)&&g.pixels&&0!==g.pixels.length){e.next=32;break}return e.abrupt("return",{location:l,value:null});case 32:if(O=d*this.rasterInfo.storageInfo.blockHeight+m,j=!g.mask||g.mask[O]?g.pixels.map((function(e){return e[O]})):null,"vector-magdir"!==(w=this.rasterInfo.dataType)&&"vector-uv"!==w||!((null==j?void 0:j.length)>1)){e.next=35;break}return e.abrupt("return",{location:l,value:j,magdirValue:"vector-magdir"===w?[j[0],j[1]]:Object(A.i)([j[0],j[1]]),pyramidLevel:c});case 35:return e.abrupt("return",{location:l,value:j,pyramidLevel:c});case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,O,j,w,k,I,T,S,R,_,C,M,P,F,D,z=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=z.length>3&&void 0!==z[3]?z[3]:{},t=Object(ae.j)(t),s=Object(ae.e)(t),o=this.rasterInfo.spatialReference,l=!t.spatialReference.equals(o),u=i.datumTransformation,c=new ie.a({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),f=i.srcResolution||(l?Object(ae.i)(c,o,t,u):c)){e.next=5;break}return e.abrupt("return",null);case 5:if(h=Object(ae.k)(f,this.rasterInfo,this.ioConfig.sampling),p=h.pyramidLevel,d=h.pyramidResolution,!h.excessiveReading){e.next=8;break}return e.abrupt("return",null);case 8:if(m=this.rasterInfo.storageInfo,v=l?Object(ae.g)(t,o,u):t,(y=Object(b.t)(this.rasterInfo.transform))&&(v=y.inverseTransform(v)),null!=v){e.next=13;break}return e.abrupt("return",null);case 13:if(x={x:Math.floor((v.xmin-m.origin.x)/d.x+.1),y:Math.floor((m.origin.y-v.ymax)/d.y+.1)},g=Math.ceil((v.xmax-v.xmin)/d.x-.1),O=Math.ceil((v.ymax-v.ymin)/d.y-.1),!(g/r>8||O/n>8||s>=2)){e.next=16;break}return e.abrupt("return",null);case 16:return e.next=18,this.fetchRawPixels(p,x,{width:g,height:O,wrapCount:s},i);case 18:if(j=e.sent){e.next=21;break}return e.abrupt("return",null);case 21:if(w=p>0?m.pyramidBlockWidth:m.blockWidth,k=p>0?m.pyramidBlockHeight:m.blockHeight,I=w===g&&k===O&&x.x%w==0&&x.y%k==0,l||!I||1!==j.pixelBlocks.length||w!==r||k!==n||f.x!==c.x||f.y!==c.y){e.next=24;break}return e.abrupt("return",{extent:t,srcExtent:v,pixelBlock:j.pixelBlocks[0]});case 24:if(T=Object(ae.c)(t,j.extent,c,u,y,s>0),R=!i.requestRawData,_={rows:T.spacing[0],cols:T.spacing[1]},C=Object(b.t)(this._getRasterTileAlignmentInfo(p,j.extent.xmin)),M=j.pixelBlocks,P=j.mosaicSize,F=j.isPartiallyFilled,!this.rasterJobHandler){e.next=32;break}return e.next=29,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:M,srcMosaicSize:P,destDimension:R?{width:r,height:n}:null,coefs:R?T.coefficients:null,sampleSpacing:R?_:null,interpolation:i.interpolation,alignmentInfo:C},i);case 29:S=e.sent,e.next=34;break;case 32:D=Object(ne.k)(M,P,null,null,C),S=R?Object(ne.a)(D,{width:r,height:n},T.coefficients,_,i.interpolation):D;case 34:return e.abrupt("return",i.requestRawData?{srcExtent:v,pixelBlock:S,transformGrid:T,extent:t,isPartiallyFilled:F}:{srcExtent:v,extent:t,pixelBlock:S});case 35:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i){var s,o,l,u,c,f,h,p,d,m,v,y,x,g,O,j,w,k,I,T,S,R,_,C,M,P,F,D,z,B,A,L,N,J=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.rasterInfo.storageInfo,o=s.origin,l=s.blockBoundary,u=this.getBlockWidthHeight(t),c=u.blockWidth,f=u.blockHeight,h=r.x,p=r.y,d=n.width,m=n.height,v=n.wrapCount,y=Object(b.t)(this._getRasterTileAlignmentInfo(t,0)),i.buffer&&(h-=i.buffer.cols,p-=i.buffer.rows,d+=2*i.buffer.cols,m+=2*i.buffer.rows),x=Math.floor(h/c),g=Math.floor(p/f),O=Math.floor((h+d-1)/c),j=Math.floor((p+m-1)/f),w=l[t]){e.next=7;break}return e.abrupt("return",null);case 7:if(k=w.minRow,I=w.minCol,T=w.maxCol,S=w.maxRow,!(j<k||O<I||g>S||x>T)){e.next=10;break}return e.abrupt("return",null);case 10:for(R=new Array,_=!1,C=null==this.ioConfig.allowPartialFill?i.allowPartialFill:this.ioConfig.allowPartialFill,M=g;M<=j;M++)for(P=x;P<=O;P++)F=0===v||null==y||P<y.worldColumnCountFromOrigin?P:P%y.worldColumnCountFromOrigin-y.originColumnOffset,M>=k&&F>=I&&S>=M&&T>=F?function(){var e=J._fetchRawTile(t,M,F,i);C?R.push(new Promise((function(t){e.then((function(e){return t(e)})).catch((function(){_=!0,t(null)}))}))):R.push(e)}():R.push(null);if(0!==R.length){e.next=16;break}return e.abrupt("return",null);case 16:return e.next=18,Promise.all(R);case 18:return D=e.sent,z={height:(j-g+1)*f,width:(O-x+1)*c},B=this.rasterInfo.spatialReference,A=this.getPyramidPixelSize(t),L=A.x,N=A.y,e.abrupt("return",{extent:new E.a({xmin:o.x+x*c*L,xmax:o.x+(O+1)*c*L,ymin:o.y-(j+1)*f*N,ymax:o.y-g*f*N,spatialReference:B}),pixelBlocks:D,mosaicSize:z,isPartiallyFilled:_});case 25:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new v.a("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return Object(ae.g)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?Object(re.a)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,o,l,u,c,f,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l=this.ioConfig.customFetchParameters,u=r.range,c=r.query,f=r.headers,n=null!=(i=null!=(o=n)?o:r.retryCount)?i:this.ioConfig.retryCount,h=u?{Range:"bytes=".concat(u.from,"-").concat(u.to)}:null,e.prev=3,e.next=6,Object(_.default)(t,Object(s.a)(Object(s.a)({},r),{},{query:Object(s.a)(Object(s.a)({},c),l),headers:Object(s.a)(Object(s.a)({},f),h)}));case 6:return e.abrupt("return",e.sent);case 9:if(e.prev=9,e.t0=e.catch(3),!(n>0)){e.next=13;break}return e.abrupt("return",(n--,this.request(t,r,n)));case 13:throw e.t0;case 14:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this,r=this.rasterInfo.multidimensionalInfo;if(!Object(b.k)(r)||null==e||!e.length)return null;for(var n=0,a=e[0].variableName,i=function(i){var s=r.variables[i],o=s.dimensions;if(s.name!==a)return n+=o.map((function(e){return t._getDimensionValuesCount(e)})).reduce((function(e,t){return e+t})),"break";for(var l=o.map((function(e){return t._getDimensionValuesCount(e)})),u=o.length,c=function(r){var a=e.filter((function(e){return e.dimensionName===o[r].name}))[0];if(null==a)return{v:{v:null}};var i=Array.isArray(a.values[0])?a.values[0][0]:a.values[0],s=t._getIndexFromDimensions(i,o[r]);if(-1===s)return{v:{v:null}};l.shift(),n+=r===u-1?s:s*l.reduce((function(e,t){return e+t}))},f=0;f<u;f++){var h=c(f);if("object"===typeof h)return h.v}},s=0;s<r.variables.length;s++){var o=i(s);if("break"===o)break;if("object"===typeof o)return o.v}return n}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,a=e.pixelSize;if(!t.tileInfo){for(var i=[],s=t.maximumPyramidLevel||0,o=Math.max(a.x,a.y),l=1/.0254*96*o,u=0;u<=s;u++)i.push({level:s-u,resolution:o,scale:l}),o*=2,l*=2;var c=new ie.a({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new B.a({origin:c,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:i}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,a=e.width,i=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,u=new ie.a({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(a,i))/Math.LN2-8)));var c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new K.a({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,n,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===a.length&&i>0)for(var o=(a=Object(Q.a)(a))[0],l=o.x,u=o.y,c=0;c<i;c++)l*=s,u*=s,a.push({x:l,y:u});for(var f=[],h=n.x,p=n.y,d=0;d<a.length;d++){var m=a[d],v=m.x,b=m.y;f.push({minCol:Math.floor((e.xmin-h+.1*v)/t/v),maxCol:Math.floor((e.xmax-h-.1*v)/t/v),minRow:Math.floor((p-e.ymax+.1*b)/r/b),maxRow:Math.floor((p-e.ymin-.1*b)/r/b)})}return f}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,a=r.pyramidScalingFactor;if(0===e)return t;if(Object(b.k)(n)&&n.length)return n[e-1];var i=Math.pow(a,e);return{x:t.x*i,y:t.y*i}}},{key:"identifyPixelLocation",value:function(e,t,r){var n=this.rasterInfo,a=n.spatialReference,i=n.nativeExtent,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.maximumPyramidLevel,c=s.origin,f=Object(ae.h)(e,a,r);if(!i.intersects(f))return null;if(t<0||t>u)return null;var h=this.getPyramidPixelSize(t),p=h.x,d=h.y,m=(c.y-f.y)/d/l,v=(f.x-c.x)/p/o,b=Math.min(l-1,Math.floor((m-Math.floor(m))*l)),y=Math.min(o-1,Math.floor((v-Math.floor(v))*o));return{pyramidLevel:t,row:Math.floor(m),col:Math.floor(v),rowOffset:b,colOffset:y,srcLocation:f}}},{key:"getTileExtent",value:function(e,t,r,n,a,i){var s=Object($.a)(i,2),o=s[0],l=s[1],u=n.x+r*o*e.x,c=u+o*e.x,f=n.y-t*l*e.y,h=f-l*e.y;return new E.a({xmin:u,xmax:c,ymin:h,ymax:f,spatialReference:a})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_fetchRawTile",value:function(e,t,r,n){var a=this.rasterInfo.storageInfo.blockBoundary[e];if(!a)return Promise.resolve(null);var i=a.minRow,o=a.minCol,l=a.maxCol,u=a.maxRow;if(t<i||r<o||t>u||r>l)return Promise.resolve(null);var c=Object(te.d)(this.url,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),h=Object(te.c)(c,n.registryId,f);if(Object(b.j)(h)){var p=Object(x.e)();h=this.fetchRawTile(e,t,r,Object(s.a)(Object(s.a)({},n),{},{signal:p.signal})),Object(te.e)(c,n.registryId,f,h,p),h.catch((function(){return Object(te.b)(c,n.registryId,f)}))}return n.signal&&Object(x.s)(n,(function(){Object(te.a)(c,n.registryId,f)})),h}},{key:"_getIndexFromDimensions",value:function(e,t){var r=t.extent,n=t.interval,a=t.unit,i=t.values;if(null!=i&&i.length)return Array.isArray(i[0])?i.findIndex((function(t){return t[0]<=e&&t[1]>=e})):i.indexOf(e);if(e>r[1])return-1;var s=r[0],o=-1;if("ISO8601"===a){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":o=Math.round((e-s)/1e3/n);break;case"minutes":o=Math.round((e-s)/6e4/n);break;case"hours":o=Math.round((e-s)/36e5/n);break;case"days":o=Math.round((e-s)/864e5/n);break;case"years":o=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/n);break;case"decades":o=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/n)}return o}return Math.round((e-s)/n)}},{key:"_getDimensionValuesCount",value:function(e){var t=e.extent,r=e.interval,n=e.unit,a=e.values,i=(null==a?void 0:a.length)||0;if(i)return i;var s=t[0];if(0===i&&"ISO8601"===n){var o;switch((null==(o=e.intervalUnit)?void 0:o.toLowerCase())||"seconds"){case"seconds":i=Math.round((t[1]-t[0])/1e3/r);break;case"minutes":i=Math.round((t[1]-t[0])/6e4/r);break;case"hours":i=Math.round((t[1]-t[0])/36e5/r);break;case"days":i=Math.round((t[1]-t[0])/864e5/r);break;case"years":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/r);break;case"decades":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/10/r)}return i}return Math.round((t[1]-t[0])/r)}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=Object(ae.d)(this.rasterInfo)),Object(b.k)(this._rasterTileAlighmentInfo.pyramidsInfo)?Object(s.a)({startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform},this._rasterTileAlighmentInfo.pyramidsInfo[e]):null}},{key:"_getRequestOptionsWithSliceId",value:function(e){var t;return null!=(t=e.multidimensionalDefinition)&&t.length&&Object(b.k)(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e=Object(s.a)(Object(s.a)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)||0})),e}}]),r}(Object(ee.b)(Z.a));Object(p.a)([Object(g.b)()],se.prototype,"_rasterTileAlighmentInfo",void 0),Object(p.a)([Object(g.b)(F.n)],se.prototype,"url",null),Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],se.prototype,"datasetName",void 0),Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],se.prototype,"datasetFormat",void 0),Object(p.a)([Object(g.b)()],se.prototype,"rasterInfo",void 0),Object(p.a)([Object(g.b)()],se.prototype,"ioConfig",void 0),Object(p.a)([Object(g.b)()],se.prototype,"sourceJSON",void 0);var oe=se=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.BaseRaster")],se),le=r(1173);function ue(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",a=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),i=a.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<i.length;l++)t[i[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:a,features:s}}var ce=function(){function e(){Object(o.a)(this,e)}return Object(l.a)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,a=t.getUint32(4,!0),i=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:a,headerByteCount:i,recordByteCount:s},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:Object(le.a)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push(Object(le.a)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=s};c.length<a&&e.byteLength-l>s;)f()}return{header:o,fields:u,records:c,recordSet:ue({fields:u,records:c})}}}]),e}(),fe=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).affectsPixelSize=!1,e}return Object(l.a)(r,[{key:"forwardTransform",value:function(e){return e}},{key:"inverseTransform",value:function(e){return e}}]),r}(Z.a);Object(p.a)([Object(g.b)()],fe.prototype,"affectsPixelSize",void 0),Object(p.a)([Object(g.b)({json:{write:!0}})],fe.prototype,"spatialReference",void 0);var he=fe=Object(p.a)([Object(I.a)("esri.layers.support.rasterTransforms.BaseRasterTransform")],fe),pe=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).type="identity",e}return r}(he);Object(p.a)([Object(w.a)({IdentityXform:"identity"})],pe.prototype,"type",void 0);var de=pe=Object(p.a)([Object(I.a)("esri.layers.support.rasterTransforms.IdentityTransform")],pe),me=r(43);function ve(e,t,r){var n=t.x,a=t.y;if(r<2)return{x:e[0]+n*e[2]+a*e[4],y:e[1]+n*e[3]+a*e[5]};if(2===r){var i=n*n,s=a*a,o=n*a;return{x:e[0]+n*e[2]+a*e[4]+i*e[6]+o*e[8]+s*e[10],y:e[1]+n*e[3]+a*e[5]+i*e[7]+o*e[9]+s*e[11]}}var l=n*n,u=a*a,c=n*a,f=l*n,h=l*a,p=n*u,d=a*u;return{x:e[0]+n*e[2]+a*e[4]+l*e[6]+c*e[8]+u*e[10]+f*e[12]+h*e[14]+p*e[16]+d*e[18],y:e[1]+n*e[3]+a*e[5]+l*e[7]+c*e[9]+u*e[11]+f*e[13]+h*e[15]+p*e[17]+d*e[19]}}function be(e,t,r){var n=t.xmin,a=t.ymin,i=t.xmax,s=t.ymax,o=t.spatialReference,l=[];if(r<2)l.push({x:n,y:s}),l.push({x:i,y:s}),l.push({x:n,y:a}),l.push({x:i,y:a});else{for(var u=10,c=0;c<u;c++)l.push({x:n,y:a+(s-a)*c/(u-1)}),l.push({x:i,y:a+(s-a)*c/(u-1)});u=8;for(var f=1;f<=u;f++)l.push({x:n+(i-n)*f/u,y:a}),l.push({x:n+(i-n)*f/u,y:s})}l=l.map((function(t){return ve(e,t,r)}));var h=l.map((function(e){return e.x})),p=l.map((function(e){return e.y}));return new E.a({xmin:Math.min.apply(null,h),xmax:Math.max.apply(null,h),ymin:Math.min.apply(null,p),ymax:Math.max.apply(null,p),spatialReference:o})}var ye=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).polynomialOrder=1,e.type="polynomial",e}return Object(l.a)(r,[{key:"readForwardCoefficients",value:function(e,t){var r=t.coeffX,n=t.coeffY;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;for(var a=[],i=0;i<r.length;i++)a.push(r[i]),a.push(n[i]);return a}},{key:"writeForwardCoefficients",value:function(e,t,r){for(var n=[],a=[],i=0;i<(null==e?void 0:e.length);i++)i%2==0?n.push(e[i]):a.push(e[i]);t.coeffX=n,t.coeffY=a}},{key:"inverseCoefficients",get:function(){var e=this._get("inverseCoefficients"),t=this._get("forwardCoefficients");return!e&&t&&this.polynomialOrder<2&&(e=function(e){var t=Object($.a)(e,6),r=t[0],n=t[1],a=t[2],i=t[3],s=t[4],o=t[5],l=a*o-s*i,u=s*i-a*o;return[(s*n-r*o)/l,(a*n-r*i)/u,o/l,i/u,-s/l,-a/u]}(t)),e},set:function(e){this._set("inverseCoefficients",e)}},{key:"readInverseCoefficients",value:function(e,t){var r=t.inverseCoeffX,n=t.inverseCoeffY;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;for(var a=[],i=0;i<r.length;i++)a.push(r[i]),a.push(n[i]);return a}},{key:"writeInverseCoefficients",value:function(e,t,r){for(var n=[],a=[],i=0;i<(null==e?void 0:e.length);i++)i%2==0?n.push(e[i]):a.push(e[i]);t.inverseCoeffX=n,t.inverseCoeffY=a}},{key:"forwardTransform",value:function(e){if("point"===e.type){var t=ve(this.forwardCoefficients,e,this.polynomialOrder);return new ie.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return be(this.forwardCoefficients,e,this.polynomialOrder)}},{key:"inverseTransform",value:function(e){if("point"===e.type){var t=ve(this.inverseCoefficients,e,this.polynomialOrder);return new ie.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return be(this.inverseCoefficients,e,this.polynomialOrder)}}]),r}(he);Object(p.a)([Object(g.b)({json:{write:!0}})],ye.prototype,"polynomialOrder",void 0),Object(p.a)([Object(g.b)()],ye.prototype,"forwardCoefficients",void 0),Object(p.a)([Object(k.a)("forwardCoefficients",["coeffX","coeffY"])],ye.prototype,"readForwardCoefficients",null),Object(p.a)([Object(me.a)("forwardCoefficients")],ye.prototype,"writeForwardCoefficients",null),Object(p.a)([Object(g.b)({json:{write:!0}})],ye.prototype,"inverseCoefficients",null),Object(p.a)([Object(k.a)("inverseCoefficients",["inverseCoeffX","inverseCoeffY"])],ye.prototype,"readInverseCoefficients",null),Object(p.a)([Object(me.a)("inverseCoefficients")],ye.prototype,"writeInverseCoefficients",null),Object(p.a)([Object(g.b)()],ye.prototype,"affectsPixelSize",void 0),Object(p.a)([Object(w.a)({PolynomialXform:"polynomial"})],ye.prototype,"type",void 0);var xe=ye=Object(p.a)([Object(I.a)("esri.layers.support.rasterTransforms.PolynomialTransform")],ye),ge={PolynomialXform:xe,IdentityXform:de},Oe=Object.keys(ge);var je=r(209),we=new Map;we.set("int16","esriFieldTypeSmallInteger"),we.set("int32","esriFieldTypeInteger"),we.set("int64","esriFieldTypeInteger"),we.set("float32","esriFieldTypeSingle"),we.set("float64","esriFieldTypeDouble"),we.set("text","esriFieldTypeString");var ke=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null==t?void 0:t.signal});case 4:if(r=e.sent,n=r.data,this._validateHeader(n)){e.next=8;break}throw new v.a("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=this._parseHeader(n),s=i.storageInfo,"thematic"!==(o=i.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:l=e.sent,o.attributeTable=l;case 15:this._set("storageInfo",s),this._set("rasterInfo",o),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=p.length>3&&void 0!==p[3]?p[3]:{},!((s=this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return o=this._buildCacheFilePath(s,r,n,i.multidimensionalDefinition),l=this._getIndexRecordFromBundle(r,n),e.next=8,this.request(o,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});case 8:if(u=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(c=new Uint8Array(u.data),0!==(f=this._getTileEndAndContentType(c,l)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(o,{range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer",signal:i.signal});case 16:return h=e.sent,e.abrupt("return",h?this.decodePixelBlock(h.data,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null}):null);case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],a=e.bandCount,i=e.histograms,s=e.colormap,o=e.blockWidth,l=e.blockHeight,u=e.firstPyramidLevel,c=e.maximumPyramidLevel,f=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),h=e.extent.spatialReference,p=null==(t=e.geodataXform)?void 0:t.spatialReference,d=new J.a(null!=h&&h.wkid||null!=h&&h.wkt?h:p),m=new E.a({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:d}),v=new ie.a({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:d}),b=Math.round((m.xmax-m.xmin)/v.x),y=Math.round((m.ymax-m.ymin)/v.y),x=this._parseTransform(e.geodataXform),g=x?m:null;x&&(m=x.forwardTransform(m),v.x=(m.xmax-m.xmin)/b,v.y=(m.ymax-m.ymin)/y);var O,j,w,k,I=null!=(r=e.properties)?r:{},T=e.format.toLowerCase().replace("cache/",""),S=new ie.a(e.origin.x,e.origin.y,d);if(s&&s.colors)for(O=[],j=0;j<s.colors.length;j++)w=s.colors[j],k=s.values?s.values[j]:j,O.push([k,255&w,w<<16>>>24,w<<8>>>24,w>>>24]);var R=e.LODInfos,_=[];for(j=0;j<R.levels.length;j++)_.push({level:R.levels[j],resolution:R.resolutions[j],scale:96/.0254*R.resolutions[j]});var C=new B.a({dpi:96,lods:_,format:T,origin:S,size:[o,l],spatialReference:d}),M={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},P=[{maxCol:Math.ceil(b/o)-1,maxRow:Math.ceil(y/l)-1,minCol:0,minRow:0}],F=2;if(c>0)for(j=0;j<c;j++)P.push({maxCol:Math.ceil(b/F/o)-1,maxRow:Math.ceil(y/F/l)-1,minCol:0,minRow:0}),F*=2;var D=e.mdInfo;return{storageInfo:M,rasterInfo:new Y.a({width:b,height:y,pixelType:n,bandCount:a,extent:m,nativeExtent:g,transform:x,spatialReference:d,pixelSize:v,keyProperties:I,statistics:f,histograms:i,multidimensionalInfo:D,colormap:O,storageInfo:new K.a({blockWidth:o,blockHeight:l,pyramidBlockWidth:o,pyramidBlockHeight:l,origin:S,tileInfo:C,firstPyramidLevel:u,maximumPyramidLevel:c,blockBoundary:P})})}}},{key:"_parseTransform",value:function(e){var t,r;if(!function(e){var t=null==e?void 0:e.type;return!e||Oe.includes(t)}(e))throw new v.a("cloudraster:open","the data contains unsupported geodata transform types");var n=function(e){if(!(null==e?void 0:e.type))return null;var t=ge[null==e?void 0:e.type];if(t){var r=new t;return r.read(e),r}return null}(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null==(t=n.forwardCoefficients)||!t.length||null==(r=n.inverseCoefficients)||!r.length)throw new v.a("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}},{key:"_fetchAuxiliaryInformation",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),n=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,n]);case 4:return(i=e.sent)[0]&&(o=i[0].fields,l=i[0].values,o&&l&&(o=o.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":we.get(e.type),name:e.name,alias:e.alias||e.name}})),u=l.map((function(e){return{attributes:e}})),o&&l&&(s={fields:o,features:u}))),!s&&i[1]&&(s=ce.parse(i[1]).recordSet),e.abrupt("return",je.default.fromJSON(s));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_buildCacheFilePath",value:function(e,t,r,n){var a=this.storageInfo.packetSize,i=Math.floor(t/a)*a,s=Math.floor(r/a)*a,o="R"+this._toHexString4(i)+"C"+this._toHexString4(s),l="L";l+=e>=10?e.toString():"0"+e.toString();var u=this.rasterInfo.multidimensionalInfo,c=null==n?void 0:n[0];if(!Object(b.k)(u)||!c)return"".concat(this.url,"/_alllayers/").concat(l,"/").concat(o,".bundle");for(var f=u.variables.filter((function(e){return e.name===c.variableName}))[0].dimensions[0].values.indexOf(c.values[0]).toString(16),h=4-f.length,p=0;p<h;p++)f="0"+f;return f="S"+f,"".concat(this.url,"/_alllayers/").concat(c.variableName,"/").concat(f,"/").concat(l,"/").concat(o,".bundle")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=this.storageInfo.packetSize,n=r*(e%r)+t%r;if(n<0)throw"Invalid level / row / col";return 20+n*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),a=0;for(r=0;r<5;r++)a|=(255&n[r])<<8*r;var i=0xffffffffff&a;for(a=0,r=5;r<8;r++)a|=(255&n[r])<<8*(r-5);return{position:i,recordSize:0xffffffffff&a}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),r}(oe);Object(p.a)([Object(g.b)({readOnly:!0})],ke.prototype,"storageInfo",void 0),Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],ke.prototype,"datasetFormat",void 0);var Ie=ke=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.CloudRaster")],ke),Te=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m,v,b,y;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return n=this.data,i=n.pixelBlock,s=n.statistics,o=n.histograms,l=n.name,u=n.keyProperties,c=n.nativeExtent,f=n.transform,h=i.width,p=i.height,d=i.pixelType,m=this.data.extent||new E.a({xmin:-.5,ymin:.5,xmax:h-.5,ymax:p-.5,spatialReference:new J.a({wkid:3857})}),v=null!=(r=this.data.isPseudoSpatialReference)?r:!this.data.extent,b={x:m.width/h,y:m.height/p},y=new Y.a({width:h,height:p,pixelType:d,extent:m,nativeExtent:c,transform:f,pixelSize:b,spatialReference:m.spatialReference,bandCount:3,keyProperties:u||{},statistics:s,isPseudoSpatialReference:v,histograms:o}),this.createRemoteDatasetStorageInfo(y,512,512),this._set("rasterInfo",y),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(i,{width:512,height:512},t);case 8:this.datasetName=l,this.url="/InMemory/"+l;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.rasterInfo.storageInfo.maximumPyramidLevel,s=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:i},n):Promise.resolve(Object(ne.o)(t,r,i)),o=Object(b.k)(this.rasterInfo.statistics),l=Object(b.k)(this.rasterInfo.histograms),u=o&&l?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},n):Promise.resolve(Object(ne.g)(t)),e.next=7,Object(x.k)([s,u]);case 7:if((c=e.sent)[0].value||!c[1].value){e.next=10;break}throw new v.a("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=c[0].value,o||(this.rasterInfo.statistics=null==(f=c[1].value)?void 0:f.statistics),l&&(this.rasterInfo.histograms=null==(h=c[1].value)?void 0:h.histograms);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(oe);Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],Te.prototype,"datasetFormat",void 0),Object(p.a)([Object(g.b)()],Te.prototype,"data",void 0);var Se=Te=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.InMemoryRaster")],Te);function Re(e,t){if(!e||!t)return[];var r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var a=Re(e,r),i=0;i<a.length;i++)Re(a[i],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item[o]);return n}function _e(e,t){if(!e||!t)return null;var r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=Re(e,r);return n.length>0?t?_e(n[0],t):n[0]:null}function Ce(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?_e(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function Me(e,t){return function(e,t){for(var r,n=Re(e,t),a=[],i=0;i<n.length;i++)(r=n[i].textContent||n[i].nodeValue)&&""!==(r=r.trim())&&a.push(r);return a}(e,t).map((function(e){return Number(e)}))}function Pe(e,t){var r=Ce(e,t);return Number(r)}function Fe(e,t){var r,n=null==e||null==(r=e.nodeName)?void 0:r.toLowerCase(),a=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===a}function De(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function ze(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new J.a({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;var r=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),a=n>-1?n:e.indexOf("GEOGCS");if(-1===a)return null;var i=e.slice(a,e.lastIndexOf("]",r)+1).trim(),s=e.slice(a,e.lastIndexOf("]")).trim();t=Be(i);var o=new J.a(t?{wkid:t}:{wkt:i}),l=Be(s);return l&&(o.vcsWkid=l),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=Be(e),new J.a(0!==t?{wkid:t}:{wkt:e})):null}function Be(e){var t=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),r=t[t.length-1].split(",");if("EPSG"===r[0]&&e.endsWith('"]]')){var n=Number(r[1]);if(!isNaN(n)&&0!==n)return n}return 0}function Ae(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(Fe(e,"SRS")){if(!r.spatialReference){var t=Ce(e);r.spatialReference=ze(t)}}else if(Fe(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=_e(e,"GeodataXform"),n=ze(Pe(r,"SpatialReference/WKID")||Ce(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var a=null!=(t=Pe(r,"PolynomialOrder"))?t:1,i=Me(r,"CoeffX/Double"),s=Me(r,"CoeffY/Double"),o=Me(r,"InverseCoeffX/Double"),l=Me(r,"InverseCoeffY/Double"),u=De(i,s),c=De(o,l);return{spatialReference:n,transform:new xe({spatialReference:n,polynomialOrder:a,forwardCoefficients:u,inverseCoefficients:c})}}(e),a=n.spatialReference,i=n.transform;r.transform=i,r.spatialReference||(r.spatialReference=a)}else Re(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=Ce(e)}));else if(Fe(e,"PAMRasterBand")){var s=function(e){var t,r,n,a,i,s=Pe(e,"NoDataValue"),o=_e(e,"Histograms/HistItem"),l=Pe(o,"HistMin"),u=Pe(o,"HistMax"),c=Pe(o,"BucketCount"),f=null==(t=Ce(o,"HistCounts"))?void 0:t.split("|").map((function(e){return Number(e)}));Re(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":a=s;break;case"STATISTICS_STDDEV":i=s}}));var h=Pe(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!=f&&f.length&&null!=r&&null!=n?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:h,statistics:null!=r&&null!=n?{min:r,max:n,avg:a,stddev:i}:null}}(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n){var a=!!n[0].statistics;r.statistics=a?n.map((function(e){return e.statistics})):null;var i=!!n[0].histogram;r.histograms=i?n.map((function(e){return e.histogram})):null}return r}var Le=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return n=e.sent,i=n.spatialReference,s=n.statistics,o=n.histograms,l=n.transform,(u=!i)&&(i=new J.a({wkid:3857})),null!=o&&o.length&&null==s&&(s=Object(ne.f)(o)),c=r.width,f=r.height,h=new E.a({xmin:-.5,ymin:.5-f,xmax:c-.5,ymax:.5,spatialReference:i}),p=l?l.forwardTransform(h):h,!0,l&&(d=l.forwardCoefficients,d&&0===d[1]&&0===d[2]&&(l=null,h=p)),m=new Se({data:{extent:p,nativeExtent:h,transform:l,pixelBlock:r,statistics:s,histograms:o,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:u}}),e.next=22,m.open();case 22:this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null==t?void 0:t.signal});case 2:if(r=e.sent,n=r.data,"JPG"===(i=Object(re.b)(n).toUpperCase())||"PNG"===i||"GIF"===i||"BMP"===i){e.next=7;break}throw new v.a("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",i),e.next=10,this.decodePixelBlock(n,{format:"jpg",width:1,height:1,useCanvas:!0});case 10:return e.abrupt("return",e.sent);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Object(b.t)(null==t?void 0:t.signal),s=null!=(r=this.ioConfig.skipExtensions)?r:[],o=s.indexOf("aux.xml")>-1?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:i}),l=this.datasetFormat,u="JPG"===l?"jgw":"PNG"===l?"pgw":"BMP"===l?"bpw":null,c=s.indexOf(u)>-1?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:i}),e.next=8,Object(x.k)([o,c]);case 8:if(f=e.sent,null==i||!i.aborted){e.next=11;break}throw Object(x.f)();case 11:return(h=Ae(null==(n=f[0].value)?void 0:n.data)).transform||(p=f[1].value?f[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,h.transform=6===(null==p?void 0:p.length)?new xe({forwardCoefficients:[p[4],p[5],p[0],-p[1],p[2],-p[3]]}):null),e.abrupt("return",h);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(oe);Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],Le.prototype,"datasetFormat",void 0);var Ne=Le=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Le),Ee=r(34),Je=r(1012),He=r(971),qe=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).type="gcs-shift",e.tolerance=1e-8,e}return Object(l.a)(r,[{key:"forwardTransform",value:function(e){return"point"===(e=e.clone()).type?(e.x>180+this.tolerance&&(e.x-=360),e):(e.xmin>=180-this.tolerance?(e.xmax-=360,e.xmin-=360):e.xmax>180+this.tolerance&&(e.xmin=-180,e.xmax=180),e)}},{key:"inverseTransform",value:function(e){return"point"===(e=e.clone()).type?(e.x<-this.tolerance&&(e.x+=360),e):(e.xmin<-this.tolerance&&(e.xmin+=360,e.xmax+=360),e)}}]),r}(he);Object(p.a)([Object(w.a)({GCSShiftXform:"gcs-shift"})],qe.prototype,"type",void 0),Object(p.a)([Object(g.b)()],qe.prototype,"tolerance",void 0);var We=qe=Object(p.a)([Object(I.a)("esri.layers.support.rasterTransforms.GCSShiftTransform")],qe),Ue=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._slices=null,e._tilemapCache=null,e.datasetFormat="RasterTileServer",e}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m,y,x,g,O,j,w,k,I,T;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(r=t&&t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:r});case 9:e.t0=e.sent;case 10:if((n=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),i=n.data,this.sourceJSON=i,i){e.next=15;break}throw new v.a("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(i.tileInfo){e.next=17;break}throw new v.a("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),s=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=i.cacheType,null==this.tileType&&(s.indexOf(i.tileInfo.format.toLowerCase())>-1?this.tileType="Map":"lerc"===i.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=i.name.slice(i.name.indexOf("/")+1),e.next=22,this._fetchRasterInfo({signal:r});case 22:if(o=e.sent,Object(b.k)(o)){e.next=25;break}throw new v.a("image-server-raster:open","cannot initialize image service");case 25:l="Map"===this.tileType?Object(Je.a)(i.tileInfo,i):B.a.fromJSON(i.tileInfo),u=o.extent,c=o.pixelSize,f=.5/o.width*c.x,d=l.lodAt(Math.max.apply(null,l.lods.map((function(e){return e.level})))),"Map"!==this.tileType&&0!==i.maxScale&&("Raster"===this.tileType?(h=l.lods.filter((function(e){return e.resolution===c.x}))[0],h||(h=l.lods[l.lods.length-1])):(h=l.lods.filter((function(e){return Math.abs(e.scale-i.maxScale)<f}))[0],h||(h=l.lods.filter((function(e){return e.scale>i.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])),c.x=c.y=h.resolution,o.width=Math.ceil((u.xmax-u.xmin)/c.x-.1),o.height=Math.ceil((u.ymax-u.ymin)/c.y-.1)),h||(h=d),m=l.lodAt(Math.min.apply(null,l.lods.map((function(e){return e.level})))),"Map"===this.tileType?this._levelOffset=l.lods[0].level:0!==i.minScale&&"Elevation"===this.tileType&&(p=l.lods.filter((function(e){return Math.abs(e.scale-i.minScale)<f}))[0],this._levelOffset=p.level-m.level),p||(p=m),y=Math.max(c.x,c.y),(Math.abs(c.x-c.y)>f||!l.lods.some((function(e){return Math.abs(e.resolution-y)<f})))&&(c.x=c.y=h.resolution,o.width=Math.ceil((u.xmax-u.xmin)/c.x-.1),o.height=Math.ceil((u.ymax-u.ymin)/c.y-.1)),x=h.level-p.level,g=Object($.a)(l.size,2),O=g[0],j=g[1],w=[],l.lods.forEach((function(e){e.level>=p.level&&e.level<=h.level&&w.push({x:e.resolution,y:e.resolution})})),w.sort((function(e,t){return e.x-t.x})),k=this.computeBlockBoundary(u,O,j,l.origin,w,x),I=w.length>1?w.slice(1):null,o.storageInfo=new K.a({blockWidth:l.size[0],blockHeight:l.size[1],pyramidBlockWidth:l.size[0],pyramidBlockHeight:l.size[1],pyramidResolutions:I,compression:l.format,origin:l.origin,firstPyramidLevel:1,maximumPyramidLevel:x,tileInfo:l,blockBoundary:k}),this._fixGCSShift(o),this._set("rasterInfo",o),i.capabilities.toLowerCase().indexOf("tilemap")>-1&&(T={tileInfo:o.storageInfo.tileInfo,parsedUrl:Object(Ee.K)(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new He.a({layer:T}));case 37:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,b,y,x,g,O,j,w,k,I,T,S,R,_,C=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=C.length>3&&void 0!==C[3]?C[3]:{},s=this.rasterInfo,o=s.storageInfo,l=s.extent,u=o.maximumPyramidLevel-t+this._levelOffset,c="".concat(this.url,"/tile/").concat(u,"/").concat(r,"/").concat(n),f=this._slices?{sliceId:i.sliceId||0}:null,e.next=9,this.request(c,{query:f,responseType:"array-buffer",signal:i.signal});case 9:if(h=e.sent,p=h.data){e.next=13;break}return e.abrupt("return",null);case 13:return e.next=15,this.decodePixelBlock(p,{width:o.tileInfo.size[0],height:o.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType});case 15:if(d=e.sent,m=o.blockBoundary[t],!("jpg"!==o.compression||n>m.minCol&&n<m.maxCol&&r>m.minRow&&r<m.maxRow)){e.next=19;break}return e.abrupt("return",d);case 19:return v=o.origin,b=o.blockWidth,y=o.blockHeight,x=this.getPyramidPixelSize(t),g=x.x,O=x.y,j=Math.round((l.xmin-v.x)/g)%b,w=Math.round((l.xmax-v.x)/g)%b,k=Math.round((v.y-l.ymax)/O)%y,I=Math.round((v.y-l.ymin)/O)%y,T=n===m.minCol?j:0,S=r===m.minRow?k:0,R=n===m.maxCol?w:b,_=r===m.maxRow?I:y,e.abrupt("return",(Object(ne.n)(d,{x:T,y:S},{width:R-T,height:_-S}),d));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(null==e||!e.length||!this._slices)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.filter((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}))[0];return!r||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(r.values[0])?r.values[0][0]:r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null==(t=e.data)?void 0:t.statistics})),i=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null==(t=e.data)?void 0:t.histograms})),e.next=4,Promise.all([n,i]);case 4:return s=e.sent,e.abrupt("return",(s[0]&&s[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:s[0]||null,histograms:s[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(n=this.identifyPixelLocation(t,0,Object(b.t)(r.datumTransformation)))){e.next=6;break}return e.abrupt("return",null);case 6:i=0,s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=s-i+this._levelOffset,l=n.srcLocation;case 10:if(!(o>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(o,n.row,n.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(o--,i++,null!==(n=this.identifyPixelLocation(l,i,Object(b.t)(r.datumTransformation)))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===o||null==n?null:i);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,n=Math.ceil((r.extent.xmax-r.extent.xmin)/r.pixelSizeX-.1),i=Math.ceil((r.extent.ymax-r.extent.ymin)/r.pixelSizeY-.1),s=J.a.fromJSON(r.spatialReference||r.extent.spatialReference),"Map"!==this.tileType){e.next=3;break}return e.abrupt("return",new Y.a({width:n,height:i,bandCount:3,extent:E.a.fromJSON(r.extent),spatialReference:s,pixelSize:new ie.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:s}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 3:return o=t.slice,l=t.signal,u=!!r.hasRasterAttributeTable&&this.request(this.url+"/rasterAttributeTable",{query:{slice:o,f:"json"},signal:l}).then((function(e){return je.default.fromJSON(e.data)})).catch((function(){return null})),c=!!r.hasColormap&&this.request(this.url+"/colormap",{query:{slice:o,f:"json"},signal:l}).then((function(e){var t;return null==(t=e.data)?void 0:t.colormap})),f=!!r.hasHistograms&&this.request(this.url+"/histograms",{query:{slice:o,f:"json"},signal:l}).then((function(e){var t;return null==(t=e.data)?void 0:t.histograms})),h=this.request(this.url+"/keyProperties",{query:{f:"json"},signal:l}).then((function(e){return e.data})).catch((function(){})),p=!!r.hasMultidimensions&&this._fetchMultidimensionalInfo(),d=!!r.hasMultidimensions&&this.request(this.url+"/slices",{query:{f:"json"},signal:l}).then((function(e){return e.data&&e.data.slices})).catch((function(){})),e.abrupt("return",Promise.all([u,c,f,h,p,d]).then((function(e){var t=null;if(r.minValues&&r.minValues.length===r.bandCount){t=[];for(var a=0;a<r.minValues.length;a++)t.push({min:r.minValues[a],max:r.maxValues[a],avg:r.meanValues[a],stddev:r.stdvValues[a]})}return m._slices=e[5]||null,new Y.a({width:n,height:i,bandCount:r.bandCount,extent:E.a.fromJSON(r.extent),spatialReference:s,pixelSize:new ie.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:s}),pixelType:r.pixelType.toLowerCase(),statistics:t,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})})));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchMultidimensionalInfo",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:t}).then((function(e){var t;return null==(t=e.data)?void 0:t.multidimensionalInfo}));case 2:return n=e.sent,e.abrupt("return",(null!=(r=n.variables)&&r.length&&n.variables.forEach((function(e){var t;null!=(t=e.statistics)&&t.length&&e.statistics.forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation}))})),n));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_fixGCSShift",value:function(e){var t=e.extent,r=e.spatialReference;0===t.xmin&&360===t.xmax&&r.wkid&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new We,e.extent=e.transform.forwardTransform(t))}}]),r}(oe);Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],Ue.prototype,"datasetFormat",void 0),Object(p.a)([Object(g.b)()],Ue.prototype,"tileType",void 0);var Ge=Ue=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.ImageServerRaster")],Ue),Ve=r(981),Xe=r(1111),Ye=new Map;Ye.set("Int8","s8"),Ye.set("UInt8","u8"),Ye.set("Int16","s16"),Ye.set("UInt16","u16"),Ye.set("Int32","s32"),Ye.set("UInt32","u32"),Ye.set("Float32","f32"),Ye.set("Float64","f32"),Ye.set("Double64","f32");var Ke=new Map;Ke.set("lerc",".lrc"),Ke.set("none",".til"),Ke.set("deflate",".pzp"),Ke.set("jpeg",".jzp");var $e=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h,p,d,m,v,y,x,g,O,j,w,k,I,T,S;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=t?Object(b.t)(t.signal):null,e.next=6,this.request(this.url,{responseType:"xml",signal:n});case 6:if(i=e.sent,s=this._parseHeader(i.data),o=s.rasterInfo,l=s.files,-1!==(null==(r=this.ioConfig.skipExtensions)?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(u=e.sent)&&(o.statistics=null!=(c=u.statistics)?c:o.statistics,o.histograms=u.histograms,u.histograms&&!Object(b.k)(o.statistics)&&(o.statistics=Object(ne.f)(u.histograms)));case 15:return this._set("rasterInfo",o),this._files=l,e.next=18,this.request(l.index,{responseType:"array-buffer",signal:n});case 18:for(f=e.sent,this._storageIndex=this._parseIndex(f.data),d=0,m=-1,v=this.rasterInfo.storageInfo,y=v.blockWidth,x=v.blockHeight,g=v.compression,O=this.rasterInfo.storageInfo.pyramidScalingFactor,j=this.rasterInfo,w=j.width,k=j.height,I=j.bandCount,T=[],S="none"===g?1:I;d<this._storageIndex.length;)m++,h=Math.ceil(w/y/Math.pow(O,m)),p=Math.ceil(k/x/Math.pow(O,m)),d+=h*p*S*4,T.push({maxRow:p,maxCol:h,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=T,m>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=m),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,b,y,x,g,O,j,w,k,I,T,S,R,_,C,M,P,F=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=F.length>3&&void 0!==F[3]?F[3]:{},s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.blockBoundary,c=s.compression,!(!(f=u[t])||f.maxRow<r||f.maxCol<n||f.minRow>r||f.minCol>n)){e.next=4;break}return e.abrupt("return",null);case 4:if(h=this.rasterInfo,p=h.bandCount,d=h.pixelType,m=this._getTileLocation(t,r,n),v=m.ranges,b=m.actualTileWidth,y=m.actualTileHeight,v&&0!==v.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==v[0].from||0!==v[0].to){e.next=10;break}return x=new Uint8Array(o*l),e.abrupt("return",new Ve.a({width:o,height:l,pixels:null,mask:x,validPixelCount:0}));case 10:for(g=this.ioConfig.bandIds,O="none"===c?1:p,j=[],w=0,w=0;w<O;w++)(!g||g.indexOf[w]>-1)&&j.push(this.request(this._files.data,{range:{from:v[w].from,to:v[w].to},responseType:"array-buffer",signal:i.signal}));return e.next=15,Promise.all(j);case 15:for(k=e.sent,I=k.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),T=new Uint8Array(I),S=0,w=0;w<O;w++)T.set(new Uint8Array(k[w].data),S),S+=k[w].data.byteLength;return R="lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip",e.next=23,this.decodePixelBlock(T.buffer,{width:o,height:l,format:R,pixelType:d});case 23:if(_=e.sent,C=0,M=0,b!==o||y!==l)if(P=_.mask)for(w=0;w<l;w++)if(M=w*o,w<y)for(C=b;C<o;C++)P[M+C]=0;else for(C=0;C<o;C++)P[M+C]=0;else for(P=new Uint8Array(o*l),_.mask=P,w=0;w<y;w++)for(M=w*o,C=0;C<b;C++)P[M+C]=1;return e.abrupt("return",_);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";var t,r,n,a,i,s;if(Xe.a){for(r=new Uint8Array(e),a=new ArrayBuffer(e.byteLength),n=new Uint8Array(a),i=0;i<e.byteLength/4;i++)for(s=0;s<4;s++)n[4*i+s]=r[4*i+3-s];t=new Uint32Array(a)}else t=new Uint32Array(e);return t}},{key:"_getTileLocation",value:function(e,t,r){var n,a,i,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.pyramidScalingFactor,c=s.compression,f=this.rasterInfo,h=f.width,p=f.height,d=f.bandCount,m="none"===c?1:d,v=0,b=0;for(i=0;i<e;i++)b=Math.pow(u,i),v+=(n=Math.ceil(h/o/b))*(a=Math.ceil(p/l/b));b=Math.pow(u,e),n=Math.ceil(h/o/b),a=Math.ceil(p/l/b),v+=t*n+r,v*=4*m;for(var y=this._storageIndex.subarray(v,v+4*m),x=0,g=0,O=[],j=0;j<m;j++)g=(x=y[4*j+0]*Math.pow(2,32)+y[4*j+1])+y[4*j+2]*Math.pow(2,32)+y[4*j+3],O.push({from:x,to:g});return{ranges:O,actualTileWidth:r<n-1?o:Math.ceil(h/b)-o*(n-1),actualTileHeight:t<a-1?l:Math.ceil(p/b)-l*(a-1)}}},{key:"_parseHeader",value:function(e){var t=_e(e,"MRF_META/Raster");if(!t)throw new v.a("mrf:open","not a valid MRF format");var r=_e(t,"Size"),n=parseInt(r.getAttribute("x"),10),a=parseInt(r.getAttribute("y"),10),i=parseInt(r.getAttribute("c"),10),s=(Ce(t,"Compression")||"none").toLowerCase();if(!s||-1===["none","lerc"].indexOf(s))throw new v.a("mrf:open","currently does not support compression "+s);var o=Ce(t,"DataType")||"UInt8",l=Ye.get(o);if(null==l)throw new v.a("mrf:open","currently does not support pixel type "+o);var u,c,f=_e(t,"PageSize"),h=parseInt(f.getAttribute("x"),10),p=parseInt(f.getAttribute("y"),10),d=_e(t,"DataValues");if(d&&(null!=(c=d.getAttribute("NoData"))&&(u=c.trim().split(" ").map((function(e){return parseFloat(e)})))),_e(e,"MRF_META/CachedSource"))throw new v.a("mrf:open","currently does not support MRF referencing other data files");var m=_e(e,"MRF_META/GeoTags"),b=_e(m,"BoundingBox");if(null==b)throw new v.a("mrf:open","missing node MRF_META/GeoTags/BoundingBox");var y,x=parseFloat(b.getAttribute("minx")),g=parseFloat(b.getAttribute("miny")),O=parseFloat(b.getAttribute("maxx")),j=parseFloat(b.getAttribute("maxy")),w=Ce(m,"Projection")||"",k=Ce(e,"datafile"),I=Ce(e,"IndexFile");if("LOCAL_CS[]"!==w)if(w.toLowerCase().startsWith("epsg:")){var T=Number(w.slice(5));isNaN(T)||0===T||(y=new J.a({wkid:T}))}else y=ze(w);var S=new E.a(x,g,O,j);S.spatialReference=y;var R=_e(e,"MRF_META/Rsets"),_=parseInt(R&&R.getAttribute("scale")||"2",10),C=new K.a({origin:new ie.a({x:S.xmin,y:S.ymax,spatialReference:y}),blockWidth:h,blockHeight:p,pyramidBlockWidth:h,pyramidBlockHeight:p,compression:s,pyramidScalingFactor:_}),M=new ie.a({x:(O-x)/n,y:(j-g)/a,spatialReference:y});return{rasterInfo:new Y.a({width:n,height:a,extent:S,spatialReference:y,bandCount:i,pixelType:l,pixelSize:M,noDataValue:u,storageInfo:C}),files:{mrf:this.url,index:I||this.url.replace(".mrf",".idx"),data:k||this.url.replace(".mrf",Ke.get(s))}}}},{key:"_fetchAuxiliaryData",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null==t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Ae(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(oe);Object(p.a)([Object(g.b)()],$e.prototype,"_files",void 0),Object(p.a)([Object(g.b)()],$e.prototype,"_storageIndex",void 0),Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],$e.prototype,"datasetFormat",void 0);var Qe=$e=Object(p.a)([Object(I.a)("esri.layers.support.rasterIO.MRFRaster")],$e),Ze=r(1223),et=r(1174),tt=function(e,t){var r=e.get(t);return r&&r.values},rt=function(e,t){var r=e.get(t);return r&&r.values[0]},nt=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return Object(l.a)(r,[{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,o,l,u,c,f,h,p,d,m,y,x,g,O,j,w,k,I,T,S,R,_,C,M,P,F,D,z,B,A,L,N,H,q,W,U;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return o=t?Object(b.t)(t.signal):null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:o});case 5:if(l=e.sent,u=l.data){e.next=9;break}throw new v.a("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),c=Object(Ze.h)(u),f=c.littleEndian,h=c.firstIFD,p=c.isBigTiff,d=[],e.next=13,this.readIFDs(d,u,f,h,0,p?8:4,o);case 13:if(m=Object(Ze.f)(d),y=m.width,x=m.height,g=m.tileWidth,O=m.tileHeight,j=m.planes,w=m.pixelType,k=m.compression,I=m.firstPyramidLevel,T=m.maximumPyramidLevel,S=m.pyramidBlockWidth,R=m.pyramidBlockHeight,_=m.tileBoundary,C=m.affine,M=m.metadata,P=(null==(r=m.extent.spatialReference)?void 0:r.wkt)||(null==(n=m.extent.spatialReference)?void 0:n.wkid),F=ze(P),D=!1,null==F&&(D=!0,F=new J.a({wkid:3857})),z=new E.a(Object(s.a)(Object(s.a)({},m.extent),{},{spatialReference:F})),B=new ie.a(z?{x:z.xmin,y:z.ymax,spatialReference:F}:{x:0,y:0}),A=new K.a({blockWidth:g,blockHeight:O,pyramidBlockWidth:S,pyramidBlockHeight:R,compression:k,origin:B,firstPyramidLevel:I,maximumPyramidLevel:T,blockBoundary:_}),L=new ie.a({x:(z.xmax-z.xmin)/y,y:(z.ymax-z.ymin)/x,spatialReference:F}),N=M?{BandProperties:M.bandProperties,DataType:M.dataType}:{},H=new Y.a({width:y,height:x,bandCount:j,pixelType:w,compression:k,pixelSize:L,storageInfo:A,spatialReference:F,isPseudoSpatialReference:D,keyProperties:N,extent:z,statistics:M?M.statistics:null}),null!=C&&C.length&&(H.nativeExtent=new E.a({xmin:-.5,ymin:.5-x,xmax:y-.5,ymax:.5,spatialReference:F}),H.transform=new xe({polynomialOrder:1,forwardCoefficients:[C[2]+C[0]/2,C[5]-C[3]/2,C[0],C[3],-C[1],-C[4]]}),H.extent=H.transform.forwardTransform(H.nativeExtent),H.pixelSize=new ie.a({x:(z.xmax-z.xmin)/y,y:(z.ymax-z.ymin)/x,spatialReference:F}),A.origin.x=-.5,A.origin.y=.5),null!=(i=this.ioConfig.skipExtensions)&&i.includes("aux.xml")){e.next=22;break}return e.next=20,this._fetchAuxiliaryData(t);case 20:null!=(q=e.sent)&&(H.statistics=null!=(W=q.statistics)?W:H.statistics,H.histograms=q.histograms,q.histograms&&!Object(b.k)(H.statistics)&&(H.statistics=Object(ne.f)(q.histograms)),q.transform&&!C&&(H.transform=q.transform,H.nativeExtent=H.extent,U=H.transform.forwardTransform(H.nativeExtent),H.pixelSize=new ie.a({x:(U.xmax-U.xmin)/y,y:(U.ymax-U.ymin)/x,spatialReference:F}),H.extent=U),H.spatialReference||(H.spatialReference=q.spatialReference));case 22:if(this._set("rasterInfo",H),this._headerInfo=Object(s.a)({littleEndian:f,isBigTiff:p,ifds:d},m),this._headerInfo.isSupported){e.next=24;break}throw new v.a("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);case 24:this.updateTileInfo();case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,o,l,u,c,f,h,p,d,m,v,b,y,x,g,O,j,w,k,I,T,S,R,_,C=this,M=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=M.length>3&&void 0!==M[3]?M[3]:{},null!=(s=this._headerInfo)&&s.isSupported&&!this.isBlockOutside(t,r,n)){e.next=3;break}return e.abrupt("return",null);case 3:if(o=this.getTileLocation(t,r,n)){e.next=6;break}return e.abrupt("return",null);case 6:return l=o.ranges,u=o.actualTileWidth,c=o.actualTileHeight,f=o.ifd,h=l.map((function(e){return C.request(C.url,{range:e,responseType:"array-buffer",signal:i.signal})})),e.next=13,Promise.all(h);case 13:if(p=e.sent,d=p.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===p.length?p[0].data:new ArrayBuffer(d),v=[0],b=[0],p.length>1)for(y=new Uint8Array(m),x=0,g=0;x<p.length;x++)O=p[x].data,y.set(new Uint8Array(O),g),v[x]=g,g+=O.byteLength,b[x]=O.byteLength;return j=this.getBlockWidthHeight(t),w=j.blockWidth,k=j.blockHeight,e.next=24,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:v,sizes:b},width:w,height:k,planes:null,pixelType:null});case 24:if(I=e.sent,u!==w||c!==k)if(_=I.mask)for(T=0;T<k;T++)if(R=T*w,T<c)for(S=u;S<w;S++)_[R+S]=0;else for(S=0;S<w;S++)_[R+S]=0;else for(_=new Uint8Array(w*k),I.mask=_,T=0;T<c;T++)for(R=T*w,S=0;S<u;S++)_[R+S]=1;return e.abrupt("return",I);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"readIFDs",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i,s){var o,l,u,c=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=c.length>5&&void 0!==c[5]?c[5]:4,l=c.length>6?c[6]:void 0,i){e.next=4;break}return e.abrupt("return",null);case 4:if(!(i>=r.byteLength||i<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:i+s,to:i+s+this._bufferSize},responseType:"array-buffer",signal:l});case 7:r=e.sent.data,s=i+s,i=0;case 10:return e.next=12,this.readIFD(r,n,i,s,et.a.TIFF_TAGS,o,l);case 12:if(u=e.sent,t.push(u.ifd),u.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this.readIFDs(t,r,n,u.nextIFD-s,s,o,l);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i){return e.apply(this,arguments)}}()},{key:"readIFD",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i){var s,o,l,u,c,f,h,p,d,m,v,b,y,x,g=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=g.length>4&&void 0!==g[4]?g[4]:et.a.TIFF_TAGS,o=g.length>5&&void 0!==g[5]?g[5]:4,l=g.length>6?g[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(u=Object(Ze.c)(t,r,n,i,s,o)).success){e.next=25;break}if(c=[],u.ifd.forEach((function(e){e.values||c.push(e)})),!(c.length>0)){e.next=16;break}if(f=c.map((function(e){return e.offlineOffsetSize})),h=Math.min.apply(null,f.map((function(e){return e[0]}))),!(Math.min.apply(null,f.map((function(e){return e[0]+e[1]})))-h<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:h,to:h+this._bufferSize},responseType:"array-buffer",signal:l});case 13:p=e.sent,d=p.data,t=d,i=h,c.forEach((function(e){return Object(Ze.d)(t,r,e,i)}));case 16:if(!u.ifd.has("GEOKEYDIRECTORY")){e.next=24;break}if(m=u.ifd.get("GEOKEYDIRECTORY"),!((v=m.values)&&v.length>4)){e.next=24;break}return b=v[0]+"."+v[1]+"."+v[2],e.next=22,this.readIFD(t,r,m.valueOffset+6-i,i,et.a.GEO_KEYS,2,l);case 22:y=e.sent,m.data=y.ifd,m.data&&m.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[b]});case 24:return e.abrupt("return",u);case 25:if(!u.requiredBufferSize||u.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:i,to:i+u.requiredBufferSize+4},responseType:"array-buffer",signal:l});case 28:return x=e.sent,e.abrupt("return",(t=x.data).byteLength<u.requiredBufferSize?null:this.readIFD(t,r,0,i,et.a.TIFF_TAGS,4,l));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"getTileLocation",value:function(e,t,r){var n=this.rasterInfo.storageInfo,a=n.firstPyramidLevel,i=n.blockBoundary,s=0===e?0:e-(a-1),o=this._headerInfo.ifds[s];if(!o)return null;var l=Object(Ze.g)(o,this._headerInfo),u=tt(o,"TILEOFFSETS");if(void 0===u)return null;var c=tt(o,"TILEBYTECOUNTS"),f=i[s],h=f.minRow,p=f.minCol,d=f.maxRow,m=f.maxCol;if(t>d||r>m||t<h||r<p)return null;var v=rt(o,"IMAGEWIDTH"),b=rt(o,"IMAGELENGTH"),y=rt(o,"TILEWIDTH"),x=rt(o,"TILELENGTH"),g=l?this.rasterInfo.bandCount:1,O=g*t*(m+1)+r,j=[{from:u[O],to:u[O+g-1]+c[O+g-1]-1}];if(l){for(var w=!0,k=0;k<g;k++)if(u[O+k]+c[O+k]!==u[O+k+1]){w=!1;break}if(!w)for(var I=0;I<g;I++)j[I]={from:u[O+I],to:u[O+I]+c[O+I]-1}}var T=u[O],S=c[O];return null==T||null==S?null:{ranges:j,ifd:o,actualTileWidth:r===m?v%y:y,actualTileHeight:t===d?b%x:x}}},{key:"_fetchAuxiliaryData",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null==t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Ae(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(oe);Object(p.a)([Object(g.b)()],nt.prototype,"_files",void 0),Object(p.a)([Object(g.b)()],nt.prototype,"_headerInfo",void 0),Object(p.a)([Object(g.b)()],nt.prototype,"_bufferSize",void 0),Object(p.a)([Object(g.b)({type:String,json:{write:!0}})],nt.prototype,"datasetFormat",void 0);var at=nt=Object(p.a)([Object(I.a)("esri.layers.support.rasterDatasets.TIFFRaster")],nt),it=new Map;it.set("CRF",{desc:"Cloud Raster Format",constructor:Ie}),it.set("MRF",{desc:"Meta Raster Format",constructor:Qe}),it.set("TIFF",{desc:"GeoTIFF",constructor:at}),it.set("RasterTileServer",{desc:"Raster Tile Server",constructor:Ge}),it.set("JPG",{desc:"JPG Raster Format",constructor:Ne}),it.set("PNG",{desc:"PNG Raster Format",constructor:Ne}),it.set("GIF",{desc:"GIF Raster Format",constructor:Ne}),it.set("BMP",{desc:"BMP Raster Format",constructor:Ne});var st=function(){function e(){Object(o.a)(this,e)}return Object(l.a)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return it.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,o,l,u,c,f,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,n=t.ioConfig,i=t.sourceJSON,null==(s=t.datasetFormat)&&r.lastIndexOf(".")&&(s=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===s||"TIF"===s?s="TIFF":"JPG"!==s&&"JPEG"!==s&&"JFIF"!==s||(s="JPG"),r.toLowerCase().indexOf("/imageserver")>-1&&-1===r.toLowerCase().indexOf("/wcsserver")&&(s="RasterTileServer"),o={url:r,sourceJSON:i,datasetFormat:s,ioConfig:n||{bandIds:null,sampling:null}},!this.supportedFormats.has(s)){e.next=10;break}return l=it.get(s).constructor,u=new l(o),e.next=9,u.open({signal:t.signal});case 9:return e.abrupt("return",u);case 10:if(!s){e.next=12;break}throw new v.a("rasterfactory:open","not a supported format "+s);case 12:return c=Array.from(it.keys()),f=0,h=function e(){return(s=c[f++])?(l=it.get(s).constructor,(u=new l(o)).open({signal:t.signal}).then((function(){return u})).catch((function(){return e()}))):null},e.abrupt("return",h());case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){it.has(e.toUpperCase())||it.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}(),ot=r(701),lt=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;Object(o.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.title=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e}return Object(l.a)(r,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?Object(s.a)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=Object(b.k)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(x.w).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e,t,r=[new V.a({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})],n=null==(e=this.rasterInfo)||null==(t=e.attributeTable)?void 0:t.fields;if(n){var a=n.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));r=r.concat(a)}var i=this.rasterInfo.dataType;if(("vector-magdir"===i||"vector-uv"===i)&&Object(b.k)(this.rasterInfo.multidimensionalInfo)){var s,o=null==(s=this.rasterInfo.multidimensionalInfo.variables[0].unit)?void 0:s.trim(),l="Magnitude"+(o?" (".concat(o,")"):"");r.push(new V.a({name:"Raster.Magnitude",alias:l,domain:null,editable:!1,type:"double"})),r.push(new V.a({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return r}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"readRenderer",value:function(e,t,r){var n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,a=Object(m.b)(n,r)||void 0;if(null!=a)return a}},{key:"createPopupTemplate",value:function(e){return Object(ot.a)({fields:this.rasterFields,title:this.title},e)}},{key:"write",value:function(e,t){var n=this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return Object(u.a)(Object(c.a)(r.prototype),"write",this).call(this,e,t);if(t&&t.messages){var a="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new v.a("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(a,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.raster){e.next=8;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=5;break}return e.next=5,this.raster.open();case 5:this.url=this.raster.url,e.next=11;break;case 8:return e.next=10,st.open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:Object(s.a)(Object(s.a)({sampling:"closest"},this.ioConfig),{},{customFetchParameters:this.customParameters}),signal:t});case 10:this.raster=e.sent;case 11:if(this.raster.rasterInfo){e.next=14;break}throw new v.a("imagery-tile-layer:load","cannot load resources on "+this.url);case 14:this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(this._set("version",this.sourceJSON.currentVersion),this._set("copyright",this.sourceJSON.copyrightText)),null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.watch("customParameters",(function(e){return r.raster.ioConfig.customFetchParameters=e}));case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(Object(S.a)(Object(G.a)(Object(q.a)(Object(W.a)(Object(R.a)(function(e){var t=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments))._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},e.bandIds=null,e.copyright=null,e.fullExtent=null,e.interpolation="nearest",e.raster=null,e.rasterInfo=null,e.sourceJSON=null,e.spatialReference=null,e.tileInfo=null,e.symbolizer=null,e}return Object(l.a)(r,[{key:"multidimensionalDefinition",set:function(e){this.raster&&(this._sliceId=this.raster.getSliceIndex(e)),this._set("multidimensionalDefinition",e)}},{key:"url",set:function(e){this._set("url",Object(P.h)(e,H))}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"convertVectorFieldData",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(b.j)(t)){e.next=2;break}return e.abrupt("return",null);case 2:return n=this._rasterJobHandler.instance,i=this.rasterInfo.dataType,e.abrupt("return",n?n.convertVectorFieldData({pixelBlock:t,dataType:i},r):Object(A.a)(t,i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateRenderer",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loaded){e.next=2;break}return e.abrupt("return");case 2:if(JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer)){e.next=4;break}return e.abrupt("return");case 4:if(t=this._rasterJobHandler.instance,e.t0=t,!e.t0){e.next=12;break}return this.symbolizer.rendererJSON=Object(L.e)(this.renderer.toJSON()),this.symbolizer.bind(),e.next=11,t.updateSymbolizer(this.symbolizer);case 11:this._cachedRendererJson=this.renderer.toJSON();case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,o,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t&&t.pixelBlock,Object(b.k)(n)&&n.pixels&&n.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(o=this._rasterJobHandler.instance,l=this.bandIds,!o){e.next=12;break}return e.next=9,o.symbolize(Object(s.a)(Object(s.a)({},t),{},{simpleStretchParams:r,bandIds:l}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize(Object(s.a)(Object(s.a)({},t),{},{simpleStretchParams:r,bandIds:l}));case 13:return i=e.t0,e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded)return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=Object(M.e)(e);return B.a.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,o,l,u,c=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=c.length>3&&void 0!==c[3]?c[3]:{}).requestAsImageElement){e.next=4;break}return o=this.getTileUrl(t,r,n),e.abrupt("return",Object(_.default)(o,{responseType:"image",query:Object(s.a)(Object(s.a)({sliceId:this._sliceId},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:i.signal}).then((function(e){return e.data})));case 4:return e.next=6,this._initJobHandler();case 6:return l="raster-shaded-relief"===this.renderer.type?{cols:1,rows:1}:null,this.multidimensionalDefinition&&(u=this._sliceId,i=Object(s.a)({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:u,buffer:l},i)),e.abrupt("return",this.raster.fetchTile(t,r,n,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i){var o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initJobHandler();case 2:if(!this.multidimensionalDefinition){e.next=5;break}o=this._sliceId,i=Object(s.a)({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:o},i);case 5:return e.abrupt("return",this.raster.fetchPixels(t,r,n,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"identify",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.multidimensionalDefinition&&!t.multidimensionalDefinition&&(t=Object(s.a)(Object(s.a)({},t),{},{multidimensionalDefinition:this.multidimensionalDefinition})),this.raster.identify(e,t)}},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t=this.rasterInfo.multidimensionalInfo;if(!Object(b.k)(t)||"standard-time"!==this.rasterInfo.dataType)return!1;var r=null==(e=this.multidimensionalDefinition[0])?void 0:e.variableName;return t.variables.some((function(e){return e.name===r&&e.dimensions.some((function(e){return"StdTime"===e.name}))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this._configDefaultSlice(),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new z.a;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer()})).catch((function(){return null})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e,t=Object(L.c)(this.rasterInfo,this.raster.tileType,null==(e=this.sourceJSON)?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}},{key:"_configDefaultSlice",value:function(){var e=this.raster.rasterInfo.multidimensionalInfo;if(Object(b.k)(e)){if(!this.multidimensionalDefinition){var t=e.variables[0],r=[];t.dimensions.forEach((function(e){r.push(new D.a({variableName:t.name,dimensionName:e.name,values:e.hasRegularIntervals?e.extent[0]:e.values[0],isSlice:!0}))})),this.multidimensionalDefinition=r}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}}},{key:"_configDefaultRenderer",value:function(){var e,t,r=this.raster.rasterInfo;this.bandIds||(this.bandIds=Object(L.b)(r)),this.renderer||(this.renderer=Object(L.a)(r,{bandIds:this.bandIds,variableName:null==(e=this.multidimensionalDefinition)||null==(t=e[0])?void 0:t.variableName})),this.symbolizer?(this.symbolizer.rendererJSON=Object(L.e)(this.renderer.toJSON()),this.symbolizer.rasterInfo=r):this.symbolizer=new N.a({rendererJSON:this.renderer.toJSON(),rasterInfo:r}),this.symbolizer.bind()||H.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")}}]),r}(e);return Object(p.a)([Object(g.b)()],t.prototype,"_cachedRendererJson",void 0),Object(p.a)([Object(g.b)()],t.prototype,"_sliceId",void 0),Object(p.a)([Object(g.b)()],t.prototype,"_compatibleFullExtent",void 0),Object(p.a)([Object(g.b)()],t.prototype,"_rasterJobHandler",void 0),Object(p.a)([Object(g.b)()],t.prototype,"bandIds",void 0),Object(p.a)([Object(g.b)()],t.prototype,"copyright",void 0),Object(p.a)([Object(g.b)({type:E.a}),Object(C.a)("rasterInfo.extent")],t.prototype,"fullExtent",void 0),Object(p.a)([Object(g.b)()],t.prototype,"interpolation",void 0),Object(p.a)([Object(g.b)()],t.prototype,"ioConfig",void 0),Object(p.a)([Object(g.b)({type:[D.a]})],t.prototype,"multidimensionalDefinition",null),Object(p.a)([Object(g.b)()],t.prototype,"raster",void 0),Object(p.a)([Object(g.b)({readOnly:!0}),Object(C.a)("raster.rasterInfo")],t.prototype,"rasterInfo",void 0),Object(p.a)([Object(g.b)()],t.prototype,"sourceJSON",void 0),Object(p.a)([Object(g.b)({type:J.a}),Object(C.a)("rasterInfo.spatialReference")],t.prototype,"spatialReference",void 0),Object(p.a)([Object(g.b)({type:B.a}),Object(C.a)("rasterInfo.storageInfo.tileInfo")],t.prototype,"tileInfo",void 0),Object(p.a)([Object(g.b)(F.n)],t.prototype,"url",null),Object(p.a)([Object(g.b)({types:m.a})],t.prototype,"renderer",null),Object(p.a)([Object(g.b)()],t.prototype,"symbolizer",void 0),t=Object(p.a)([Object(I.a)("esri.layers.ImageryTileMixin")],t),t}(Object(U.a)(Object(y.a)(T.a)))))))));Object(p.a)([Object(g.b)({type:[O.a],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null==(e=this.bandIds)?void 0:e.join(","))}}}}})],lt.prototype,"bandIds",void 0),Object(p.a)([Object(g.b)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),Object(w.a)(X.a)],lt.prototype,"interpolation",void 0),Object(p.a)([Object(g.b)({json:{write:!0}})],lt.prototype,"multidimensionalDefinition",void 0),Object(p.a)([Object(g.b)(F.e)],lt.prototype,"legendEnabled",void 0),Object(p.a)([Object(g.b)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],lt.prototype,"isReference",void 0),Object(p.a)([Object(g.b)({type:["show","hide"]})],lt.prototype,"listMode",void 0),Object(p.a)([Object(g.b)()],lt.prototype,"sourceJSON",void 0),Object(p.a)([Object(g.b)({readOnly:!0})],lt.prototype,"version",void 0),Object(p.a)([Object(g.b)()],lt.prototype,"title",void 0),Object(p.a)([Object(g.b)({readOnly:!0,json:{read:!1}})],lt.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:["ArcGISTiledImageServiceLayer"]})],lt.prototype,"operationalLayerType",void 0),Object(p.a)([Object(g.b)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],lt.prototype,"popupEnabled",void 0),Object(p.a)([Object(g.b)({type:d.a,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],lt.prototype,"popupTemplate",void 0),Object(p.a)([Object(g.b)({readOnly:!0})],lt.prototype,"defaultPopupTemplate",null),Object(p.a)([Object(g.b)({readOnly:!0,type:[V.a]})],lt.prototype,"fields",void 0),Object(p.a)([Object(g.b)({readOnly:!0,type:[V.a]})],lt.prototype,"rasterFields",null),Object(p.a)([Object(g.b)({types:m.a,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null==(e=this.renderer)?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:m.c,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type}}}}}}})],lt.prototype,"renderer",null),Object(p.a)([Object(k.a)("renderer")],lt.prototype,"readRenderer",null);var ut=lt=Object(p.a)([Object(I.a)("esri.layers.ImageryTileLayer")],lt)},971:function(e,t,r){"use strict";r.d(t,"a",(function(){return P}));var n,a=r(8),i=r.n(a),s=r(15),o=r(14),l=r(3),u=r(4),c=r(6),f=r(7),h=r(0),p=r(69),d=r(32),m=r(20),v=r(55),b=r(16),y=r(698),x=r(75),g=r(23),O=r(141),j=r(34),w=r(27),k=r(1),I=(r(17),r(60)),T=r(9),S=r(102),R=r(26),_=function(){function e(){Object(l.a)(this,e),this.location={left:0,top:0,width:0,height:0},this._allAvailability="unknown",this.byteSize=40}return Object(u.a)(e,[{key:"getAvailability",value:function(e,t){if("unknown"!==this._allAvailability)return this._allAvailability;var r=(e-this.location.top)*this.location.width+(t-this.location.left),n=r%8,a=r>>3,i=this._tileAvailabilityBitSet;return a<0||a>i.length?"unknown":i[a]&1<<n?"available":"unavailable"}},{key:"_updateFromData",value:function(e){for(var t=this.location.width,r=this.location.height,n=!0,a=!0,i=Math.ceil(t*r/8),s=new Uint8Array(i),o=0,l=0;l<e.length;l++){var u=l%8;e[l]?(a=!1,s[o]|=1<<u):n=!1,7===u&&++o}a?this._allAvailability="unavailable":n?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=s,this.byteSize+=s.length)}}],[{key:"fromDefinition",value:function(t,r){var n=t.service.request||p.default,a=t.row,i=t.col,s=t.width,l=t.height,u={query:{f:"json"}};return r=r?Object(o.a)(Object(o.a)({},u),r):u,n(function(e){var t;if("vector-tile"===e.service.type)t="".concat(e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height);else{var r=e.service.tileServers;t="".concat(r&&r.length?r[e.row%r.length]:e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var n=e.service.query;return n&&(t="".concat(t,"?").concat(n)),t}(t),r).then((function(e){return e.data})).catch((function(e){if(e&&e.details&&422===e.details.httpStatus)return{location:{top:a,left:i,width:s,height:l},valid:!0,data:Object(S.c)(s*l,0)};throw e})).then((function(t){if(t.location&&(t.location.top!==a||t.location.left!==i||t.location.width!==s||t.location.height!==l))throw new m.a("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:a,left:i,width:s,height:l}});return e.fromJSON(t)}))}},{key:"fromJSON",value:function(t){e.validateJSON(t);var r=new e;return r.location=Object.freeze(Object(R.a)(t.location)),r._updateFromData(t.data),Object.freeze(r)}},{key:"validateJSON",value:function(e){if(!e||!e.location)throw new m.a("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new m.a("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new m.a("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new m.a("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new m.a("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}]),e}();function C(e){return"".concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var M=b.a.getLogger("esri.layers.support.TilemapCache"),P=n=function(e){Object(c.a)(r,e);var t=Object(f.a)(r);function r(e){var n;return Object(l.a)(this,r),(n=t.call(this,e))._handles=new v.a,n._pendingTilemapRequests={},n._availableLevels={},n.levels=5,n.cacheByteSize=2097152,n.request=p.default,n._prefetchingEnabled=!0,n}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this;this._tilemapCache=new y.a(this.cacheByteSize),this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],(function(){return e._initializeTilemapDefinition()})),Object(w.a)(this,"layer.tileInfo.lods",(function(t){return e._initializeAvailableLevels(t)}),!0)]),this._initializeTilemapDefinition()}},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null)}},{key:"castLevels",value:function(e){return e<=2?(M.error("Minimum levels for Tilemap is 3, but got ",e),3):e}},{key:"size",get:function(){return 1<<this.levels}},{key:"fetchTilemap",value:function(e,t,r,n){var a=this;if(!this._availableLevels[e])return Promise.reject(new m.a("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")));var i=this._tmpTilemapDefinition,s=this._tilemapFromCache(e,t,r,i);if(s)return Promise.resolve(s);var l=n&&n.signal;return n=Object(o.a)(Object(o.a)({},n),{},{signal:null}),new Promise((function(e,t){Object(g.s)(l,(function(){return t(Object(g.f)())}));var r=C(i),s=a._pendingTilemapRequests[r];if(!s){s=_.fromDefinition(i,n).then((function(e){return a._tilemapCache.put(r,e,e.byteSize),e}));var o=function(){return delete a._pendingTilemapRequests[r]};a._pendingTilemapRequests[r]=s,s.then(o,o)}s.then(e,t)}))}},{key:"getAvailability",value:function(e,t,r){if(!this._availableLevels[e])return"unavailable";var n=this._tilemapFromCache(e,t,r,this._tmpTilemapDefinition);return n?n.getAvailability(t,r):"unknown"}},{key:"getAvailabilityUpsample",value:function(e,t,r,n){n.level=e,n.row=t,n.col=r;var a=this.layer.tileInfo;for(a.updateTileInfo(n);;){var i=this.getAvailability(n.level,n.row,n.col);if("unavailable"!==i)return i;if(!a.upsampleTile(n))return"unavailable"}}},{key:"fetchAvailability",value:function(e,t,r,n){return this._availableLevels[e]?this.fetchTilemap(e,t,r,n).catch((function(e){return e})).then((function(n){if(n instanceof _){var a=n.getAvailability(t,r);return"unavailable"===a?Promise.reject(new m.a("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r})):a}if(Object(g.n)(n))throw n;return"unknown"})):Promise.reject(new m.a("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")))}},{key:"fetchAvailabilityUpsample",value:function(e,t,r,n,a){var i=this;n.level=e,n.row=t,n.col=r;var s=this.layer.tileInfo;s.updateTileInfo(n);var o=this.fetchAvailability(e,t,r,a).catch((function(e){if(Object(g.n)(e))throw e;if(s.upsampleTile(n))return i.fetchAvailabilityUpsample(n.level,n.row,n.col,n);throw e}));return this._fetchAvailabilityUpsamplePrefetch(n.id,e,t,r,a,o),o}},{key:"_fetchAvailabilityUpsamplePrefetch",value:function(){var e=Object(s.a)(i.a.mark((function e(t,r,a,s,l,u){var c,f,h,p,d,m,v,b,y,x=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._prefetchingEnabled){e.next=2;break}return e.abrupt("return");case 2:if(c="prefetch-".concat(t),!this._handles.has(c)){e.next=5;break}return e.abrupt("return");case 5:return f=Object(g.e)(),u.then((function(){return f.abort()}),(function(){return f.abort()})),h=!1,p={remove:function(){h||(h=!0,f.abort())}},this._handles.add(p,c),e.next=12,Object(O.d)(10,f.signal).catch((function(){}));case 12:if(h||(h=!0,this._handles.remove(c)),!Object(g.o)(f)){e.next=15;break}return e.abrupt("return");case 15:for(d={id:t,level:r,row:a,col:s},m=Object(o.a)(Object(o.a)({},l),{},{signal:f.signal}),v=this.layer.tileInfo,b=function(e){var t=x.fetchAvailability(d.level,d.row,d.col,m);n._prefetches.push(t);var r=function(){n._prefetches.removeUnordered(t)};t.then(r,r)},y=0;n._prefetches.length<n._maxPrefetch&&v.upsampleTile(d);++y)b();case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,i,s){return e.apply(this,arguments)}}()},{key:"_initializeTilemapDefinition",value:function(){if(this.layer.parsedUrl){var e=this.layer.parsedUrl,t=e.query;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:t?Object(j.E)(t):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}}},{key:"_tilemapFromCache",value:function(e,t,r,n){n.level=e,n.row=t-t%this.size,n.col=r-r%this.size;var a=C(n);return this._tilemapCache.get(a)}},{key:"_initializeAvailableLevels",value:function(e){var t=this;this._availableLevels={},e&&e.forEach((function(e){return t._availableLevels[e.level]=!0}))}},{key:"test",get:function(){var e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:function(t,r,n){return!!e._tilemapFromCache(t,r,n,e._tmpTilemapDefinition)}}}}]),r}(d.a);P._maxPrefetch=4,P._prefetches=new x.a({initialSize:n._maxPrefetch}),Object(h.a)([Object(k.b)({constructOnly:!0,type:Number})],P.prototype,"levels",void 0),Object(h.a)([Object(I.a)("levels")],P.prototype,"castLevels",null),Object(h.a)([Object(k.b)({readOnly:!0,type:Number})],P.prototype,"size",null),Object(h.a)([Object(k.b)({constructOnly:!0,type:Number})],P.prototype,"cacheByteSize",void 0),Object(h.a)([Object(k.b)({constructOnly:!0})],P.prototype,"layer",void 0),Object(h.a)([Object(k.b)({constructOnly:!0})],P.prototype,"request",void 0),P=n=Object(h.a)([Object(T.a)("esri.layers.support.TilemapCache")],P)}}]);
//# sourceMappingURL=94.149b8c17.chunk.js.map