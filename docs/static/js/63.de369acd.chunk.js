(this.webpackJsonpgeowebmap=this.webpackJsonpgeowebmap||[]).push([[63,221],{1023:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r,n=i(3),a=i(4),s=i(6),o=i(7),c=i(0),l=(i(112),i(25)),u=i(26),d=i(218),h=i(1),f=(i(18),i(17),i(16),i(9)),b=i(43),v=i(999),y=i(53),p=i(147),g=r=function(e){Object(s.a)(i,e);var t=Object(o.a)(i);function i(e){var r;return Object(n.a)(this,i),(r=t.call(this,e)).geometry=null,r.type="clip",r}return Object(a.a)(i,[{key:"writeGeometry",value:function(e,t,i,r){if(r.layer&&r.layer.spatialReference&&!r.layer.spatialReference.equals(this.geometry.spatialReference)){if(!Object(y.b)(e.spatialReference,r.layer.spatialReference))return void(r&&r.messages&&r.messages.push(new d.a("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:r.layer.spatialReference,context:r})));var n=new p.a;Object(y.w)(e,n,r.layer.spatialReference),t[i]=n.toJSON(r)}else t[i]=e.toJSON(r);delete t[i].spatialReference}},{key:"clone",value:function(){return new r({geometry:Object(u.a)(this.geometry),type:this.type})}}]),i}(l.a);Object(c.a)([Object(h.b)({type:p.a}),Object(v.a)()],g.prototype,"geometry",void 0),Object(c.a)([Object(b.a)(["web-scene","portal-item"],"geometry")],g.prototype,"writeGeometry",null),Object(c.a)([Object(h.b)({type:["clip","mask","replace"],nonNullable:!0}),Object(v.a)()],g.prototype,"type",void 0);var m=g=r=Object(c.a)([Object(f.a)("esri.layers.support.SceneModification")],g)},1024:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(35),n=i(12),a=i(3),s=i(4),o=i(6),c=i(7),l=i(80),u=i(123),d=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(a.a)(this,i),(e=t.apply(this,arguments))._map=new Map,e}return Object(s.a)(i,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,i=0;i<e.length;i++){var r=e[i],n=r.objectId,a=this._map.get(n);a?(t.add(n),r!==a&&(e[i]=a),++a.refCount):(r.refCount=1,this._map.set(n,r))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),i.push(a))}}catch(c){r.e(c)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"removeManyByObjectId",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),i.push(s))}}catch(o){r.e(o)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"toArray",value:function(){return Object(r.a)(this._map.values())}},{key:"find",value:function(e){var t;return Object(u.c)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),i}(l.a)},1025:function(e,t,i){"use strict";i.d(t,"a",(function(){return Ve}));var r=i(35),n=i(31),a=i(3),s=i(4),o=i(6),c=i(7),l=i(0),u=i(32),d=i(55),h=i(17),f=i(16),b=i(2),v=i(75),y=i(202),p=i(23),g=i(27),m=i(1),_=(i(18),i(9)),O=i(53),j=i(38),x=i(45),k=i(208),w=i(715),I=i(12),C=i(102),S=i(104),N=function(){function e(t){Object(a.a)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(S.b.I3S_CONTROLLER,this)}return Object(s.a)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=Object(I.a)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(i){t.e(i)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this.sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}},{key:"sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){Object(C.m)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}]),e}(),F=new Map;function M(e,t){var i=F.get(e);return null==i&&(i=new N(e),F.set(e,i)),i.add(t),{remove:function(){null!=i&&(i.remove(t),i.callbacks.length>0||(F.delete(e),i.destroy()),i=null)}}}var E=i(5),D=i(50),P=function e(t,i){Object(a.a)(this,e),this.id=t,this.mbs=i,this.renderMbs=Object(D.d)([0,0,0,-1]),this.imModificationImpact=4},R=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(e,r,n,s,o,c,l,u,d,h){var f;return Object(a.a)(this,i),(f=t.call(this,e,n)).index=r,f.childCount=s,f.level=o,f.resources=c,f.version=l,f.lodMetric=u,f.maxError=d,f.numFeatures=h,f.failed=!1,f.hasModifications=!1,f.cacheState=0,f.vertexCount=0,f.memory=0,f}return i}(P),A=function e(t,i,r,n){Object(a.a)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=r,this.version=n},L=i(910),V=i(445),T=function e(t,i,r,n,s){Object(a.a)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=r,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=2},U=function(){function e(t,i,r,n,s,o,c,l,u,d,h,f,b,y){Object(a.a)(this,e),this.streamDataController=r,this.viewportQueries=n,this.logger=s,this.holeFilling=o,this._isLoaded=c,this._isReloading=l,this._isSelected=u,this._enable=d,this._needsUpdate=h,this._canRequest=f,this._computeVisibilityObb=b,this._computeNodeFiltering=y,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=z(0),this._visibilityCacheVersion=z(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new v.a({deallocator:null}),this._prefetch=new v.a({deallocator:null}),this._updates=new H,this._imModificationUncategorized=new v.a({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(i)}return Object(s.a)(e,[{key:"init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=$}this.addPage(J(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new P(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}},{key:"loadPage",value:function(e){var t=this;this._loading.add(e);var i=this.urlPrefix+e;this.streamDataController.request(i,"json").then((function(i){t._loading.delete(e),t.addPage(e,i)})).catch((function(i){t._loading.delete(e),Object(p.n)(i)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),i))}))}},{key:"addPage",value:function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],a=[],s=t.nodes.map((function(t,r){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var c=0;c<o;c++)n.push(t.children[c]);var l="".concat(t.index),u=Object(V.b)(t.obb),d=Object(D.d)([u.center[0],u.center[1],u.center[2],Object(E.r)(u.halfSize)]),h=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,v={hasSharedResource:!1,hasFeatureData:!!f,attributes:h&&null!=h.resource?"".concat(h.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:b&&null!=b.resource?"".concat(b.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:b?b.definition:-1},y=new R(l,e*i.nodesPerPage+r,d,o,0,v,i.lastUpdate,i.lodMetric,i.lodConversion(t.lodThreshold),f?f.featureCount:null);return y.serviceObb=u,y.visibilityObb=i._computeVisibilityObb(y),y.vertexCount=f?f.vertexCount:0,new T(s,o,B(i._visibilityCacheVersion),null,y)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length,this.updateParentsAndLevel()}},{key:"updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,r,n){var a=e.getPage(i);if(Object(b.k)(a)){var s=Y(i,e.nodesPerPage);a.parents[s]=r;var o=a.nodes[s].node;Object(b.k)(o)&&(o.level=n,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var r=t.pop(),n=this.getNode(r);if(Object(b.k)(n))for(var a=0;a<n.childCount;a++)i(this.getChildIndex(n,a),r,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"getPage",value:function(e){return this._nodePages[J(e,this.nodesPerPage)]}},{key:"getNodeInternal",value:function(e){var t=this.getPage(e);return Object(b.j)(t)?null:t.nodes[Y(e,this.nodesPerPage)]}},{key:"addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),r=Object(b.k)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);var n=function(e){if(e)for(var t=0;t<e.length;t++){var i,r=Object(I.a)(Z);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){r.e(a)}finally{r.f()}}return{lodMetric:0,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=Object(b.t)(this.getNodeInternal(t));return o.node=new R(e.id,t,Object(D.d)(e.mbs),o.childCount,r,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=Object(V.b)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),Object(b.k)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"makeRefNode",value:function(e,t){var i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new T(0,0,B(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,Object(b.k)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),r}},{key:"populateChildren",value:function(e,t){var i=Object(b.t)(this.getNodeInternal(e)),r=Object(b.t)(this.getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(var n=0;n<t.length;n++){var a=this.makeRefNode(t[n],e);r.children.push(a)}}},{key:"getNode",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this.forAllNodes((function(i,r){(Object(b.k)(i.node)&&i.node.id===e||Object(b.k)(i.ref)&&i.ref.id===e)&&(t=r)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this.getPage(e.index);if(Object(b.j)(i))return-1;var r=i.nodes[Y(e.index,this.nodesPerPage)];return i.children[r.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this.getPage(e);return Object(b.k)(t)?t.parents[Y(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=z(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=B(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&(q(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"invalidateGeometryVisibility",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&Object(b.k)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,Object(b.k)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;Object(b.j)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"isNodeVisible",value:function(e){var t=this.getNodeInternal(e);if(Object(b.j)(t)||Object(b.k)(t.ref)&&!t.ref.mbs)return!0;if(!W(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,r=Object(b.k)(i)&&(Object(b.j)(t.ref)||Object(b.k)(i.visibilityObb))?i:Object(b.k)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(Object(b.k)(i)||Object(b.k)(t.ref))&&2===t.filterImpact){var n=Object(b.k)(i)?i.mbs:Object(b.k)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):0}var a=Object(b.k)(i)&&1===t.filterImpact,s=!(Object(b.k)(i)&&2===i.imModificationImpact)&&(!r||this.viewportQueries.isNodeVisible(r))&&!a;return t.visibilityCache=Q(s,this._visibilityCacheVersion),s}return K(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(Object(b.k)(t)&&Object(b.k)(t.node)&&Object(b.k)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,r,n){var a=this.getPage(e);if(!Object(b.j)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,c=t.childOffset;c<s;++c){var l=a.children[c],u=this.getNodeInternal(l);Object(b.k)(u)&&Object(b.k)(u.node)&&this.isGeometryVisible(l)&&o.push(u)}r/=o.length;for(var d=0,h=o;d<h.length;d++){var f=h[d],v=Object(b.t)(f.node).index;this._isLoaded(v)||this._isReloading(v)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(v,f,i+1,r,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(Object(b.j)(t))return!1;if("always"===this.holeFilling)return!0;if(W(t.useAsHole,this._version))return K(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var r=i.delta*i.coverage<=.5;return t.useAsHole=Q(r,this._version),r}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=z(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var i=e.node;Object(b.k)(i)&&(i.imModificationImpact=4,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this.forAllNodes((function(e){if(Object(b.k)(e)){e.filterImpact=2;var i=e.node;Object(b.k)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var r=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),G.clear();var n=!0,a=new X,s=new X,o=this._imModificationUncategorized;o.clear();var c=new Set;this.traverseVisible((function(l,u,d){if(Object(b.j)(u)){var h=r.entryPriority(l);h===1/0&&(h=r.entryPriority(d));var f=J(l,r.nodesPerPage);return G.set(f,Math.max(h,G.get(f)||0)),r._loading.has(f)||r._failedPages.has(f)||r._missing.push(f),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,h))}var v=u.node;if(r._updateNodeFeatureEstimate(v,s),Object(b.j)(v)){var y=r.entryPriority(l);return r._loading.has(l)||r._failedNodes.has(l)||(r._missing.push(l),G.set(l,y)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,y))}var p=Object(b.t)(r.getPage(l));if(0===r._missing.length&&0===r.nodesPerPage)for(var g=0;g<u.childCount;g++){var m=p.children[u.childOffset+g],_=r.getNodeInternal(m);!Object(b.k)(_)||_.node||r._loading.has(m)||r._failedNodes.has(m)||(G.set(m,r.entryPriority(m)),r._prefetch.push(m))}if(!v.failed&&v.resources.hasFeatureData)if(c.add(v.id),r._isLoaded(l)){if(a.known+=v.memory,++a.knownNodes,r._isSelected(v)?u.childCount>0&&(n=!1):(a.unremoved+=v.memory,n=!1),r._needsUpdate(v)){var O=r.entryPriority(l);G.set(l,O),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,O),r._updates.update.push(l)}}else if(v.memory&&(a.known+=v.memory,++a.knownNodes),r._isSelected(v)){if(u.childCount>0&&(n=!1),v.memory?(a.missing+=v.memory,a.known+=v.memory,++a.knownNodes):++a.missingNodes,e.indexOf(v.index)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(l)),void(r._updates.cancel=r._updates.cancel.filter((function(e){return e!==v.index})));if(t.done||!r._enable(v)){var j=r.entryPriority(l);G.set(l,j),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,j),r._updates.add.push(l),r.layerHasModifications&&i&&Object(b.k)(v)&&4===v.imModificationImpact&&o.push(l)}else t.madeProgress()}else r._isReloading(l)&&r._updates.remove.push(l)}));var l=this._updates.add;l.length>0&&this.layerHasModifications&&(o.length>0&&i(o),l.filterInPlace((function(e){var t=r.getNodeInternal(e),i=Object(b.j)(t)||Object(b.j)(t.node)||2!==t.node.imModificationImpact;return i||r.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||r._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return G.get(e)-G.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=G.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return G.get(e)>=r._maxUnloadedPrio})).sort((function(e,t){return G.get(e)-G.get(t)})),this._updates.update.sort((function(e,t){return G.get(e)-G.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,G.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,s=10;s--;){var o=new X;if(this._updateFeatureEstimate(r,o),this._computeFeatureEstimate(o)<=e){if(r>=t||o.missingNodes>0||0===s)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate(Object(b.k)(r)&&r.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!(Object(b.j)(e)||e.failed||Object(b.j)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(Object(b.k)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return G.get(e)-G.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if(Object(b.j)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&W(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&i>s.lodLevel}else n=i>0}else n=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=n,t.version=Q(!0,this._version),t):(t=new A(r,n,i,Q(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=Object(b.t)(this.getNodeInternal(e)).ref;if(Object(b.j)(i))this._failedNodes.add(e);else{var r=i.id,n=this.urlPrefix+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(i){a();var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t.addNode(n,e);t.nodeTraversalState(s)}}),(function(i){a(),Object(p.n)(i)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("#validateNode()",i.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)r("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i.logger.error("#validateNode()",i.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new P("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){Object(b.k)(e.node)&&(e.node.failed=!1)}))}},{key:"entryPriority",value:function(e){var t=this.getNodeInternal(e),i=this.getParentIndex(e);if(Object(b.j)(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);var r=0;if(t.node&&i>=0){var n=this._nodeTraversalState.get(i);null!=n&&(r=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=Object(b.k)(t.ref)?this.viewportQueries.distToPOI(t.ref):Object(b.k)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-r*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this.getNodeInternal(this.rootIndex);Object(b.j)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,r){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&r(e,i,t);else if(this.isNodeVisible(e)&&(r(e,i,t),null!=i.node)){var n=this.nodeTraversalState(i.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=Object(b.t)(this.getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],c=this.getNodeInternal(o);Object(b.k)(c)?this._traverseVisible(o,e,c,r):r(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,r=this.getNodeInternal(i);Object(b.k)(r)&&this._traverseChildren(i,r,t)}},{key:"_traverseChildren",value:function(e,t,i){var r=this.getPage(e);if(!Object(b.j)(r))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=r.children[a],o=this.getNodeInternal(s);Object(b.k)(o)&&Object(b.k)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e){this.forAllNodes(q),this.viewportQueries.updateElevationInfo(e)}},{key:"forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e.addNode(t,i)}}}}]),e}(),G=new Map,H=function(){function e(){Object(a.a)(this,e),this.update=new v.a({deallocator:null}),this.add=new v.a({deallocator:null}),this.remove=new v.a({deallocator:null}),this.cancel=[]}return Object(s.a)(e,[{key:"reset",value:function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}]),e}();function q(e){Object(b.k)(e.node)&&(e.node.renderMbs[3]=-1,Object(b.k)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),Object(b.k)(e.ref)&&(e.ref.renderMbs[3]=-1,Object(b.k)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function B(e){return Object(L.a)(e,-2)}function z(e){return Object(L.a)(e,2)}function Q(e,t){return t+(e?1:0)}function W(e,t){return(-2&e)===t}function K(e){return 1==(1&e)}function J(e,t){return 0===t?0:e/t|0}function Y(e,t){return 0===t?e:e%t}var Z=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];var X=function e(){Object(a.a)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function $(e){return Math.sqrt(e*(4/Math.PI))}var ee=function(){function e(t){Object(a.a)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return Object(s.a)(e,[{key:"startNodeLoading",value:function(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if(Object(b.j)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));te.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1);var r=te.length;this._removeNodes(te,e);var n=te.length<r;return 0!==te.length&&(this._lodGlobalDirty=!0),te.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,i){if(Object(b.j)(e))return!1;var r=e.index,n=this._index,a=this.layerView,s=n.nodeTraversalState(e),o=this.isChosenMaxLOD(s),c=a.isNodeLoaded(r),l=a.nodeCrossfadingEnabled;if(l&&c&&o){var u=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,0,!u)}var d=c&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(c&&(a.updateNodeState(r,o?1:0),o))return d&&this._removeChildrenRecursive(e),d;var h=e.childCount>0,f=h;if(h)for(var v=0;v<e.childCount;v++){var y=n.getChildIndex(e,v),p=n.getNode(y);Object(b.k)(p)?n.isGeometryVisible(y)&&!this._lodGlobalHandling(p,t,i||d)&&this._isNodeInScaleBounds(p)&&(f=!1):n.isNodeVisible(y)&&(f=!1)}var g=c&&!o&&(f||te.length<t);g&&te.push(r),!l||g||!c||i||f||a.fadeNode(r,0,!1);var m=!e.resources.hasFeatureData;return f||d&&!g||m}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&te.push(e.index),!0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(!t.layerView.isNodeLoaded(e.index)||(i=!1,!1))})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,(function(e){if(!r||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(i=!0),!t.layerView.isNodeLoaded(e.index)||(r=!1,!1)})),r&&i}},{key:"isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),te=new v.a({deallocator:null}),ie=i(8),re=i.n(ie),ne=i(15),ae=i(134),se=i(26),oe=i(34),ce=i(1019),le=i(998),ue=function(){function e(t,i,r,n,s,o){if(Object(a.a)(this,e),this.streamDataController=i,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var c=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return Object(le.c)(c,e)}))}}return Object(s.a)(e,[{key:"load",value:function(e,t,i){return this.streamDataController.request(e,t,i)}},{key:"loadAttribute",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this.load(r,"binary",i).then((function(e){return Object(ce.d)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var r=this;return Object(p.k)(t.map((function(t){return r.loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var n={},a=0;a<t.length;++a)if(i[a].value)n[t[a].name]=i[a].value;else{if(Object(p.n)(i[a].error))throw i[a].error;r.logger.error("#loadAttributes",r.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=Object(ne.a)(re.a.mark((function e(t,i){var r,n,a,s,o,c,l,u,d,h,f,v,y,p,g,m,_,O,j,x,k,w;return re.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this.requiredAttributes&&t.resources.attributes?Object(ae.d)(this.loadAttributes(t,this.requiredAttributes,i)):null,n=be(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,c=o?Object(ae.d)(this.loadGeometry(t.resources.geometry,s,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this.loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(l=e.t0,u=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=l?Object(le.d)(l):null,d=u&&u.material,h=u&&u.textures,f="".concat(t.id),!(v=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this.loadFeatureData(f,i);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(y=e.t1,p=v?de(y):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:d}}],featureDataPosition:[0,0,0]},g=Object(b.j)(p)&&he(y),m=null!=h&&h.length>0?Object(ae.d)(this.loadTextures(t,h,i)):null,_=null,O=null,!c){e.next=39;break}return e.t2=ae.a,e.next=35,c;case 35:e.t3=e.sent,_=(0,e.t2)(e.t3),j=fe(this.defaultGeometrySchema,l),O=Object(ce.a)(a,j);case 39:if(!m){e.next=47;break}return e.t5=ae.a,e.next=43,m;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(x=e.t4,!r){e.next=57;break}return e.t8=ae.a,e.next=53,r;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:return k=e.t7,w=k?{attributeData:k,loadedAttributes:this.requiredAttributes}:null,e.abrupt("return",Object(b.k)(p)?{geometryData:p,attributeDataInfo:w,geometryBuffer:_,geometryDescriptor:O,requiredTextures:h,textureData:x}:Object(b.k)(g)?{pointData:g,attributeDataInfo:w,geometryBuffer:_,geometryDescriptor:O,requiredTextures:h,textureData:x}:Promise.reject());case 61:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"loadShared",value:function(t,i){var r="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this.load(r,"json",i).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,r),t}))}},{key:"loadTexture",value:function(e,t,i,r,n,a){var s=!1;return 4===n||1===n||2===n?this.load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:n,downsampled:s}})):this.load(e,"image",a).then((function(e){var a=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),c=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=o,l.height=c,l.getContext("2d").drawImage(e,0,0,o,c),a=l,s=!0}return{id:t,usage:i,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var r=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Object(le.f)(t.encodings,r.options.textureEncodings);if(null==s)return r.logger.error("#loadTextures",r.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,c="".concat(r.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return r.loadTexture(c,t.id,t.usage,n,s.encoding,i)})))}},{key:"loadFeatureData",value:function(e,t){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this.load(i,"json",t)}},{key:"loadGeometry",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this.load(r,"binary",i)}}],[{key:"addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++){var a,s=n[r],o=Object(I.a)(i[s].images);try{for(o.s();!(a=o.n()).done;){var c=a.value;Array.isArray(c.href)?c.hrefConcat=c.href.map((function(e){return Object(oe.A)(e,t)})):c.hrefConcat=Object(oe.A)(c.href,t)}}catch(l){o.e(l)}finally{o.f()}}}},{key:"fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a=r.encoding[n];"data:"===a.substring(0,5)&&(r.encoding[n]=a.substring(5))}else{var s=r.encoding;"data:"===s.substring(0,5)&&(r.encoding=s.substring(5))}}}}]),e}();function de(e){var t,i=Object(I.a)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.geometries;if(null!=n){var a,s=Object(I.a)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[r.id],featureDataPosition:r.position,geometries:[o]}}}catch(c){s.e(c)}finally{s.f()}}}}catch(c){i.e(c)}finally{i.f()}return null}function he(e){var t,i=new Array,r=Object(I.a)(e.featureData);try{for(r.s();!(t=r.n()).done;){var n=t.value;null!=n.position&&i.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){r.e(a)}finally{r.f()}return i}function fe(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Object(se.a)(e)).vertexAttributes.region,e}function be(e,t){var i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;var r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(var n=0;n<r.length;n++){var a=r[n];if(null==a.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=r[n];else if("draco"===a.compressedAttributes.encoding&&!Object(h.a)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=a,i}return i}var ve=function(){function e(t,i){Object(a.a)(this,e),this.requester=t,this.apiKey=i,this.activeRequests=new Set}return Object(s.a)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,i){var r=this,n=Object(p.e)(),a=Object(p.t)(i,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),c={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(c),Object(p.c)(o,(function(){var e;c.abortController=null,null==(e=c.abortHandle)||e.remove(),c.abortHandle=null,r.activeRequests.delete(c)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,i;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(i=e.abortHandle)||i.remove()})),this.activeRequests.clear()}}]),e}(),ye=i(11),pe=i(62),ge=i(72),me=i(138),_e=i(76),Oe=i(73),je=i(174),xe=i(274),ke=1e5,we=function(){function e(t,i,r,n,s,o,c){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};Object(a.a)(this,e),this.indexSR=t,this._renderCoordsHelper=i,this.extent=s,this.elevationProvider=o,this.options=l,this._frustum=Object(me.c)(),this._useFrustumCulling=!1,this._poi=Object(ye.e)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=Object(ye.e)(),this._tmp2=Object(ye.e)(),this._tmp3=Object(ye.e)(),this._tmp0=Object(ye.e)(),this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(r,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(c),this.tmpPoint=Object(k.j)(0,0,0,t)}return Object(s.a)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=je.a.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Object(xe.c)(Object(xe.f)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&Object(me.e)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}},{key:"updateExtent",value:function(e){this.extent=e}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return t[3]<0&&(Object(pe.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=Object(Oe.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),Object(O.p)(t,this.indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if(Object(b.k)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb;return Object(b.j)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i){if(Object(b.j)(t)&&(t=Object(V.e)()),t.halfSize[0]<0){var r=0;this._elevationContext&&i<ke&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],r=Object(Oe.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),Object(L.v)(e,this.indexSR,t,this.engineSR,r)}return t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return Object(b.k)(i)?Object(V.h)(i,this._frustum):Object(me.j)(this._frustum,Object(_e.n)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return Object(b.k)(t)?Object(V.h)(t,this._frustum):this.isNodeVisible(e)}},{key:"isMBSinExtent",value:function(e){return!this.extent||0!==Object(L.s)(this.extent,e)}},{key:"screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),r=Math.sqrt(Object(E.n)(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=Object(E.o)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/Object(E.r)(t)+i)/Object(E.o)(t,this._camPos);return Math.min(1,r)}},{key:"hasLOD",value:function(e){return 0!==e.lodMetric}},{key:"getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"getDistanceGlobeMode",value:function(e,t){var i=Object(E.r)(t),r=Object(E.r)(e)-i;Object(E.g)(this._tmp0,e,Object(E.j)(e,t)/Object(E.v)(e));var n=Object(E.n)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(r);var s=Object(E.g)(this._tmp0,t,1/i),o=i,c=a*a/2/o,l=Object(E.g)(this._tmp1,s,o-c),u=e,d=Object(E.l)(this._tmp2,u,l),h=Object(E.l)(this._tmp2,d,Object(E.g)(this._tmp3,s,Object(E.j)(s,d))),f=Object(E.h)(this._tmp2,l,Object(E.g)(this._tmp2,h,a/Object(E.r)(h))),b=Object(E.o)(u,f);if(r>=2e5){var v=Object(E.l)(this._tmp1,u,f),y=Object(E.j)(v,s)/Object(E.r)(v);y<.08&&(y=1e-4),b/=y}return b}},{key:"getDistance",value:function(e,t){return this.engineSR===Object(ge.g)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case 2:var i=this.getRenderMbs(e),r=this.getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,a=r+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case 1:var s=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return Object(E.o)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return Object(E.o)(this._camPos,this._poi)}}]),e}(),Ie=i(546),Ce=i(661),Se=i(449),Ne=f.a.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Fe=1e-4,Me=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leavesReached=!1,r.scaleVisibilityEnabled=!0,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new v.a({deallocator:null}),r._loadedNodeScales=new Map,r._modificationsNodeFilteringArray=new v.a,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new d.a,r._idleQueue=new w.a,r._elevationUpdateNodes=new v.a({deallocator:null}),r._errorCount=0,r}return Object(s.a)(i,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new ve(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(3);return new ve(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return Object(L.r)(this.layer)}},{key:"crsIndex",get:function(){return Object(L.p)(this.layer)}},{key:"rootNodeVisible",get:function(){if(Object(b.k)(this._index)){var e=this._index.rootNode;if(Object(b.k)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new ee(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=Object(h.a)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((function(i){var r,a=Object(n.a)(i,1)[0];if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var s=e.layerView.view;e._setClippingArea(s.clippingArea);var o=e.layerView.view.resourceController;e._handles.add([Object(g.a)(s,"pointsOfInterest.focus.renderLocation",(function(t){return e._pointOfInterestChanged(t)})),o.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),Object(g.a)(e.layerView,"suspended",(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},r=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=r):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,r)})),M(e.layerView.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),s.state.watch("contentCamera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return Object(b.k)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new we(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,s.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new U(t,a,e.indexStreamController,e._viewportQueries,Ne,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}),null!=(r=e.layerView)&&r.computeNodeFiltering?function(t){return e.layerView.computeNodeFiltering(t)}:void 0);var c=Object(b.k)(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(c),e._startNodeLoading()}}))),this._tmpPoint=Object(k.j)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,r=this.layerView;Object(b.k)(i)&&r&&r.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var r=i.getNode(e);Object(b.k)(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,De.prune(),Object(b.k)(Ee)&&(Ee.hide(),Ee=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=Re(e,i),n=Re(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Pe(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=Object(j.h)();Object(Ie.a)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){Object(b.k)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),Object(b.k)(this._index)&&(this._index.progressiveLoadPenalty=Ae.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),Object(b.k)(this._viewportQueries)&&Object(b.k)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this,r=this._index;if(!Object(b.j)(r)){var n=r.rootNode;if(!Object(b.j)(n)){var a=this._elevationUpdateNodes;a.clear(),Object(L.l)(e,t,n,this.crsIndex,r,(function(e){return a.push(e.index)})),a.forAll((function(e){r.invalidateBoundingVolumeCache(e),e===n.index&&i.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}}},{key:"getParentIndex",value:function(e){return Object(b.k)(this._index)&&this._index.getParentIndex(e)}},{key:"_elevationInfoChanged",value:function(){Object(b.k)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t,i){var r=this,n=this._index;if(!Object(b.j)(n)){var a=n.rootNode;!Object(b.j)(a)&&Object(O.o)(t,i,Le,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,i){var a=n.getNode(i);Object(b.k)(a)&&Object(x.h)(Le,a.mbs)&&r._loadedNodeScales.set(i,e)}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=Object(Se.a)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return Object(b.j)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return Object(b.k)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||Object(b.j)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Ne.error("Error during processing: "+i):50===this._errorCount&&Ne.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!Object(b.j)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}}},{key:"_processIndex",value:function(e){var t=this;if(Object(b.j)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Object(r.a)(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading()||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(Object(b.j)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.isGraphics3D&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Fe)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Fe)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Fe,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(Object(b.j)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);Object(b.k)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,0)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(Object(b.j)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var n=this._index.getNode(r.update.pop());Object(b.k)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if(Object(b.j)(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Ce.b&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=(Object(b.k)(this._index)?this._index.getIndexMissing():0)+3*(Object(b.k)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,r=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Ae.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"updateBoundingVolume",value:function(e){Object(b.k)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){Object(b.k)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){if(Object(b.k)(this._index)){var e=Object(b.k)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"_shouldDropNode",value:function(e){if(Object(b.j)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||Object(b.j)(t)||Object(b.j)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new ue(this.layer,this.dataStreamController,Ne,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,1)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if(Object(b.j)(i)||Object(b.j)(this._viewportQueries))return!1;De.clear(),this.layerView.getLoadedNodeIndices(De);var r=0===this._viewportQueries.maxDistance,n=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return De.filterInPlace((function(e){var r=i.getNode(e);return Object(b.j)(r)||!i.isGeometryVisible(e)||n(r)||!t._isNodeInScaleBounds(r)})),De.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(De,e,0),!(r&&this.lodDropFactor<1)&&(0===De.length||(De.clear(),!1))}},{key:"markNodeToRemove",value:function(e){De.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(De,S.d,0)}},{key:"_removeNodes",value:function(e,t,i){var r=e.length;if(0!==r&&!t.done){for(Object(b.k)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&Object(b.k)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,1,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<r;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=Object(p.e)();this._updatingNodes.set(e.index,i),(Pe(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r},i.signal)}),i.signal)})).catch((function(r){if(!Object(p.n)(r))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Ne.error("already loading node "+e.index);else{var i=Object(p.e)();this._loadingNodes.set(e.index,i);var r=function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then(r).catch((function(e){if(r(),!Object(p.n)(e))throw e}))}}},{key:"_loadAndAddNode",value:function(e,t){var i=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,Object(b.k)(i._index)&&i._index.updates.add.push(e.index))})).catch((function(t){if(!Object(p.n)(t))throw e.cacheState=1,t}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||Object(b.j)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return Object(b.k)(t)&&Object(b.k)(t.attributeInfo)&&Pe(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){Object(b.k)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule((function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))}),t).then((function(n){if(Object(b.j)(n))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return r.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,r,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=2})).catch((function(t){if(!Object(p.n)(t))throw Ne.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,Object(b.k)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&Object(b.k)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=Object(Se.a)(this.layer),r=i.minScale,n=i.maxScale;return Object(Se.d)(t,r,n)}},{key:"updateStats",value:function(e){e.index=Object(b.k)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),Object(b.k)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){Object(b.k)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),Object(b.k)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;Object(b.k)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),i}(Object(y.b)(u.a));Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"isMeshPyramid",null),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"isGraphics3D",null),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"indexStreamController",null),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"dataStreamController",null),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"crsVertex",null),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"crsIndex",null),Object(l.a)([Object(m.b)()],Me.prototype,"screenSizeFactor",void 0),Object(l.a)([Object(m.b)()],Me.prototype,"featureTarget",void 0),Object(l.a)([Object(m.b)()],Me.prototype,"fixedFeatureTarget",void 0),Object(l.a)([Object(m.b)()],Me.prototype,"layerView",void 0),Object(l.a)([Object(m.b)()],Me.prototype,"layer",void 0),Object(l.a)([Object(m.b)({})],Me.prototype,"updating",void 0),Object(l.a)([Object(m.b)({})],Me.prototype,"updatingProgress",void 0),Object(l.a)([Object(m.b)({readOnly:!0})],Me.prototype,"leavesReached",void 0),Object(l.a)([Object(m.b)({constructOnly:!0})],Me.prototype,"scaleVisibilityEnabled",void 0),Object(l.a)([Object(m.b)({readOnly:!0,dependsOn:[]})],Me.prototype,"rootNodeVisible",null),Me=Object(l.a)([Object(_.a)("esri.layers.graphics.controllers.I3SOnDemandController")],Me);var Ee,De=new v.a({deallocator:null});function Pe(e,t){return Object(b.k)(e)&&e.length===t.length&&e.every((function(e){return Re(t,e.name)>=0}))}function Re(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var Ae={factorIM:.2,factor3dObject:.05,distancePenalty:10},Le=Object(x.l)(),Ve=Me},1026:function(e,t,i){"use strict";i.d(t,"a",(function(){return w}));var r=i(35),n=i(8),a=i.n(n),s=i(15),o=i(31),c=i(12),l=i(3),u=i(4),d=i(69),h=i(102),f=i(134),b=i(553),v=i(16),y=i(2),p=i(23),g=i(158),m=i(163);function _(e,t,i){return O.apply(this,arguments)}function O(){return(O=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=i.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(i.maxRecordCountFactor=x(t)),n=j(t),s=t.capabilities.query.supportsPagination,i.start=0,i.num=n,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(i,r);case 6:if(c=e.sent,Object(y.j)(o)?o=c:o.features=o.features.concat(c.features),o.exceededTransferLimit=c.exceededTransferLimit,s&&c.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:i.start+=n;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return x(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function x(e){return e.capabilities.query.supportsMaxRecordCountFactor?m.a.MAX_MAX_RECORD_COUNT_FACTOR:1}var k=v.a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),w=function(){function e(t,i){var r=this;Object(l.a)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=Object(p.e)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=S,this.memCache=i.getMemCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return r.pendingFetchAbortController=null}))}return Object(u.a)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),Object(y.j)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var i=this.interactiveEditingSessions,r=new I(e,{rollback:function(){Object(h.l)(i,r),0===i.length&&(t.interactiveEditingSessions=null)},commit:function(i){var r,n=Object(c.a)(i);try{for(n.s();!(r=n.n()).done;){var a=Object(o.a)(r.value,2),s=a[0],l=a[1];t.updateValue(e,s,l)}}catch(u){n.e(u)}finally{n.f()}}});return i.unshift(r),r}},{key:"apply",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,c,l,u,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(y.j)(i)){e.next=2;break}return e.abrupt("return");case 2:if(n=i.loadedAttributes,s=i.attributeData,!Object(y.j)(n)&&0!==n.length&&!Object(y.j)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(p.B)(this.pendingFetchChangedObjectIds,r);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:n,attributeData:s},c=this.getOverridesFromCache(t,o,this.changedObjectIds),l=c.objectIds,u=c.fieldNames,e.next=15,this.queryOverridesFromAssociatedLayer(l,u,r);case 15:d=e.sent,Object(y.j)(d)||this.processOverridesFromAssociatedLayer(t,d,u,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)}},{key:"cacheValue",value:function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))}},{key:"getOverridesFromCache",value:function(e,t,i){var r,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,l=Object(c.a)(n);try{for(l.s();!(r=l.n()).done;){var u=r.value;o[u.index]=a[u.name]}}catch(g){l.e(g)}finally{l.f()}for(var d=new Set,h=0;h<e.length;h++){var f=e[h];if(i.has(f)){var b,v=Object(c.a)(n);try{for(v.s();!(b=v.n()).done;){var y=b.value,p=this.fromCache(f,y.index);void 0===p?(s.add(f),d.add(y.name)):o[y.index][h]=p}}catch(g){v.e(g)}finally{v.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(d)}}},{key:"fromCache",value:function(e,t){var i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var r=this.getCacheKey(e,t);return this.memCache.get(r)}},{key:"fromInteractiveEditingSession",value:function(e,t){if(!Object(y.j)(this.interactiveEditingSessions)){var i,r=Object(c.a)(this.interactiveEditingSessions);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){r.e(s)}finally{r.f()}}}},{key:"getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"queryOverridesFromAssociatedLayer",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,n){var s,o,c,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning()),s=Object(y.t)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat(Object(r.a)(i)),o.cacheHint=!0,o.objectIds=t,c=j(s),l=t.length>c?Object(h.p)(t,c).map((function(e){var t=o.clone();return t.objectIds=e,Object(f.e)(_(s,t,{signal:n}))})):[Object(f.e)(_(s,o,{signal:n}))],e.next=8,Promise.all(l);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat(Object(g.b)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),k.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"processOverridesFromAssociatedLayer",value:function(e,t,i,r){var n,a=r.loadedAttributes,s=r.attributeData,o=Object(y.t)(this.layer.associatedLayer).objectIdField,l=i.map((function(e){return s[e]})),u=new Map(a.map((function(e){return[e.name,e.index]}))),d=i.map((function(e){return u.get(e)})),h=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=Object(c.a)(t);try{for(f.s();!(n=f.n()).done;)for(var b=n.value,v=b.attributes[o],p=0;p<i.length;p++){var g=d[p],m=h.get(v),_=b.attributes[i[p]];l[p][m]=_,this.cacheValue(v,g,_)}}catch(O){f.e(O)}finally{f.f()}}},{key:"memCacheValueSize",value:function(e){return"string"==typeof e?Object(b.d)(e):Object(b.c)()}},{key:"fetchChangedObjectIds",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var i,r,n,s,o,c,l,u,h,b,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!Object(y.j)(s.associatedLayer)&&null!=(i=s.associatedLayer.capabilities)&&null!=(r=i.operations)&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this.getFetchChangedObjectIdsServerGen(),!Object(y.j)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return c=s.associatedLayer.layerId,e.next=12,Object(f.d)(Object(d.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(c),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:c,serverGen:o}])},timeout:C,signal:t}));case 12:if(l=e.sent,u=l.ok&&null!=(n=l.value.data)&&n.edits?Object(y.i)(l.value.data.edits[0],"objectIds","updates"):null,Object(y.k)(u))for((h=Math.min(this._maximumNumberOfEditOVerrides,u.length))<u.length&&(this.warnMaximumChangedObjectsExceeded=!0),b=u.sort((function(e,t){return e-t})),v=0;v<h;v++)this.changedObjectIds.add(b[v]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if(Object(y.k)(e.serviceUpdateTimeStamp)&&Object(y.k)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return Object(y.k)(t)&&Object(y.k)(t.serverGens)&&Object(y.k)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),I=function(){function e(t,i){Object(l.a)(this,e),this.objectId=t,this.options=i,this.updates=new Map,this.state=0}return Object(u.a)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=2,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return 0===this.state}}]),e}(),C=1e4,S=5e4},1061:function(e,t,i){"use strict";i.d(t,"a",(function(){return b}));var r=i(3),n=i(4),a=i(6),s=i(7),o=i(0),c=i(16),l=i(1),u=(i(17),i(18),i(9)),d=i(851),h=i(910),f=c.a.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),b=function(e){var t=function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments))._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e.logError=function(t){e._definitionExpressionErrors<e._maxDefinitionExpressionErrors&&f.error("Error while evaluating definitionExpression: "+t),e._definitionExpressionErrors++,e._definitionExpressionErrors===e._maxDefinitionExpressionErrors&&f.error("Further errors are ignored")},e}return Object(n.a)(i,[{key:"parsedDefinitionExpression",get:function(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{var e=d.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return f.error("definitionExpression is using non standard function"),null;var t=[],i=e.fieldNames;return Object(h.k)(i,this.i3slayer.fields,{missingFields:t}),t.length>0?(f.error("definitionExpression references unknown fields: ".concat(t.join(", "))),null):(this._definitionExpressionErrors=0,e)}catch(r){return f.error("Failed to parse definitionExpression: "+r),null}}},{key:"definitionExpressionFields",get:function(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}},{key:"_evaluateClause",value:function(e,t){try{return e.testFeature(t)}catch(i){return this.logError(i),!1}}},{key:"_addDefinitionExpressionToQuery",value:function(e){if(!this.parsedDefinitionExpression)return e;var t=this.i3slayer.definitionExpression,i=e.clone();return i.where?i.where="(".concat(t,") AND (").concat(i.where,")"):i.where=t,i}}]),i}(e);return Object(o.a)([Object(l.b)()],t.prototype,"i3slayer",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),Object(o.a)([Object(l.b)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=Object(o.a)([Object(u.a)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},1062:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r=i(35),n=i(12),a=i(8),s=i.n(a),o=i(15),c=i(3),l=i(4),u=i(6),d=i(7),h=i(0),f=i(20),b=i(2),v=(i(1),i(17),i(18),i(16),i(9)),y=i(81),p=i(942),g=function(e){var t=function(e){Object(u.a)(i,e);var t=Object(d.a)(i);function i(){return Object(c.a)(this,i),t.apply(this,arguments)}return Object(l.a)(i,[{key:"_validateFetchPopupFeatures",value:function(e){var t=this.layer;return t.popupEnabled?Object(p.a)(t,e)?void 0:new f.a("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new f.a("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}},{key:"prepareFetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t,i){var a,o,c,l,u,d,h,f,v,g;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=this._validateFetchPopupFeatures(i))){e.next=3;break}return e.abrupt("return",Promise.reject(a));case 3:if((o=Object(b.k)(i)?i.clientGraphics:null)&&0!==o.length){e.next=6;break}return e.abrupt("return",Promise.resolve([]));case 6:return c=[],l=[],u="scene"===this.layer.type&&Object(b.k)(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,e.t0=y.v,e.t1=this.layer.fieldsIndex,e.next=13,Object(p.b)(u,Object(p.a)(this.layer,i));case 13:return e.t2=e.sent,d=(0,e.t0)(e.t1,e.t2),e.next=17,this.prepareFetchPopupFeatures(d);case 17:h=new Set,f=Object(n.a)(o);try{for(f.s();!(v=f.n()).done;)g=v.value,Object(y.t)(d,g,h)?l.push(g):c.push(g)}catch(t){f.e(t)}finally{f.f()}return e.abrupt("return",0===l.length?Promise.resolve(c):this.whenGraphicAttributes(l,Object(r.a)(h)).catch((function(){return l})).then((function(e){return c.concat(e)})));case 21:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()}]),i}(e);return t=Object(h.a)([Object(v.a)("esri.views.3d.layers.support.PopupSceneLayerView")],t)}},1066:function(e,t,i){"use strict";i.d(t,"a",(function(){return tt}));var r=i(35),n=i(8),a=i.n(n),s=i(15),o=i(14),c=i(12),l=i(4),u=i(22),d=i(3),h=i(6),f=i(7),b=i(0),v=i(39),y=i(119),p=i(49),g=i(17),m=i(16),_=i(123),O=i(2),j=i(75),x=i(23),k=i(141),w=i(109),I=i(79),C=i(27),S=i(1),N=(i(18),i(9)),F=i(70),M=i(267),E=i(29),D=i(36),P=i(5),R=i(11),A=i(62),L=i(53),V=i(38),T=i(1025),U=i(81),G=i(224),H=i(1023),q=i(413),B=i(157),z=i(252),Q=i(502),W=(i(105),i(32)),K=i(55),J=i(687),Y=i(208),Z=i(988),X=i(984),$=i(997),ee=i(80),te=i(1024),ie=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(d.a)(this,i),(r=t.call(this))._limit=e,r._all=new te.a,r._active=new ne(Object(u.a)(r)),r._pending=new Map,r._handle=r._all.on("change",(function(e){return r._handleChanges(e)})),r}return Object(l.a)(i,[{key:"destroy",value:function(){this._handle.remove()}},{key:"length",get:function(){return this._active.length}},{key:"toArray",value:function(){return this._active.toArray()}},{key:"find",value:function(e){return this._active.find(e)}},{key:"forEach",value:function(e){this._active.forEach(e)}},{key:"addMany",value:function(e){this._all.addMany(e)}},{key:"removeManyByObjectId",value:function(e){this._all.removeManyByObjectId(e)}},{key:"_handleChanges",value:function(e){var t=this,i=e.removed;if(this._pending.size>0){i=new Array;var r,n=Object(c.a)(e.removed);try{for(n.s();!(r=n.n()).done;){var a=r.value;this._pending.delete(a.objectId)||i.push(a)}}catch(f){n.e(f)}finally{n.f()}}var s=this._limit-this._active.length+i.length;s<e.added.length&&(this._active.removeMany(i),i=[],re.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((function(e){re.sample()&&(i.push(e),t._pending.set(e.objectId,e))})),s=this._limit-this._active.length+i.length);var o=e.added;if(s<e.added.length){o=new Array,re.reset(s/e.added.length);var l,u=Object(c.a)(e.added);try{for(u.s();!(l=u.n()).done;){var d=l.value;re.sample()?o.push(d):this._pending.set(d.objectId,d)}}catch(f){u.e(f)}finally{u.f()}}var h=s-o.length;h>0&&this._pending.size>0&&(re.reset(h/this._pending.size),this._pending.forEach((function(e){re.sample()&&(o.push(e),t._pending.delete(e.objectId))}))),this._active.addAndRemove(o,i)}}]),i}(ee.a),re=new(function(){function e(){Object(d.a)(this,e),this.percentage=1,this.last=-1,this.index=0}return Object(l.a)(e,[{key:"reset",value:function(e){this.percentage=e,this.last=-1}},{key:"sample",value:function(){var e=Math.floor(this.index*this.percentage);return++this.index,e!==this.last&&(this.last=e,!0)}}]),e}()),ne=function(){function e(t){Object(d.a)(this,e),this._parent=t,this._map=new Map}return Object(l.a)(e,[{key:"length",get:function(){return this._map.size}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}},{key:"find",value:function(e){var t;return Object(_.c)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"toArray",value:function(){return Object(r.a)(this._map.values())}},{key:"addAndRemove",value:function(e,t){var i,r=Object(c.a)(e);try{for(r.s();!(i=r.n()).done;){var n=i.value;this._map.set(n.objectId,n)}}catch(l){r.e(l)}finally{r.f()}var a,s=Object(c.a)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._map.delete(o.objectId)}}catch(l){s.e(l)}finally{s.f()}(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}},{key:"removeMany",value:function(e){var t,i=Object(c.a)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._map.delete(r.objectId)}}catch(n){i.e(n)}finally{i.f()}e.length>0&&this._parent.emit("change",{added:[],removed:e})}}]),e}(),ae=i(231),se=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(d.a)(this,i),(r=t.call(this,e)).loadedGraphics=new ie(5e4),r.slicePlaneEnabled=!1,r._renderingInfo={symbol:new ae.a},r._handles=new K.a,r._graphicsByNode=new Map,r._scaleVisibility=null,r}return Object(l.a)(i,[{key:"initialize",value:function(){var e=this;this._graphicsCore=new Z.a({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});var t=this.view.basemapTerrain;this._scaleVisibility=new X.a({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,(function(t,i,r){return e._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,i,r)}),this._graphicsCore,t);var i=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),r=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:i,deconflictor:r,scaleVisibility:this._scaleVisibility}).then((function(){e._graphicsCore.startCreateGraphics()})).catch((function(){})),this._handles.add([this.layer.watch("labelingInfo",(function(t,i){Object(J.a)(t,i)&&e._graphicsCore.updateLabelingInfo()}))])}},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}},{key:"addNodeMeta",value:function(e,t){var i=this,r=0,n=e.filteredIds,a=e.featureIds.map((function(a,s){Object($.b)(s,i.collection,e.objectHandle,ce);var o=Object(Y.j)(0,0,0,i.view.spatialReference);i.view.renderCoordsHelper.fromRenderCoords(ce,o);var c=t(s,e),l=!1;return Object(O.j)(n)?l=!0:r<n.length&&a===n[r]&&(l=!0,r++),{objectId:a,uid:y.a.generateUID(),attributes:c,visible:l,geometry:o}}));this.loadedGraphics.addMany(a),this._graphicsByNode.set(e.node.index,a)}},{key:"setNodeMetaAttributes",value:function(e,t){for(var i=this._graphicsByNode.get(e.node.index),r=new Array(i.length),n=0;n<i.length;n++){var a=i[n];a.attributes=t(n,e),r[n]=a.uid}this._graphicsCore.updateLabelingInfo(r)}},{key:"applyFilterChange",value:function(e){var t=this._graphicsByNode.get(e.node.index);if(t)if(Object(O.j)(e.filteredIds)){var i,r=Object(c.a)(t);try{for(r.s();!(i=r.n()).done;){var n=i.value;n.visible||(n.visible=!0,oe.graphic=n,oe.property="visible",oe.oldValue=!1,oe.newValue=!0,this._graphicsCore.graphicUpdateHandler(oe))}}catch(d){r.e(d)}finally{r.f()}}else{var a,s=0,o=Object(c.a)(t);try{for(o.s();!(a=o.n()).done;){var l=a.value,u=l.visible;s<e.filteredIds.length&&l.objectId===e.filteredIds[s]?(l.visible=!0,s++):l.visible=!1,u!==l.visible&&(oe.graphic=l,oe.property="visible",oe.oldValue=u,oe.newValue=l.visible,this._graphicsCore.graphicUpdateHandler(oe))}}catch(d){o.e(d)}finally{o.f()}}}},{key:"removeNodeMeta",value:function(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}},{key:"getRenderingInfo",value:function(){return this._renderingInfo}},{key:"notifyGraphicGeometryChanged",value:function(){}},{key:"notifyGraphicVisibilityChanged",value:function(){}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]),i}(W.a);Object(b.a)([Object(S.b)()],se.prototype,"view",void 0),Object(b.a)([Object(S.b)()],se.prototype,"layer",void 0),Object(b.a)([Object(S.b)()],se.prototype,"collection",void 0),Object(b.a)([Object(S.b)()],se.prototype,"loadedGraphics",void 0),Object(b.a)([Object(S.b)({aliasOf:"_graphicsCore.updating"})],se.prototype,"updating",void 0),Object(b.a)([Object(S.b)()],se.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(S.b)()],se.prototype,"_graphicsCore",void 0),se=Object(b.a)([Object(N.a)("esri.views.3d.layers.I3SMeshViewLabeler")],se);var oe={graphic:null,property:null,oldValue:null,newValue:null},ce=Object(R.e)(),le=se,ue=i(544),de=m.a.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle"),he=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){return Object(d.a)(this,i),t.call(this,"SceneLayerWorker","process",e,{hasInitialize:!0})}return Object(l.a)(i,[{key:"getTransferList",value:function(e){return[e.geometryBuffer]}},{key:"setModifications",value:function(e,t,i){var r={context:e,modifications:ve(t,i),isGeodetic:i.isGeographic};this.broadcast(r,"setModifications")}},{key:"setLegacySchema",value:function(e,t){var i=JSON.stringify(t);this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}},{key:"destroyContext",value:function(e){return this.broadcast(e,"destroyContext")}}]),i}(ue.a),fe=new j.a({deallocator:null}),be=[0,0,0];function ve(e,t){fe.clear();var i,r=Object(c.a)(e);try{var n=function(){var e=i.value,r="clip"===e.type?2:"mask"===e.type?1:0,n=e.geometry,a=function(e){return e};if(n.spatialReference){if(!Object(L.b)(n.spatialReference,t))return de.warn("Can't project modification polygon into layer spatial reference, ignoring modification"),"continue";a=function(e){return Object(L.z)(e,n.spatialReference,be,t),be}}else n.hasZ||(be[2]=0,a=function(e){return be[0]=e[0],be[1]=e[1],be});fe.push(r),fe.push(n.rings.length);var s,o=Object(c.a)(n.rings);try{for(o.s();!(s=o.n()).done;){var l=s.value;fe.push(l.length);var u,d=Object(c.a)(l);try{for(d.s();!(u=d.n()).done;){var h=a(u.value);fe.push(h[0]),fe.push(h[1]),fe.push(h[2])}}catch(f){d.e(f)}finally{d.f()}}}catch(f){o.e(f)}finally{o.f()}};for(r.s();!(i=r.n()).done;)n()}catch(o){r.e(o)}finally{r.f()}fe.push(3);for(var a=new Float64Array(fe.length),s=0;s<fe.length;++s)a[s]=fe.getItemAt(s);return a}var ye=i(852),pe=i(117),ge=i(102),me=function e(){Object(d.a)(this,e),this.ids=new Set,this.paused=!1},_e=function(){function e(t){var i=t.collection,r=t.forAllFeatures,n=t.forAllFeaturesOfNode;Object(d.a)(this,e),this.highlights=[],this.collection=i,this.forAllFeatures=r,this.forAllFeaturesOfNode=n}return Object(l.a)(e,[{key:"destroy",value:function(){var e=this;this.highlights.forEach((function(t){return e.releaseSet(t)})),this.highlights=null}},{key:"acquireSet",value:function(){var e=this,t=new me;this.highlights.push(t);var i={remove:function(){e.releaseSet(t),Object(ge.m)(e.highlights,t)},pause:function(){e.releaseSet(t),t.paused=!0},resume:function(){t.paused=!1,e.initializeSet(t)}};return{set:t,handle:i}}},{key:"setFeatureIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)}},{key:"initializeSet",value:function(e){var t=this;this.forAllFeatures((function(i,r,n){return e.ids.has(i)&&t.collection.addComponentHighlight(n.objectHandle,r),1}))}},{key:"releaseSet",value:function(e){var t=this;this.forAllFeatures((function(i,r,n){return e.ids.has(i)&&t.collection.removeComponentHighlight(n.objectHandle,r),1}))}},{key:"objectCreated",value:function(e){var t=this;this.highlights.forEach((function(i){i.paused||t.forAllFeaturesOfNode(e,(function(r,n){return i.ids.has(r)&&t.collection.addComponentHighlight(e.objectHandle,n),1}))}))}},{key:"objectDeleted",value:function(e){this.collection.clearHighlights(e.objectHandle)}}]),e}(),Oe=i(1026),je=function e(){Object(d.a)(this,e),this.lodCrossfadeSignedDuration=0},xe=function(){function e(t){Object(d.a)(this,e),this.view=t,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}return Object(l.a)(e,[{key:"updating",get:function(){return this._numFadingNodes>0}},{key:"stopNodeFading",value:function(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=Object(O.s)(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}},{key:"_startNodeFading",value:function(e,t,i){var r=this;0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=Object(k.a)({preRender:function(e){return r._updateAllNodeFading(e)}}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=t}},{key:"_updateAllNodeFading",value:function(e){var t=this,i=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode((function(r,n){if(Object(O.k)(n)&&Object(O.k)(n.lodCrossfadeProgress)){var a=n.lodCrossfadeSignedDuration,s=a>0?t.view.fullOpacity:0,o=e.deltaTime/a,c=n.lodCrossfadeProgress+Math.abs(o),l=!i||c>=1||0===a,u=s-(l?0:a>0?1:-1)*(1-c);l?(t.stopNodeFading(n),a<0&&t.view.markNodeToRemove(r)):n.lodCrossfadeProgress=c,t.view.setNodeOpacityByIndex(r,u)}})),this.view.removeMarkedNodes()}},{key:"stopAllNodeFading",value:function(){var e=this;this.view.foreachCrossfadeNode((function(t,i){if(Object(O.k)(i)&&Object(O.k)(i.lodCrossfadeProgress)){e.stopNodeFading(i);var r=i.lodCrossfadeSignedDuration;r<0&&e.view.markNodeToRemove(t);var n=r>0?e.view.fullOpacity:0;e.view.setNodeOpacityByIndex(t,n)}})),this.view.removeMarkedNodes()}},{key:"fadeNode",value:function(e,t,i,r){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());var n=this.view,a=n.nodeCrossfadingEnabled,s=0===i?n.fullOpacity:0,o=a?r?0===i?n.lodCrossfadeinDuration:n.lodCrossfadeoutDuration:n.lodCrossfadeUncoveredDuration:0,c=this.view.getNodeOpacityByIndex(e);if(a&&c!==s&&o>0){var l=1-Math.abs(s-c);this._startNodeFading(t,l,function(e){return 0===e?1:-1}(i)*o)}else this.stopNodeFading(t),this.view.setNodeOpacityByIndex(e,s),1===i&&this.view.removeNode(e)}},{key:"isNodeFullyFadedIn",value:function(e){var t=this.view.getNodeCrossfadeMetaData(e);return Object(O.k)(t)&&null==t.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity}}]),e}();var ke=i(45),we=i(166),Ie=Object(ke.n)(),Ce=Object(D.d)(),Se=Object(R.e)(),Ne=Object(R.e)(),Fe=Object(R.e)(),Me=m.a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider"),Ee=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(d.a)(this,i),(r=t.call(this,e)).tmpEvent={spatialReference:null,extent:Ie,context:"scene"},r}return Object(l.a)(i,[{key:"initialize",value:function(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new we.a(this.view.state.viewingMode),this.intersector.options.store=0;var e=this.layerView.i3slayer.fullExtent;this.zmin=e.zmin,this.zmax=e.zmax,this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}},{key:"getElevation",value:function(e,t,i,r){if(Se[0]=e,Se[1]=t,Se[2]=i,!this.renderCoordsHelper.toRenderCoords(Se,r,Se))return Me.error("could not project point to compute elevation"),null;var n=this.layerView.elevationOffset,a=this.zmin+n,s=this.zmax+n;return this.renderCoordsHelper.setAltitude(Ne,s,Se),this.renderCoordsHelper.setAltitude(Fe,a,Se),this.intersector.reset(Ne,Fe),this.intersectionHandler.intersect(this.intersector,null,Ne,Fe),this.intersector.results.min.getIntersectionPoint(Se)?this.renderCoordsHelper.getAltitude(Se):null}},{key:"layerChanged",value:function(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"objectChanged",value:function(e){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(e),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"computeObjectExtent",value:function(e){return Object(ke.n)(Ie),this._expandExtent(e,Ie),Ie}},{key:"computeLayerExtent",value:function(){Object(ke.n)(Ie);var e,t=Object(c.a)(this.layerView.getVisibleNodes());try{for(t.s();!(e=t.n()).done;){var i=e.value;this._expandExtent(i,Ie)}}catch(r){t.e(r)}finally{t.f()}return Ie}},{key:"_expandExtent",value:function(e,t){var i=e.visibilityObb||e.serviceObbInRenderSR;if(Object(O.k)(i)){Object(E.x)(Ce,i.quaternion),Ce[12]=i.center[0],Ce[13]=i.center[1],Ce[14]=i.center[2];for(var r=0;r<8;++r)Se[0]=1&r?i.halfSize[0]:-i.halfSize[0],Se[1]=2&r?i.halfSize[1]:-i.halfSize[1],Se[2]=4&r?i.halfSize[2]:-i.halfSize[2],Object(P.s)(Se,Se,Ce),this.renderCoordsHelper.fromRenderCoords(Se,Se,this.spatialReference),Object(ke.p)(t,Se,t)}else{var n=e.renderMbs[3],a=Object(P.m)(Ne,e.renderMbs);a[0]-=n,a[1]-=n,a[2]-=n;var s=Object(P.m)(Fe,e.renderMbs);s[0]+=n,s[1]+=n,s[2]+=n;for(var o=0;o<8;++o)Se[0]=1&o?a[0]:s[0],Se[1]=2&o?a[1]:s[1],Se[2]=4&o?a[2]:s[2],this.renderCoordsHelper.fromRenderCoords(Se,Se,this.spatialReference),Object(ke.p)(t,Se,t)}}}]),i}(ee.a.EventedMixin(W.a));Object(b.a)([Object(S.b)({constructOnly:!0})],Ee.prototype,"layerView",void 0),Object(b.a)([Object(S.b)({constructOnly:!0})],Ee.prototype,"intersectionHandler",void 0),Object(b.a)([Object(S.b)()],Ee.prototype,"view",void 0),Object(b.a)([Object(S.b)({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],Ee.prototype,"spatialReference",void 0);var De=Ee=Object(b.a)([Object(N.a)("esri.views.3d.layers.i3s.I3SElevationProvider")],Ee),Pe=i(445),Re=i(292),Ae=i(213),Le=function(){function e(t){Object(d.a)(this,e),this.type="I3S",this.layerUid=t.layerUid,this.sublayerUid=t.sublayerUid,this.collection=t.collection,this.traverseNodeHierarchy=t.traverseNodeHierarchy,this.slicePlane=t.slicePlaneEnabled,this.isGround=t.isGround}return Object(l.a)(e,[{key:"intersect",value:function(e,t,i,r){var n=this,a=e.results,s=2===e.options.store,o=e.ray.direction,c=e.tolerance,l=function(e){return e},u=function(e){return e},d=Object(Ae.c)(e.verticalOffset);Object(O.k)(d)&&(l=function(e){return d.applyToMbs(e)},u=function(e){return d.applyToObb(e)}),this.traverseNodeHierarchy((function(h,f){return!(Object(O.k)(h.serviceObbInRenderSR)&&!Object(Pe.f)(u(h.serviceObbInRenderSR),i,o,c))&&(!f||Object(O.k)(h.geometryObb)&&!Object(Pe.f)(u(h.geometryObb),i,o,c)||!Object(O.k)(h.serviceObbInRenderSR)&&!function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=e[3]+r,a=t[0]-e[0],s=t[1]-e[1],o=t[2]-e[2],c=i[0],l=i[1],u=i[2],d=c*a+l*s+u*o;return d*d-(c*c+l*l+u*u)*(a*a+s*s+o*o-n*n)>=0}(l(h.renderMbs),i,o,c)||n.collection.intersect(f,i,r,c,d,(function(o,c,l,u){if(c>=0){if(null!=t&&!t(i,r,c))return;var d=function(e){e.intersector=n.type,e.target={type:"external",metadata:{layerUid:n.layerUid,sublayerUid:n.sublayerUid,nodeIndex:h.index,componentIndex:o}},e.dist=c,Object(P.m)(e.normal,l),e.triangleNr=u};if(n.isGround&&(null==a.ground.dist||c<a.ground.dist)&&d(a.ground),e.options.isFiltered)return;if((null==a.min.dist||c<a.min.dist)&&d(a.min),(null==a.max.dist||c>a.max.dist)&&d(a.max),s){var f=new Re.a(e.ray);d(f),e.results.all.push(f)}}})),!0)}))}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}();var Ve=i(998),Te=i(1080),Ue=i(910),Ge=i(20),He=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:14;Object(d.a)(this,e),this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=t,this._storeName=i}return Object(l.a)(e,[{key:"init",value:function(){var e=this;return Promise.resolve().then((function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(i){var r=t.result,n=t.transaction,a=r.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):r.createObjectStore(e._storeName),s=r.objectStoreNames.contains("last_access")?n.objectStore("last_access"):r.createObjectStore("last_access");s.indexNames.contains("date")||s.createIndex("date","date",{unique:!1}),s.indexNames.contains("byteSize")||s.createIndex("byteSize","byteSize",{unique:!1}),i.oldVersion<e._version&&(a.clear(),s.clear())},Be(t)})).then((function(t){e._destroyed?t.close():e._db=t}))}},{key:"destroy",value:function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}},{key:"initialized",get:function(){return null!=this._db}},{key:"getHitRate",value:function(){return this._hit/(this._hit+this._miss)}},{key:"put",value:function(e,t){var i=this;return null==this._db?Promise.reject(new Ge.a("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((function(){return i._put(e,t)})).catch((function(r){if(r&&"QuotaExceededError"===r.name)return null==i._quotaReductionPromise&&(i._quotaReductionPromise=i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*i.quotaReductionFactor))})),i._quotaReductionPromise.then((function(){return i._quotaReductionPromise=null}),(function(){return i._quotaReductionPromise=null}))),i._quotaReductionPromise.then((function(){return i._put(e,t)}));throw r})).then((function(){i._gcCounter--,i._gcCounter<0&&null!=i._db&&(i._gcCounter=i.gcFrequency,i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(e-i.maxByteSize)})))}))}},{key:"get",value:function(e,t){var i=this;if(null==this._db)return Promise.resolve(null);var r=null;return Promise.resolve().then((function(){var n=i._db.transaction(i._storeName,"readonly");return r=Object(x.s)(t,(function(){n.abort()})),Be(n.objectStore(i._storeName).get(e))})).then((function(t){return null==t?++i._miss:i._db&&(++i._hit,i._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),Object(O.k)(r)&&r.remove(),t})).catch((function(){return++i._miss,Object(x.x)(t),Object(O.k)(r)&&r.remove(),null}))}},{key:"remove",value:function(e){var t=this;return null==this._db?Promise.resolve():Promise.resolve().then(Object(s.a)(a.a.mark((function i(){var r,n,s,o,c;return a.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return r=t._db.transaction([t._storeName,"last_access"],"readwrite"),n=r.objectStore(t._storeName),s=r.objectStore("last_access"),o=n.delete(e),c=s.delete(e),i.next=3,Promise.all([Be(o),Be(c),qe(r)]);case 3:case"end":return i.stop()}}),i)}))))}},{key:"_put",value:function(e,t){var i=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=i.objectStore(this._storeName),n=i.objectStore("last_access"),a=r.put(t,e),s=n.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([Be(a),Be(s),qe(i)])}},{key:"_removeLeastRecentlyAccessed",value:function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=t.objectStore(this._storeName),r=t.objectStore("last_access"),n=0,a=r.index("date").openCursor(null,"next");return a.onsuccess=function(){var t=a.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),i.delete(t.primaryKey),r.delete(t.primaryKey),n<e&&t.continue())},qe(t)}}},{key:"_getCacheSize",value:function(){var e=this._db.transaction("last_access"),t=e.objectStore("last_access"),i=0,r=t.index("byteSize").openKeyCursor();return r.onsuccess=function(){var e=r.result;if(e){var t=e.key;null!=t&&(i+=t),e.continue()}},qe(e).then((function(){return i}))}}]),e}();function qe(e){return new Promise((function(t,i){e.oncomplete=function(){return t()},e.onerror=function(){return i(e.error)},e.onabort=function(){return i(e.error)}}))}function Be(e){return new Promise((function(t,i){"done"===e.readyState?null!=e.error?i(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return i(e.error)})}))}var ze=i(934),Qe=i(93),We=i(546),Ke=i(498),Je=i(165),Ye=i(725),Ze=i(508),Xe=m.a.getLogger("esri.views.3d.layers.SceneLayerView3D"),$e=[1,1,1,1],et=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e,r,n,a,s,o,c){var l;return Object(d.a)(this,i),(l=t.call(this)).node=e,l.featureIds=r,l.objectHandle=n,l.cachedRendererVersion=a,l.attributeInfo=s,l.material=o,l.textures=c,l.cachedEdgeMaterials=new Array,l.cachedSymbology=null,l}return i}(je),tt=function(e){var t=function(e){Object(h.a)(n,e);var t=Object(f.a)(n);function n(){var e;Object(d.a)(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call(this,r))._elevationProvider=null,e._intersectionHandler=null,e._nodeId2Meta=new Map,e._nodeId2MetaReloading=new Map,e._i3sWasmLoaded=!1,e._hasLoadedPBRTextures=!1,e._asyncModuleLoading=0,e._addTasks=new Map,e._rendererVersion=0,e._colorVariable=null,e._opacityVariable=null,e._rendererFields=null,e._symbologyFields=null,e._symbologyOverride=null,e._symbologyOverrideFields=null,e._symbolInfos=new Map,e._idbCache=new He("esri-scenelayer-cache","geometries"),e.holeFilling="auto",e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._modifications=new Array,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new y.a(null,null,{}),e._crossfadeHelper=new xe(Object(u.a)(e)),e}return Object(l.a)(n,[{key:"lodCrossfadeoutDuration",get:function(){return 0}},{key:"lodCrossfadeinDuration",get:function(){return 0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return 0}},{key:"layerUid",get:function(){return this.i3slayer&&this.i3slayer.uid}},{key:"sublayerUid",get:function(){return null}},{key:"hasTexturesOrVertexColors",get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}},{key:"rendererTextureUsage",get:function(){return Object(Ue.u)(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}},{key:"elevationOffset",get:function(){var e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=Object(I.g)(this.i3slayer.spatialReference),i=Object(Q.a)(e.unit);return Object(O.u)(e.offset,0)*i/t}return 0}},{key:"supportedTextureEncodings",get:function(){return Object(Ve.e)(this.view._stage.renderView.capabilities)}},{key:"uncompressedTextureDownsamplingEnabled",get:function(){var e,t=null==(e=this.view)?void 0:e.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled,i=0==(4&this.supportedTextureEncodings);return t&&i}},{key:"initialize",value:function(){var e=this;this.preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);var t=this.view.resourceController;if(this.attributeOverrides=new Oe.a(this.i3slayer,t.memoryController),this._worker=new he((function(e){return t.schedule(e)})),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),Object(Ue.e)(this.i3slayer),Object(Ue.d)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new T.a({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new _e({collection:this._collection,forAllFeatures:function(t){return e._forAllFeatures(t,null,1)},forAllFeaturesOfNode:function(t,i){return e._forAllFeaturesOfNode(t,i)}}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,(function(t){return e._deleteComponentObject(t)}));this._intersectionHandler=new Le({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:function(t){return Object(O.k)(e._controller.index)&&Object(O.k)(e._controller.index.rootNode)?e._controller.index.traverse(e._controller.index.rootNode,(function(i){var r=i.index,n=e._nodeId2Meta.get(r)||e._nodeId2MetaReloading.get(r);return t(i,Object(O.k)(n)?n.objectHandle:null)})):function(){}}}),this._elevationProvider=new De({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR(),this.updatingHandles.add(this,"view.clippingArea",(function(){return e._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(t){return e._opacityChange(t)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._slicePlaneEnabledChange(t)})),this.updatingHandles.add(this,"elevationOffset",(function(t,i){e._reloadAll(i),e._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(function(){return e._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return e._updatePBR()}));var n=function(){e._reloadAll(),e.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",n),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",n),this.updatingHandles.add(this,"suspended",(function(t){return e._suspendedChange(t)}),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this,"_modifications",(function(){return e._modificationsChanged()}),2),this.handles.add([Object(C.a)(Qe.a,"I3S_TREE_SHOW_TILES",(function(t){if(t&&!e._treeDebugger){var r=e._controller.crsIndex;i.e(45).then(i.bind(null,1356)).then((function(t){var i=t.I3STreeDebugger;!e._treeDebugger&&Qe.a.I3S_TREE_SHOW_TILES&&(e._treeDebugger=new i({lv:e,view:e.view,nodeSR:r}))}))}else t||Qe.a.I3S_TREE_SHOW_TILES||(e._treeDebugger=Object(O.e)(e._treeDebugger))})),Object(C.a)(Qe.a,"I3S_SHOW_MODIFICATIONS",(function(){return e._showModifications()}))]),this._cacheKeySuffix=Object(Ue.m)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return Xe.warn("Failed to initialize IndexedDB cache: ".concat(e))}))}},{key:"destroy",value:function(){this._clearAddTasks(),this.attributeOverrides=Object(O.e)(this.attributeOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var e=this._worker;e&&(e.destroyContext(this.i3slayer.uid).then((function(){return e.destroy()})),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=Object(O.e)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=Object(O.e)(this._labeler),this._treeDebugger=Object(O.e)(this._treeDebugger),this._controller=Object(O.e)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}},{key:"memEstimateTextureAdded",value:function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t}},{key:"memEstimateTextureRemoved",value:function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t}},{key:"memEstimateGeometryAdded",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t}},{key:"memEstimateGeometryRemoved",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t}},{key:"isNodeLoaded",value:function(e){return this._nodeId2Meta.has(e)}},{key:"isNodeReloading",value:function(e){return this._nodeId2MetaReloading.has(e)}},{key:"getUsedMemory",value:function(){var e=Object(O.k)(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=Object(O.k)(t)?t.node.memory:0})),this._nodeId2MetaReloading.forEach((function(t){return e+=Object(O.k)(t)?t.node.memory:0})),e}},{key:"getUnloadedMemory",value:function(){return(Object(O.k)(this._controller)?this._controller.unloadedMemoryEstimate:0)+(Object(O.k)(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}},{key:"ignoresMemoryFactor",value:function(){return!1}},{key:"_labelingChanged",value:function(){var e=this;if(Object(G.a)(this.i3slayer)&&this._supportsLabeling){if(!Object(O.k)(this._labeler)){var t=new le({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((function(i){return Object(O.k)(i)&&e._addMetaToLabeler(t,i)})),this._labeler=t}}else Object(O.k)(this._labeler)&&(this._labeler.destroy(),this._labeler=null)}},{key:"_loadAsyncModule",value:function(e){var t=this;return++this._asyncModuleLoading,e.then((function(e){return--t._asyncModuleLoading,e}),(function(e){throw--t._asyncModuleLoading,e}))}},{key:"_modificationsChanged",value:function(){var e=this;if(!this._i3sWasmLoaded&&this._hasModifications)return this._i3sWasmLoaded=Object(ye.initialize)().then((function(){e._i3sWasmLoaded=!0,e._modificationsChanged(),e.notifyUpdate()})),void this.notifyUpdate();if(!0===this._i3sWasmLoaded){var t=this.i3slayer.uid,i=this.i3slayer.spatialReference;this._worker.setModifications(t,this._modifications,i);var r=ve(this._modifications,i);Object(ye.setModificationsSync)({context:t,modifications:r,isGeodetic:i.isGeographic}),this._controller.modificationsChanged();var n=this._hasModifications?new j.a:null;this._nodeId2Meta.forEach((function(t,i){Object(O.j)(t)?e._nodeId2Meta.delete(i):t.node.hasModifications?(e._nodeId2Meta.delete(i),e._nodeId2MetaReloading.set(i,t)):Object(O.k)(n)&&n.push(t.node)})),Object(O.k)(n)&&this._nodeId2MetaReloading.forEach((function(e){return n.push(e.node)})),Object(O.k)(n)&&n.length>0&&(this.updateNodeModificationStatus(n),n.forAll((function(t){if(2!==t.imModificationImpact){var i=e._nodeId2Meta.get(t.index);e._controller.invalidateGeometryVisibility(t.index),e._nodeId2Meta.delete(t.index),Object(O.k)(i)&&e._nodeId2MetaReloading.set(t.index,i)}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}}},{key:"_showModifications",value:function(){if(Object(O.k)(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),Qe.a.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;var i,r=Object(c.a)(this._modifications);try{for(r.s();!(i=r.n()).done;){var n=i.value;n.geometry.spatialReference=this.i3slayer.spatialReference;var a=Object(o.a)(Object(o.a)({},t),{},{color:e[n.type]});this._modificationGraphics.push(new y.a({geometry:n.geometry,symbol:a}))}}catch(s){r.e(s)}finally{r.f()}this.view.graphics.addMany(this._modificationGraphics)}}},{key:"_addMetaToLabeler",value:function(e,t){var i=this;e.addNodeMeta(t,(function(e,t){return i._createAttributes(e,t)}))}},{key:"_suspendedChange",value:function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}},{key:"getLoadedAttributes",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(O.k)(t)&&Object(O.k)(t.attributeInfo))return t.attributeInfo.loadedAttributes}},{key:"getAttributeData",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(O.k)(t)&&Object(O.k)(t.attributeInfo))return t.attributeInfo.attributeData}},{key:"setAttributeData",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&Object(O.k)(i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}},{key:"updateAttributes",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._nodeId2Meta.get(t),e.t0=Object(O.k)(n),!e.t0){e.next=7;break}return e.next=5,this.attributeOverrides.apply(n.featureIds,i,r);case 5:n.attributeInfo=i,this._attributeValuesChanged(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_attributeValuesChanged",value:function(e){var t=this;e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,Object(O.k)(this._labeler)&&this._labeler.setNodeMetaAttributes(e,(function(e,i){return t._createAttributes(e,i)})),this._updateEngineObject(e)}},{key:"clearMemCache",value:function(){Object(O.k)(this._memCache)&&this._memCache.clear()}},{key:"getVisibleNodes",value:function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return Object(O.k)(t)&&e.push(t.node)})),e}},{key:"getLoadedNodeIndices",value:function(e){this._nodeId2Meta.forEach((function(t,i){return e.push(i)})),this._nodeId2MetaReloading.forEach((function(t,i){return e.push(i)}))}},{key:"preLoadBasis",value:function(){!Object(g.a)("disable-feature:i3s-basis")&&0!=(2&this.supportedTextureEncodings)&&Object(O.c)(this.i3slayer.textureSetDefinitions,(function(e){return e.some((function(e){return e.formats.some((function(e){return"basis"===e.format||"ktx2"===e.format}))}))}))&&Object(Ze.e)()}},{key:"_getVertexBufferLayout",value:function(e,t){var i={hasTexture:ct(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return Object(Je.a)(Object(Ye.a)(this._getGeometryParameters(i)))}},{key:"_getObjectIdField",value:function(){return this.i3slayer.objectIdField||"OBJECTID"}},{key:"_findGraphicNodeAndIndex",value:function(e){var t=Object(ze.a)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField()),i=null;return Object(_.c)(this._nodeId2Meta,(function(e){if(Object(O.j)(e))return!1;var r=e.featureIds.indexOf(t);return-1!==r&&(i={node:e.node,index:r},!0)})),i}},{key:"_getGraphicIndices",value:function(e,t){var i=this._nodeId2Meta.get(e.index);if(Object(O.j)(i))return[];var r,n=[],a=this._getObjectIdField(),s=this.i3slayer.fieldsIndex,o=Object(c.a)(t);try{for(o.s();!(r=o.n()).done;){var l=r.value,u=Object(ze.a)(s,l.attributes,a),d=i.featureIds.indexOf(u);-1!==d&&n.push(d)}}catch(h){o.e(h)}finally{o.f()}return n}},{key:"whenGraphicBounds",value:function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();var i=this._nodeId2Meta.get(t.node.index);if(Object(O.j)(i))return Promise.reject();var r=i.objectHandle,n=Object($.a)(t.index,this._collection,r,new Float64Array(24)),a=this.view.renderSpatialReference,s=this.view.spatialReference;if(Object(L.q)(n,a,0,n,s,0,8)){var o=Object(V.k)();return Object(V.n)(o,n,0,8),Promise.resolve({boundingBox:o,screenSpaceObjects:[]})}}},{key:"whenGraphicAttributes",value:function(e,t){var i=this;return Object(Ue.x)(this.i3slayer,e,this._getObjectIdField(),t,(function(){return Object(r.a)(i._nodeId2Meta.values()).filter(O.k)}))}},{key:"getGraphicFromIntersectorMetadata",value:function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return Object(O.j)(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}},{key:"_getCacheKey",value:function(e){return"".concat(this._layerUrl,"/v").concat(19,"/").concat(e.id).concat(this._cacheKeySuffix)}},{key:"_getMemCacheKey",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;return e+"#"+t}},{key:"_idbCacheEnabled",get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix}},{key:"loadCachedGPUData",value:function(e){return Object(O.k)(this._memCache)?this._memCache.pop(this._getMemCacheKey(e.index)):null}},{key:"deleteCachedGPUData",value:function(e){Object(O.k)(e)&&this._deleteComponentObject(e)}},{key:"_cacheGPUData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;if(Object(O.j)(this._memCache))this._deleteComponentObject(e);else{var i=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,i)}}},{key:"loadMissingTextures",value:function(e,t,i,r){var n=this,a=e.filter((function(e,i){if(0==(e.usage&n.rendererTextureUsage))return!1;if(Object(O.j)(t))return!0;var r=Object(Ve.f)(e.encodings,n.supportedTextureEncodings),a=t[i];return!!(Object(O.j)(a)||null==a.data||r&&a.encoding!==r.encoding)}));return 0===a.length?Promise.resolve(!1):i(a,r).then((function(i){for(var r=0,n=0;n<e.length;n++)r<i.length&&i[r].id===e[n].id&&(t[n]=i[r],r++);return!0}))}},{key:"loadCachedNodeData",value:function(e,t,i){var r=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((function(n){return null==n?null:n.nodeVersion!==e.version?(r._idbCache.remove(r._getCacheKey(e)),null):(e.geometryObb=n.geometryObb,r.loadMissingTextures(n.requiredTextures,n.textureData,i,t).then((function(i){return i&&r._idbCache.initialized&&Object(O.k)(n.textureData)&&(n.byteSize=ut(n.transformedGeometry,n.textureData),n.textureData.every(lt)&&dt(e,n)&&r._idbCache.put(r._getCacheKey(e),n).catch((function(t){return Xe.warn("Failed to update node with textures in IndexedDB cache: ".concat(e.id,": ").concat(t))}))),Object(x.x)(t),n})))})):Promise.resolve(null)}},{key:"addNode",value:function(e,t,i){var r=this;return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(function(){return r._transformNode(e,t,i).then((function(n){return r._safeReschedule((function(){if(Object(O.j)(n))return e.hasModifications=!1,r._addCachedNodeData(e,null,i);e.hasModifications=n.transformedGeometry.hasModifications;var a=n.obb,s=n.componentOffsets,c=n.featureIds,l=n.transformedGeometry,u=r._controller.crsIndex,d=r.view.renderSpatialReference,h=Object(Te.a)(e.mbs,r.elevationOffset,u,d);e.geometryObb=Object(Pe.e)([a.center.x,a.center.y,a.center.z],[a.extents.x,a.extents.y,a.extents.z],[a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w]),Object(P.s)(e.geometryObb.center,e.geometryObb.center,h),t.geometryData.componentOffsets=s,c&&(t.geometryData.featureIds=Array.prototype.slice.call(c));var f={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:l,globalTrafo:h,geometryObb:e.geometryObb,byteSize:ut(l,t.textureData)};if(r._idbCacheEnabled&&r._idbCache.initialized&&dt(e,f)){var b=Object(O.k)(f.textureData)?f.textureData.map((function(e){return lt(e)?e:null})):null;r._idbCache.put(r._getCacheKey(e),Object(o.a)(Object(o.a)({},f),{},{textureData:b})).catch((function(t){return Xe.warn("Failed to store node in IndexedDB cache: ".concat(e.id,": ").concat(t))}))}return r._addCachedNodeData(e,f,i)}),i)}))})):Promise.reject()}},{key:"computeVisibilityObb",value:function(e){return Object(Ue.h)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}},{key:"_transformNode",value:function(e,t,i){for(var r=t.geometryData.geometries,n=new Array(r.length),a=0;a<r.length;++a)n[a]=this._getVertexBufferLayout(r[a],t.geometryDescriptor);var s=e.mbs,o=this.elevationOffset,c=this._controller.crsIndex,l=this._controller.crsVertex,u=this.view.renderSpatialReference,d=Object(Te.b)(s,o,c),h=Object(Te.a)(s,o,c,u),f=Object(L.e)(c,l),b=Object(L.e)(l,u);if(Object(O.j)(f)||Object(O.j)(b))return Promise.resolve(null);var v={context:this.i3slayer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:n,localOrigin:d,globalTrafo:h,mbs:s,obb:e.serviceObb,elevationOffset:o,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:f,vertexToRenderProjector:b};return this._worker.invoke(v,i)}},{key:"supportsNodeCrossFading",get:function(){var e,t;return!(null!=(e=this.view)&&null!=(t=e._stage)&&t.renderView.hasShadowsEnabled)}},{key:"nodeCrossfadingEnabled",get:function(){return this.supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}},{key:"nodeFadeoutEnabled",get:function(){return this.supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}},{key:"_setNewNodeOpacity",value:function(e){var t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}},{key:"addCachedGPUData",value:function(e,t,i){if(e.geometryObb=Object(Pe.b)(this._collection.getComponentObb(t.objectHandle)),this._controller.isGeometryVisible(e)){Object(O.k)(this._labeler)&&this._addMetaToLabeler(this._labeler,t);var r=e.index;this._addNodeMeta(r,t),this.updateNodeState(r,i),this._collection.setObjectVisibility(t.objectHandle,1),this._updateMaterial(t),this._setNewNodeOpacity(t),this._updateEngineObject(t),this._highlights.objectCreated(t),Object(O.k)(this._treeDebugger)&&this._treeDebugger.update()}else this._cacheGPUData(t)}},{key:"addCachedNodeData",value:function(e,t,i,r){var n=this;return this._addData(e,i,(function(){return n._addCachedNodeData(e,t,r)}))}},{key:"_addCachedNodeData",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,c,l,u,d,h,f,b,v,y,p,m,_,j,x,k,w,I,C,S,N,P,A,V,T,U,G,H,q,B,z=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended&&this._controller.isGeometryVisible(t)){e.next=2;break}return e.abrupt("return",void this._removeNodeStageData(t.index,this.elevationOffset,this._nodeId2MetaReloading));case 2:if(!Object(O.j)(i)){e.next=4;break}return e.abrupt("return",void this._addNodeMeta(t.index,null));case 4:return n=this._addTasks.get(t.index),s=i.geometryData,o=i.transformedGeometry,c=i.globalTrafo,e.next=7,this.attributeOverrides.apply(s.featureIds,n.attributeInfo,r);case 7:if(l=Object(O.k)(i.textureData)?i.textureData.filter((function(e){return Object(O.k)(e)&&0!=(e.usage&z.rendererTextureUsage)})):[],e.t0=!Object(g.a)("disable-feature:i3s-basis")&&l.some((function(e){return Object(O.k)(e)&&(2===e.encoding||1===e.encoding)})),!e.t0){e.next=12;break}return e.next=12,Object(Ze.e)();case 12:return t.memory=0,u=s.componentOffsets,d=s.geometries,h=s.featureIds,f=this._collection,b=d[0],v=o.layout,y=o.indices,p=o.interleavedVertexData,m=o.positionData,_=o.hasColors,j=this._materialParameters(b,v),x=u||new Uint32Array([0,y?y.length:p.byteLength/v[0].stride]),k={vertices:{data:p,count:p.byteLength/v[0].stride,layoutParameters:j.geometryParams},positionData:{positions:m.data,indices:m.indices},indices:y,componentOffsets:x},w=b.transformation?Object(D.c)(b.transformation):Object(D.d)(),Object(E.m)(w,c,w),I=Object(E.v)(Object(R.e)(),w),C=Object(F.f)(Object(M.b)(),w),S=this.view.renderSpatialReference,N=this.view.basemapTerrain.spatialReference,P=Object(R.e)(),A=[1,1,1],Object(L.k)(I,S,A,N)||Xe.errorOnce("Unsupported coordinate system for IM overlay"),Object(L.z)(I,S,P,N),V=f.createObject({toMapSpace:[P[0],P[1],A[0],A[1]],geometry:k,obb:Object(O.t)(t.geometryObb),transform:{position:I,rotationScale:C}}),T=2===j.geometryParams.textureCoordinates,U=this._initMaterialAndTextures(V,j.material,l,T),t.memory+=this.memEstimateGeometryAdded(V),t.memory+=U.reduce((function(e,t){return e+(Object(O.k)(t)?z.memEstimateTextureAdded(t):0)}),0),G=!!j.material.hasParametersFromSource,H="blend"!==j.material.alphaMode&&j.material.metallicRoughness.baseColorFactor[3]>=1,q=new et(t,h,V,this._getInvalidRendererVersion(),n.attributeInfo,{hasParametersFromSource:G,isOpaque:H},U),n.meta=q,!this._hasTextures&&i.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||_,this._hasTextures=this._hasTextures||!!t.resources.texture,this.notifyChange("hasTexturesOrVertexColors"),B=this.slicePlaneEnabled,e.abrupt("return",this._addOrUpdateEdgeRendering(q).then((function(e){return Object(O.k)(e)&&e.updateObjectVisibility(q.objectHandle,!1),z._safeReschedule((function(){var i=z._addTasks.get(t.index);if(i)if(Object(O.k)(z._labeler)&&z._addMetaToLabeler(z._labeler,q),z._addNodeMeta(t.index,q),i.meta=null,z.suspended)z._removeNodeStageData(t.index,z.elevationOffset);else{f.setObjectVisibility(V,1),Object(O.k)(e)&&e.updateObjectVisibility(q.objectHandle,!0),q.attributeInfo=i.attributeInfo;var r=q.cachedRendererVersion!==z._rendererVersion,n=B!==z.slicePlaneEnabled;z._setObjectSymbolColors(q);var a=z._applyFiltersToNode(q);(r||Object(O.k)(e)&&(n||a))&&z._addOrUpdateEdgeRendering(q),z._visibleGeometryChanged(q),z._highlights.objectCreated(q),z._updateMaterial(q),z._setNewNodeOpacity(q),Object(O.k)(z._treeDebugger)&&z._treeDebugger.update()}}),r)})).catch((function(e){throw Object(O.k)(n.meta)&&(z._deleteComponentObject(n.meta),n.meta=null),e})));case 23:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_addNodeMeta",value:function(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){Xe.error("Removing duplicated node");var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._deleteComponentObject(i)}Object(O.k)(t)&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&ft(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t)}},{key:"_safeReschedule",value:function(e,t){return Object(x.x)(t),this._controller.reschedule(e,t)}},{key:"_materialParameters",value:function(e,t){var i=e.params.material,r=t.some((function(e){return"uvRegion"===e.name})),n=t.some((function(e){return"normalCompressed"===e.name})),a=ct(i);return{geometryParams:this._getGeometryParameters({hasTexture:a,hasNormals:n,hasRegions:r}),material:i}}},{key:"_initMaterialAndTextures",value:function(e,t,i,r){var n,a=this,s=this._stage.renderView,o=i.map((function(e){return Object(Ve.b)(e,t,r,s)})),l=Object(c.a)(o);try{for(l.s();!(n=l.n()).done;){var u=n.value;Object(O.k)(u)&&this._stage.add(u)}}catch(d){l.e(d)}finally{l.f()}return this._collection.updateMaterial(e,(function(e){Object(Ve.a)(e,t,o,i,a.view._stage.renderView.textureRepository,{rendererTextureUsage:a.rendererTextureUsage,usePBR:a._usePBR(),isIntegratedMesh:a._isIntegratedMesh,slicePlaneEnabled:a.slicePlaneEnabled,viewSpatialReference:a.view.spatialReference}),a._updateMaterialOverlay(e)})),o}},{key:"_getGeometryParameters",value:function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}}},{key:"_addData",value:function(e,t,i){var r=this,n=this._addTasks.get(e.index);return n?n.attributeInfo=t:(n=Object(o.a)(Object(o.a)({},Object(x.h)()),{},{attributeInfo:t,meta:null}),this._addTasks.set(e.index,n),i().then(n.resolve,n.reject).then((function(){return r._addTasks.delete(e.index)})).catch((function(t){throw r._addTasks.delete(e.index),t}))),n.promise}},{key:"_clearAddTasks",value:function(){var e=this;this._addTasks.forEach((function(t){Object(O.k)(t.meta)&&(e._deleteComponentObject(t.meta),t.meta=null)})),this._addTasks.clear()}},{key:"_clippingAreaChanged",value:function(){var e=Object(V.h)();Object(We.a)(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)}},{key:"_geometryFilterChange",value:function(){this._controller.geometryFilterChanged(this.hasGeometryFilter)}},{key:"hasGeometryFilter",get:function(){return!1}},{key:"_filterChange",value:function(){this._applyFilters(!1)}},{key:"_applyFilters",value:function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){Object(O.k)(e)&&t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t._visibleGeometryChanged(e))}))}},{key:"getFilters",value:function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,i){return e._boundingboxFilter(t,i,e._clippingArea)})),t}},{key:"addSqlFilter",value:function(e,t,i){var r=this;if(Object(O.k)(t)){var n=t.fieldNames;e.push((function(e,a){return r._sqlFilter(e,a,t,n,i)}))}}},{key:"_sqlFilter",value:function(e,t,i,r,n){var a={},s=this._createLayerGraphic(a),o=this.i3slayer.objectIdField,l=t.featureIds,u=Object(O.k)(t.attributeInfo)&&t.attributeInfo.attributeData;r.every((function(e){return null!=u[e]||e===o}))&&Object(Ue.j)(e,l,(function(e){a[o]=l[e];var d,h=Object(c.a)(r);try{for(h.s();!(d=h.n()).done;){var f=d.value;f!==o&&(a[f]=Object(Ue.n)(u[f],e))}}catch(b){h.e(b)}finally{h.f()}try{return i.testFeature(s)}catch(t){return n(t),!1}}))}},{key:"_boundingboxNodeTest",value:function(e,t){return Object(L.p)(e.node.mbs,this._controller.crsIndex,ot,this.view.renderSpatialReference),Object(Ue.s)(t,ot)}},{key:"_boundingboxFeatureTest",value:function(e,t,i){return Object(V.v)(i,this._collection.getComponentAabb(e.objectHandle,t,it))}},{key:"_boundingboxFilter",value:function(e,t,i){var r=this,n=this._collection,a=this._boundingboxNodeTest(t,i);if(3!==a)if(0!==a){var s=n.getComponentCount(t.objectHandle);if(s.invisible+s.visible===t.featureIds.length){var o=this._transformAABB(rt,i,t.objectHandle);Object(Ue.j)(e,t.featureIds,(function(e){return r._boundingboxFeatureTest(t,e,o)}))}}else e.length=0}},{key:"_transformAABB",value:function(e,t,i){var r=this._collection.getObjectTransform(i),n=r.position,a=r.rotationScale;return e[0]=(t[0]-n[0])/a[0],e[1]=(t[1]-n[1])/a[4],e[2]=(t[2]-n[2])/a[8],e[3]=(t[3]-n[0])/a[0],e[4]=(t[4]-n[1])/a[4],e[5]=(t[5]-n[2])/a[8],e}},{key:"_addOrUpdateEdgeRendering",value:function(e){var t=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Object(O.j)(this._edgeView))return Promise.resolve(null);var r=e.objectHandle,n=this._edgeView.hasObject(r),a=this._getFilteredEdgeMaterials(e),s=a.hasEdges,o=a.perFeatureEdgeMaterials,c={slicePlaneEnabled:this.slicePlaneEnabled};return s?n?(this.nodeCrossfadingEnabled&&ft(o,this.getNodeOpacity(e)),this._edgeView.updateAllComponentMaterials(r,o,c,i),this._edgeView.updateObjectVisibility(r,!0),Promise.resolve(this._edgeView)):this._collection.addEdges(r,this._edgeView,o,c).then((function(){return t._edgeView})):(n&&this._edgeView.removeObject(r),Promise.resolve(null))}},{key:"_removeEdgeRendering",value:function(e){Object(O.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)}},{key:"_applyFiltersToNode",value:function(e){return!!this._applyFiltersToNodeComponents(e)&&(Object(O.k)(this._labeler)&&this._labeler.applyFilterChange(e),!0)}},{key:"_applyFiltersToNodeComponents",value:function(e){var t=this._collection,i=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!i;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!i;var r=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,r),!0}},{key:"_updateCachedFilteredIds",value:function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}},{key:"_computeFilteredIds",value:function(e){var t,i=e.featureIds.slice(),r=Object(c.a)(this._filters);try{for(r.s();!(t=r.n()).done;){if((0,t.value)(i,e),0===i.length)break}}catch(n){r.e(n)}finally{r.f()}return i.length===e.featureIds.length?e.featureIds:i}},{key:"_computeFilteredComponentIndices",value:function(e){var t=new Array;return e.featureIds.forEach((function(i,r){e.filteredIds[t.length]===i&&t.push(r)})),t}},{key:"_removeAllNodeDataFromStage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._nodeId2Meta.forEach((function(i,r){return e._removeNodeStageData(r,t)})),this._nodeId2MetaReloading.forEach((function(i,r){return e._removeNodeStageData(r,t,e._nodeId2MetaReloading)}))}},{key:"removeNode",value:function(e){var t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading)}},{key:"_removeNodeStageData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodeId2Meta,r=i.get(e);Object(O.j)(r)?i.delete(e):(this._collection.setObjectVisibility(r.objectHandle,0),this._visibleGeometryChanged(r),this._removeEdgeRendering(r),Object(O.k)(this._labeler)&&this._labeler.removeNodeMeta(r),i.delete(e),this._highlights.objectDeleted(r),i===this._nodeId2Meta?(this._cacheGPUData(r,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(r)):this._deleteComponentObject(r),Object(O.k)(this._treeDebugger)&&this._treeDebugger.update())}},{key:"_deleteComponentObject",value:function(e){if(Object(O.k)(this._edgeView)&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures){var t,i=Object(c.a)(e.textures);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.memEstimateTextureRemoved(r),this._stage.remove(r)}}catch(n){i.e(n)}finally{i.f()}}}},{key:"updateNodeState",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._collection.updateMaterial(i.objectHandle,(function(e){return e.polygonOffsetEnabled=0===t}))}},{key:"_invalidateAllSymbols",value:function(){this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}},{key:"_getInvalidRendererVersion",value:function(){return Object(Ue.a)(this._rendererVersion,-1)}},{key:"_rendererChange",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var i,r,n,s,o,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._currentRenderer=t,this.notifyChange("rendererTextureUsage"),this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e.t0=t,!e.t0){e.next=12;break}return e.next=11,t.getRequiredFields(this.i3slayer.fieldsIndex);case 11:this._rendererFields=e.sent;case 12:if(this._updateSymbologyFields(),e.t1=!this._arcade&&t&&"arcadeRequired"in t&&t.arcadeRequired,!e.t1){e.next=18;break}return e.next=17,Object(B.e)();case 17:this._arcade=e.sent;case 18:if(!(t&&"visualVariables"in t&&t.visualVariables)){e.next=21;break}i=Object(c.a)(t.visualVariables);try{for(i.s();!(r=i.n()).done;)"color"===(n=r.value).type?this._colorVariable=n:"opacity"===n.type?this._opacityVariable=n:Xe.warn("Unsupported visual variable type for 3D Object Scene Services: ".concat(n.type))}catch(a){i.e(a)}finally{i.f()}case 21:if(t){s=Object(c.a)(t.getSymbols());try{for(s.s();!(o=s.n()).done;)"mesh-3d"!==(l=o.value).type&&Xe.error("Symbols of type '".concat(l.type,"' are not supported for 3D Object Scene Services."))}catch(a){s.e(a)}finally{s.f()}}this._controller&&this._controller.requestUpdate();case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getCachedEdgeMaterials",value:function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}},{key:"_getSymbolColors",value:function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,i){var r=5*e;Object(A.l)(i.externalColor,t[r+0]/255,t[r+1]/255,t[r+2]/255,t[r+3]/255),i.externalColorMixMode=15&t[r+4],i.castShadows=0!=(16&t[r+4]),i.pickable=0!=(32&t[r+4])}}},{key:"_getSymbolInfo",value:function(e,t){var i=e&&e.getSymbol(t,{arcade:this._arcade});if(!(i instanceof z.a))return null;var r=i.id;if(this._symbolInfos.has(r))return this._symbolInfos.get(r);var n=Object(Ue.q)(i);return this._symbolInfos.set(r,n),n}},{key:"_setSymbologyOverride",value:function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}},{key:"_updateSymbologyFields",value:function(){this._symbologyFields=Object(O.k)(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?Object(O.k)(this._rendererFields)&&this._rendererFields.length>0?Object(U.j)(this.i3slayer.fieldsIndex,[].concat(Object(r.a)(this._rendererFields),Object(r.a)(this._symbologyOverrideFields))):this._symbologyOverrideFields:this._rendererFields}},{key:"_updateCachedRendererData",value:function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,i={};t.attributes=i;var r=this._currentRenderer,n=Object(O.k)(e.attributeInfo)&&e.attributeInfo.attributeData,a=null!=e.featureIds?this.i3slayer.objectIdField:null,s=null!=n&&Object(O.k)(this._symbologyFields)&&this._symbologyFields.length>0,l=s?[]:null,u=s?[]:null;if(s&&Object(O.k)(this._symbologyFields)){var d,h=Object(c.a)(this._symbologyFields);try{for(h.s();!(d=h.n()).done;){var f=d.value,b=n[f];b&&(l.push(f),u.push(b))}}catch(M){h.e(M)}finally{h.f()}}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var v={color:at,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},y=this.fullOpacity,p=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):y,g=null,m=2,_=Ue.w,j=0,x=0;x<e.featureIds.length;x++){if(null!=a&&(i[a]=e.featureIds[x]),s)for(var k=0;k<l.length;k++)i[l[k]]=Object(Ue.n)(u[k],x);var w=this._getSymbolInfo(r,t),I=null,C=null;if(r&&"visualVariables"in r){if(this._colorVariable){var S=Object(q.getColor)(this._colorVariable,t,{color:st,arcade:this._arcade});S&&((I=at)[0]=S.r/255,I[1]=S.g/255,I[2]=S.b/255,this._opacityVariable||null===S.a||(C=S.a))}this._opacityVariable&&(C=Object(q.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(w&&w.material){var N=w.material;I=Object(O.j)(I)||Object(O.j)(C)?Object(pe.i)(I,C,N.color,N.alpha,$e,at):Object(pe.i)(I,C,null,null,$e,at)}if(Object(O.j)(I)&&((I=at)[0]=1,I[1]=1,I[2]=1,I[3]=1),v.pickable=!0,v.castShadows=!w||w.castShadows,v.colorMixMode=w&&w.material?w.material.colorMixMode:1,v.edgeMaterial=w?w.edgeMaterial:null,Object(O.k)(this._symbologyOverride)&&(v.color=I,this._symbologyOverride(t,v),I=v.color),Object(O.k)(v.edgeMaterial)){var F=I[3]<=0?0:I[3]>=1&&(e.material.isOpaque||3===v.colorMixMode)?2:1;v.edgeMaterial===g&&F===m||(_=Object(o.a)(Object(o.a)({},v.edgeMaterial),{},{opacity:p,objectTransparency:F}),g=v.edgeMaterial,m=F),e.cachedEdgeMaterials[x]=_}else e.cachedEdgeMaterials[x]=Ue.w;e.cachedSymbology[j+0]=Math.round(255*I[0]),e.cachedSymbology[j+1]=Math.round(255*I[1]),e.cachedSymbology[j+2]=Math.round(255*I[2]),e.cachedSymbology[j+3]=Math.round(255*I[3]),e.cachedSymbology[j+4]=v.colorMixMode|+v.castShadows<<4|+v.pickable<<5,j+=5}}}},{key:"_getFilteredEdgeMaterials",value:function(e){var t=this._getCachedEdgeMaterials(e);if(this.nodeCrossfadingEnabled||ft(t,this.fullOpacity),Object(O.j)(e.filteredIds))return{hasEdges:t.some((function(e){return e!==Ue.w})),perFeatureEdgeMaterials:t};var i=0,r=!1,n=t.map((function(t,n){return e.featureIds[n]!==e.filteredIds[i]?Ue.w:(r=r||t!==Ue.w,i++,t)}));return{hasEdges:r,perFeatureEdgeMaterials:n}}},{key:"_setObjectSymbolColors",value:function(e){if(this._hasSymbolColors){var t=e.objectHandle,i=this._getSymbolColors(e);this._collection.setComponentData(t,i),this._stage.renderView.setNeedsRender()}}},{key:"_reloadAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}},{key:"_opacityChange",value:function(e){var t=this;this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((function(i){Object(O.j)(i)||(t._collection.updateMaterial(i.objectHandle,(function(t){return t.objectOpacity=e})),ft(i.cachedEdgeMaterials,e),t._updateEdgeRendering(i))}))}},{key:"_updateMaterial",value:function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(e){e.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,e.usePBR=t._usePBR(),t._updateMaterialOverlay(e)}))}},{key:"_updateMaterialOverlay",value:function(e){}},{key:"_updateEngineObject",value:function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e)}},{key:"_slicePlaneEnabledChange",value:function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),Object(O.k)(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(i){Object(O.j)(i)||(t._collection.updateMaterial(i.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(i,!1))}))}},{key:"_updatePBR",value:function(){var e=this;this._nodeId2Meta.forEach((function(t){Object(O.j)(t)||e._collection.updateMaterial(t.objectHandle,(function(t){t.usePBR=e._usePBR()}))})),this._hasLoadedPBRTextures=!0}},{key:"_usePBR",value:function(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}},{key:"_updateEdgeRendering",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object(O.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}},{key:"_forAllNodes",value:function(e){this._nodeId2Meta.forEach(e)}},{key:"_forAllFeatures",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(_.c)(this._nodeId2Meta,(function(n){if(Object(O.j)(n))return!1;if(Object(O.k)(t))switch(t(n)){case 0:return!0;case 2:return!1}var a=1;switch(r){case 1:a=i._forAllFeaturesOfNode(n,e);break;case 0:a=i._forVisibleFeaturesOfNode(n,e);break;case 2:a=i._forAllFeaturesOfNodeInClippingArea(n,e)}return 0===a}))}},{key:"_forAllFeaturesOfNode",value:function(e,t){for(var i=1,r=e.featureIds,n=0;n<r.length;n++)if(0===(i=t(r[n],n,e)))return i;return i}},{key:"_forVisibleFeaturesOfNode",value:function(e,t){var i=1,r=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(n){return 1===(i=t(r[n],n,e))})),i}},{key:"_forAllFeaturesOfNodeInClippingArea",value:function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var i=this._boundingboxNodeTest(e,this._clippingArea);if(0===i)return 1;if(3===i)return this._forAllFeaturesOfNode(e,t);for(var r=e.featureIds,n=e.objectHandle,a=Object(Ue.o)(this._clippingArea,this._collection.getObjectTransform(n)),s=0;s<r.length;s++)if(this._boundingboxFeatureTest(e,s,a)){var o=t(r[s],s,e);if(0===o)return o}return 1}},{key:"_createAttributes",value:function(e,t){var i={};null!=t.featureIds&&(i[this._getObjectIdField()]=t.featureIds[e]);var r=Object(O.k)(t.attributeInfo)&&t.attributeInfo.attributeData;if(Object(O.k)(r))for(var n=0,a=Object.keys(r);n<a.length;n++){var s=a[n];i[s]=Object(Ue.n)(r[s],e)}return i}},{key:"_createGraphic",value:function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}},{key:"highlight",value:function(e){var t=this._highlights;if("number"==typeof e||e instanceof y.a?e=[e]:e instanceof p.a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y.a){var i=e,r=this.i3slayer.fieldsIndex,n=this._getObjectIdField(),a=i.map((function(e){return Object(ze.a)(r,e.attributes,n)})),s=t.acquireSet(),o=s.set,c=s.handle;return t.setFeatureIds(o,a),c}if("number"==typeof e[0]){var l=e,u=t.acquireSet(),d=u.set,h=u.handle;return t.setFeatureIds(d,l),h}}return ht}},{key:"_visibleGeometryChanged",value:function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=Object(k.b)((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))}},{key:"performanceInfo",get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};return Object(O.k)(this._memCache)&&(e.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e}},{key:"test",get:function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}}},{key:"getNodeOpacityByIndex",value:function(e){var t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}},{key:"getNodeOpacity",value:function(e){return Object(O.k)(e)?this._collection.getMaterial(e.objectHandle).objectOpacity:0}},{key:"isNodeFullyFadedIn",value:function(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}},{key:"getNodeCrossfadeMetaData",value:function(e){return this._nodeId2Meta.get(e)}},{key:"markNodeToRemove",value:function(e){this._controller&&this._controller.markNodeToRemove(e)}},{key:"removeMarkedNodes",value:function(){this._controller&&this._controller.removeMarkedNodes()}},{key:"foreachCrossfadeNode",value:function(e){this._nodeId2Meta.forEach((function(t,i){return e(i,t)}))}},{key:"fadeNode",value:function(e,t,i){if(this.nodeCrossfadingEnabled){var r=this._nodeId2Meta.get(e);Object(O.k)(r)&&this._crossfadeHelper.fadeNode(e,r,t,i)}}},{key:"setNodeOpacityByIndex",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._setNodeOpacity(i,t)}},{key:"_setNodeOpacity",value:function(e,t){this._collection.updateMaterial(e.objectHandle,(function(e){return e.objectOpacity=t})),this._setNodeEdgeOpacity(e,t)}},{key:"_setNodeEdgeOpacity",value:function(e,t){if(Object(O.k)(this._edgeView)&&e.cachedEdgeMaterials){ft(e.cachedEdgeMaterials,t);var i=e.objectHandle;this._edgeView.hasObject(i)&&this._edgeView.updateAllComponentOpacities(i,t)}}},{key:"_hasModifications",get:function(){return this._modifications&&this._modifications.length>0}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=e.length;if(this._hasModifications&&!(i<=0)&&!0===this._i3sWasmLoaded){var r=this.i3slayer.uid,n=function(e){if(0===e.length)return null;var t=10*e.length,i=new Float64Array(t);return e.forAll((function(e,t){var r=e.serviceObb;Object(O.j)(r)&&(r=nt,Object(P.m)(r.center,e.mbs),r.halfSize[0]=r.halfSize[1]=r.halfSize[2]=e.mbs[3]);var n=10*t;i[n+0]=r.center[0],i[n+1]=r.center[1],i[n+2]=r.center[2],i[n+3]=r.halfSize[0],i[n+4]=r.halfSize[1],i[n+5]=r.halfSize[2],i[n+6]=r.quaternion[0],i[n+7]=r.quaternion[1],i[n+8]=r.quaternion[2],i[n+9]=r.quaternion[3]})),i}(e);if(Object(O.k)(n)){var a={context:r,buffer:n.buffer};Object(ye.filterObbsForModificationsSync)(a);var s=new Float64Array(n.buffer);e.forAll((function(e,i){var r=s[i],n=Object(ye.interpretObbModificationResults)(r);e.imModificationImpact=n,0!==n&&t._controller.invalidateGeometryVisibility(e.index)}))}}}},{key:"notifyUpdate",value:function(){this.notifyChange("updating")}},{key:"notifyLODUpdate",value:function(){this._controller.notifyLODUpdate()}},{key:"isUpdating",value:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||Object(O.k)(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0}}]),n}(e);return Object(b.a)([Object(S.b)()],t.prototype,"_hasLoadedPBRTextures",void 0),Object(b.a)([Object(S.b)()],t.prototype,"_asyncModuleLoading",void 0),Object(b.a)([Object(S.b)()],t.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),Object(b.a)([Object(S.b)()],t.prototype,"view",void 0),Object(b.a)([Object(S.b)()],t.prototype,"i3slayer",void 0),Object(b.a)([Object(S.b)()],t.prototype,"_controller",void 0),Object(b.a)([Object(S.b)()],t.prototype,"_labeler",void 0),Object(b.a)([Object(S.b)()],t.prototype,"updating",void 0),Object(b.a)([Object(S.b)()],t.prototype,"suspended",void 0),Object(b.a)([Object(S.b)()],t.prototype,"holeFilling",void 0),Object(b.a)([Object(S.b)(Ke.a)],t.prototype,"updatingProgress",void 0),Object(b.a)([Object(S.b)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),Object(b.a)([Object(S.b)({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),Object(b.a)([Object(S.b)({readOnly:!0})],t.prototype,"rendererTextureUsage",null),Object(b.a)([Object(S.b)({readOnly:!0})],t.prototype,"elevationOffset",null),Object(b.a)([Object(S.b)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(S.b)()],t.prototype,"supportedTextureEncodings",null),Object(b.a)([Object(S.b)()],t.prototype,"uncompressedTextureDownsamplingEnabled",null),Object(b.a)([Object(S.b)({type:[H.a]})],t.prototype,"_modifications",void 0),t=Object(b.a)([Object(N.a)("esri.views.3d.layers.I3SMeshView3D")],t)},it=Object(V.h)(),rt=Object(V.h)(),nt=Object(Pe.e)(),at=[0,0,0,0],st=new v.a([0,0,0,0]),ot=[0,0,0,0];function ct(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function lt(e){return Object(O.k)(e)&&Object(w.c)(e.data)}function ut(e,t){var i=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(Object(O.k)(t)){var r,n=Object(c.a)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;Object(O.k)(a)&&Object(w.c)(a.data)&&(i+=a.data.byteLength)}}catch(s){n.e(s)}finally{n.f()}}return i}function dt(e,t){return t.byteSize>104857600?(Xe.warn("Node is too big to store in IndexedDB cache: ".concat(e.id," (").concat(t.byteSize," bytes)")),!1):t.byteSize>0}var ht={remove:function(){},pause:function(){},resume:function(){}};function ft(e,t){e.forEach((function(e){return e.opacity=t}))}},1123:function(e,t,i){"use strict";i.d(t,"a",(function(){return M}));var r,n=i(8),a=i.n(n),s=i(12),o=i(15),c=i(3),l=i(4),u=i(6),d=i(7),h=i(0),f=(i(112),i(32)),b=i(102),v=i(16),y=i(2),p=i(79),g=i(27),m=i(1),_=(i(17),i(18),i(9)),O=i(5),j=i(851),x=i(53),k=i(38),w=i(45),I=i(68),C=i(910),S=i(925),N=i(52),F=v.a.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter"),M=function(e){Object(u.a)(i,e);var t=Object(d.a)(i);function i(e){var r;return Object(c.a)(this,i),(r=t.call(this,e))._projectionEngineLoaded=!1,r}return Object(l.a)(i,[{key:"initialize",value:function(){var e=this;Object(g.k)(this,"filter.geometry").then((function(){return e.loadAsyncModule(function(){return D.apply(this,arguments)}().then((function(t){e.destroyed||(e._geometryEngine=t,e.applyFilters())})))}))}},{key:"sortedObjectIds",get:function(){if(Object(y.j)(this.filter.objectIds))return null;var e=new Float64Array(this.filter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){var e=Object(y.k)(this.filter)?this.filter.where:null;if(Object(y.j)(e)||!e)return null;try{return j.WhereClause.create(e,this.layerFieldsIndex)}catch(t){F.error("Failed to parse filter where clause: ".concat(t))}return null}},{key:"addFilters",value:function(e,t,i,n){var a=this.sortedObjectIds;Object(y.k)(a)&&e.push((function(e){return Object(C.t)(a,!0,e)})),this.addSqlFilter(e,this.parsedWhereClause);var o=this.parsedGeometry;if(Object(y.k)(o)){var c=this.spatialRelationship;e.push((function(e,a){return function(e,t,i,n,a,o,c){var l=o[0].spatialReference||n.spatialReference;if(!Object(x.p)(t.node.mbs,a,A,l))return void F.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");var u,d=L(A,l),h=function(e,t,i,n,a){var s=t.renderSpatialReference,o=new Map,c={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:i};c.rings[0][3]=c.rings[0][0];var l,u,d={indices:null,data:null,stride:0,startIndex:0,endIndex:0};switch(e){case"intersects":l=function(e,t){return r.intersects(e,t)?0:2},u=T;break;case"contains":l=function(e,t){return r.contains(e,t)?2:1},u=T;break;default:l=function(e,t){return r.disjoint(e,t)?2:1},u=U}return{collection:n,object:a,type:e,maskSR:i,renderSR:s,aabbCache:o,triangle:c,positions:d,triangleTest:l,geometryTest:u}}(c,n,l,i,t.objectHandle),f=Object(s.a)(o);try{var b=function(){var i=u.value;if(0===e.length)return{v:void 0};switch(V(i,d,c)){case 1:return{v:void(e.length=0)};case 0:return"continue"}Object(C.j)(e,t.featureIds,(function(e){return function(e,t,i){var r=i.collection,n=i.object,a=i.renderSR,s=i.maskSR,o=i.geometryTest,c=i.aabbCache,l=c.get(t);if(!l){var u=r.getObjectTransform(n);r.getComponentAabb(n,t,H);for(var d=[[H[0],H[1],0],[H[0],H[4],0],[H[3],H[4],0],[H[3],H[1],0]],h=0;h<4;++h)Object(O.z)(d[h],d[h],u.rotationScale),Object(O.h)(d[h],d[h],u.position),Object(x.z)(d[h],a,d[h],s);(l={rings:[d],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s}).rings[0][4]=l.rings[0][0],c.set(t,l)}switch(o(e,l)){case 1:return!1;case 0:return!0}var f=i.triangle,b=i.triangleTest,v=i.positions,y=f.rings[0][0],p=f.rings[0][1],g=f.rings[0][2],m=r.getObjectTransform(n);r.getComponentPositions(n,t,v);for(var _=v.indices,j=v.data,k=v.stride,w=v.startIndex,I=v.endIndex,C=w;C<I;C+=3){var S=k*_[C+0],N=k*_[C+1],F=k*_[C+2];Object(O.y)(y,j[S+0],j[S+1],j[S+2]),Object(O.y)(p,j[N+0],j[N+1],j[N+2]),Object(O.y)(g,j[F+0],j[F+1],j[F+2]),Object(O.z)(y,y,m.rotationScale),Object(O.z)(p,p,m.rotationScale),Object(O.z)(g,g,m.rotationScale),Object(O.h)(y,y,m.position),Object(O.h)(p,p,m.position),Object(O.h)(g,g,m.position),Object(x.z)(y,a,y,s),Object(x.z)(p,a,p,s),Object(x.z)(g,a,g,s);var M=p[0]-y[0],E=p[1]-y[1],D=g[0]-y[0],P=g[1]-y[1];if(!(Math.abs(M*P-E*D)<G))switch(delete f._geVersion,b(e,f)){case 1:return!1;case 0:return!0}}return"intersects"!==i.type}(i,e,h)}))};for(f.s();!(u=f.n()).done;){var v=b();if("continue"!==v&&"object"===typeof v)return v.v}}catch(y){f.e(y)}finally{f.f()}}(e,a,n,t,i,o,c)}))}}},{key:"isMBSGeoemtryVisible",value:function(e,t,i){var r=this.parsedGeometry;if(Object(y.k)(r)){var n=this.spatialRelationship,a=r[0].spatialReference||t;return Object(x.p)(e,i,A,a)?function(e,t,i,r){var n=L(e,i);return t.every((function(e){return 1!==V(e,n,r)}))}(A,r,a,n):(F.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}},{key:"parsedGeometry",get:function(){var e=this;if(Object(y.j)(this.filter))return null;if(!this._geometryEngine)return null;var t=this.filter.geometry;if(Object(y.j)(t))return null;var i=this.filter,r=i.distance,n=i.units,a=this.spatialRelationship,s="mesh"===t.type?t.extent:t;if(Object(y.j)(r)||0===r)return R(s,a);var o=n||Object(p.h)(s.spatialReference);if(s.spatialReference.isWGS84)return R(this._geometryEngine.geodesicBuffer(s,r,o),a);var c=Object(I.d)(s,N.a.WGS84);if(Object(y.k)(c))return R(Object(I.d)(this._geometryEngine.geodesicBuffer(c,r,o),s.spatialReference),a);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(Object(x.j)().then((function(){return e._projectionEngineLoaded=!0}))),!this._projectionEngineLoaded))return null;var l=null;try{l=Object(x.n)(s,N.a.WGS84)}catch(u){}if(l)try{l=Object(x.n)(this._geometryEngine.geodesicBuffer(l,r,o),s.spatialReference)}catch(u){l=null}return l||F.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry (".concat(s.spatialReference.wkid,") to WGS84.")),R(l,a)}},{key:"spatialRelationship",get:function(){return Object(y.k)(this.filter)?this.filter.spatialRelationship:"intersects"}}],[{key:"checkSupport",value:function(e){return e.timeExtent?(F.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&P.indexOf(e)>=0}(e.spatialRelationship)||(F.warn("Filters with spatialRelationship other than ".concat(P.join(", ")," are not supported for mesh scene layers")),!1)}}]),i}(f.a);function E(){return!!r}function D(){return(D=Object(o.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=E(),e.t0){e.next=5;break}return e.next=4,Promise.all([i.e(8),i.e(43)]).then(i.bind(null,1036));case 4:r=e.sent;case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Object(h.a)([Object(m.b)({type:S.a})],M.prototype,"filter",void 0),Object(h.a)([Object(m.b)()],M.prototype,"layerFieldsIndex",void 0),Object(h.a)([Object(m.b)()],M.prototype,"loadAsyncModule",void 0),Object(h.a)([Object(m.b)()],M.prototype,"applyFilters",void 0),Object(h.a)([Object(m.b)()],M.prototype,"addSqlFilter",void 0),Object(h.a)([Object(m.b)({readOnly:!0})],M.prototype,"sortedObjectIds",null),Object(h.a)([Object(m.b)({readOnly:!0})],M.prototype,"parsedWhereClause",null),Object(h.a)([Object(m.b)({readOnly:!0})],M.prototype,"parsedGeometry",null),Object(h.a)([Object(m.b)({readOnly:!0})],M.prototype,"spatialRelationship",null),Object(h.a)([Object(m.b)()],M.prototype,"_projectionEngineLoaded",void 0),Object(h.a)([Object(m.b)()],M.prototype,"_geometryEngine",void 0),M=Object(h.a)([Object(_.a)("esri.views.3d.layers.i3s.I3SMeshViewFilter")],M);var P=["contains","intersects","disjoint"];function R(e,t){if(Object(y.j)(e))return null;if("disjoint"===t&&"polygon"===e.type){var i=function(){for(var t=new Array(e.rings.length),i=0;i<e.rings.length;++i){var n=Object(w.t)(1/0,1/0,-1/0,-1/0);Object(w.r)(n,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:n}}t.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));for(var a=new Set,s=new b.a,o=function(e){for(var i=t[e],n=e+1;n<t.length;++n){var o=t[n];if(o.aabr[0]>=i.aabr[2])break;a.add(o)}a.forEach((function(e){if(i!==e)if(e.aabr[2]<=i.aabr[0])a.delete(e);else if(r.intersects(i,e)){i.rings=i.rings.concat(e.rings),Object(w.p)(i.aabr,e.aabr,i.aabr),delete i._geVersion,a.delete(e);var n=Object(b.g)(t,e,t.length,s);t.splice(n,1)}})),a.add(i)},c=0;c<t.length;++c)o(c);for(var l=0,u=t;l<u.length;l++){delete u[l].aabr}return{v:t}}();if("object"===typeof i)return i.v}return[e]}var A=[0,0,0,0];function L(e,t){var i={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=t.isWGS84||t.isWebMercator?r.geodesicBuffer(i,e[3],1):r.buffer(i,e[3],1);return n.type="polygon",n}function V(e,t,i){switch(i){case"intersects":case"contains":return T(e,t);case"disjoint":return U(e,t)}}function T(e,t){return r.intersects(e,t)?r.contains(e,t)?0:2:1}function U(e,t){return r.intersects(e,t)?r.contains(e,t)?1:2:0}var G=Math.pow(2,-32);var H=Object(k.h)()},1124:function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var r=i(8),n=i.n(r),a=i(15),s=i(3),o=i(4),c=i(6),l=i(7),u=i(0),d=i(32),h=i(20),f=i(55),b=i(2),v=i(1),y=(i(17),i(18),i(16),i(9)),p=i(61),g=i(966),m=i(209),_=i(163),O=g.a,j=function(e){Object(c.a)(i,e);var t=Object(l.a)(i);function i(e){var r;return Object(s.a)(this,i),(r=t.call(this,e))._dataQueryEngineInstance=null,r._handles=new f.a,r}return Object(o.a)(i,[{key:"defaultQueryJSON",get:function(){return new _.a({outSpatialReference:this.spatialReference}).toJSON()}},{key:"dataQueryEngine",get:function(){return this.ensureDataQueryEngine()}},{key:"initialize",value:function(){var e=this;this._handles.add(this.layerView.on("visible-geometry-changed",(function(){return e.spatialIndex.events.emit("changed")})))}},{key:"destroy",value:function(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}},{key:"executeQueryForCount",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=r.count,s=r.extent,e.abrupt("return",{count:a,extent:p.a.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this._ensureQueryJSON(t)).returnGeometry){e.next=3;break}throw new h.a("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");case 3:if(!r.returnCentroid){e.next=5;break}throw new h.a("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");case 5:return e.next=7,this.dataQueryEngine.executeQuery(r,i);case 7:return a=e.sent,s=m.default.fromJSON(a),e.abrupt("return",(s.features.forEach((function(e){e.geometry=null})),s));case 10:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e){if(Object(b.j)(e))return this.defaultQueryJSON;var t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}},{key:"ensureDataQueryEngine",value:function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((function(e){return e.toJSON()})),i=this.layerView.view.resourceController.scheduler,r=this.spatialReference.toJSON(),n=this.priority,a=this.spatialIndex;return this._dataQueryEngineInstance=new O({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:r,objectIdField:e,featureStore:a,scheduler:i,priority:n}),this._dataQueryEngineInstance}}]),i}(d.a);Object(u.a)([Object(v.b)({constructOnly:!0})],j.prototype,"layerView",void 0),Object(u.a)([Object(v.b)({constructOnly:!0})],j.prototype,"priority",void 0),Object(u.a)([Object(v.b)({constructOnly:!0})],j.prototype,"spatialIndex",void 0),Object(u.a)([Object(v.b)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],j.prototype,"spatialReference",void 0),Object(u.a)([Object(v.b)({readOnly:!0,aliasOf:"layerView.i3slayer"})],j.prototype,"layer",void 0),Object(u.a)([Object(v.b)({readOnly:!0})],j.prototype,"defaultQueryJSON",null);var x=j=Object(u.a)([Object(y.a)("esri.views.3d.layers.i3s.I3SQueryEngine")],j)},1125:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(31),n=i(3),a=i(4),s=i(2),o=i(38),c=i(901),l=i(246),u=i(910),d=function(){function e(t){Object(n.a)(this,e),this.objectIdField=t.objectIdField,this.getFeatureExtent=t.getFeatureExtent}return Object(a.a)(e,[{key:"getObjectId",value:function(e){return e.id}},{key:"getAttributes",value:function(e){var t=e.meta,i=e.index,r={};this.objectIdField&&(r[this.objectIdField]=e.id);var n=Object(s.k)(t.attributeInfo)&&t.attributeInfo.attributeData;if(Object(s.k)(n))for(var a=0,o=Object.keys(n);a<o.length;a++){var c=o[a];r[c]=Object(u.n)(n[c],i)}return r}},{key:"getAttribute",value:function(e,t){if(t===this.objectIdField)return e.id;var i=e.meta,r=e.index,n=Object(s.k)(i.attributeInfo)&&i.attributeInfo.attributeData;return Object(s.k)(n)?Object(u.n)(n[t],r):null}},{key:"getGeometry",value:function(e){if(e.geometry)return e.geometry;var t=this.getFeatureExtent(e,h),i=Object(r.a)(t,5),n=i[0],a=i[1],s=i[2],o=i[3],c=i[4];return new l.a([5],[n,a,s,o,a,s,o,c,s,n,c,s,n,a,s])}},{key:"getCentroid",value:function(e,t){if(e.geometry)return Object(c.a)(new l.a,e.geometry,t.hasZ,t.hasM);var i=this.getFeatureExtent(e,h),n=Object(r.a)(i,6),a=n[0],s=n[1],o=n[2],u=n[3],d=n[4],f=n[5];return new l.a([0],[(a+u)/2,(s+d)/2,(o+f)/2])}},{key:"cloneWithGeometry",value:function(e,t){return{id:e.id,index:e.index,meta:e.meta,geometry:t}}}]),e}(),h=Object(o.h)()},1126:function(e,t,i){"use strict";i.d(t,"a",(function(){return O}));var r=i(12),n=i(3),a=i(4),s=i(6),o=i(7),c=i(0),l=i(32),u=i(80),d=i(1),h=(i(17),i(18),i(16),i(9)),f=i(50),b=i(53),v=i(38),y=i(45),p=function(e){Object(s.a)(i,e);var t=Object(o.a)(i);function i(e){var r;return Object(n.a)(this,i),(r=t.call(this,e)).events=new u.a,r}return Object(a.a)(i,[{key:"forEach",value:function(e){this.forAllFeatures((function(t){return e(t),1}))}},{key:"forEachBounds",value:function(e,t,i){var n,a=this.getFeatureExtent,s=Object(r.a)(e);try{for(s.s();!(n=s.n()).done;){t(a(n.value,i))}}catch(o){s.e(o)}finally{s.f()}}},{key:"forEachInBounds",value:function(e,t){var i=this;this.forAllFeatures((function(r){var n=i.getFeatureExtent(r,m);return Object(y.w)(e,Object(v.F)(n,_))&&t(r),1}),(function(t){if(Object(b.p)(t.node.mbs,i.sourceSpatialReference,g,i.viewSpatialReference),g[0]>=e[0]&&g[2]<=e[2]&&g[1]>=e[1]&&g[3]<=e[3])return 1;var r=Math.max(e[0],Math.min(g[0],e[2])),n=Math.max(e[1],Math.min(g[1],e[3])),a=g[0]-r,s=g[1]-n;return a*a+s*s<=g[3]*g[3]?1:2}))}}]),i}(l.a);Object(c.a)([Object(d.b)({constructOnly:!0})],p.prototype,"featureAdapter",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],p.prototype,"forAllFeatures",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],p.prototype,"getFeatureExtent",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],p.prototype,"sourceSpatialReference",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],p.prototype,"viewSpatialReference",void 0),p=Object(c.a)([Object(h.a)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],p);var g=Object(f.e)(),m=Object(v.h)(),_=Object(y.l)(),O=p},1133:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return l}));var r=i(12),n=i(26),a=i(2),s=i(934),o={setAttribute:function(){},rollback:function(){},commit:function(){}};function c(e,t){var i=t.attributes[e.objectIdField],s=e.sessions.get(i);if(s)return s;var c=Object(n.a)(t.attributes),l=new Set;if(null==i)return o;var u=e.attributeOverrides.createInteractiveEditSession(i),d=new Map,h=function(e,t){var r=d.get(e);if(null==r){var n=t.indexOf(i);return d.set(e,n),n}return r},f=0,b={setAttribute:function(i,r){if(0===f){var n=e.fieldsIndex.get(i);if(!Object(a.j)(n)){var s=e.attributeStorageInfo.findIndex((function(e){return e.name===n.name}));if(!(s<0)){u.set(s,r);var o=e.attributeStorageInfo[s],c=!1;l.add(i),e.forEachNode((function(i,n){var a=h(i,n);if(-1!==a){var s=e.getAttributeData(i.index);if(s){var l=s[o.name];l&&(l[a]=r,e.setAttributeData(i.index,s,t),c=!0)}}})),c&&e.clearMemCache()}}}},rollback:function(){if(0===f){var t,n=Object(r.a)(l);try{for(n.s();!(t=n.n()).done;){var a=t.value;this.setAttribute(a,c[a])}}catch(s){n.e(s)}finally{n.f()}u.rollback(),f=1,e.sessions.delete(i)}},commit:function(){0===f&&(u.commit(),f=2,e.sessions.delete(i))}};return e.sessions.set(i,b),b}function l(e,t){var i=function(e,t){var i=t.edits.updateFeatures;if(!i||0===i.length)return new h;for(var n=function(e){var t=new Set;if(!e.updatedFeatures)return t;var i,n=Object(r.a)(e.updatedFeatures);try{for(n.s();!(i=n.n()).done;){var a=i.value;null!=a.objectId&&null==a.error&&t.add(a.objectId)}}catch(s){n.e(s)}finally{n.f()}return t}(t),a=new h,o=new Map,c=0;c<e.attributeStorageInfo.length;c++)o.set(e.attributeStorageInfo[c].name,c);var l=e.fieldsIndex,d=e.objectIdField,f=i.filter((function(e){var t=Object(s.a)(l,e.attributes,d);return n.has(t)}));return e.forEachNode((function(t,i){var n,o=new Set(i),c=Object(r.a)(f);try{for(c.s();!(n=c.n()).done;){var h=n.value,b=Object(s.a)(l,h.attributes,d);if(o.has(b)){var v=i.indexOf(b);for(var y in h.attributes){var p=e.fieldsIndex.normalizeFieldName(y),g=u(a,t.index,p),m=h.attributes[y];g.push({featureIndex:v,featureId:b,value:m})}}}}catch(_){c.e(_)}finally{c.f()}})),a}(e,t);if(0!==i.size){for(var n=new Map,o=0;o<e.attributeStorageInfo.length;o++)n.set(e.attributeStorageInfo[o].name,o);var c=!1;i.forEach((function(t,i){var s=e.getAttributeData(i),o=!1;t.forEach((function(t,i){var l,u=Object(a.k)(s)?s[i]:null,d=n.get(i),h=Object(r.a)(t);try{for(h.s();!(l=h.n()).done;){var f=l.value,b=f.featureIndex,v=f.value,y=f.featureId;u&&(u[b]=v,o=!0,c=!0),e.attributeOverrides.updateValue(y,d,v)}}catch(p){h.e(p)}finally{h.f()}})),o&&e.setAttributeData(i,s,null)})),c&&e.clearMemCache()}}function u(e,t,i){var r=function(e,t){var i=e.get(t);if(i)return i;var r=new d;return e.set(t,r),r}(e,t),n=r.get(i);if(n)return n;var a=new Array;return r.set(i,a),a}var d=Map,h=Map},1134:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(35),n=i(81);function a(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){var e=this.layer,t=this.layer.fieldsIndex,i=this.requiredFields;return e.outFields?Object(n.j)(t,[].concat(Object(r.a)(Object(n.v)(t,e.outFields)),Object(r.a)(i))):Object(n.j)(t,i)}}}}},1135:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(3),n=i(4),a=i(6),s=i(7),o=i(0),c=i(1),l=(i(17),i(18),i(16),i(307),i(91),function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).layer=null,e.filter=null,e}return Object(n.a)(i,[{key:"availableFields",get:function(){return[]}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){throw new Error("Not implemented")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("Not implemented")}},{key:"queryFeatures",value:function(e,t){throw new Error("Not implemented")}},{key:"queryObjectIds",value:function(e,t){throw new Error("Not implemented")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("Not implemented")}},{key:"createQuery",value:function(){throw new Error("Not implemented")}},{key:"queryExtent",value:function(e,t){throw new Error("Not implemented")}}]),i}(i(686).a));Object(o.a)([Object(c.b)()],l.prototype,"layer",void 0),Object(o.a)([Object(c.b)()],l.prototype,"availableFields",null),Object(o.a)([Object(c.b)()],l.prototype,"maximumNumberOfFeatures",null),Object(o.a)([Object(c.b)({readOnly:!0})],l.prototype,"maximumNumberOfFeaturesExceeded",null),Object(o.a)([Object(c.b)()],l.prototype,"filter",void 0)},1157:function(e,t,i){"use strict";i.d(t,"a",(function(){return k}));var r=i(8),n=i.n(r),a=i(15),s=i(35),o=i(3),c=i(4),l=i(6),u=i(7),d=i(0),h=i(32),f=i(16),b=i(91),v=i(9),y=i(464),p=function(e){var t=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(){var e;return Object(o.a)(this,i),(e=t.apply(this,arguments)).asyncUpdateState=new Map,e}return Object(c.a)(i,[{key:"autoUpdateAsync",value:function(e,t){var i=this;return function(e,t){var i=function(){a&&!s&&e(r)},r=function(){if(!a||s)return t();a.clear(),s=!0;var e=Object(b.b)(a,t);return s=!1,e},n=function(){a&&(a.destroy(),a=null)},a=new y.a(i),s=!1;return e(r),{remove:n}}((function(t){return i.updateAsync(e,t)}),t)}},{key:"updateAsync",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.startAsyncUpdate(t)){e.next=12;break}return e.prev=1,e.next=4,i();case 4:r=e.sent,this._set(t,r),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),f.a.getLogger(this.declaredClass).warn('Async update of "'.concat(t,'" failed. Async update functions should not throw exceptions.'));case 11:this.endAsyncUpdate(t)&&this.updateAsync(t,i);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"startAsyncUpdate",value:function(e){var t,i=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&i?(this.asyncUpdateState.set(e,2|i),!0):(this.asyncUpdateState.set(e,1|i),!1)}},{key:"endAsyncUpdate",value:function(e){var t,i=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&i?(this.asyncUpdateState.set(e,-3&i),!0):(this.asyncUpdateState.set(e,i),!1)}}]),i}(e);return t=Object(d.a)([Object(v.a)("esri.core.AsyncUpdate")],t)};var g=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(){return Object(o.a)(this,i),t.apply(this,arguments)}return i}(p(h.a));g=Object(d.a)([Object(v.a)("esri.core.AsyncUpdate")],g);var m=i(185),_=i(2),O=i(1),j=(i(17),i(18),i(81)),x=f.a.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields"),k=function(e){Object(l.a)(i,e);var t=Object(u.a)(i);function i(e){return Object(o.a)(this,i),t.call(this,e)}return Object(c.a)(i,[{key:"requiredFields",get:function(){var e=this.layerView,t=e.layer.fieldsIndex,i=e.definitionExpressionFields,r=this.rendererFields,n=this.labelingFields,a=this.viewFilterFields;return Object(j.j)(t,[].concat(Object(s.a)(Object(_.u)(i,[])),Object(s.a)(Object(_.u)(r,[])),Object(s.a)(Object(_.u)(n,[])),Object(s.a)(Object(_.u)(a,[]))))}},{key:"initialize",value:function(){var e=this,t=this.layerView.layer;this.layer=t,this.handles.add([this.autoUpdateAsync("rendererFields",(function(){var t=e.layer,i=t.fieldsIndex,r=t.renderer;return r?w((function(e){return r.collectRequiredFields(e,i)})):null})),this.autoUpdateAsync("labelingFields",(function(){var t=e.layer;return t.labelsVisible?w((function(e){return Object(j.g)(e,t)})):null})),this.autoUpdateAsync("viewFilterFields",(function(){var t=e.layerView,i=t.layer,r=t.filter;return w((function(e){return Object(j.f)(e,i,r)}))}))])}}]),i}(p(m.a));function w(e){return I.apply(this,arguments)}function I(){return(I=Object(a.a)(n.a.mark((function e(t){var i;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new Set,e.prev=1,e.next=4,t(i);case 4:return e.abrupt("return",Array.from(i).sort());case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",(x.error(e.t0),null));case 10:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}Object(d.a)([Object(O.b)()],k.prototype,"layerView",void 0),Object(d.a)([Object(O.b)()],k.prototype,"layer",void 0),Object(d.a)([Object(O.b)()],k.prototype,"requiredFields",null),Object(d.a)([Object(O.b)()],k.prototype,"rendererFields",void 0),Object(d.a)([Object(O.b)()],k.prototype,"labelingFields",void 0),Object(d.a)([Object(O.b)()],k.prototype,"viewFilterFields",void 0),k=Object(d.a)([Object(v.a)("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],k)},1303:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return T}));var r=i(12),n=i(3),a=i(4),s=i(47),o=i(44),c=i(6),l=i(7),u=i(0),d=i(119),h=i(16),f=i(2),b=i(1),v=(i(17),i(18),i(9)),y=i(851),p=i(163),g=i(1066),m=i(693),_=i(1133),O=i(997),j=i(1123),x=i(1124),k=i(1125),w=i(1126),I=i(910),C=i(1061),S=i(1134),N=i(1062),F=i(1157),M=i(498),E=i(1135),D=i(925),P=i(545),R=i(104),A=h.a.getLogger("esri.views.3d.layers.SceneLayerView3D"),L=Object(S.a)(),V=function(e){Object(c.a)(i,e);var t=Object(l.a)(i);function i(){var e;return Object(n.a)(this,i),(e=t.apply(this,arguments)).type="scene-layer-3d",e.lodFactor=1,e.progressiveLoadFactor=1,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!0,e._interactiveEditingSessions=new Map,e._queryEngine=null,e}return Object(a.a)(i,[{key:"filter",get:function(){return Object(f.k)(this.viewFilter)?this.viewFilter.filter:null},set:function(e){var t=this;!Object(f.j)(e)&&j.a.checkSupport(e)?Object(f.k)(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new j.a({filter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:function(e){return t._loadAsyncModule(e)},applyFilters:function(){return t._applyFilters(!0)},addSqlFilter:function(e,i){return t.addSqlFilter(e,i,t.logError)}}):this.viewFilter=null}},{key:"requiredFields",get:function(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}},{key:"floorFilterClause",get:function(){var e=Object(P.b)(this);return Object(f.k)(e)?y.WhereClause.create(e,this.layer.fieldsIndex):null}},{key:"lodCrossfadeinDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeinDuration)?e:0}},{key:"lodCrossfadeoutDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeoutDuration)?e:0}},{key:"lodCrossfadeUncoveredDuration",get:function(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeUncoveredDuration)?e:0}},{key:"initialize",value:function(){var e=this;this.fieldsHelper=new F.a({layerView:this}),this.updatingHandles.add(this.layer,"rangeInfos",(function(t){return e._rangeInfosChanged(t)}),2),this.updatingHandles.add(this.layer,"renderer",(function(t){return e.updatingHandles.addPromise(e._rendererChange(t))}),2);for(var t=0,i=["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds","floorFilterClause"];t<i.length;t++){var r=i[t];this.updatingHandles.add(this,r,(function(){return e._filterChange()}))}for(var n=0,a=["filter","viewFilter.parsedGeometry"];n<a.length;n++){var s=a[n];this.updatingHandles.add(this,s,(function(){return e._geometryFilterChange()}))}this.handles.add(this.layer.on("apply-edits",(function(t){return e.updatingHandles.addPromise(t.result)}))),this.handles.add(this.layer.on("edits",(function(t){return e._handleEdits(t)})))}},{key:"destroy",value:function(){this.fieldsHelper=Object(f.e)(this.fieldsHelper)}},{key:"_rangeInfosChanged",value:function(e){null!=e&&e.length>0&&A.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return Object(f.k)(this.filter)?this.filter.createQuery(e):new p.a(e)}},{key:"queryExtent",value:function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatureCount",value:function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatures",value:function(e,t){var i=this;return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((function(e){if(null==e||!e.features)return e;var t,n=i.layer,a=Object(r.a)(e.features);try{for(a.s();!(t=a.n()).done;){var s=t.value;s.layer=n,s.sourceLayer=n}}catch(o){a.e(o)}finally{a.f()}return e}))}},{key:"queryObjectIds",value:function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"_ensureQueryEngine",value:function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}},{key:"_createQueryEngine",value:function(){var e=this,t=Object(O.c)(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new x.a({layerView:this,priority:R.b.FEATURE_QUERY_ENGINE,spatialIndex:new w.a({featureAdapter:new k.a({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:t}),forAllFeatures:function(t,i){return e._forAllFeatures((function(e,i,r){return t({id:e,index:i,meta:r})}),i,2)},getFeatureExtent:t,sourceSpatialReference:Object(I.p)(this.layer),viewSpatialReference:this.view.spatialReference})})}},{key:"highlight",value:function(e){var t=this._highlights;if(e instanceof p.a){var r=t.acquireSet(),n=r.set,a=r.handle;return this.queryObjectIds(e).then((function(e){return t.setFeatureIds(n,e)})),a}return Object(s.a)(Object(o.a)(i.prototype),"highlight",this).call(this,e)}},{key:"createInteractiveEditSession",value:function(e){return Object(_.a)(this.attributeEditingContext,e)}},{key:"_createLayerGraphic",value:function(e){var t=new d.a(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t}},{key:"canResume",value:function(){return Object(s.a)(Object(o.a)(i.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)}},{key:"getFilters",value:function(){var e=Object(s.a)(Object(o.a)(i.prototype),"getFilters",this).call(this);return this.floorFilterClause&&this.addSqlFilter(e,this.floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),Object(f.k)(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}},{key:"_ensureQuery",value:function(e){return this._addDefinitionExpressionToQuery(Object(f.j)(e)?this.createQuery():p.a.from(e))}},{key:"attributeEditingContext",get:function(){var e=this;return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:function(t){return e._forAllNodes((function(e){return Object(f.k)(e)?t(e.node,e.featureIds):null}))},attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:function(t){return e.getAttributeData(t)},setAttributeData:function(t,i){return e.setAttributeData(t,i)},clearMemCache:function(){return e.clearMemCache()}}}},{key:"_handleEdits",value:function(e){Object(_.b)(this.attributeEditingContext,e)}},{key:"hasGeometryFilter",get:function(){var e=this.viewFilter;return Object(f.k)(e)&&Object(f.k)(e.parsedGeometry)}},{key:"computeNodeFiltering",value:function(e){var t=this.viewFilter;return Object(f.j)(t)||t.isMBSGeoemtryVisible(e,this.view.spatialReference,this._controller.crsIndex)?0:1}}]),i}(Object(g.a)(Object(C.a)(Object(N.a)(Object(m.a)(E.a)))));Object(u.a)([Object(b.b)({aliasOf:"layer"})],V.prototype,"i3slayer",void 0),Object(u.a)([Object(b.b)()],V.prototype,"suspended",void 0),Object(u.a)([Object(b.b)(M.a)],V.prototype,"updatingProgress",void 0),Object(u.a)([Object(b.b)({type:D.a})],V.prototype,"filter",null),Object(u.a)([Object(b.b)()],V.prototype,"viewFilter",void 0),Object(u.a)([Object(b.b)(L.requiredFields)],V.prototype,"requiredFields",null),Object(u.a)([Object(b.b)(L.availableFields)],V.prototype,"availableFields",void 0),Object(u.a)([Object(b.b)()],V.prototype,"fieldsHelper",void 0),Object(u.a)([Object(b.b)()],V.prototype,"floorFilterClause",null),Object(u.a)([Object(b.b)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],V.prototype,"lodFactor",void 0),Object(u.a)([Object(b.b)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],V.prototype,"updatingProgressValue",void 0);var T=V=Object(u.a)([Object(v.a)("esri.views.3d.layers.SceneLayerView3D")],V)},852:function(e,t,i){"use strict";i.r(t),i.d(t,"destroyContext",(function(){return x})),i.d(t,"dracoDecompressPointCloudData",(function(){return v})),i.d(t,"filterObbsForModifications",(function(){return p})),i.d(t,"filterObbsForModificationsSync",(function(){return C})),i.d(t,"initialize",(function(){return F})),i.d(t,"interpretObbModificationResults",(function(){return I})),i.d(t,"process",(function(){return f})),i.d(t,"setLegacySchema",(function(){return O})),i.d(t,"setModifications",(function(){return m})),i.d(t,"setModificationsSync",(function(){return k})),i.d(t,"test",(function(){return M}));var r,n,a,s=i(8),o=i.n(s),c=i(15),l=i(2),u=i(109),d=i(94);function h(e){return Object(d.b)("esri/libs/i3s/".concat(e))}function f(e){return b.apply(this,arguments)}function b(){return(b=Object(c.a)(o.a.mark((function e(t){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:return i=[t.geometryBuffer],e.abrupt("return",{result:w(t,i),transferList:i});case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e){return y.apply(this,arguments)}function y(){return(y=Object(c.a)(o.a.mark((function e(t){var i,r,n,s,c,l,d,h,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:if(r=[t.geometryBuffer],n=t.geometryBuffer,s=n.byteLength,c=a._malloc(s),(l=new Uint8Array(a.HEAPU8.buffer,c,s)).set(new Uint8Array(n)),d=a.dracoDecompressPointCloudData(c,l.byteLength),a._free(c),!(d.error.length>0)){e.next=7;break}throw"i3s.wasm: ".concat(d.error);case 7:return h=(null==(i=d.featureIds)?void 0:i.length)>0?Object(u.m)(d.featureIds):null,f=Object(u.m)(d.positions),h&&r.push(h.buffer),r.push(f.buffer),e.abrupt("return",{result:{positions:f,featureIds:h},transferList:r});case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e){return g.apply(this,arguments)}function g(){return(g=Object(c.a)(o.a.mark((function e(t){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:return C(t),i={buffer:t.buffer},e.abrupt("return",{result:i,transferList:[i.buffer]});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e){return _.apply(this,arguments)}function _(){return(_=Object(c.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:k(t);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function O(e){return j.apply(this,arguments)}function j(){return(j=Object(c.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,F();case 2:a.setLegacySchema(t.context,t.jsonSchema);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){S(e)}function k(e){for(var t=e.modifications,i=a._malloc(8*t.length),r=new Float64Array(a.HEAPU8.buffer,i,t.length),n=0;n<t.length;++n)r[n]=t[n];a.setModifications(e.context,i,t.length,e.isGeodetic),a._free(i)}function w(e,t){if(!a)return null;var i=e.context,r=e.localOrigin,n=e.globalTrafo,s=e.mbs,o=e.obb,c=e.elevationOffset,d=e.geometryBuffer,h=e.geometryDescriptor,f=e.indexToVertexProjector,b=e.vertexToRenderProjector,v=a._malloc(d.byteLength),y=a._malloc(33*Float64Array.BYTES_PER_ELEMENT),p=new Uint8Array(a.HEAPU8.buffer,v,d.byteLength);p.set(new Uint8Array(d));var g=new Float64Array(a.HEAPU8.buffer,y,33);N(g,r);var m=g.byteOffset+3*g.BYTES_PER_ELEMENT,_=new Float64Array(g.buffer,m);N(_,n),m+=16*g.BYTES_PER_ELEMENT,N(_=new Float64Array(g.buffer,m),s),m+=4*g.BYTES_PER_ELEMENT,Object(l.k)(o)&&(N(_=new Float64Array(g.buffer,m),o.center),m+=3*g.BYTES_PER_ELEMENT,N(_=new Float64Array(g.buffer,m),o.halfSize),m+=3*g.BYTES_PER_ELEMENT,N(_=new Float64Array(g.buffer,m),o.quaternion));var O=h,j={isDraco:!1,isLegacy:!1,color:e.layouts.some((function(e){return e.some((function(e){return"color"===e.name}))})),normal:e.needNormals&&e.layouts.some((function(e){return e.some((function(e){return"normalCompressed"===e.name}))})),uv0:e.layouts.some((function(e){return e.some((function(e){return"uv0"===e.name}))})),uvRegion:e.layouts.some((function(e){return e.some((function(e){return"uvRegion"===e.name}))})),featureIndex:O.featureIndex},x=a.process(i,!!e.obb,v,p.byteLength,O,j,y,c,f,b,e.normalReferenceFrame);if(a._free(y),a._free(v),x.error.length>0)throw"i3s.wasm: ".concat(x.error);if(x.discarded)return null;var k=x.componentOffsets.length>0?Object(u.m)(x.componentOffsets):null,w=x.featureIds.length>0?Object(u.m)(x.featureIds):null,I=Object(u.m)(x.interleavedVertedData).buffer,C=1===x.indicesType?Object(u.m)(new Uint16Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/2)):Object(u.m)(new Uint32Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/4)),S=Object(u.m)(x.positions),F=1===x.positionIndicesType?Object(u.m)(new Uint16Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/2)):Object(u.m)(new Uint32Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/4)),M={layout:e.layouts[0],interleavedVertexData:I,indices:C,hasColors:x.hasColors,hasModifications:x.hasModifications,positionData:{data:S,indices:F}};return w&&t.push(w.buffer),k&&t.push(k.buffer),t.push(I),t.push(C.buffer),t.push(S.buffer),t.push(F.buffer),{componentOffsets:k,featureIds:w,transformedGeometry:M,obb:x.obb}}function I(e){return 0===e?0:1===e?1:2===e?2:3}function C(e){var t=e.context,i=e.buffer,r=a._malloc(i.byteLength),n=i.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(a.HEAPU8.buffer,r,n),o=new Float64Array(i);s.set(o),a.filterOBBs(t,r,n),o.set(s),a._free(r)}function S(e){a&&a.destroy(e)}function N(e,t){for(var i=0;i<t.length;++i)e[i]=t[i]}function F(){return a?Promise.resolve():(n||(n=(r||(r=new Promise((function(e){return i.e(123).then(i.bind(null,1353)).then((function(e){return e.i})).then((function(t){var i=(0,t.default)({locateFile:h,onRuntimeInitialized:function(){return e(i)}});delete i.then}))})).catch((function(e){return Promise.reject(e)}))),r).then((function(e){a=e,n=null}))),n)}var M={transform:w,destroy:S}},925:function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var r,n=i(14),a=i(3),s=i(4),o=i(6),c=i(7),l=i(0),u=i(112),d=i(164),h=i(57),f=i(25),b=i(26),v=i(1),y=(i(18),i(17),i(16),i(9)),p=i(43),g=i(77),m=i(163),_=new h.a({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),O=new h.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),j=r=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).where=null,r.geometry=null,r.spatialRelationship="intersects",r.hiddenIds=new Set,r.distance=void 0,r.objectIds=null,r.units=null,r.timeExtent=null,r.enabled=!1,r}return Object(s.a)(i,[{key:"writeWhere",value:function(e,t){t.where=e||"1=1"}},{key:"enable",value:function(){this._set("enabled",!0)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.where,i=this.geometry,r=this.spatialRelationship,a=this.timeExtent,s=this.objectIds,o=this.units,c=this.distance;return new m.a(Object(n.a)({geometry:Object(b.a)(i),objectIds:Object(b.a)(s),spatialRelationship:r,timeExtent:Object(b.a)(a),where:t,units:o,distance:c},e))}},{key:"clone",value:function(){var e=this.where,t=this.geometry,i=this.spatialRelationship,n=this.hiddenIds,a=this.timeExtent,s=this.objectIds,o=this.units,c=this.distance,l=new Set;return n.forEach((function(e){return l.add(e)})),new r({geometry:Object(b.a)(t),hiddenIds:l,objectIds:Object(b.a)(s),spatialRelationship:i,timeExtent:Object(b.a)(a),where:e,units:o,distance:c})}}]),i}(f.a);Object(l.a)([Object(v.b)({type:String})],j.prototype,"where",void 0),Object(l.a)([Object(p.a)("where")],j.prototype,"writeWhere",null),Object(l.a)([Object(v.b)({types:u.a,json:{read:g.a,write:!0}})],j.prototype,"geometry",void 0),Object(l.a)([Object(v.b)({type:String,json:{read:{source:"spatialRel",reader:_.read},write:{target:"spatialRel",writer:_.write}}})],j.prototype,"spatialRelationship",void 0),Object(l.a)([Object(v.b)({json:{write:function(e,t,i){return t[i]=Array.from(e)},read:function(e){return new Set(e)}}})],j.prototype,"hiddenIds",void 0),Object(l.a)([Object(v.b)({type:Number,json:{write:{overridePolicy:function(e){return{enabled:e>0}}}}})],j.prototype,"distance",void 0),Object(l.a)([Object(v.b)({type:[Number],json:{write:!0}})],j.prototype,"objectIds",void 0),Object(l.a)([Object(v.b)({type:String,json:{read:O.read,write:{writer:O.write,overridePolicy:function(e){return{enabled:e&&this.distance>0}}}}})],j.prototype,"units",void 0),Object(l.a)([Object(v.b)({type:d.a,json:{write:!0}})],j.prototype,"timeExtent",void 0),Object(l.a)([Object(v.b)({readOnly:!0})],j.prototype,"enabled",void 0);var x=j=r=Object(l.a)([Object(y.a)("esri.views.layers.support.FeatureFilter")],j)},934:function(e,t,i){"use strict";function r(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){var i=t.toLowerCase();for(var r in e)if(r.toLowerCase()===i)return e[r];return null}(t,i);var r=e.get(i);return r?t[r.name]:null}i.d(t,"a",(function(){return r}))},942:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return l}));var r=i(8),n=i.n(r),a=i(35),s=i(15),o=i(2),c=i(81);function l(e){return u.apply(this,arguments)}function u(){return u=Object(s.a)(n.a.mark((function e(t){var i,r,s,l,u,d,h,f,b,v=arguments;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=v.length>1&&void 0!==v[1]?v[1]:t.popupTemplate,Object(o.k)(i)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,i.getRequiredFields(t.fieldsIndex);case 5:if(r=e.sent,s=i.lastEditInfoEnabled,l=t.objectIdField,u=t.typeIdField,d=t.globalIdField,h=t.relationships,!r.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,Object(c.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,b=Object(c.j)(t.fieldsIndex,[].concat(Object(a.a)(r),Object(a.a)(f))),e.abrupt("return",(u&&b.push(u),b&&l&&t.fieldsIndex.has(l)&&-1===b.indexOf(l)&&b.push(l),b&&d&&t.fieldsIndex.has(d)&&-1===b.indexOf(d)&&b.push(d),h&&h.forEach((function(e){var i=e.keyField;b&&i&&t.fieldsIndex.has(i)&&-1===b.indexOf(i)&&b.push(i)})),b));case 23:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}function d(e,t){return e.popupTemplate?e.popupTemplate:Object(o.k)(t)&&t.defaultPopupTemplateEnabled&&Object(o.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},997:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return l}));var r=i(2),n=i(5),a=i(11),s=i(53),o=i(38);function c(e,t,i,r){for(var a=t.getComponentAabb(i,e,d),s=t.getObjectTransform(i),o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=4&o?a[2]:a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),r[3*o]=h[0],r[3*o+1]=h[1],r[3*o+2]=h[2];return r}function l(e,t,i){var n=new Float64Array(24);return function(a){var l=a.meta.featureExtents;if(Object(r.j)(l)){l=new Float64Array(6*a.meta.featureIds.length),a.meta.featureExtents=l;for(var u=0;u<l.length;u+=6)l[u]=Number.POSITIVE_INFINITY}var d=new Float64Array(l.buffer,6*a.index*Float64Array.BYTES_PER_ELEMENT,6);return d[0]===Number.POSITIVE_INFINITY&&(c(a.index,i,a.meta.objectHandle,n),Object(s.q)(n,t,0,n,e,0,8)?(Object(o.B)(d,o.a),Object(o.n)(d,n,0,8)):Object(o.B)(d,o.c)),d}}function u(e,t,i,r){var a=t.getComponentAabb(i,e,d),s=t.getObjectTransform(i);r[0]=0,r[1]=0,r[2]=0;for(var o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),r[0]+=h[0],r[1]+=h[1],r[2]+=h[2];return r[0]/=8,r[1]/=8,r[2]/=8,r}var d=Object(o.h)(),h=Object(a.e)()},998:function(e,t,i){"use strict";i.d(t,"a",(function(){return k})),i.d(t,"b",(function(){return O})),i.d(t,"c",(function(){return v})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return w})),i.d(t,"f",(function(){return I}));var r=i(21),n=i(17),a=i(24),s=i(2),o=i(3),c=i(4),l=function(){function e(t,i){var r=this;Object(o.a)(this,e),this._textureRep=t,this._textureId=i,this._textureRef=Object(s.c)(this._textureId,(function(e){return r._textureRep.acquire(e)}))}return Object(c.a)(e,[{key:"dispose",value:function(){var e=this;this._textureRef=Object(s.c)(this._textureId,(function(t){e._textureRep.release(t)}))}},{key:"bind",value:function(e,t,i){if(Object(s.k)(this._textureRef)){var r=this._textureRef.glTexture;e.bindTexture(r,t),e.setUniform2f(i,r.descriptor.width,r.descriptor.height)}}}]),e}(),u=i(331),d=i(125),h=i(59);var f,b=i(237);function v(e,t){var i=new Map,r=function(e,t){if(Object(s.j)(e))return-1;if(i.has(e.id)){var r=i.get(e.id);return r.usage|=t,r.id}var n=i.size;return i.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,o=t.emissiveFactor,c=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),l=c?u.a[0]:n?n.metallicFactor:1,d=c?u.a[1]:n?n.roughnessFactor:1,h="mask"===t.alphaMode?33:1,f={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,h),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,2),metallicFactor:l,roughnessFactor:d},b={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:r(t.normalTexture,4),emissiveTextureId:r(t.emissiveTexture,16),occlusionTextureId:r(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:c},v=[];return i.forEach((function(t,i){var r=t.usage,n=Object(s.k)(e)&&e[i]&&e[i].formats,a=n?y(n.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:p[i]}}))):[];v.push({id:i,usage:r,encodings:a})})),{material:b,textures:v}}function y(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var p={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},g=(f={},Object(r.a)(f,b.a.KTX2_ENCODING,2),Object(r.a)(f,b.a.BASIS_ENCODING,2),Object(r.a)(f,b.a.DDS_ENCODING,4),Object(r.a)(f,"image/png",8),Object(r.a)(f,"image/jpg",16),Object(r.a)(f,"image/jpeg",16),Object(r.a)(f,"image/ktx",32),f);function m(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],n=i&&e.textureDefinitions[i],s=_();if(null!=r){var o=r.params;o.diffuse&&(s.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(s.doubleSided=o.doubleSided,s.cullFace=o.doubleSided?0:2),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(s.cullFace="none"===o.cullFace?0:"back"===o.cullFace?2:1),o.transparency&&(s.metallicRoughness.baseColorFactor[3]=Object(a.f)(1-o.transparency,0,1)),(o.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}var c=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(s.wrapTextures=!0);var l=1;"rgba"===n.channels&&(s.alphaMode="blend",l|=32);var u=n.images.length-1,d=n.images[u],h=function(e){return e&&e.split("/").pop()},f=Array.isArray(n.encoding)?y(n.encoding.map((function(e,t){return{name:h(d.href[t]),encoding:g[e]||0}}))):[{name:h(d.href),encoding:g[n.encoding]||0}];c.push({id:0,usage:l,encodings:f}),s.metallicRoughness.baseColorTextureId=0}return{material:s,textures:c}}var _=function(){return{alphaMode:"opaque",alphaCutoff:d.b,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function O(e,t,i,r){if(Object(s.j)(e)||null==e.data)return null;var n=e.data,o=!(n instanceof HTMLImageElement)||Object(a.l)(n.width)&&Object(a.l)(n.height),c=r.renderingContext.parameters.maxMaxAnisotropy,l=i&&!r.capabilities.shaderTextureLOD?1:c,u=o&&!e.downsampled&&l>1,d=i||!t.wrapTextures?j:x,h=function(e){switch(e){case 1:return b.a.KTX2_ENCODING;case 2:return b.a.BASIS_ENCODING;case 4:return b.a.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),f=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new b.a(n,{mipmap:u,maxAnisotropy:l,encoding:h,wrap:d,components:f,noUnpackFlip:!0})}var j={s:33071,t:33071},x={s:10497,t:10497};function k(e,t,i,r,n,o){var c=o.rendererTextureUsage,u=function(e){return function(e,t,i){if(Object(s.j)(e)||0===i)return null;for(var r=0;r<e.length;r++){var n=e[r];if(Object(s.k)(n)&&0!=(n.usage&i))return t[r].id}return null}(r,i,e&c)},f=t.metallicRoughness.baseColorFactor,b=Object(a.f)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[f[0],f[1],f[2],b],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=o.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=o.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:d.b,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var v=u(33);v&&(e.baseColorTexture=new l(n,v));var y=u(2);y&&(e.metallicRoughnessTexture=new l(n,y));var p=u(16);p&&(e.emissionTexture=new l(n,p));var g=u(8);g&&(e.occlusionTexture=new l(n,g));var m=u(4);m&&(e.normalTexture=new l(n,m)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&Object(h.i)(e)?2:e&&Object(h.j)(e)?3:1}(o.viewSpatialReference)}function w(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,r=Object(n.a)("disable-feature:i3s-basis")?0:3;return 24|(t?4|r:0)|(i?r:0)}function I(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}},999:function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r=i(8),n=i.n(r),a=i(15),s=i(14),o=i(12),c=i(2),l=i(718),u=i(34),d=i(552),h=i(236),f=i(190),b=i(1);function v(e){return y[function(e){return e instanceof Blob?e.type:function(e){var t=Object(u.n)(e);return m[t]||p}(e.url)}(e)]||g}var y={},p="text/plain",g=y[p],m={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(var _ in m)y[m[_]]=_;var O=i(150);function j(e){var t=Object(c.k)(e)&&e.origins?e.origins:[void 0];return function(i,r){var n,a=function(e,t,i){if(Object(c.k)(e)&&"resource"===e.type)return function(e,t,i){var r=Object(h.b)(t,i);return{type:String,read:function(e,t,i){var n=Object(O.d)(e,t,i);return r.type===String?n:"function"==typeof r.type?new r.type({url:n}):void 0},write:{writer:function(t,n,a,o){if(!o||!o.resources)return"string"==typeof t?void(n[a]=Object(O.e)(t,o)):void(n[a]=t.write({},o));var d=function(e){return Object(c.j)(e)?null:"string"==typeof e?e:e.url}(t),h=d?Object(O.e)(d,Object(s.a)(Object(s.a)({},o),{},{verifyItemRelativeUrls:o&&o.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null}),1):null,b=r.type!==String&&(!Object(l.a)(this)||o&&o.origin&&this.originIdOf(i)>Object(f.d)(o.origin));o&&o.portalItem&&Object(c.k)(h)&&!Object(u.s)(h)?b?function(e,t,i,r,n,a,s,o){var c=s.portalItem.resourceFromPath(r),l=w(i,r,s);v(l)===Object(u.n)(c.path)?(k(e,t,c,l,s.resources.toUpdate),n[a]=r):x(e,t,i,r,n,a,s,o)}(this,i,t,h,n,a,o,e):function(e,t,i,r){r.resources.toKeep.push({resource:r.portalItem.resourceFromPath(e)}),t[i]=e}(h,n,a,o):o&&o.portalItem&&(Object(c.j)(h)||Object(c.k)(Object(O.b)(h))||Object(u.t)(h)||b)?x(this,i,t,h,n,a,o,e):n[a]=h}}}}(e,t,i);switch(Object(c.k)(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":return{read:O.c.read,write:O.c.write}}}(e,i,r),d=Object(o.a)(t);try{for(d.s();!(n=d.n()).done;){var y=n.value,p=Object(b.c)(i,y,r);for(var g in a)p[g]=a[g]}}catch(m){d.e(m)}finally{d.f()}}}function x(e,t,i,r,n,a,s,o){var l=Object(d.a)(),h=w(i,r,s),f=Object(u.z)(Object(c.i)(o,"prefix"),l),b="".concat(f,".").concat(v(h)),y=s.portalItem.resourceFromPath(b);Object(u.t)(r)&&s.resources.pendingOperations.push(function(e){return I.apply(this,arguments)}(r).then((function(e){y.path="".concat(f,".").concat(v(e)),n[a]=y.itemRelativeUrl})).catch((function(){}))),k(e,t,y,h,s.resources.toAdd),n[a]=y.itemRelativeUrl}function k(e,t,i,r,n){n.push({resource:i,content:r,finish:function(i){!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function w(e,t,i){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(i))],{type:"application/json"})}function I(){return(I=Object(a.a)(n.a.mark((function e(t){var r,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(i.bind(null,69));case 2:return r=e.sent.default,e.next=5,r(t,{responseType:"blob"});case 5:return a=e.sent,s=a.data,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=63.de369acd.chunk.js.map