(function(){var e={"esri/views/3d/layers/SceneLayerGraphicsView3D":1378,"esri/views/3d/layers/i3s/I3SUtil":1395,"esri/views/layers/support/popupUtils":1398,"esri/views/layers/support/FeatureFilter":1406,"esri/views/3d/layers/i3s/I3SBinaryReader":1430,"esri/views/3d/layers/graphics/Graphics3DElevationAlignment":1445,"esri/views/3d/layers/graphics/ExtentSet":1446,"esri/views/3d/layers/graphics/Graphics3DObjectStates":1447,"esri/views/3d/layers/graphics/Graphics3DObjectStateSet":1448,"esri/views/3d/layers/support/attributeUtils":1449,"esri/views/3d/layers/i3s/I3SProjectionUtil":1450,"esri/views/3d/layers/i3s/LEPCC":1459,"esri/views/3d/layers/graphics/QueryEngine":1460,"esri/views/3d/layers/graphics/Graphics3DFrustumVisibility":1477,"esri/views/3d/layers/graphics/Graphics3DFeatureLikeLayerView":1533,"esri/views/3d/layers/graphics/Graphics3DFilterVisibility":1534,"esri/layers/graphics/controllers/I3SOnDemandController":1535,"esri/views/3d/layers/i3s/I3SFrameTask":1536,"esri/views/3d/layers/i3s/I3SIndex":1537,"esri/views/3d/layers/i3s/I3SNode":1538,"esri/views/3d/layers/i3s/I3SLodHandling":1539,"esri/views/3d/layers/i3s/I3SNodeLoader":1540,"esri/views/3d/layers/i3s/I3SMaterialUtil":1541,"esri/views/3d/layers/i3s/I3SStreamDataController":1542,"esri/views/3d/layers/i3s/I3SViewportQueries":1543,"esri/views/3d/support/GraphicsMap":1545,"esri/views/3d/layers/support/DefinitionExpressionSceneLayerView":1546,"esri/views/3d/layers/support/PopupSceneLayerView":1547,"esri/views/3d/layers/support/fieldProperties":1689},t=this||window,r=t.webpackJsonp=t.webpackJsonp||[];r.registerAbsMids?r.registerAbsMids(e):(r.absMidsWaiting=r.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{1378:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(91),r(30),r(5),r(2),r(4),r(92),r(13),r(1),r(3),r(34),r(176),r(106),r(1535),r(66),r(441),r(423),r(304),r(680),r(1533),r(1460),r(1395),r(1546),r(1689),r(691),r(1547),r(77),r(1545),r(416),r(36),r(678),r(1406),r(100),r(14)],void 0===(n=function(e,t,i,n,o,a,s,u,d,l,c,h,p,f,y,g,v,_,m,b,x,w,S,C,I,D,E,N,O,P,M,F,A,V,T){var L=a.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),R=D.defineFieldProperties(),j=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._nodesAddedToStage=new Map,t.drapeSourceType=1,t._queryEngine=null,t._memCache=null,t.loadedGraphics=new P.GraphicsMap,t.holeFilling="always",t.progressiveLoadFactor=1,t.supportsHeightUnitConversion=!0,t._coordinatesOutsideExtentErrors=0,t._maxCoordinatesOutsideExtentErrors=20,t}return i.__extends(t,e),t.prototype.initialize=function(){var e=this,t=this.layer;C.checkSpatialReferences(t,this.view.spatialReference,this.view.viewingMode);for(var i=0,n=["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields","filter"];i<n.length;i++){var o=n[i];this.updatingHandles.add(this,o,(function(){return e._updateRequiredFields()}))}this.updatingHandles.add(t,"rangeInfos",(function(t){return e._rangeInfosChanged(t)}),2),this.updatingHandles.add(t,"renderer",(function(t,r){return e._rendererChange(t,r)})),this.updatingHandles.add(this,"layer.objectIdFilter",(function(){return e._filterChange()})),this.updatingHandles.add(this,"parsedDefinitionExpression",(function(){return e._filterChange()})),this.handles.add(l.init(O,"I3S_TREE_SHOW_TILES",(function(t){if(t&&!e._treeDebugger){var i=e._controller.crsIndex;new Promise((function(e,t){r.e(21).then(function(){var t=[r(1708)];e.apply(null,t)}.bind(this)).catch(t.bind(this))})).then((function(t){var r=t.I3STreeDebugger;!e._treeDebugger&&O.I3S_TREE_SHOW_TILES&&(e._treeDebugger=new r({lv:e,view:e.view,nodeSR:i}))}))}else t||!e._treeDebugger||O.I3S_TREE_SHOW_TILES||(e._treeDebugger.destroy(),e._treeDebugger=null)}))),this._updateRequiredFields(),this._set("graphics3d",new w.default({owner:this,layer:t,preferredUpdatePolicy:1,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:t.fullExtent,updateClippingExtent:function(t){return e._updateClippingExtent(t)}})),this.graphics3d.elevationAlignment&&this.graphics3d.elevationAlignment.events.on("invalidate-elevation",(function(t){return e._invalidateElevation(t)})),this.supportsHeightUnitConversion&&(this._verticalScale=m.getGeometryZScaler("point",t.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.graphics3d.setup()),this._memCache=this.view.resourceController.memoryController.getMemCache(t.uid),this._controller=new g({layerView:this,scaleVisibilityEnabled:!1}),this.when((function(){e._queryEngine=new S.default({layerView:e,task:T.Task.FEATURE_QUERY_ENGINE}),e.updatingHandles.add(e,"maximumNumberOfFeatures",(function(t){return e._controller.featureTarget=t}),2),e.updatingHandles.add(e,"suspended",(function(t){t&&e._removeAllNodeData()}))}))},t.prototype.destroy=function(){this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null)),this._controller&&(this._controller.destroy(),this._controller=null),this._queryEngine&&(this._queryEngine.destroy(),this._queryEngine=null),this._memCache.destroy(),this._memCache=null,this._nodesAddedToStage=null},Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!this.suspended&&!!this._controller&&!this._controller.leafsReached},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasM",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasZ",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.notifyGraphicUpdate=function(e,t){this.graphics3d.graphicsCore.notifyGraphicUpdate(e,t)},t.prototype.whenGraphicAttributes=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,n=this;return i.__generator(this,(function(i){return r=function(e){for(var t=new Map,r=[],i=0,o=e;i<o.length;i++){var a=o[i],s=n._findGraphicNodeAndIndex(a),u=t.get(s.node);u||(u={node:s.node,indices:[],graphics:[]},r.push(u)),u.indices.push(s.index),u.graphics.push(a)}return r},[2,C.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,r,{populateObjectId:!0})]}))}))},t.prototype.getGraphicFromGraphicUid=function(e){if(!this.loadedGraphics)return null;var t=y.hydrateGraphic(this.loadedGraphics.find((function(t){return t.uid===e})),this.layer),r=this._getObjectIdField();return t&&t.attributes&&t.attributes[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null},t.prototype.whenGraphicBounds=function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)},t.prototype.computeAttachmentOrigin=function(e,t){return this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t)},t.prototype.canResume=function(){return e.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return!!(this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating)},t.prototype.getRenderingInfo=function(e,t,r){var i=_.getRenderingInfo(e,{renderer:t,arcade:r});if(i&&i.color){var n=i.color;n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255}return i},t.prototype.getRenderingInfoAsync=function(e,t,r,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(o){return[2,_.getRenderingInfoAsync(e,i.__assign({renderer:t,arcade:r},n))]}))}))},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0}),t.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],r=0,i=o.keysOfMap(this._nodesAddedToStage);r<i.length;r++){var n=i[r],a=this._nodesAddedToStage.get(n),s=this._findGraphicIndex(a.bundle,t);if(s>=0)return{node:a.node,index:s}}return null},t.prototype._findGraphicIndex=function(e,t){for(var r=0;r<e.length;r++)for(var i=0,n=e[r].featureIds;i<n.length;i++)if(n[i]===t)return r;return-1},t.prototype.highlight=function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)},t.prototype.addNodeData=function(e,t){if(!function(e){return"pointData"in e}(t))return u.reject();if(!this._nodesAddedToStage.has(e.index)){for(var r=t.pointData,i=t.attributeDataInfo,o=this._controller.crsIndex,a=this._controller.crsVertex,d=this.view.spatialReference,l=[0,0,0],c=this._getObjectIdField(),h=[],p=this.layer.fullExtent&&function(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}(this.layer.fullExtent.clone(),.5),g=[],v=[],_=0,m=r;_<m.length;_++){var b=m[_],x=b.featureDataPosition,w=x.length,S=b.geometries||[G[w]],C=b.featureIds;p&&!f.extentContainsCoords3D(p,x)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&L.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&L.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var I=0;I<S.length;I++){var D=S[I];if("points"===D.params.type){var E=[],N=C[I<C.length?I:0],O={};null!=N&&(O[c]=N);var P=null==N?n.generateUID():N,A=void 0;"Embedded"===D.type&&(A=D.params.vertexAttributes.position);for(var V=0;V<A.length;V+=w){for(var T=0;T<w;T++)l[T]=x[T]+A[V+T];var R=3===w;e.obb||v.push(l[0],l[1],R?l[2]:0),F.bufferToBuffer(l,a,0,B,d,0,1);var j=y.makeDehydratedPoint(B[0],B[1],R?B[2]:void 0,d),k=P,q=this.loadedGraphics.get(k);s.isSome(q)?E.push(q):E.push({objectId:P,uid:n.generateUID(),geometry:j,attributes:O,visible:!0})}g.push.apply(g,E),h.push({featureIds:b.featureIds,graphics:E})}}}e.numFeatures=g.length,this._updateNodeMemory(e);var Q={bundle:h,attributeInfo:i,node:e};if(U(Q.bundle,Q.attributeInfo),v.length>0){var z=o.isGeographic?this.view.renderSpatialReference:o;F.bufferToBuffer(v,a,0,v,z,0,v.length/3);var H={data:v,size:3,offsetIdx:0,strideIdx:3};e.obb=M.compute(H),o.isGeographic&&F.vectorToVector(e.obb.center,z,e.obb.center,o),this._controller.updateVisibility(e.index)}if(!this._controller.isGeometryVisible(e))return this._cacheNodeData(Q),u.resolve();if(this._verticalScale)for(var J=0,W=g;J<W.length;J++){var Y=W[J];this._verticalScale(Y.geometry)}return this._nodesAddedToStage.set(e.index,Q),this.loadedGraphics.addMany(g),this._filterNode(Q),this._treeDebugger&&this._treeDebugger.update(),u.resolve()}L.error("I3S node "+e.id+" already added")},t.prototype.isNodeLoaded=function(e){return this._nodesAddedToStage.has(e)},t.prototype.updateNodeState=function(){},t.prototype._updateNodeMemory=function(e){e.memory=4096+(s.isSome(e.numFeatures)?e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic:0)},t.prototype._cacheNodeData=function(e){var t=e.bundle.reduce((function(e,t){return t.graphics.reduce((function(e,t){return y.estimateSize(t)+e}),512+8*t.featureIds.length+e)}),1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)},t.prototype._getMemCacheKey=function(e){return""+e.index},t.prototype._removeAllNodeData=function(){var e=this;this._nodesAddedToStage.forEach((function(t){if(t){var r=t.node;e._updateNodeMemory(r),e._cacheNodeData(t)}})),this._nodesAddedToStage.clear(),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()},t.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop(),i=this._removeNodeStageData(r);i&&(this._updateNodeMemory(i.node),this._cacheNodeData(i)),t.madeProgress()}},t.prototype._removeNodeStageData=function(e){var t=this._nodesAddedToStage.get(e);if(!t)return null;for(var r=0,i=t.bundle;r<i.length;r++){var n=i[r];this.loadedGraphics.removeMany(n.graphics)}return this._nodesAddedToStage.delete(e),this._treeDebugger&&this._treeDebugger.update(),t},t.prototype.loadCachedNodeData=function(e){return u.resolve(this._memCache.pop(this._getMemCacheKey(e)))},t.prototype.addCachedNodeData=function(e,t,r){if(!this._nodesAddedToStage.has(e.index)){for(var i=0,n=t.bundle;i<n.length;i++){var o=n[i];this.loadedGraphics.addMany(o.graphics)}return this._nodesAddedToStage.set(e.index,t),this._updateNodeMemory(e),this.setAttributeData(e.index,r),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update(),u.resolve()}L.error("I3S node "+e.id+" already added")},t.prototype.getLoadedNodeIds=function(){var e=[];return this._nodesAddedToStage.forEach((function(t){return e.push(t.node.id)})),e.sort()},t.prototype.getVisibleNodes=function(){var e=new Array;return this._nodesAddedToStage.forEach((function(t){return e.push(t.node)})),e},t.prototype.getLoadedNodeIndices=function(e){this._nodesAddedToStage.forEach((function(t,r){return e.push(r)}))},t.prototype.getLoadedAttributes=function(e){var t=this._nodesAddedToStage.get(e);if(t&&s.isSome(t.attributeInfo))return t.attributeInfo.loadedAttributes},t.prototype.getAttributeData=function(e){var t=this._nodesAddedToStage.get(e);if(t&&s.isSome(t.attributeInfo))return t.attributeInfo.attributeData},t.prototype.setAttributeData=function(e,t){var r=this._nodesAddedToStage.get(e);if(r&&(r.attributeInfo=t,U(r.bundle,t),this._filterNode(r),this.graphics3d.graphicsCore.labelsEnabled)){var i=r.bundle.map((function(e){return e.graphics.length&&e.graphics[0].uid}));this.graphics3d.graphicsCore.updateLabelingInfo(i)}},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,n,o,a;return i.__generator(this,(function(i){switch(i.label){case 0:return r=this.layer.fields,n=new Set,e?[4,e.collectRequiredFields(n,r)]:[3,2];case 1:return i.sent(),o=d.valuesOfSet(n).sort(),[3,3];case 2:o=[],i.label=3;case 3:return n.clear(),t?[4,t.collectRequiredFields(n,r)]:[3,5];case 4:return i.sent(),a=d.valuesOfSet(n).sort(),[3,6];case 5:a=[],i.label=6;case 6:return o.length===a.length&&o.every((function(e,t){return o[t]===a[t]}))||this._reloadAllNodes(),[2]}}))}))},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&L.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype._filterChange=function(){var e=this;this._nodesAddedToStage.forEach((function(t){return e._filterNode(t)}))},t.prototype._reloadAllNodes=function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()},t.prototype._filterNode=function(e){var t=this._getObjectIdField(),r=null;if(this.layer.objectIdFilter){var i=this.layer.objectIdFilter.ids,n="include"===this.layer.objectIdFilter.method;r=function(e){return i.indexOf(e)>=0===n}}for(var o=this.parsedDefinitionExpression,a=0,s=e.bundle;a<s.length;a++)for(var u=0,d=s[a].graphics;u<d.length;u++){var l=d[u],c=l.visible;r&&!r(l.attributes[t])?l.visible=!1:l.visible=!o||this._evaluateClause(o,l),c!==l.visible&&(k.graphic=l,k.property="visible",k.oldValue=c,k.newValue=l.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(k))}},t.prototype._updateRequiredFields=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,r,n,o,a,u,l,c;return i.__generator(this,(function(i){switch(i.label){case 0:return t=(e=this).layer,r=e.layer,n=r.fields,o=r.renderer,a=r.labelsVisible,u=e.filter,l=e.definitionExpressionFields,c=new Set,o?[4,o.collectRequiredFields(c,n)]:[3,2];case 1:i.sent(),i.label=2;case 2:return a?[4,v.collectLabelingFields(c,t)]:[3,4];case 3:i.sent(),i.label=4;case 4:return s.isSome(u)?[4,v.collectFilterFields(c,t,u)]:[3,6];case 5:i.sent(),i.label=6;case 6:return v.collectFields(c,n,l),this._set("requiredFields",d.valuesOfSet(c).sort()),[2]}}))}))},t.prototype._invalidateElevation=function(e){var t=this._controller.crsIndex;F.boundingRectToBoundingRect(e.extent,e.spatialReference,q,t),this._controller.updateElevationChanged(q,t)},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return s.isSome(this.filter)?this.filter.createQuery(e):new b(e)},t.prototype.queryFeatures=function(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),t&&t.signal)},t.prototype.queryObjectIds=function(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),t&&t.signal)},t.prototype.queryFeatureCount=function(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),t&&t.signal)},t.prototype.queryExtent=function(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t&&t.signal)},t.prototype._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(s.isNone(e)?this.createQuery():b.from(e))},t.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0},t.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))},t.prototype.ignoresMemoryFactor=function(){return this._controller&&this._controller.fixedFeatureTarget},t.prototype.getNumberOfNodes=function(){return this._nodesAddedToStage.size},t.prototype.getNumberOfFeatures=function(){return this.loadedGraphics.length},Object.defineProperty(t.prototype,"performanceInfo",{get:function(){var e={displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:this.maximumNumberOfFeatures,totalNumberOfFeatures:-1,nodes:this.getNumberOfNodes(),core:this.graphics3d.graphicsCore.performanceInfo};return this._controller&&this._controller.updateStats(e),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{controller:this._controller}},enumerable:!0,configurable:!0}),i.__decorate([c.property()],t.prototype,"graphics3d",void 0),i.__decorate([c.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],t.prototype,"hasDraped",void 0),i.__decorate([c.property({type:V})],t.prototype,"filter",void 0),i.__decorate([c.property()],t.prototype,"loadedGraphics",void 0),i.__decorate([c.property()],t.prototype,"layer",void 0),i.__decorate([c.property()],t.prototype,"_controller",void 0),i.__decorate([c.property({dependsOn:["_controller.updating","graphics3d.updating"]})],t.prototype,"updating",void 0),i.__decorate([c.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),i.__decorate([c.property()],t.prototype,"holeFilling",void 0),i.__decorate([c.property(E.updatingProgress)],t.prototype,"updatingProgress",void 0),i.__decorate([c.property({aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),i.__decorate([c.property(R.requiredFields)],t.prototype,"requiredFields",void 0),i.__decorate([c.property(R.availableFields)],t.prototype,"availableFields",void 0),i.__decorate([c.property({type:Number,dependsOn:["graphics3d.graphicsCore.displayFeatureLimit"]})],t.prototype,"maximumNumberOfFeatures",null),i.__decorate([c.property({readOnly:!0,dependsOn:["suspended","_controller.leafsReached"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),i.__decorate([c.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],t.prototype,"lodFactor",void 0),i.__decorate([c.property({readOnly:!0})],t.prototype,"hasM",null),i.__decorate([c.property({readOnly:!0})],t.prototype,"hasZ",null),i.__decorate([c.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(I.DefinitionExpressionSceneLayerView(N.PopupSceneLayerView(x.LayerView3D(A))));function U(e,t){for(var r=0;r<e.length;r++)for(var i=0,n=e[r].graphics;i<n.length;i++){var o=n[i];if(o.attributes||(o.attributes={}),s.isSome(t)&&s.isSome(t.loadedAttributes))for(var a=0,u=t.loadedAttributes;a<u.length;a++){var d=u[a].name;t.attributeData[d]&&(o.attributes[d]=C.getCachedAttributeValue(t.attributeData[d],r))}}}var G={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},B=h.vec3f64.create(),k={graphic:null,property:null,oldValue:null,newValue:null},q=p.create();return j}.apply(null,i))||(e.exports=n)},1395:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(33),r(30),r(11),r(2),r(4),r(101),r(248),r(21),r(16),r(245),r(702),r(6),r(31),r(40),r(37),r(34),r(46),r(304),r(1430),r(1450),r(427),r(437),r(416),r(36)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c,h,p,f,y,g,v,_,m,b,x,w,S,C,I){function D(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=D,t.selectEncoding=function(e,r){if(r)for(var i=0;i<e.length;i++)if(e[i].encoding===t.DDS_ENCODING_STRING)return e[i];for(i=0;i<e.length;i++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[i].encoding)>-1)return e[i];return null},t.findIntersectingNodes=function(e,t,r,i,n,o){n.traverse(r,(function(r){var n=r.mbs;t!==i&&(n=N,I.mbsToMbs(r.mbs,i,n,t));var a=O(e,n);return 0!==a&&(o(r,a),!0)}))},t.filterInPlace=function(e,t,r){for(var i=0,n=0,o=0;o<t.length&&i<e.length;o++)e[i]===t[o]&&(r(o)&&(e[n]=e[i],n++),i++);e.length=n};var E=g.create();t.getClipAABB=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return E[0]=(e[0]-t.position[0])/t.rotationScale[0],E[1]=(e[1]-t.position[1])/t.rotationScale[4],E[2]=(e[2]-t.position[2])/t.rotationScale[8],E[3]=(e[3]-t.position[0])/t.rotationScale[0],E[4]=(e[4]-t.position[1])/t.rotationScale[4],E[5]=(e[5]-t.position[2])/t.rotationScale[8],E};var N=f.vec4f64.create();function O(e,t){var r=t[0],i=t[1],n=t[3],o=e[0]-r,a=r-e[2],s=e[1]-i,u=i-e[3],d=Math.max(o,a,0),l=Math.max(s,u,0),c=d*d+l*l;return c>n*n?0:c>0?1:-Math.max(o,a,s,u)>n?3:2}function P(e,t,r){for(var i=[],n=r&&r.missingFields,o=r&&r.originalFields,a=0,s=e;a<s.length;a++){for(var u=s[a],d=u.toLowerCase(),l=!1,c=0,h=t;c<h.length;c++){var p=h[c];if(d===p.name.toLowerCase()){i.push(p.name),l=!0,o&&o.push(u);break}}!l&&n&&n.push(u)}return i}t.intersectBoundingRectWithMbs=O,t.intersectBoundingBoxWithMbs=function(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=e[0]-r,s=r-e[3],u=e[1]-i,d=i-e[4],l=e[2]-n,c=n-e[5],h=Math.max(a,s,0),p=Math.max(u,d,0),f=Math.max(l,c,0),y=h*h+p*p+f*f;return y>o*o?0:y>0?1:-Math.max(a,s,u,d,l,c)>o?3:2},t.findFieldsCaseInsensitive=P,t.whenGraphicAttributes=function(e,t,o,s,u,d){var l;if(!0===(d&&d.populateObjectId)&&(l=o,s=s.filter((function(e){return e!==l})).concat([l])),0===t.length)return a.resolve(t);var c=e.associatedLayer,h=e.attributeStorageInfo;if(c)return function(e,t,r,i){t.sort((function(e,t){return e.attributes[r]-t.attributes[r]}));var o=t.map((function(e){return e.attributes[r]})),s=[],u=P(i,e.fields,{originalFields:s});return function e(t,r,i){var o=t.capabilities.query.maxRecordCount;if(null!=o&&r.length>o){var s=function(e,t){for(var r=e.length,i=Math.ceil(r/t),n=[],o=0;o<i;o++){var a=Math.floor(r*o/i),s=Math.floor(r*(o+1)/i);n.push(e.slice(a,s))}return n}(r,o);return a.all(s.map((function(r){return e(t,r,i)}))).then(V)}var u=new m({objectIds:r,outFields:i,orderByFields:[t.objectIdField]});return t.queryFeatures(u).then((function(e){if(e&&e.features&&e.features.length===r.length)return e.features.map((function(e){return e.attributes}));throw new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}(e,o,u).then((function(e){for(var r=0;r<t.length;r++){var i=t[r],n=e[r],o={};if(i.attributes)for(var a in i.attributes)o[a]=i.attributes[a];for(var d=0;d<s.length;d++)o[s[d]]=n[u[d]];i.attributes=o}return t}))}(c,t,o,s);if(h){var p=u(t);if(!p)return a.reject(new n("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var f=e.parsedUrl.path;return a.all(p.map((function(e){return function(e,t,i,n,o){for(var s=[],u=0,d=t;u<d.length;u++){var l=d[u];if(l&&-1!==o.indexOf(l.name)){var c=e+"/nodes/"+i.resources.attributes+"/attributes/"+l.key+"/0";s.push({url:c,storageInfo:l})}}return a.eachAlways(s.map((function(e){return r(e.url,{responseType:"array-buffer"}).then((function(t){return b.readBinaryAttribute(e.storageInfo,t.data)}))}))).then((function(e){for(var t=[],r=0,i=n;r<i.length;r++){for(var o=i[r],a={},u=0;u<e.length;u++)null!=e[u].value&&(a[s[u].storageInfo.name]=A(e[u].value,o));t.push(a)}return t}))}(f,h,e.node,e.indices,s).then((function(t){for(var r=0;r<e.graphics.length;r++){var i=e.graphics[r],n=t[r];if(i.attributes)for(var o in i.attributes)o in n||(n[o]=i.attributes[o]);i.attributes=n}return e.graphics}))}))).then(i.flatten)}return a.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var M=-Math.pow(2,15),F=-Math.pow(2,31);function A(e,t){if(!e)return null;var r=e[t];return s.isInt16Array(e)?r===M?null:r:s.isInt32Array(e)?r===F?null:r:r!=r?null:r}function V(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];t=t.concat(n)}return t}function T(e){var t=new y(D(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function L(e){var t=new y(D(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function R(e,t,r){if(!_.canProject(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function j(e,t,r){var i=T(e),n=L(e);R(i,t,r),R(n,t,r)}function U(e){return"mesh-3d"===e.type}t.getCachedAttributeValue=A,t.getIndexCrs=T,t.getVertexCrs=L,t.getCacheKeySuffix=function(e,t){return t===I.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=R,t.checkSpatialReferences=j,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},t.checkSceneLayerCompatibleWithView=function(e,t){j(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},t.checkPointCloudLayerCompatibleWithView=function(e,t){R(e.spatialReference,t.spatialReference,t.viewingMode)},t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,i=t;r<i.length;r++){var n=i[r];if(!U(n)||0===n.symbolLayers.length)return!0;for(var a=0,s=n.symbolLayers.items;a<s.length;a++){var u=s[a];if("fill"!==u.type||o.isNone(u.material)||o.isNone(u.material.color)||"replace"!==u.material.colorMixMode)return!0}}return!1},t.transparentEdgeMaterial=w.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var G=function(){this.edgeMaterial=null,this.material=null,this.castShadows=!0};function B(e,t,r,i,n,o){void 0===n&&(n=0),void 0===o&&(o=!1),i!==k||o?e===r?(r.center[2]+=n,I.bufferToBuffer(r.center,t,0,r.center,i,0,1)):(p.vec3.set(r.center,e.center[0],e.center[1],e.center[2]+n),I.bufferToBuffer(r.center,t,0,r.center,i,0,1),c.quat.copy(r.quaternion,e.quaternion),p.vec3.copy(r.halfSize,e.halfSize)):t.isGeographic?function(e,t,r,i){var n=1+Math.max(0,i)/(u.wgs84Radius+e.center[2]);p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+i),I.bufferToBuffer(t.center,r,0,t.center,k,0,1),c.quat.copy(t.quaternion,e.quaternion),c.quat.conjugate(z,e.quaternion),p.vec3.set(Z,0,0,1),p.vec3.transformQuat(Z,Z,z),p.vec3.set(Z,e.halfSize[0]*Math.abs(Z[0]),e.halfSize[1]*Math.abs(Z[1]),e.halfSize[2]*Math.abs(Z[2])),p.vec3.scale(Z,Z,q),p.vec3.add(t.halfSize,e.halfSize,Z),p.vec3.scale(t.halfSize,t.halfSize,n)}(e,r,t,n):function(e,t,r,i){C.corners(e,H),p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+i),I.computeLinearTransformation(r,t.center,Q,k),p.vec3.set(t.center,Q[12],Q[13],Q[14]);var n=2*Math.sqrt(1+Q[0]+Q[5]+Q[10]);z[0]=(Q[6]-Q[9])/n,z[1]=(Q[8]-Q[2])/n,z[2]=(Q[1]-Q[4])/n,z[3]=.25*n,c.quat.multiply(t.quaternion,z,e.quaternion),c.quat.conjugate(z,t.quaternion);for(var o=0,a=0,s=0,u=0,d=H;u<d.length;u++){var l=d[u];l[2]+=i,I.bufferToBuffer(l,r,0,l,k,0,1),p.vec3.sub(Z,l,t.center),p.vec3.transformQuat(Z,Z,z),o=Math.max(o,Math.abs(Z[0])),a=Math.max(a,Math.abs(Z[1])),s=Math.max(s,Math.abs(Z[2]))}p.vec3.set(t.halfSize,o,a,s)}(e,r,t,n)}t.SymbolInfo=G,t.getSymbolInfo=function(e){for(var t=new G,r=!1,i=!1,n=0,a=e.symbolLayers.items;n<a.length;n++){var s=a[n];if("fill"===s.type&&s.enabled){var u=s.material,d=s.edges;if(o.isSome(u)&&!r){var l=u.color,c=S.parseColorMixMode(u.colorMixMode);o.isSome(l)?t.material={color:[l.r/255,l.g/255,l.b/255],alpha:l.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=s.castShadows,r=!0}o.isSome(d)&&!i&&(t.edgeMaterial=w.createMaterialFromEdges(d,{}),i=!0)}}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t},t.addWraparound=function(e,t){return(0|e)+(0|t)|0},t.transformObb=B,t.computeAuthorativeOBB=function(e,t,r,i,n,a){var s,u=x.computeGlobalTransformation(e.mbs,n,r,t);d.mat4.invert(K,u);var l=1/0,c=-1/0,h=function(a){if("replace"===a.type){var u=a.geometry;if(u.hasZ){v.empty(J);var d=u.spatialReference||i,h=u.rings.reduce((function(e,r){return r.reduce((function(e,r){return I.vectorToVector(r,d,Z,t),p.vec3.transformMat4(Z,Z,K),v.expandPointInPlace(J,Z),Math.min(Z[2],e)}),e)}),1/0);!function(){if(!s)if(s=H,v.empty(W),o.isSome(e.obb)&&!e.isComputedObb){B(e.obb,r,Y,t,n,e.isComputedObb),C.corners(Y,s);for(var i=0,a=s;i<a.length;i++){var u=a[i];p.vec3.transformMat4(u,u,K),v.expandPointInPlace(W,u)}}else{var d=e.mbs,l=d[3];I.vectorToVector(d,r,Z,t),p.vec3.transformMat4(Z,Z,K),Z[2]+=n;for(var c=0;c<8;++c){var h=1&c?l:-l,f=2&c?l:-l,y=4&c?l:-l;u=s[c],p.vec3.copy(u,[Z[0]+h,Z[1]+f,Z[2]+y]),v.expandPointInPlace(W,u)}}}(),v.intersects(W,J)&&(l=Math.min(l,h),c=Math.max(c,h))}}};if(a.forEach((function(e){return h(e)})),l===1/0)return null;for(var f,y,g,_=0;_<8;++_)f=X.data,y=3*_,g=s[_],p.vec3.transformMat4(Z,g,u),f[y+0]=Z[0],f[y+1]=Z[1],f[y+2]=Z[2],y+=24,g[2]=l,p.vec3.transformMat4(Z,g,u),f[y+0]=Z[0],f[y+1]=Z[1],f[y+2]=Z[2],y+=24,g[2]=c,p.vec3.transformMat4(Z,g,u),f[y+0]=Z[0],f[y+1]=Z[1],f[y+2]=Z[2];return C.compute(X)};var k=I.SphericalECEFSpatialReference,q=1/(1-u.wgs84Flattening)-1,Q=l.mat4f64.create(),z=h.quatf32.create(),H=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],J=v.create(),W=v.create(),Y=C.create(),Z=[0,0,0],X={data:new Array(72),size:3,offsetIdx:0,strideIdx:3},K=l.mat4f64.create()}.apply(null,i))||(e.exports=n)},1398:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(234),r(2),r(66)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getRequiredFields=function(e,t){return void 0===t&&(t=e.popupTemplate),r.__awaiter(this,void 0,void 0,(function(){var a,s,u,d,l,c,h,p,f;return r.__generator(this,(function(y){switch(y.label){case 0:return n.isSome(t)?[4,t.getRequiredFields(e.fields)]:[2,[]];case 1:return a=y.sent(),s=t.lastEditInfoEnabled,u=e.objectIdField,d=e.typeIdField,l=e.globalIdField,c=e.relationships,i.includes(a,"*")?[2,["*"]]:s?[4,o.getFeatureEditFields(e)]:[3,3];case 2:return p=y.sent(),[3,4];case 3:p=[],y.label=4;case 4:return h=p,f=o.fixFields(e.fields,r.__spreadArrays(a,h)),d&&f.push(d),f&&u&&o.hasField(e.fields,u)&&-1===f.indexOf(u)&&f.push(u),f&&l&&o.hasField(e.fields,l)&&-1===f.indexOf(l)&&f.push(l),c&&c.forEach((function(t){var r=t.keyField;f&&r&&o.hasField(e.fields,r)&&-1===f.indexOf(r)&&f.push(r)})),[2,f]}}))}))},t.getFetchPopupTemplate=function(e,t){return e.popupTemplate?e.popupTemplate:n.isSome(t)&&t.defaultPopupTemplateEnabled&&n.isSome(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}}.apply(null,i))||(e.exports=n)},1406:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(28),r(236),r(22),r(7),r(8),r(92),r(1),r(29),r(304)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c){var h=new o.default({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),p=new o.default({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});return function(e){function t(t){var r=e.call(this,t)||this;return r.where=null,r.geometry=null,r.spatialRelationship="intersects",r.hiddenIds=new Set,r.distance=void 0,r.objectIds=null,r.units=null,r.timeExtent=null,r.enabled=!1,r}var o;return r.__extends(t,e),o=t,t.prototype.writeWhere=function(e,t){t.where=e||"1=1"},t.prototype.enable=function(){this._set("enabled",!0)},t.prototype.createQuery=function(e){void 0===e&&(e={});var t=this,i=t.where,n=t.geometry,o=t.spatialRelationship,a=t.timeExtent,u=t.objectIds,d=t.units,l=t.distance;return new c(r.__assign({geometry:s.clone(n),objectIds:s.clone(u),spatialRelationship:o,timeExtent:s.clone(a),where:i,units:d,distance:l},e))},t.prototype.clone=function(){var e=this,t=e.where,r=e.geometry,i=e.spatialRelationship,n=e.hiddenIds,a=e.timeExtent,u=e.objectIds,d=e.units,l=e.distance,c=new Set;return n.forEach((function(e){return c.add(e)})),new o({geometry:s.clone(r),hiddenIds:c,objectIds:s.clone(u),spatialRelationship:i,timeExtent:s.clone(a),where:t,units:d,distance:l})},r.__decorate([d.property({type:String})],t.prototype,"where",void 0),r.__decorate([d.writer("where")],t.prototype,"writeWhere",null),r.__decorate([d.property({types:i.geometryTypes,json:{read:l.fromJSON,write:!0}})],t.prototype,"geometry",void 0),r.__decorate([d.property({type:String,json:{read:{source:"spatialRel",reader:h.read},write:{target:"spatialRel",writer:h.write}}})],t.prototype,"spatialRelationship",void 0),r.__decorate([d.property({json:{write:function(e,t,r){return t[r]=u.valuesOfSet(e)},read:function(e){return u.SetFromValues(e)}}})],t.prototype,"hiddenIds",void 0),r.__decorate([d.property({type:Number,json:{write:{overridePolicy:function(e){return{enabled:e>0}}}}})],t.prototype,"distance",void 0),r.__decorate([d.property({type:[Number],json:{write:!0}})],t.prototype,"objectIds",void 0),r.__decorate([d.property({type:String,json:{read:p.read,write:{writer:p.write,overridePolicy:function(e){return{enabled:e&&this.distance>0}}}}})],t.prototype,"units",void 0),r.__decorate([d.property({type:n,json:{write:!0}})],t.prototype,"timeExtent",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"enabled",void 0),o=r.__decorate([d.subclass("esri.views.layers.support.FeatureFilter")],t)}(a.JSONSupport)}.apply(null,i))||(e.exports=n)},1430:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(11),r(8),r(5),r(1459)],void 0===(n=function(e,t,r,i,n,o,a){Object.defineProperty(t,"__esModule",{value:!0});var s=o.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function u(e,t,r){for(var n="",o=0;o<r;){var a=e[t+o];if(a<128)n+=String.fromCharCode(a),o++;else if(a>=192&&a<224){if(o+1>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var s=(31&a)<<6|63&e[t+o+1];n+=String.fromCharCode(s),o+=2}else if(a>=224&&a<240){if(o+2>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");s=(15&a)<<12|(63&e[t+o+1])<<6|63&e[t+o+2],n+=String.fromCharCode(s),o+=3}else{if(!(a>=240&&a<248))throw new i("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(o+3>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");if((s=(7&a)<<18|(63&e[t+o+1])<<12|(63&e[t+o+2])<<6|63&e[t+o+3])>=65536){var u=55296+(s-65536>>10),d=56320+(1023&s);n+=String.fromCharCode(u,d)}else n+=String.fromCharCode(s);o+=4}}return n}function d(e,r){for(var i={byteOffset:0,byteCount:0,fields:Object.create(null)},n=0,o=0;o<r.length;o++){var a=r[o],s=a.valueType||a.type,u=t.valueType2ArrayBufferReader[s];i.fields[a.property]=u(e,n),n+=t.valueType2TypedArrayClassMap[s].BYTES_PER_ELEMENT}return i.byteCount=n,i}function l(e,t,r){var n,o,a=[],s=0;for(o=0;o<e;o+=1){if((n=t[o])>0){if(a.push(u(r,s,n-1)),0!==r[s+n-1])throw new i("string-array-error","Invalid string array: missing null termination.")}else a.push(null);s+=n}return a}function c(e,r){return new(0,t.valueType2TypedArrayClassMap[r.valueType])(e,r.byteOffset,r.count*r.valuesPerElement)}function h(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function p(e,t,r){for(var o=null!=t.header?d(e,t.header):{byteOffset:0,byteCount:0,fields:{count:r}},a={header:o,byteOffset:o.byteCount,byteCount:0,entries:Object.create(null)},s=o.byteCount,u=0;u<t.ordering.length;u++){var l=t.ordering[u],c=n.clone(t[l]);if(c.count=o.fields.count,"String"===c.valueType){if(c.byteOffset=s,c.byteCount=o.fields[l+"ByteCount"],"UTF-8"!==c.encoding)throw new i("unsupported-encoding","Unsupported String encoding.",{encoding:c.encoding})}else{if(!m(c.valueType))throw new i("unsupported-value-type","Unsupported binary valueType",{valueType:c.valueType});var h=b(c.valueType);s+=s%h!=0?h-s%h:0,c.byteOffset=s,c.byteCount=h*c.valuesPerElement*c.count}s+=c.byteCount,a.entries[l]=c}return a.byteCount=s-a.byteOffset,a}function f(e,t,r){if(t!==e&&s.error("Invalid "+r+" buffer size\n expected: "+e+", actual: "+t+")"),t<e)throw new i("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function y(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}function g(e){for(var t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,i=e.ordering;r<i.length;r++){var n=i[r];if(e.vertexAttributes[n])switch(n){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function v(e){for(var t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,i=e;r<i.length;r++)switch(i[r]){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}t.readHeader=d,t.readStringArray=l,t.createTypedView=c,t.createRawView=h,t.createAttributeDataIndex=p,t.createGeometryDescriptorFromDefinition=y,t.createGeometryIndexFromSchema=function(e,t){for(var i=d(e,t&&t.header),n=i.byteCount,o={isDraco:!1,header:i,byteOffset:i.byteCount,byteCount:0,vertexAttributes:{}},a=i.fields,s=null!=a.vertexCount?a.vertexCount:a.count,u=0,l=t.ordering;u<l.length;u++){var c=l[u];if(t.vertexAttributes[c]){var h=r.__assign(r.__assign({},t.vertexAttributes[c]),{byteOffset:n,count:s}),p=_[c]?_[c]:"_"+c;o.vertexAttributes[p]=h,n+=b(h.valueType)*h.valuesPerElement*s}}var y=a.faceCount;if(t.faces&&y){o.faces={};for(var g=0,v=t.ordering;g<v.length;g++){var m=v[g];t.faces[m]&&(h=r.__assign(r.__assign({},t.faces[m]),{byteOffset:n,count:y}),o.faces[m]=h,n+=b(h.valueType)*h.valuesPerElement*y)}}var x=a.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&x){o.featureAttributes={};for(var w=0,S=t.featureAttributeOrder;w<S.length;w++){var C=S[w];t.featureAttributes[C]&&(h=r.__assign(r.__assign({},t.featureAttributes[C]),{byteOffset:n,count:x}),o.featureAttributes[C]=h,n+=("UInt64"===h.valueType?8:b(h.valueType))*h.valuesPerElement*x)}}return f(n,e.byteLength,"geometry"),o.byteCount=n-o.byteOffset,o},t.createGeometryDescriptor=function(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?v(e.compressedAttributes.attributes):e?y(e):g(t)},t.createGeometryDescriptorFromSchema=g,t.createGeometryDescriptorForDraco=v;var _={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function m(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function b(e){return m(e)?t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT:0}t.readBinaryAttribute=function(e,t,r){if("lepcc-rgb"===e.encoding)return a.decodeRGB(t);if("lepcc-intensity"===e.encoding)return a.decodeIntensity(t);if(null!=e.encoding&&""!==e.encoding)throw new i("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(s.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(s.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var n=p(t,e,r);f(n.byteOffset+n.byteCount,t.byteLength,"attribute");var o=n.entries.attributeValues||n.entries.objectIds;if(o){if("String"===o.valueType){var u=n.entries.attributeByteCounts,d=c(t,u),y=h(t,o);return l(u.count,d,y)}return c(t,o)}throw new i("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=m,t.getBytesPerValue=b}.apply(null,i))||(e.exports=n)},1445:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(9),r(38),r(17),r(92),r(1),r(1446),r(100)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d){Object.defineProperty(t,"__esModule",{value:!0});var l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.dirtyExtents=new u.ExtentSet,t.globalDirty=!1,t.dirtyGraphicsSet=new Set,t.handles=new o,t.updateElevation=!1,t.layerView=null,t.graphicsCore=null,t.events=new n,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t,r,i){var n=this;this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=r,this.elevationProvider=i;var o=this.layerView.view.resourceController.scheduler;this.handles.add([i.on("elevation-change",(function(e){return n.elevationUpdateHandler(e)})),this.layerView.watch("suspended",(function(){return n.suspendedChange()})),o.registerTask(d.Task.ELEVATION_ALIGNMENT,(function(e){return n.update(e)}),(function(){return n.needsUpdate()}))])},t.prototype.destroy=function(){this.dirtyGraphicsSet=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},t.prototype.clear=function(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")},t.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},t.prototype.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},t.prototype.needsUpdate=function(){return this.dirtyGraphicsSet&&this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty},t.prototype.update=function(e){var t=this;for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((function(){return t.dirtyExtents.merge(e)}));this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},t.prototype._updateDirtyGraphics=function(e){for(var t=this,r=this.layerView.view,i=this.graphicsCore.stageLayer.id,n=this.layerView.labeling,o=function(){var o=Math.min(s.dirtyGraphicsSet.size,100);a.someSet(s.dirtyGraphicsSet,(function(i){var n=t.graphicsCore.getGraphics3DGraphicById(i);return t.dirtyGraphicsSet.delete(i),n&&n.alignWithElevation(t.elevationProvider,r.renderCoordsHelper,t.graphicsCore.asyncUpdates),e.madeProgress(),--o<=0||e.done})),r._stage.processDirtyLayer(i),n&&n.processStageDirty()},s=this;this.dirtyGraphicsSet.size>0&&!e.done;)o()},t.prototype._updateDirtyExtents=function(e){for(var t=this;!this.dirtyExtents.empty&&this.dirtyGraphicsSet.size<100&&!e.done;){var r=this.dirtyExtents.pop();this.events.emit("invalidate-elevation",{extent:r,spatialReference:this.spatialReference}),this.queryGraphicUIDsInExtent(r,this.spatialReference,(function(e){var r=t.graphicsCore.getGraphics3DGraphicById(e);r&&r.needsElevationUpdates()&&t.dirtyGraphicsSet.add(e)})),e.madeProgress()}},t.prototype.markAllGraphicsElevationDirty=function(){var e=this;this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((function(t,r){return e.dirtyGraphicsSet.add(r)}))},t.prototype.elevationUpdateHandler=function(e){if("scene"!==e.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var t=e.extent;if(this.spatialReference=e.spatialReference,this.layerView.suspended){if(!this.updateElevation){var r=this.graphicsCore.computedExtent;r&&t[2]>r.xmin&&t[0]<r.xmax&&t[3]>r.ymin&&t[1]<r.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:this.spatialReference})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}},r.__decorate([s.property({readOnly:!0})],t.prototype,"updating",null),r.__decorate([s.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],t)}(i);t.default=l}.apply(null,i))||(e.exports=n)},1446:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(57),r(34),r(100)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this.extents=new r({allocator:function(e){return e||i.create()}}),this.tempExtent=i.create(),this.dirty=!1}return Object.defineProperty(e.prototype,"empty",{get:function(){return 0===this.extents.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this.extents.clear()},e.prototype.add=function(e){this.contains(e)||(this.removeContained(e),i.set(this.extents.pushNew(),e),this.dirty=!0)},e.prototype.pop=function(){return this.dirty&&this.mergeTight(),this.extents.pop()},e.prototype.merge=function(e){return this.mergeTight(e),e.hasProgressed},e.prototype.mergeTight=function(e){var t=this;void 0===e&&(e=n.noBudget);for(var r=this.extents,o=new Set,a=0;a!==r.length;){r.sort((function(e,t){return e[0]-t[0]})),a=r.length,o.clear();for(var s=function(n){if(e.done)return{value:void 0};for(var a=r.getItemAt(n),s=n+1;s<r.length;++s){var u=r.getItemAt(s);if(u[0]>=a[2])break;o.add(u)}o.forEach((function(n){if(a!==n)if(n[2]<=a[0])o.delete(n);else{var s=i.area(a),u=i.area(n),d=t.tempExtent;i.expand(a,n,d);var l=s+u;(i.area(d)-l)/l<.05&&(i.set(a,d),o.delete(n),r.remove(n),e.madeProgress())}})),o.add(a)},u=0;u<r.length;++u){var d=s(u);if("object"==typeof d)return d.value}}this.dirty=!1},e.prototype.contains=function(e){return this.extents.some((function(t){return i.contains(t,e)}))},e.prototype.removeContained=function(e){this.extents.filterInPlace((function(t){return!i.contains(e,t)}))},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{containsPoint:function(t){return e.extents.some((function(e){return i.containsPoint(e,t)}))}}},enumerable:!0,configurable:!0}),e}();t.ExtentSet=o}.apply(null,i))||(e.exports=n)},1447:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1448)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this._graphicsCore=e,this._stateSets=new Array}return e.prototype.destroy=function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()})),this._stateSets=null},e.prototype.acquireSet=function(e,t){var i=this,n=new r.Graphics3DObjectStateSet(e,t);this._stateSets.push(n);var o={remove:function(){return i.releaseSet(n)},pause:function(){n.objectStateSet.removeAll(),n.paused=!0},resume:function(){n.paused=!1,i.initializeSet(n)}};return{set:n,handle:o}},e.prototype.releaseSet=function(e){e.objectStateSet.removeAll();var t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)},e.prototype._addObjectStateSet=function(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)},e.prototype._removeObjectStateSet=function(e,t){e.removeObjectState(t.objectStateSet)},e.prototype.setUid=function(e,t){e.ids.add(t);var r=this._graphicsCore.graphics3DGraphics.get(t);r&&this._addObjectStateSet(r,e)},e.prototype.setUids=function(e,t){var r=this;t.forEach((function(t){return r.setUid(e,t)}))},e.prototype.setObjectIds=function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)},e.prototype.addGraphic=function(e){var t=this;this._stateSets.forEach((function(r){!r.paused&&r.hasGraphic(e)&&t._addObjectStateSet(e,r)}))},e.prototype.removeGraphic=function(e){var t=this;this._stateSets.forEach((function(r){r.hasGraphic(e)&&t._removeObjectStateSet(e,r)}))},e.prototype.allGraphicsDeleted=function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()}))},e.prototype.initializeSet=function(e){var t=this,r=this._graphicsCore.graphics3DGraphics;e.objectIdField?r.forEach((function(r){r&&e.hasGraphic(r)&&t._addObjectStateSet(r,e)})):e.ids.forEach((function(i){var n=r.get(i);n&&t._addObjectStateSet(n,e)}))},Object.defineProperty(e.prototype,"test",{get:function(){return{states:this._stateSets}},enumerable:!0,configurable:!0}),e}();t.Graphics3DObjectStates=i}.apply(null,i))||(e.exports=n)},1448:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(312)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new r.Object3DStateSet,this.ids=new Set,this.paused=!1}return e.prototype.hasGraphic=function(e){if(this.objectIdField){var t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)},e}();t.Graphics3DObjectStateSet=i}.apply(null,i))||(e.exports=n)},1449:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var o=n[i];if(o.toLowerCase()===r)return e[o]}return null}}.apply(null,i))||(e.exports=n)},1450:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(16),r(3),r(47),r(36)],void 0===(n=function(e,t,r,i,n,o){function a(e,t,r){var o=i.vec3f64.create(),a=e[3],s=Math.ceil(Math.log(a)*Math.LOG2E/4),u=Math.pow(2,4*s+1);if(r.isGeographic){var d=u/n.earthRadius*180/Math.PI,l=Math.round(e[1]/d),c=Math.max(-90,Math.min(90,l*d)),h=d/Math.cos((Math.abs(c)-d/2)/180*Math.PI),p=(f=Math.round(e[0]/h))*h;o[0]=p,o[1]=c}else{var f=Math.round(e[0]/u);l=Math.round(e[1]/u),o[0]=f*u,o[1]=l*u}var y=e[2]+t,g=Math.round(y/u);return o[2]=g*u,o}Object.defineProperty(t,"__esModule",{value:!0}),t.computeGlobalTransformation=function(e,t,i,n){var s=a(e,t,i),u=r.mat4f64.create();return o.computeLinearTransformation(i,s,u,n),u},t.getLocalOrigin=a}.apply(null,i))||(e.exports=n)},1459:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});function i(e,t,r){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,r+0,10)),version:t.getUint16(r+10,!0),checksum:t.getUint32(r+12,!0)}}function n(e,t,r){var i=[];t=o(e,t,i);for(var n=[],a=0;a<i.length;a++){n.length=0,t=o(e,t,n);for(var s=0;s<n.length;s++)r.push(n[s]+i[a])}return t}function o(e,t,i){var n=new DataView(e,t),o=n.getUint8(0),a=31&o,s=!!(32&o),u=(192&o)>>6,d=0;if(0===u)d=n.getUint32(1,!0),t+=5;else if(1===u)d=n.getUint16(1,!0),t+=3;else{if(2!==u)throw new r("lepcc-decode-error","Bad count type");d=n.getUint8(1),t+=2}if(s)throw new r("lepcc-decode-error","LUT not implemented");for(var l=Math.ceil(d*a/8),c=new Uint8Array(e,t,l),h=0,p=0,f=0,y=-1>>>32-a,g=0;g<d;g++){for(;p<a;)h|=c[f]<<p,p+=8,f+=1;i[g]=h&y,h>>>=a,(p-=a)+a>32&&(h|=c[f-1]>>8-p)}return t+f}t.decodeXYZ=function(e){var t=new DataView(e,0),o=0,a=i(e,t,o),s=a.identifier,u=a.version;if(o+=16,"LEPCC     "!==s)throw new r("lepcc-decode-error","Bad identifier");if(u>1)throw new r("lepcc-decode-error","Unknown version");var d=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),minX:e.getFloat64(t+8,!0),minY:e.getFloat64(t+16,!0),minZ:e.getFloat64(t+24,!0),maxX:e.getFloat64(t+32,!0),maxY:e.getFloat64(t+40,!0),maxZ:e.getFloat64(t+48,!0),errorX:e.getFloat64(t+56,!0),errorY:e.getFloat64(t+64,!0),errorZ:e.getFloat64(t+72,!0),count:e.getUint32(t+80,!0),reserved:e.getUint32(t+84,!0)}}(t,o);if(o+=88,d.sizeHi*Math.pow(2,32)+d.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var l=new Float64Array(3*d.count),c=[],h=[],p=[],f=[];if(o=n(e,o,c),o=n(e,o,h),o=n(e,o,p),(o=n(e,o,f))!==e.byteLength)throw new r("lepcc-decode-error","Bad length");for(var y=0,g=0,v=0;v<c.length;v++){g+=c[v];for(var _=0,m=0;m<h[v];m++){_+=p[y];var b=f[y];l[3*y]=Math.min(d.maxX,d.minX+2*d.errorX*_),l[3*y+1]=Math.min(d.maxY,d.minY+2*d.errorY*g),l[3*y+2]=Math.min(d.maxZ,d.minZ+2*d.errorZ*b),y++}}return{errorX:d.errorX,errorY:d.errorY,errorZ:d.errorZ,result:l}};t.decodeRGB=function(e){var t=new DataView(e,0),n=0,o=i(e,t,n),a=o.identifier,s=o.version;if(n+=16,"ClusterRGB"!==a)throw new r("lepcc-decode-error","Bad identifier");if(s>1)throw new r("lepcc-decode-error","Unknown version");var u=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),colorMapCount:e.getUint16(t+12,!0),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}(t,n);if(n+=16,u.sizeHi*Math.pow(2,32)+u.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");if((2===u.lookupMethod||1===u.lookupMethod)&&0===u.compressionMethod){if(3*u.colorMapCount+u.count+n!==e.byteLength||u.colorMapCount>256)throw new r("lepcc-decode-error","Bad count");for(var d=new Uint8Array(e,n,3*u.colorMapCount),l=new Uint8Array(e,n+3*u.colorMapCount,u.count),c=new Uint8Array(3*u.count),h=0;h<u.count;h++){var p=l[h];c[3*h]=d[3*p],c[3*h+1]=d[3*p+1],c[3*h+2]=d[3*p+2]}return c}if(0===u.lookupMethod&&0===u.compressionMethod){if(3*u.count+n!==e.byteLength||0!==u.colorMapCount)throw new r("lepcc-decode-error","Bad count");return new Uint8Array(e,n).slice()}if(u.lookupMethod<=2&&1===u.compressionMethod){if(n+3!==e.byteLength||1!==u.colorMapCount)throw new r("lepcc-decode-error","Bad count");var f=t.getUint8(n),y=t.getUint8(n+1),g=t.getUint8(n+2);for(c=new Uint8Array(3*u.count),h=0;h<u.count;h++)c[3*h]=f,c[3*h+1]=y,c[3*h+2]=g;return c}throw new r("lepcc-decode-error","Bad method "+u.lookupMethod+","+u.compressionMethod)};t.decodeIntensity=function(e){var t=new DataView(e,0),n=0,a=i(e,t,n),s=a.identifier,u=a.version;if(n+=16,"Intensity "!==s)throw new r("lepcc-decode-error","Bad identifier");if(u>1)throw new r("lepcc-decode-error","Unknown version");var d=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),scaleFactor:e.getUint16(t+12,!0),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}(t,n);if(n+=16,d.sizeHi*Math.pow(2,32)+d.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var l=new Uint16Array(d.count);if(8===d.bitsPerPoint){if(d.count+n!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(var c=new Uint8Array(e,n,d.count),h=0;h<d.count;h++)l[h]=c[h]*d.scaleFactor}else if(16===d.bitsPerPoint){if(2*d.count+n!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(c=new Uint16Array(e,n,d.count),h=0;h<d.count;h++)l[h]=c[h]*d.scaleFactor}else{if(o(e,n,c=[])!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(h=0;h<d.count;h++)l[h]=c[h]*d.scaleFactor}return l}}.apply(null,i))||(e.exports=n)},1460:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(28),r(9),r(2),r(1),r(49),r(1402),r(305),r(304)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l){Object.defineProperty(t,"__esModule",{value:!0});var c=u.default,h=function(e){function t(t){var r=e.call(this,t)||this;return r._dataQueryEngineInstance=null,r}return r.__extends(t,e),Object.defineProperty(t.prototype,"queryGeometryType",{get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultQueryJSON",{get:function(){return new l({outSpatialReference:this.spatialReference}).toJSON()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataQueryEngine",{get:function(){return this.ensureDataQueryEngine()},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this.clear()},t.prototype.clear=function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)},t.prototype.executeQueryForIdSet=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)]}))}))},t.prototype.executeQueryForCount=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)]}))}))},t.prototype.executeQueryForExtent=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t)];case 1:return i=r.sent(),n=i.count,o=i.extent,a=s.fromJSON(o),[2,{count:n,extent:a}]}}))}))},t.prototype.executeQueryForIds=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)]}))}))},t.prototype.executeQueryForLatestObservations=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o=this;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t)];case 1:return i=r.sent(),(n=d.fromJSON(i)).features.forEach((function(e){e.layer=o.layer,e.sourceLayer=o.layer})),[2,n]}}))}))},t.prototype.executeQuery=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o=this;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t)];case 1:return i=r.sent(),(n=d.fromJSON(i)).features.forEach((function(e){e.layer=o.layer,e.sourceLayer=o.layer})),[2,n]}}))}))},t.prototype._ensureQueryJSON=function(e){return o.isNone(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())},t.prototype.ensureDataQueryEngine=function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,r=i.featureGeometryTypeKebabDictionary.toJSON(this.queryGeometryType),n=this.layer.fields.map((function(e){return e.toJSON()})),o=this.layerView.view.resourceController.scheduler,a=this.task,s=this.spatialReference.toJSON(),u=this.layerView.graphics3d.graphicsCore.featureStore,d=this.layerView,l=d.hasZ,h=d.hasM;return this._dataQueryEngineInstance=new c({hasZ:l,hasM:h,geometryType:r,fields:n,timeInfo:e,spatialReference:s,objectIdField:t,featureStore:u,scheduler:o,task:a}),this._dataQueryEngineInstance},r.__decorate([a.property({constructOnly:!0})],t.prototype,"layerView",void 0),r.__decorate([a.property({constructOnly:!0})],t.prototype,"task",void 0),r.__decorate([a.property({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],t.prototype,"spatialReference",void 0),r.__decorate([a.property({readOnly:!0,aliasOf:"layerView.layer"})],t.prototype,"layer",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["layer.geometryType"]})],t.prototype,"queryGeometryType",null),r.__decorate([a.property({readOnly:!0,dependsOn:["spatialReference"]})],t.prototype,"defaultQueryJSON",null),r.__decorate([a.subclass("esri.views.3d.layers.graphics.QueryEngine")],t)}(n);t.QueryEngine=h,t.default=h}.apply(null,i))||(e.exports=n)},1477:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(9),r(17),r(13),r(1),r(47),r(709),r(100)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d){var l=-.3*s.earthRadius;return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.suspended=!1,t.extent=null,t.extentIntersectionDirty=!0,t._isVisibleBelowSurface=!1,t.handles=new n,t.layerView=null,t.updating=!0,t}return r.__extends(t,e),t.prototype.setup=function(e){var t=this;this.layerView=e,this.extentIntersection=new u.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});var r=e.view,i=r.basemapTerrain,n=r.resourceController.scheduler;this.handles.add([r.on("resize",(function(){return t.viewChange()})),r.state.watch("camera",(function(){return t.viewChange()}),!0),n.registerTask(d.Task.FRUSTUM_VISIBILITY,(function(){return t.update()}),(function(){return t.updating})),i.on("elevation-bounds-change",(function(){return t.elevationBoundsChange()}))]),"local"===r.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([o.init(i,["opacity","wireframe"],(function(){return t.updateIsVisibleBelowSurface()})),o.init(r,"map.ground.navigationConstraint.type",(function(){return t.updateIsVisibleBelowSurface()}))])},t.prototype.destroy=function(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)},t.prototype._setDirty=function(){this.updating||this._set("updating",!0)},t.prototype.setExtent=function(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()},t.prototype.viewChange=function(){this._setDirty()},t.prototype.elevationBoundsChange=function(){this._setDirty(),this.extentIntersectionDirty=!0},Object.defineProperty(t.prototype,"isVisibleBelowSurface",{set:function(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0},enumerable:!0,configurable:!0}),t.prototype.updateIsVisibleBelowSurface=function(){var e=this.layerView.view,t=e.basemapTerrain,r="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=r||!t.isOpaque()||i},t.prototype.updateExtentIntersection=function(){if(this.extentIntersectionDirty){this.extentIntersectionDirty=!1;var e,t=this.layerView.view;if(this._isVisibleBelowSurface)e=l;else{var r=t.basemapTerrain.elevationBounds,i=r.min,n=r.max;e=i-Math.max(1,(n-i)*(1.2-1))}this.extentIntersection.update(this.extent,t.spatialReference,e)}},t.prototype.update=function(){if(this._set("updating",!1),this.extent){this.updateExtentIntersection();var e=this.layerView.view.frustum;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e))}else this._set("suspended",!1)},r.__decorate([a.property({readOnly:!0})],t.prototype,"suspended",void 0),r.__decorate([a.property({readOnly:!0})],t.prototype,"updating",void 0),r.__decorate([a.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],t)}(i)}.apply(null,i))||(e.exports=n)},1533:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(91),r(9),r(24),r(17),r(4),r(13),r(1),r(689),r(46),r(304),r(428),r(1475),r(1445),r(1534),r(1477),r(1447),r(1476),r(78),r(1449),r(311)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c,h,p,f,y,g,v,_,m,b,x,w){Object.defineProperty(t,"__esModule",{value:!0});var S=function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new a,r.watchUpdatingTracking=new w.WatchUpdatingTracking,r.suspendResumeExtentMode="computed",r.dataExtent=null,r.suspendResumeExtent=null,r}return r.__extends(t,e),Object.defineProperty(t.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"suspendInfo",{get:function(){var e={};return this.scaleVisibility&&this.scaleVisibility.suspended&&(e.outsideScaleRange=!0),this.frustumVisibility&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!0,configurable:!0}),t.prototype.normalizeCtorArgs=function(e){var t=e.frustumVisibilityEnabled?new v:null,r=e.scaleVisibilityEnabled?new m:null,i=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.layer.geometryType?new g.Graphics3DFilterVisibility:null,n=e.elevationAlignmentEnabled?new y.default:null;return{graphicsCore:new f.Graphics3DCore({owner:e.owner,layer:e.layer,preferredUpdatePolicy:e.preferredUpdatePolicy,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.owner.hasZ,hasM:e.owner.hasM}),frustumVisibility:t,scaleVisibility:r,filterVisibility:i,elevationAlignment:n,updateClippingExtent:e.updateClippingExtent,suspendResumeExtentMode:e.suspendResumeExtentMode,dataExtent:e.dataExtent}},t.prototype.initialize=function(){var e=this;this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(function(){return e.scaleVisibility.layerMinMaxScaleChangeHandler()})),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(function(){return e.filterVisibility.filterChanged()})),this.watchUpdatingTracking.add(this.owner,"timeExtent",(function(){return e.filterVisibility.filterChanged()}))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",(function(t,r){l.diff(t,r)&&e.watchUpdatingTracking.addPromise(e.graphicsCore.elevationInfoChange())})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(function(){return e.graphicsCore.updateVisibilityInfo()})),this.watchUpdatingTracking.add(this.layer,"labelingInfo",(function(t,r){l.diff(t,r)&&e.graphicsCore.updateLabelingInfo()}))},t.prototype.setup=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n,o=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this.frustumVisibility&&this.frustumVisibility.setup(this.owner),e=this.owner,t=this.owner.view.basemapTerrain,i=function(e,t,r){return o.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,r)},this.scaleVisibility&&this.scaleVisibility.setup(e,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment&&(n=e.view.elevationProvider,this.elevationAlignment.setup(e,i,this.graphicsCore,n)),this._set("objectStates",new _.Graphics3DObjectStates(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),[4,s.logOnError(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates}))];case 1:return r.sent(),this.watchUpdatingTracking.add(this.layer,"renderer",(function(e){return o.watchUpdatingTracking.addPromise(o.graphicsCore.rendererChange(e))})),this.watchUpdatingTracking.add(e,"fullOpacity",(function(){return o.graphicsCore.opacityChange()})),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(e.view,"clippingArea",(function(){return o._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?[4,s.logOnError(this.graphicsCore.updateLabelingInfo())]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var e=0,t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];e<t.length;e++){var r=t[e],i=this[r];i&&(i.destroy(),this._set(r,null))}this._set("layer",null),this._set("owner",null)},t.prototype.highlight=function(e,t){var r=this;if(e instanceof h){var n=this.objectStates.acquireSet(0,t),o=n.set,a=n.handle;return this.owner.queryObjectIds(e).then((function(e){return r.objectStates.setObjectIds(o,e)})),a}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof i)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof i){var s=e;if(!t||!s[0].attributes||null===x.attributeLookup(s[0].attributes,t)){var u=s.map((function(e){return e.uid})),d=this.objectStates.acquireSet(0,null),l=d.set;return a=d.handle,this.objectStates.setUids(l,u),a}e=s.map((function(e){return x.attributeLookup(e.attributes,t)}))}if("number"==typeof e[0]||"string"==typeof e[0]){var c=e,p=this.objectStates.acquireSet(0,t);return l=p.set,a=p.handle,this.objectStates.setObjectIds(l,c),a}}return I},t.prototype._updateClippingExtent=function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())},t.prototype.setupSuspendResumeExtent=function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(u.init(this,"suspendResumeExtentMode",(function(){switch(e._handles.remove(C),e.suspendResumeExtentMode){case"computed":e._handles.add(u.init(e.graphicsCore,"computedExtent",(function(t){return e.updateSuspendResumeExtent(t)})),C);break;case"data":e._handles.add(u.init(e,"dataExtent",(function(t){return e.updateSuspendResumeExtent(t)})),C);break;default:o.neverReached(e.suspendResumeExtentMode)}})))},t.prototype.updateSuspendResumeExtent=function(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},t.prototype.extentToSuspendResumeRect=function(e,t){var r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!c.canProject(e,r))return;e=c.project(e,r)}return b.enlargeExtent(e,t,p.SUSPEND_RESUME_EXTENT_OPTIMISM)},t.prototype.suspendResumeExtentChanged=function(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)},r.__decorate([d.property({aliasOf:"graphicsCore.layer"})],t.prototype,"layer",void 0),r.__decorate([d.property({aliasOf:"graphicsCore.owner"})],t.prototype,"owner",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"updateClippingExtent",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"graphicsCore",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"scaleVisibility",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"filterVisibility",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"elevationAlignment",void 0),r.__decorate([d.property({constructOnly:!0})],t.prototype,"frustumVisibility",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"deconfliction",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"labeling",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"objectStates",void 0),r.__decorate([d.property({readOnly:!0})],t.prototype,"watchUpdatingTracking",void 0),r.__decorate([d.property()],t.prototype,"suspendResumeExtentMode",void 0),r.__decorate([d.property()],t.prototype,"dataExtent",void 0),r.__decorate([d.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],t.prototype,"suspended",null),r.__decorate([d.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],t.prototype,"suspendInfo",null),r.__decorate([d.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],t.prototype,"updating",null),r.__decorate([d.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],t)}(n);t.default=S;var C="suspendResumeExtentMode",I={remove:function(){},pause:function(){},resume:function(){}}}.apply(null,i))||(e.exports=n)},1534:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(9),r(17),r(5),r(2),r(4),r(13),r(1),r(1460),r(1406),r(100)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c,h){Object.defineProperty(t,"__esModule",{value:!0});var p=o.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility"),f=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i=e.apply(this,t)||this;return i.filter=null,i._dirty=!1,i._querying=!1,i._handles=new n,i}return r.__extends(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this._dirty||this._querying||null!=this._queryResult},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t){var r=this;this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new l.default({layerView:this._layerView,task:h.Task.FILTER_VISIBILITY});var i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(h.Task.FILTER_VISIBILITY,(function(e){return r._update(e)}),(function(){return r._needsUpdate()}))),this._handles.add(u.on(t.owner,"loadedGraphics","after-changes",(function(e){return r._graphicsChanged(e)}),(function(){return r.dirty=!0}))),this.filterChanged()},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null},t.prototype.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(2)})),this._queryResult=null,this._querying=!1),this.dirty=!1,this.notifyChange("updating")},t.prototype._graphicsChanged=function(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)},t.prototype.updateVisibility=function(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)},t.prototype.filterChanged=function(){var e=this.recomputeFilter();e!==this.filter&&(this.filter=e,this.dirty=!0)},Object.defineProperty(t.prototype,"active",{get:function(){return this.filter&&this._core.graphics3DGraphics.size>0},enumerable:!0,configurable:!0}),t.prototype.recomputeFilter=function(){var e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null;if(!t)return e;var r=a.isSome(e)?e.clone():new c;return r.timeExtent=r.timeExtent?r.timeExtent.intersection(t):t,r},t.prototype._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult},t.prototype._update=function(e){var t=this;this.active?(!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then((function(e){t._queryResult=e,t._querying=!1})).catch((function(e){s.isAbortError(e)||(p.warn("FeatureFilter query failed: "+e,{error:e}),t._queryResult=new Set,t._core.graphics3DGraphics.forEach((function(e){return t._queryResult.add(t._getFeatureId(e.graphic))})),t._querying=!1)})),e.madeProgress()),this._queryResult&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((function(r){if(e.done)return!1;var i=t._queryResult.has(t._getFeatureId(r.graphic));return!!r.setVisibilityFlag(2,i,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()},t.prototype._getFeatureId=function(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId},Object.defineProperty(t.prototype,"dirty",{set:function(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),r.__decorate([d.property({readOnly:!0})],t.prototype,"updating",null),r.__decorate([d.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],t)}(i);t.Graphics3DFilterVisibility=f}.apply(null,i))||(e.exports=n)},1535:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(9),r(30),r(17),r(25),r(5),r(2),r(57),r(127),r(4),r(13),r(1),r(6),r(3),r(37),r(34),r(106),r(1417),r(1536),r(1537),r(1539),r(1540),r(1542),r(1395),r(1543),r(36),r(314)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c,h,p,f,y,g,v,_,m,b,x,w,S,C,I,D,E,N){var O=s.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),P=function(e){function t(t){var r=e.call(this,t)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leafsReached=!1,r.scaleVisibilityEnabled=!0,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new d({deallocator:null}),r._loadedNodeScales=new Map,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._poi=y.vec3f64.create(),r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new o,r._idleQueue=new m.default,r._elevationUpdateNodes=new d({deallocator:null}),r._errorCount=0,r}return r.__extends(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new C.default(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return I.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return I.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){if(u.isSome(this._index)){var e=this._index.rootNode;if(u.isSome(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new w(this.layerView);var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=a("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=c.all([this.layer.when(),this.layerView.when()]).then((function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var r=e.layerView.view;e._setClippingArea(r.clippingArea),e._centerOnSurface=r.pointsOfInterest.centerOnSurfaceFrequent;var i=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",(function(){return e._pointOfInterestChanged()})),i.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),h.init(e.layerView,"suspended",(function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=i.scheduler.registerIdleStateCallbacks(r,n)})),b.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),r.state.watch("camera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return u.isSome(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new D(e.crsIndex,r.renderCoordsHelper,r.state.camera,e._clippingArea,r.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(t,e.streamDataController,e._viewportQueries,O,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.streamDataController.busy}),(function(t){return e.layerView.computeAuthorativeOBB?e.layerView.computeAuthorativeOBB(t):null}))}}));this._tmpPoint=_.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(r),this.when((function(){return e._startNodeLoading()}))},t.prototype.destroy=function(){this._cancelAllNodes(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,M.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map((function(r){var i=A(e,r),n=A(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null})).filter((function(e){return null!=e&&e.name!==r}))},t.prototype._requiredFieldsChange=function(){var e=this._getRequiredAttributes();F(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=g.create();E.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&this.camPos&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),u.isSome(this._index)&&(this._index.progressiveLoadPenalty=V.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=y.vec3f64.create();f.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,n=y.vec3f64.create();i.worldUpAtPosition(t,n);var o=f.vec3.angle(n,r)-.5*Math.PI;return f.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,o/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),this._viewportQueries&&u.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype.updateElevationChanged=function(e,t){var r=this,i=this._index;if(!u.isNone(i)){var n=i.rootNode;if(!u.isNone(n)){var o=this._elevationUpdateNodes;o.clear(),I.findIntersectingNodes(e,t,n,this.crsIndex,i,(function(e){return o.push(e.index)})),o.forEach((function(e){i.invalidateBoundingVolumeCache(e),e===n.index&&r.notifyChange("rootNodeVisible")})),o.length&&this.restartNodeLoading()}}},t.prototype.getParentIndex=function(e){return u.isSome(this._index)&&this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){u.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,r){var i=this,n=this._index;if(!u.isNone(n)){var o=n.rootNode;!u.isNone(o)&&E.boundingRectToBoundingRect(t,r,L,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,r){var o=n.getNode(r);u.isSome(o)&&v.containsPoint(L,o.mbs)&&i._loadedNodeScales.set(r,e)}))}},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()},t.prototype.schedule=function(e,t){return this._idleQueue.push((function(){return c.throwIfAborted(e),t()}))},t.prototype.reschedule=function(e,t){return this._idleQueue.unshift((function(){return c.throwIfAborted(e),t()}))},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=N.extractSafeScaleBounds(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return u.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return u.isSome(this._index)?this._index.maxLevel:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"disableMemCache",{set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||u.isNone(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?O.error("Error during processing: "+e):50===this._errorCount&&O.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!u.isNone(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return r._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return r._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return r._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return r._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return r._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}},t.prototype._processIndex=function(e){if(u.isNone(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(n.keysOfMap(this._loadingNodes),e),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var t=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||t===this._get("leafsReached")||this._set("leafsReached",t)}return this._index.load()},t.prototype._prefetchIndex=function(){return!(u.isNone(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D&&!u.isNone(this._index)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,o=this._index.checkFeatureTarget(t,n);o!==n&&(this._featureLOD=o/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e){var t=this._index;if(u.isNone(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=t.getParent(r);u.isSome(i)&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=t.getParent(i.index))if(this._enableFromGPUCache(i,0)){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){if(u.isNone(this._index))return!1;var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());u.isSome(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0&&(--r,n=this._index.getNode(i.add.back()),!u.isNone(n)&&(2===n.cacheState||this._hasNodeLoadToken(t)));)i.add.pop(),this._loadNode(n),e.madeProgress();return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()},t.prototype._cancelNode=function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))},t.prototype._hasNodeLoadToken=function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2||this.streamDataController.busy)},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?.5:1;else{var r=(u.isSome(this._index)?this._index.getIndexMissing():0)+3*(u.isSome(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}e!==this.updating&&this._set("updating",e),t!==this.updatingProgress&&this._set("updatingProgress",t)},t.prototype._updateViewData=function(){if(this._cameraDirty&&!u.isNone(this._index)){var e=this.layerView.view,t=e.state.camera;this.camPos=y.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=V.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return u.isSome(this._index)&&this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){u.isSome(this._index)&&this._index.invalidateVisibilityCache(e)},t.prototype.updateBoundingVolume=function(e){u.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(e)},t.prototype.invalidateComputedOBBs=function(){u.isSome(this._index)&&this._index.invalidateComputedOBBs()},t.prototype.recomputeAuthorativeOBBs=function(){u.isSome(this._index)&&this._index.recomputeAuthorativeOBBs()},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!u.isSome(this._index)||!u.isSome(e.obb)||this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!this._updatesDisabled&&null!=this.streamDataController&&!u.isNone(t)){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var r=S.TextureFormat.Normal;this.layerView.useCompressedTextures?r=S.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(r=S.TextureFormat.Downsampled);var i={textureFormat:r,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new S(this.layer,this.streamDataController,O,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(e){return t.isNodeVisible(e)}),(function(e){return t.isGeometryVisible(e)}),(function(t){return e._isNodeInScaleBounds(t)}),(function(e){return t.nodeTraversalState(e)}),(function(t,r){return e._removeNodes(t,r)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this,r=this._index;if(u.isNone(r))return!1;M.clear(),this.layerView.getLoadedNodeIndices(M);var i=0===this._viewportQueries.maxDistance,n=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return M.filterInPlace((function(e){var i=r.getNode(e);return u.isNone(i)||!r.isGeometryVisible(e)||n(i)||!t._isNodeInScaleBounds(i)})),M.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(M,e),!(i&&this.lodDropFactor<1||0!==M.length&&(M.clear(),1))},t.prototype._removeNodes=function(e,t){e.length>0&&u.isSome(this._index)&&this._index.requestUpdate();var r=e.length;if(this.layerView.removeNodeData(e,t),this._loadedNodeScales.size>0)for(var i=e.length;i<r;i++){var n=e.data[i];this._loadedNodeScales.delete(n)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=c.createAbortController();this._updatingNodes.set(e.index,r),(F(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?c.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,r.signal)).then((function(i){return t.schedule(r.signal,(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:i})}))})).catch((function(r){c.isAbortError(r)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this;if(this._loadingNodes.has(e.index))O.error("already loading node "+e.index);else{var r=c.createAbortController();this._loadingNodes.set(e.index,r),this._evaluateUpdating(),this._loadAndAddNode(e,r.signal).catch((function(e){return e})).then((function(){t._loadingNodes.get(e.index)===r&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}},t.prototype._loadAndAddNode=function(e,t){var r=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,u.isSome(r._index)&&r._index.updates.add.push(e.index))})).catch((function(t){c.isAbortError(t)||(e.cacheState=1)}))},t.prototype._enableFromGPUCache=function(e,t){if(this._disableMemCache||u.isNone(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return u.isSome(t)&&T(t.attributeInfo)&&F(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(){u.isSome(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype._loadCached=function(e,t){var r=this;if(this._enableFromGPUCache(e,1))return c.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule(t,(function(){return i.loadCachedNodeData(e,t,(function(t,i){return r._nodeLoader.loadTextures(e,t,i)}))})).then((function(n){if(u.isNone(n))return!1;var o=r._requiredAttributes;return T(n)&&F(n.loadedAttributes,o)?r.reschedule(t,(function(){return i.addCachedNodeData(e,n,n,t)})).then((function(){return r._nodeAdded(),!0})):r.reschedule(t,(function(){return r._nodeLoader.loadAttributes(e,o,t)})).then((function(a){return r.reschedule(t,(function(){return i.addCachedNodeData(e,n,{loadedAttributes:o,attributeData:a},t)}))})).then((function(){return r._nodeAdded(),!0}))})):c.resolve(!1)},t.prototype._loadUncached=function(e,t){var r=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw r._downloadingCount--,e})).then((function(i){return r._downloadingCount--,r.schedule(t,(function(){return r.layerView.addNodeData(e,i,t)}))})).then((function(){r._nodeAdded(),e.cacheState=2})).catch((function(t){c.isAbortError(t)||(O.error("Failed to load node '"+e.id+"': "+t),e.failed=!0,u.isSome(r._index)&&r._index.requestUpdate())}))},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&u.isSome(this._index)&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=N.extractSafeScaleBounds(this.layer),i=r.minScale,n=r.maxScale;return N.scaleBoundsPredicate(t,i,n)},t.prototype.updateStats=function(e){e.index=u.isSome(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),u.isSome(this._index)&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){u.isSome(e._index)&&(e._index.ignoreServiceOBB=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}},enumerable:!0,configurable:!0}),r.__decorate([p.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"isGraphics3D",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"streamDataController",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"crsVertex",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"crsIndex",null),r.__decorate([p.property()],t.prototype,"camPos",void 0),r.__decorate([p.property()],t.prototype,"screenSizeFactor",void 0),r.__decorate([p.property()],t.prototype,"featureTarget",void 0),r.__decorate([p.property()],t.prototype,"fixedFeatureTarget",void 0),r.__decorate([p.property()],t.prototype,"layerView",void 0),r.__decorate([p.property()],t.prototype,"layer",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"updating",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"updatingProgress",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"leafsReached",void 0),r.__decorate([p.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),r.__decorate([p.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),r.__decorate([p.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(l.EsriPromiseMixin(i)),M=new d({deallocator:null});function F(e,t){return u.isSome(e)&&e.length===t.length&&e.every((function(e){return A(t,e.name)>=0}))}function A(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}var V={factorIM:.2,factor3dObject:.05,distancePenalty:10};function T(e){return u.isSome(e)&&u.isSome(e.loadedAttributes)&&u.isSome(e.attributeData)}var L=v.create();return P}.apply(null,i))||(e.exports=n)},1536:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(30),r(100)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(i.Task.I3S_CONTROLLER,(function(e){return t.update(e)}),(function(){return t.needsUpdate()}))}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.needsUpdate=function(){for(var e=0,t=this.callbacks;e<t.length;e++)if(t[e].needsUpdate())return!0;return!1},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){r.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),o=new Map;t.addTask=function(e,t){var r=o.get(e);return null==r&&(r=new n(e),o.set(e,r)),r.add(t),{remove:function(){null!=r&&(r.remove(t),r.callbacks.length>0||(o.delete(e),r.destroy()),r=null)}}}}.apply(null,i))||(e.exports=n)},1537:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(57),r(4),r(6),r(31),r(1538),r(1395),r(416)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d){Object.defineProperty(t,"__esModule",{value:!0});var l=function(e,t,r,i,n){this.childOffset=e,this.childCount=t,this.visibilityCache=r,this.ref=i,this.node=n,this.useAsHole=0},c=function(){function e(e,t,r,n,o,a,s,u,d,l,c){this.streamDataController=t,this.viewportQueries=r,this.logger=n,this.holeFilling=o,this._isLoaded=a,this._isSelected=s,this._enable=u,this._needsUpdate=d,this._canRequest=l,this._computeAuthorativeOBB=c,this._dirty=!0,this.nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=g(0),this._visibilityCacheVersion=g(0),this._maxLevel=1,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new i({deallocator:null}),this._prefetch=new i({deallocator:null}),this._updates=new p,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this.layerUrl=e.parsedUrl.path,this.rootId=e.rootNode&&e.rootNode.split("/").pop(),e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=""+e.serviceUpdateTimeStamp.lastUpdate),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,e.nodePages?this.initNodePages(e.nodePages):this.initNodeDocuments(this.rootId)}return e.prototype.initNodePages=function(e){switch(this.nodesPerPage=e.nodesPerPage,this.rootIndex=e.rootIndex,e.lodSelectionMetricType){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=I}},e.prototype.initNodeDocuments=function(e){this.nodesPerPage=0,this.rootIndex=0,this.nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new s.NodeBase(e,null),-1)},e.prototype.loadPage=function(e){var t=this;this._loading.add(e);var r=this.layerUrl+"/nodepages/"+e;this.streamDataController.request(r,"json").then((function(r){t._loading.delete(e),t.addPage(e,r)})).catch((function(r){if(t._loading.delete(e),!n.isAbortError(r)){if(0===t.nodePages.length)return t.initNodeDocuments(t.rootId);t._failedPages.add(e),t.logger.error("Error when loading page "+e,r)}}))},e.prototype.addPage=function(e,t){for(var r=this,i=this.nodePages.length;i<e;i++)this.nodePages[i]=null;var n=[],u=[],c=t.nodes.map((function(t,i){var c=n.length,h=t.children?t.children.length:0;u.push(-1);for(var p=0;p<h;p++)n.push(t.children[p]);var f=""+t.index,g=d.clone(t.obb),v=a.vec4f64.fromArray([g.center[0],g.center[1],g.center[2],o.vec3.length(g.halfSize)]),_=t.mesh&&t.mesh.attribute,m=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,x={hasSharedResource:!1,hasFeatureData:!!m,attributes:_&&null!=_.resource?""+_.resource:null,geometry:m&&null!=m.resource?""+m.resource:null,texture:b&&null!=b.resource?""+b.resource:null,geometryDefinition:m?m.definition:-1,materialDefinition:b?b.definition:-1},w=new s.Node(f,e*r.nodesPerPage+i,v,h,0,x,r.lastUpdate,r.lodMetric,r.lodConversion(t.lodThreshold),m?m.featureCount:null);return w.obb=g,w.authorativeObb=r._computeAuthorativeOBB(w),w.vertexCount=m?m.vertexCount:0,new l(c,h,y(r._visibilityCacheVersion),null,w)}));this.nodePages[e]={nodes:c,children:n,parents:u},this.nodeCount+=c.length,this.updateParentsAndLevel()},e.prototype.updateParentsAndLevel=function(){var e=this,t=[],i=function(i,n,o){var a=e.getPage(i);if(r.isSome(a)){var s=x(i,e.nodesPerPage);a.parents[s]=n;var u=a.nodes[s].node;r.isSome(u)&&(u.level=o,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var n=t.pop(),o=this.getNode(n);if(r.isSome(o))for(var a=0;a<o.childCount;a++)i(this.getChildIndex(o,a),n,o.level+1)}},e.prototype.getPage=function(e){return this.nodePages[b(e,this.nodesPerPage)]},e.prototype.getNodeInternal=function(e){var t=this.getPage(e);return r.isNone(t)?null:t.nodes[x(e,this.nodesPerPage)]},e.prototype.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),n=r.isSome(i)?i.level+1:1;this._maxLevel=Math.max(this._maxLevel,n);var o=S(e.lodSelection),u=o.lodMetric,l=o.maxError,c=r.unwrap(this.getNodeInternal(t));return c.node=new s.Node(e.id,t,a.vec4f64.fromArray(e.mbs),c.childCount,n,e.resources,e.version,u,l,e.numFeatures),e.obb&&(c.node.obb=d.clone(e.obb)),c.node.authorativeObb=this._computeAuthorativeOBB(c.node),r.isSome(c.ref)&&(null==c.ref.mbs&&(c.ref.mbs=e.mbs),c.node.renderMbs=c.ref.renderMbs,c.node.renderObb=c.ref.renderObb,c.ref.authorativeObb=c.node.authorativeObb),c.node},e.prototype.makeRefNode=function(e,t){var i=this.nodePages[0],n=i.nodes.length;return i.nodes.push(new l(0,0,y(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,r.isSome(e.renderObb)&&(e.renderObb.halfSize[0]=-1),n},e.prototype.populateChildren=function(e,t){var i=r.unwrap(this.getNodeInternal(e)),n=r.unwrap(this.getPage(e));i.childOffset=n.children.length,i.childCount=t.length;for(var o=0;o<t.length;o++){var a=this.makeRefNode(t[o],e);n.children.push(a)}},e.prototype.getNode=function(e){var t=this.getNodeInternal(e);return r.isSome(t)?t.node:null},e.prototype.getIndexById=function(e){var t;return this.forAllNodes((function(i,n){(r.isSome(i.node)&&i.node.id===e||r.isSome(i.ref)&&i.ref.id===e)&&(t=n)})),t},e.prototype.getNodeById=function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null},e.prototype.getChildIndex=function(e,t){var i=this.getPage(e.index);if(r.isNone(i))return-1;var n=i.nodes[x(e.index,this.nodesPerPage)];return i.children[n.childOffset+t]},e.prototype.getParentIndex=function(e){var t=this.getPage(e);return r.isSome(t)?t.parents[x(e,this.nodesPerPage)]:-1},e.prototype.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},e.prototype.isLeaf=function(e){var t=this.getNodeInternal(e);return r.isSome(t)&&0===t.childCount},Object.defineProperty(e.prototype,"rootNode",{get:function(){return this.getNode(this.rootIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0}),e.prototype.invalidateVisibilityCache=function(e){if(null==e)this._visibilityCacheVersion=g(this._visibilityCacheVersion);else{var t=this.getNodeInternal(e);r.isSome(t)&&(t.visibilityCache=y(this._visibilityCacheVersion))}},e.prototype.invalidateBoundingVolumeCache=function(e){var t=this.getNodeInternal(e);r.isSome(t)&&(f(t),t.visibilityCache=y(this._visibilityCacheVersion))},e.prototype.invalidateComputedOBBs=function(){r.isNone(this.rootNode)||this.traverse(this.rootNode,(function(e){return e.isComputedObb&&(e.obb=null),e.renderMbs[3]=-1,r.isSome(e.renderObb)&&(e.renderObb.halfSize[0]=-1),!0}))},e.prototype.recomputeAuthorativeOBBs=function(){var e=this;r.isNone(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.authorativeObb=e._computeAuthorativeOBB(t),!0}))},e.prototype.isNodeVisible=function(e){var t=this.getNodeInternal(e);if(r.isNone(t)||r.isSome(t.ref)&&!t.ref.mbs)return!0;if(!_(t.visibilityCache,this._visibilityCacheVersion)){var i=!0;return r.isSome(t.node)&&(r.isNone(t.ref)||r.isSome(t.node.authorativeObb))?i=this.viewportQueries.isNodeVisible(t.node):r.isSome(t.ref)&&(i=this.viewportQueries.isNodeVisible(t.ref)),t.visibilityCache=v(i,this._visibilityCacheVersion),i}return m(t.visibilityCache)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!!r.isNone(t)||!(r.isSome(t.node)&&r.isSome(t.ref)&&!t.ref.obb)||this.viewportQueries.isGeometryVisible(t.node)},e.prototype._traverseCoverage=function(e,t,i,n,o){var a=this.getPage(e);if(!r.isNone(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,u=new Array,d=t.childOffset;d<s;++d){var l=a.children[d],c=this.getNodeInternal(l);r.isSome(c)&&r.isSome(c.node)&&this.isGeometryVisible(l)&&u.push(c)}n/=u.length;for(var h=0,p=u;h<p.length;h++)c=p[h],l=r.unwrap(c.node).index,this._isLoaded(l)?(o.delta=Math.max(o.delta,i),o.coverage+=n):this._traverseCoverage(l,c,i+1,n,o)}},e.prototype.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(r.isNone(t))return!1;if("always"===this.holeFilling)return!0;if(_(t.useAsHole,this._version))return m(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var n=i.delta*i.coverage<=.5;return t.useAsHole=v(n,this._version),n},Object.defineProperty(e.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=g(this._version)},e.prototype.update=function(e,t){var i=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),h.clear();var n=!0,o=new C,a=new C;this.traverseVisible((function(s,u){if(!u){var d=i.entryPriority(s),l=b(s,i.nodesPerPage);return h.set(l,Math.max(d,h.get(l)||0)),i._loading.has(l)||i._failedPages.has(l)||i._missing.push(l),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,d))}var c=u.node;if(i._updateNodeFeatureEstimate(c,a),r.isNone(c)){var p=i.entryPriority(s);return i._loading.has(s)||i._failedNodes.has(s)||(i._missing.push(s),h.set(s,p)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,p))}var f=r.unwrap(i.getPage(s));if(0===i._missing.length&&0===i.nodesPerPage)for(var y=0;y<u.childCount;y++){var g=f.children[u.childOffset+y],v=i.getNodeInternal(g);!r.isSome(v)||v.node||i._loading.has(g)||i._failedNodes.has(g)||(h.set(g,i.entryPriority(g)),i._prefetch.push(g))}if(!c.failed&&c.resources.hasFeatureData)if(i._isLoaded(s)){if(o.known+=c.memory,++o.knownNodes,i._isSelected(c)?u.childCount>0&&(n=!1):(o.unremoved+=c.memory,n=!1),i._needsUpdate(c)){var _=i.entryPriority(s);h.set(s,_),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,_),i._updates.update.push(s)}}else if(c.memory&&(o.known+=c.memory,++o.knownNodes),i._isSelected(c)){if(u.childCount>0&&(n=!1),c.memory?(o.missing+=c.memory,o.known+=c.memory,++o.knownNodes):++o.missingNodes,e.indexOf(c.index)>=0)return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i.entryPriority(s)),void(i._updates.cancel=i._updates.cancel.filter((function(e){return e!==c.index})));if(t.done||!i._enable(c)){var m=i.entryPriority(s);h.set(s,m),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,m),i._updates.add.push(s)}else t.madeProgress()}})),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leafsReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||i._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return h.get(e)-h.get(t)})),this._missing.length>0?(this._maxUnloadedPrio=h.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort((function(e,t){return h.get(e)-h.get(t)})),this._updates.add.filterInPlace((function(e){return h.get(e)>=i._maxUnloadedPrio})).sort((function(e,t){return h.get(e)-h.get(t)})),this._updates.update.sort((function(e,t){return h.get(e)-h.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,h.clear()}},e.prototype.checkFeatureTarget=function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,o=r,a=10;a--;){var s=new C;if(this._updateFeatureEstimate(i,s),this._computeFeatureEstimate(s)<=e){if(i>=t||s.missingNodes>0||0===a)break;o=i,i=.5*(i+n)}else n=i,i=.5*(i+o)}return this._version=g(this._version),this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)},e.prototype._updateFeatureEstimate=function(e,t){var r=this;this._version=g(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,i){return r._updateNodeFeatureEstimate(i&&i.node,t)}))},e.prototype._updateNodeFeatureEstimate=function(e,t){if(!(r.isNone(e)||e.failed||r.isNone(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(r.isSome(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(){return this._load(this._missing)},e.prototype.prefetch=function(){return this._load(this._prefetch)},e.prototype._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loading.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(r.isNone(e))return null;var t=this._nodeTraversalState[e.index];if(t&&_(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),n=this.viewportQueries.hasLOD(e),o=!0;if(n){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState[a];o=s&&i>s.lodLevel}else o=i>0}else o=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=o,t.version=v(!0,this._version),t):(this._nodeTraversalState[e.index]={nodeHasLOD:n,lodLevel:i,isChosen:o,version:v(!0,this._version)},this._nodeTraversalState[e.index])},e.prototype._loadNode=function(e){var t=this;this._loading.add(e);var i=r.unwrap(this.getNodeInternal(e)).ref;if(r.isNone(i))this._failedNodes.add(e);else{var o=i.id,a=this.layerUrl+"/nodes/"+o,s=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(a,"json").then((function(r){var i=t._validateNode(o,r);if(null!=i){i.obb&&t.invalidateVisibilityCache(e);var n=t.addNode(i,e);t.nodeTraversalState(n),s()}else s()}),(function(r){n.isAbortError(r)||(t.logger.error("Error loading node: "+a),t._failedNodes.add(e)),s()}))}},e.prototype._validateNode=function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error('Invalid node. Wrong type or wrong id "'+e+'"'),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+e+'"'),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+e+'"'),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_"+t+"/0"}))||this.logger.warn('Invalid attribute data on node "'+e+'"'),t.featureData&&t.featureData.length>1&&this.logger.warn("Node "+e+" has "+t.featureData.length+" bundles. Only the first bundle will be loaded.");var i=t.hasOwnProperty("obb")&&!this.ignoreServiceOBB?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,o=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var i=function(t){return r.logger.error("Invalid node reference on node "+e+": "+t)};if("number"==typeof t.id)i("id "+t.id+" is a number instead of a string.");else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference "+t.id+"."),null;t.href&&t.href!=="../"+t.id&&r.logger.error('Invalid node href on node "'+e+'"');var n=t.hasOwnProperty("obb")&&!r.ignoreServiceOBB?t.obb:null,o=new s.NodeBase(""+t.id,t.mbs);return o.obb=n,o})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},e.prototype.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){r.isSome(e.node)&&(e.node.failed=!1)}))},e.prototype.entryPriority=function(e){var t=this.getNodeInternal(e),i=this.getParentIndex(e);if(r.isNone(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);var n=0;if(t.node&&i>=0){var o=this._nodeTraversalState[i];null!=o&&(n=o.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var u=r.isSome(t.ref)?this.viewportQueries.distToPOI(t.ref):r.isSome(t.node)?this.viewportQueries.distToPOI(t.node):0;return-u-n*(u+this.progressiveLoadPenalty)+a},e.prototype.traverseVisible=function(e){var t=this.getNodeInternal(this.rootIndex);r.isNone(t)?e(this.rootIndex,null):this._traverseVisible(this.rootIndex,t,e)},e.prototype._traverseVisible=function(e,t,i){if(t.node&&0===t.childCount)this.isGeometryVisible(e)&&i(e,t);else if(this.isNodeVisible(e)&&(i(e,t),null!=t.node)){var n=this.nodeTraversalState(t.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var o=r.unwrap(this.getPage(e)),a=0;a<t.childCount;a++){var s=o.children[t.childOffset+a],u=this.getNodeInternal(s);r.isSome(u)?this._traverseVisible(s,u,i):i(s,null)}}},e.prototype.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},e.prototype.traverseChildren=function(e,t){var i=e.index,n=this.getNodeInternal(i);r.isSome(n)&&this._traverseChildren(i,n,t)},e.prototype._traverseChildren=function(e,t,i){var n=this.getPage(e);if(!r.isNone(n))for(var o=t.childOffset+t.childCount,a=t.childOffset;a<o;++a){var s=n.children[a],u=this.getNodeInternal(s);r.isSome(u)&&r.isSome(u.node)&&i(u.node)&&this._traverseChildren(s,u,i)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e.prototype.updateElevationInfo=function(e){this.forAllNodes(f),this.viewportQueries.updateElevationInfo(e)},e.prototype.forAllNodes=function(e){for(var t=0;t<this.nodePages.length;t++){var r=this.nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}},enumerable:!0,configurable:!0}),e}();t.I3SIndex=c;var h=new Map,p=function(){function e(){this.update=new i({deallocator:null}),this.add=new i({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}();function f(e){r.isSome(e.node)&&(e.node.renderMbs[3]=-1,r.isSome(e.node.renderObb)&&(e.node.renderObb.halfSize[0]=-1)),r.isSome(e.ref)&&(e.ref.renderMbs[3]=-1,r.isSome(e.ref.renderObb)&&(e.ref.renderObb.halfSize[0]=-1))}function y(e){return u.addWraparound(e,-2)}function g(e){return u.addWraparound(e,2)}function v(e,t){return t+(e?1:0)}function _(e,t){return(-2&e)===t}function m(e){return 1==(1&e)}function b(e,t){return 0===t?0:e/t|0}function x(e,t){return 0===t?e:e%t}var w=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];function S(e){if(e)for(var t=0;t<e.length;t++)for(var r=0,i=w;r<i.length;r++){var n=i[r];if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}return{lodMetric:0,maxError:0}}t.selectErrorMetric=S;var C=function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function I(e){return Math.sqrt(e*(4/Math.PI))}}.apply(null,i))||(e.exports=n)},1538:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(31)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e,t){this.id=e,this.mbs=t,this.isComputedObb=!1,this.renderMbs=i.vec4f64.fromArray([0,0,0,-1])};t.NodeBase=n;var o=function(e){function t(t,r,i,n,o,a,s,u,d,l){var c=e.call(this,t,i)||this;return c.index=r,c.childCount=n,c.level=o,c.resources=a,c.version=s,c.lodMetric=u,c.maxError=d,c.numFeatures=l,c.failed=!1,c.cacheState=0,c.vertexCount=0,c.memory=0,c}return r.__extends(t,e),t}(n);t.Node=o}.apply(null,i))||(e.exports=n)},1539:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(57)],void 0===(n=function(e,t,r,i){var n=function(){function e(e){this.layerView=e,this._lodGlobalDirty=!1}return e.prototype.startNodeLoading=function(e,t,r,i,n,o,a){this._maxLodLevel=a.maxLodLevel,this._index=o,this._nodeTraversalState=i,this._isNodeVisible=e,this._isGeometryVisible=t,this._isNodeInScaleBounds=r,this._removeNodes=n},e.prototype.shouldLoadNode=function(e){if(r.isNone(e))return!1;var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._index&&!0===this._lodGlobalDirty},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(!this.requiresLODGlobalHandling)return!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));o.clear(),this._lodGlobalHandlingRecursion(this._index.rootNode,r);var i=o.length;this._removeNodes(o,e);var n=o.length<i;return 0===o.length&&(this._lodGlobalDirty=!1),o.clear(),n},e.prototype._lodGlobalHandlingRecursion=function(e,t){if(r.isNone(e))return!1;var i=this._nodeTraversalState(e),n=this.isChosenMaxLOD(i),a=this.layerView.isNodeLoaded(e.index);if(a){if(n)return this._removeChildrenRecursive(e),this.layerView.updateNodeState(e.index,1),!0;this.layerView.updateNodeState(e.index,0)}var s=!1;if(e.childCount>0){s=!0;for(var u=0;u<e.childCount;u++){var d=this._index.getChildIndex(e,u),l=this._index.getNode(d);r.isSome(l)?this._isGeometryVisible(d)&&!this._lodGlobalHandlingRecursion(l,t)&&this._isNodeInScaleBounds(l)&&(s=!1):this._isNodeVisible(d)&&(s=!1)}}a&&!n&&(s||o.length<t)&&(o.push(e.index),a=!1);var c=!e.resources.hasFeatureData;return s||a||c},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,(function(e){return o.push(e.index),!0}))},e.prototype.childrenEmpty=function(e){var t=this,r=!0;return this._index.traverseChildren(e,(function(e){return!(!r||!t._isNodeVisible(e.index)||t.layerView.isNodeLoaded(e.index)&&(r=!1,1))})),r},e.prototype._childrenRequireLoading=function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,(function(e){if(!i||!t._isNodeVisible(e.index))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)})),i&&r},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),o=new i({deallocator:null});return n}.apply(null,i))||(e.exports=n)},1540:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(72),r(25),r(8),r(2),r(4),r(26),r(1430),r(1541),r(1395)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c){var h=function(){function e(e,t,r,i,n,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=n,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((function(e){return l.getMaterialAndTextures(a,e)}))}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(i,"binary",r).then((function(e){return d.readBinaryAttribute(t,e)}))},e.prototype.loadAttributes=function(e,t,r){var i=this;return s.eachAlways(t.map((function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var n={},o=0;o<t.length;++o)if(r[o].value)n[t[o].name]=r[o].value;else{if(s.isAbortError(r[o].error))throw r[o].error;i.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'",r[o].error)}return n}))},e.prototype.loadNodeData=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var u,c,h,p,f,y,g,v,_,m,b,x,w,S,C,I,D,E,N,O,P,M,F,A,V,T,L,R,j;return r.__generator(this,(function(r){switch(r.label){case 0:return u=null!=this.requiredAttributes&&e.resources.attributes?i.result(this.loadAttributes(e,this.requiredAttributes,t)):null,c=function(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var o=0;o<i.length;o++)if(null==i[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=i[o];else if("draco"===i[o].compressedAttributes.encoding&&!n("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=i[o],r;return r}(this.geometryDefinitions,e),h=c.bufferDefinition,p=c.bufferIndex,f=e.resources.geometry?i.result(this.loadGeometry(e,p,t)):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return g=r.sent(),[3,3];case 2:g=null,r.label=3;case 3:return y=g,v=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=y?l.getMaterialAndTexturesFromShared(y):null,_=v&&v.material,m=v&&v.textures,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return x=r.sent(),[3,6];case 5:x=null,r.label=6;case 6:return b=x,w=this.options.loadFeatureData?function(e){for(var t=0,r=e.featureData;t<r.length;t++){var i=r[t],n=i.geometries;if(null!=n)for(var o=0,a=n;o<a.length;o++){var s=a[o];return{featureIds:[i.id],featureDataPosition:i.position,geometries:[s]}}}return null}(b):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(_),S=a.isNone(w)&&function(e){for(var t=new Array,r=0,i=e.featureData;r<i.length;r++){var n=i[r];null!=n.position&&t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}return t}(b),C=null!=m&&m.length>0?i.result(this.loadTextures(e,m,t)):null,I=null,D=null,f?(N=(E=i).assertResult,[4,f]):[3,8];case 7:I=N.apply(E,[r.sent()]),O=function(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=o.clone(e)).vertexAttributes.region,e}(this.defaultGeometrySchema,y),D=d.createGeometryDescriptor(h,O),r.label=8;case 8:return C?(A=(F=i).assertResult,[4,C]):[3,10];case 9:return M=A.apply(F,[r.sent()]),[3,11];case 10:M=null,r.label=11;case 11:return P=M,u?(R=(L=i).assertResult,[4,u]):[3,13];case 12:return T=R.apply(L,[r.sent()]),[3,14];case 13:T={},r.label=14;case 14:return j=(V=T)?{attributeData:V,loadedAttributes:this.requiredAttributes}:null,a.isSome(w)?[2,{geometryData:w,attributeDataInfo:j,geometryBuffer:I,geometryDescriptor:D,requiredTextures:m,textureData:P}]:a.isSome(S)?[2,{pointData:S,attributeDataInfo:j,geometryBuffer:I,geometryDescriptor:D,requiredTextures:m,textureData:P}]:[2,s.reject()]}}))}))},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=0,a=r[n[i]].images;o<a.length;o++){var s=a[o];Array.isArray(s.href)?s.hrefConcat=s.href.map((function(e){return u.makeAbsolute(e,t)})):s.hrefConcat=u.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var o;"data:"===(o=i.encoding[n]).substring(0,5)&&(i.encoding[n]=o.substring(5))}else"data:"===(o=i.encoding).substring(0,5)&&(i.encoding=o.substring(5))}},e.prototype.loadShared=function(t,r){var i=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(i,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t}))},e.prototype.loadTexture=function(e,t,r,i,n,o){return n===c.DDS_ENCODING_STRING?this.load(e,"binary",o).then((function(e){return{id:t,usage:r,data:e,encoding:n}})):this.load(e,"image",o).then((function(e){var o=e;if(i&&e.width*e.height>=4096){var a=Math.ceil(e.width/2),s=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=a,u.height=s,u.getContext("2d").drawImage(e,0,0,a,s),o=u}return{id:t,usage:r,data:o,encoding:n}}))},e.prototype.loadTextures=function(t,r,i){var n=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled,u=this.options.textureUsageMask;return s.all(r.map((function(e){if(0==(e.usage&u))return null;var r=c.selectEncoding(e.encodings,o);if(null==r)return n.logger.error("No known encoding for texture found on node "+t.id),s.reject();var d=t.resources.texture||t.id,l=n.layerUrl+"/nodes/"+d+"/textures/"+r.name;return n.loadTexture(l,e.id,e.usage,a,r.encoding,i)})))},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(i,"binary",r)},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(h||(h={})),h}.apply(null,i))||(e.exports=n)},1541:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(12),r(2),r(196),r(148)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getMaterialAndTextures=function(e,t){var r=new Map,o=function(e,t){if(i.isNone(e))return-1;if(r.has(e.id)){var n=r.get(e.id);return n.usage|=t,n.id}var o=r.size;return r.set(e.id,{id:o,usage:t}),o},s=t.pbrMetallicRoughness,u=s&&s.baseColorFactor,d=t.emissiveFactor,l=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!s||null==s.metallicRoughnessTexture&&1===s.roughnessFactor&&(1===s.metallicFactor||0===s.metallicFactor)),c=l?n.PBRSchematicMRRValues[0]:s?s.metallicFactor:1,h=l?n.PBRSchematicMRRValues[1]:s?s.roughnessFactor:1,p="mask"===t.alphaMode?33:1,f={baseColorFactor:u?[u[0],u[1],u[2],u[3]]:[1,1,1,1],baseColorTextureId:o(s&&s.baseColorTexture,p),metallicRoughnessTextureId:o(s&&s.metallicRoughnessTexture,2),metallicFactor:c,roughnessFactor:h},y={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:o(t.normalTexture,4),emissiveTextureId:o(t.emissiveTexture,16),occlusionTextureId:o(t.occlusionTexture,8),emissiveFactor:d?[d[0],d[1],d[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,isSchematic:l},g=[];return r.forEach((function(t,r){var n=t.usage,o=i.isSome(e)&&e[r]&&e[r].formats,s=o?o.map((function(e){var t=e.name,r=e.format;return{name:t,encoding:a[r]}})):[];g.push({id:r,usage:n,encodings:s})})),{material:y,textures:g}};var a={jpg:"image/jpeg",png:"image/png",dds:"image/vnd-ms.dds","ktx-etc2":"image/ktx"};t.getMaterialAndTexturesFromShared=function(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,n=t&&e.materialDefinitions[t],o=i&&e.textureDefinitions[i],a=s();if(null!=n){var u=n.params;u.diffuse&&(a.metallicRoughness.baseColorFactor=[u.diffuse[0],u.diffuse[1],u.diffuse[2],1]),null!=u.doubleSided&&(a.doubleSided=u.doubleSided,a.cullFace=u.doubleSided?0:2),"none"!==u.cullFace&&"front"!==u.cullFace&&"back"!==u.cullFace||(a.cullFace="none"===u.cullFace?0:"back"===u.cullFace?2:1),u.transparency&&(a.metallicRoughness.baseColorFactor[3]=r.clamp(1-u.transparency,0,1)),(u.useVertexColorAlpha||a.metallicRoughness.baseColorFactor[3]<1)&&(a.alphaMode="blend")}var d=[];if(null!=o){!o.wrap||"repeat"!==o.wrap[0]&&"repeat"!==o.wrap[1]||(a.wrapTextures=!0);var l=1;"rgba"===o.channels&&(a.alphaMode="blend",l|=32);var c=o.images.length-1,h=o.images[c],p=function(e){return e&&e.split("/").pop()},f=Array.isArray(o.encoding)?o.encoding.map((function(e,t){return{name:p(h.href[t]),encoding:e}})):[{name:p(h.href),encoding:o.encoding}];d.push({id:0,usage:l,encodings:f}),a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:d}};var s=function(){return{alphaMode:"opaque",alphaCutoff:o.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,isSchematic:!0}}}.apply(null,i))||(e.exports=n)},1542:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(4)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.requester=e,this.activeRequests=new Set}return Object.defineProperty(e.prototype,"busy",{get:function(){return this.requester.busy},enumerable:!0,configurable:!0}),e.prototype.request=function(e,t,n){var o=this,a=i.createAbortController();i.onAbortOrThrow(n,(function(){return a.abort()})),n=r.__assign(r.__assign({},n),{signal:a.signal});var s=this.requester.request(e,t,n),u={response:s,abortController:a};return this.activeRequests.add(u),i.always(s,(function(){return o.activeRequests.delete(u)})),s},e.prototype.cancelAll=function(){this.activeRequests.forEach((function(e){return e.abortController.abort()})),this.activeRequests.clear()},e}();t.I3SStreamDataController=n,t.default=n}.apply(null,i))||(e.exports=n)},1543:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(6),r(3),r(48),r(106),r(62),r(103),r(190),r(1395),r(27),r(416),r(36)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d,l,c,h,p){return function(){function e(e,t,r,i,o,s,u){void 0===u&&(u={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=i,this.elevationProvider=o,this.options=u,this.fp=c.frustum.create(),this._poi=n.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=n.vec3f64.create(),this._tmp2=n.vec3f64.create(),this._tmp3=n.vec3f64.create(),this._tmp0=n.vec3f64.create(),this.screenspaceErrorBias=u.screenspaceErrorBias||1,this.progressiveLoadFactor=u.progressiveLoadFactor||1,this.updateCamera(r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s),this.tmpPoint=a.makeDehydratedPoint(0,0,0,e)}return e.prototype.updateElevationInfo=function(e){null!=e?(this._elevationContext=u.ElevationContext.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(d.createContextWithoutExpressionSupport(d.extractExpressionInfo(e,!1)))):this._elevationContext=null},e.prototype.updateCamera=function(e){c.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},e.prototype.setPointOfInterest=function(e){i.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.updateExtent=function(e){this.extent=e},e.prototype.getRenderMbs=function(e){var t=e.renderMbs;return t[3]<0&&(o.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=s.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.getRenderObb=function(e){var t=e.authorativeObb||e.obb;if(!(r.isNone(t)||t.halfSize[0]<0)){r.isNone(e.renderObb)&&(e.renderObb=h.create());var i=e.renderObb;if(i.halfSize[0]<0){if(r.isSome(e.authorativeObb))return h.set(e.authorativeObb,i),e.authorativeObb;var n=0;this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=t.center[0],this.tmpPoint.y=t.center[1],this.tmpPoint.z=t.center[2],n=s.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),l.transformObb(t,this.indexSR,i,this.engineSR,n,e.isComputedObb)}return i}},e.prototype.isNodeVisible=function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;var i=this.getRenderObb(e);return r.isSome(i)?h.isVisible(i,this.fp):this.isMBSVisible(t)},e.prototype.isGeometryVisible=function(e){var t=this.getRenderObb(e);return!r.isSome(t)||h.isVisible(t,this.fp)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==l.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return c.frustum.intersectsSphere(this.fp.planes,c.sphere.wrap(e[3],e))},e.prototype.screenSpaceDiameterMbs=function(e,t){var r=this.getRenderMbs(e),n=Math.sqrt(i.vec3.squaredDistance(r,this._camPos)),o=n-r[3];return this._updateMinMaxDistance(n),o<0?.5*Number.MAX_VALUE:t/o*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},e.prototype.calcCameraDistanceToCenter=function(e){var t=this.getRenderMbs(e),r=i.vec3.distance(t,this._camPos);return this._updateMinMaxDistance(r),r},e.prototype.calcAngleDependentLoD=function(e){var t=this.getRenderMbs(e),r=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/i.vec3.length(t)+r)/i.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return 0!==e.lodMetric},e.prototype.getDistancePlanarMode=function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],o=r*r+i*i,a=t[3];if(o<=a*a)return Math.abs(n);var s=Math.sqrt(o)-a;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var r=i.vec3.length(t),n=i.vec3.length(e)-r;i.vec3.scale(this._tmp0,e,i.vec3.dot(e,t)/i.vec3.squaredLength(e));var o=i.vec3.squaredDistance(t,this._tmp0),a=t[3];if(o<=a*a)return Math.abs(n);var s=i.vec3.scale(this._tmp0,t,1/r),u=r,d=a*a/2/u,l=i.vec3.scale(this._tmp1,s,u-d),c=e,h=i.vec3.subtract(this._tmp2,c,l),p=i.vec3.subtract(this._tmp2,h,i.vec3.scale(this._tmp3,s,i.vec3.dot(s,h))),f=i.vec3.add(this._tmp2,l,i.vec3.scale(this._tmp2,p,a/i.vec3.length(p))),y=i.vec3.distance(c,f);if(n>=2e5){var g=i.vec3.subtract(this._tmp1,c,f),v=i.vec3.dot(g,s)/i.vec3.length(g);v<.08&&(v=1e-4),y/=v}return y},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},e.prototype.getLodLevel=function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,o=i+r[3];return this._updateMinMaxDistance(o),e.maxError*t<=n;case 1:var a=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(e)),a<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.getRenderMbs(e);return i.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return i.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,i))||(e.exports=n)},1545:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(38),r(67)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._map=new Map,t}return r.__extends(t,e),t.prototype.clear=function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}},Object.defineProperty(t.prototype,"length",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.get=function(e){return this._map.get(e)},t.prototype.addMany=function(e){if(0!==e.length){for(var t=new Set,r=0;r<e.length;r++){var i=e[r],n=i.objectId,o=this._map.get(n);o?(t.add(n),i!==o&&(e[r]=o),++o.refCount):(i.refCount=1,this._map.set(n,i))}var a=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;a.length>0&&this.emit("change",{added:a,removed:[]})}},t.prototype.removeMany=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r],o=n.objectId,a=this._map.get(o);null!=a&&--a.refCount<=0&&(this._map.delete(o),t.push(n))}t.length>0&&this.emit("change",{added:[],removed:t})},t.prototype.removeManyByObjectId=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r],o=this._map.get(n);null!=o&&--o.refCount<=0&&(this._map.delete(n),t.push(o))}t.length>0&&this.emit("change",{added:[],removed:t})},t.prototype.toArray=function(){return n.valuesOfMap(this._map)},t.prototype.find=function(e){var t;return n.someMap(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t},t.prototype.forEach=function(e){this._map.forEach((function(t){return e(t)}))},t}(i);t.GraphicsMap=o}.apply(null,i))||(e.exports=n)},1546:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(5),r(1),r(681),r(1395)],void 0===(n=function(e,t,r,i,n,o,a){Object.defineProperty(t,"__esModule",{value:!0});var s=i.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView");t.DefinitionExpressionSceneLayerView=function(e){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t.logError=function(e){t._definitionExpressionErrors<t._maxDefinitionExpressionErrors&&s.error("Error while evaluating definitionExpression: "+e),t._definitionExpressionErrors++,t._definitionExpressionErrors===t._maxDefinitionExpressionErrors&&s.error("Further errors are ignored")},t}return r.__extends(t,e),Object.defineProperty(t.prototype,"parsedDefinitionExpression",{get:function(){if(!this.layer||!this.layer.definitionExpression)return null;try{var e=o.WhereClause.create(this.layer.definitionExpression,this.layer.fieldsIndex);if(!e.isStandardized)return s.error("definitionExpression is using non standard function"),null;var t=[],r=e.fieldNames;return a.findFieldsCaseInsensitive(r,this.layer.fields,{missingFields:t}),t.length>0?(s.error("definitionExpression references unknown fields: "+t.join(", ")),null):(this._definitionExpressionErrors=0,e)}catch(e){return s.error("Failed to parse definitionExpression: "+e),null}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definitionExpressionFields",{get:function(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null},enumerable:!0,configurable:!0}),t.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(e){return this.logError(e),!1}},t.prototype._addDefinitionExpressionToQuery=function(e){if(!this.parsedDefinitionExpression)return e;var t=this.layer.definitionExpression,r=e.clone();return r.where?r.where="("+t+") AND ("+r.where+")":r.where=t,r},r.__decorate([n.property()],t.prototype,"layer",void 0),r.__decorate([n.property({readOnly:!0,dependsOn:["layer.definitionExpression","layer.fieldsIndex"]})],t.prototype,"parsedDefinitionExpression",null),r.__decorate([n.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],t.prototype,"definitionExpressionFields",null),r.__decorate([n.subclass("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t)}(e)}}.apply(null,i))||(e.exports=n)},1547:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(11),r(2),r(4),r(92),r(1),r(66),r(1398)],void 0===(n=function(e,t,r,i,n,o,a,s,u,d){Object.defineProperty(t,"__esModule",{value:!0}),t.PopupSceneLayerView=function(e){return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype._validateFetchPopupFeatures=function(e){var t=this.layer;return t.popupEnabled?d.getFetchPopupTemplate(t,e)?void 0:new i("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new i("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})},t.prototype.prepareFetchPopupFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.fetchPopupFeatures=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var e,i,s,l,c,h,p,f,y,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:return(e=this._validateFetchPopupFeatures(t))?[2,o.reject(e)]:(i=n.isSome(t)?t.clientGraphics:null)&&0!==i.length?(s=[],l=[],h=u.unpackFieldNames,p=[this.layer.fields],[4,d.getRequiredFields(this.layer,d.getFetchPopupTemplate(this.layer,t))]):[2,o.resolve([])];case 1:return c=h.apply(void 0,p.concat([r.sent()])),[4,this.prepareFetchPopupFeatures(c)];case 2:for(r.sent(),f=new Set,y=0,g=i;y<g.length;y++)v=g[y],u.populateMissingFields(c,v,f)?l.push(v):s.push(v);return 0===l.length?[2,o.resolve(s)]:[2,this.whenGraphicAttributes(l,a.valuesOfSet(f)).catch((function(){return l})).then((function(e){return s.concat(e)}))]}}))}))},r.__decorate([s.subclass("esri.views.3d.layers.support.PopupSceneLayerView")],t)}(e)}}.apply(null,i))||(e.exports=n)},1689:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(66)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0}),t.defineFieldProperties=function(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,dependsOn:["layer.fields","layer.outFields","requiredFields"],get:function(){var e=this.layer,t=this.layer.fields,n=this.requiredFields;return e.outFields?i.fixFields(t,r.__spreadArrays(i.unpackFieldNames(t,e.outFields),n)):i.fixFields(t,n)}}}}}.apply(null,i))||(e.exports=n)}}]);