(function(){var e={"esri/core/libs/quickselect/quickselect":1409,"esri/views/3d/layers/graphics/Graphics3DCore":1475,"esri/views/3d/layers/graphics/Graphics3DScaleVisibility":1476,"esri/core/libs/rbush/PooledRBush":1645,"esri/renderers/support/rendererConversion":1985,"esri/symbols/support/defaults3D":1986,"esri/views/3d/layers/graphics/Graphics3DFeatureStore":1987,"esri/views/3d/layers/graphics/Graphics3DSymbolCreationContext":1988,"esri/views/3d/layers/graphics/Graphics3DSymbolFactory":1989,"esri/views/3d/layers/graphics/Graphics3DPointSymbol":1990,"esri/views/3d/layers/graphics/GraphicStateTracking":1991,"esri/views/3d/layers/graphics/SpatialIndex2D":1992,"esri/views/3d/layers/support/StageLayerElevationProvider":1993},t=this||window,i=t.webpackJsonp=t.webpackJsonp||[];i.registerAbsMids?i.registerAbsMids(e):(i.absMidsWaiting=i.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1409:function(e,t,i){var r;void 0===(r=function(){"use strict";function e(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function t(e,t){return e<t?-1:e>t?1:0}return function(i,r,a,n,o){!function t(i,r,a,n,o){for(;n>a;){if(n-a>600){var s=n-a+1,l=r-a+1,h=Math.log(s),p=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*p*(s-p)/s)*(l-s/2<0?-1:1);t(i,r,Math.max(a,Math.floor(r-l*p/s+c)),Math.min(n,Math.floor(r+(s-l)*p/s+c)),o)}var d=i[r],u=a,y=n;for(e(i,a,r),o(i[n],d)>0&&e(i,a,n);u<y;){for(e(i,u,y),u++,y--;o(i[u],d)<0;)u++;for(;o(i[y],d)>0;)y--}0===o(i[a],d)?e(i,a,y):e(i,++y,n),y<=r&&(a=y+1),r<=y&&(n=y-1)}}(i,r,a||0,n||i.length-1,o||t)}}.apply(null,[]))||(e.exports=r)},1475:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(28),i(692),i(74),i(9),i(30),i(24),i(11),i(17),i(5),i(67),i(12),i(2),i(65),i(57),i(4),i(54),i(13),i(1),i(689),i(6),i(3),i(37),i(34),i(170),i(106),i(1985),i(107),i(1986),i(733),i(764),i(190),i(1987),i(757),i(1988),i(1989),i(763),i(1991),i(78),i(1992),i(199),i(1993),i(36),i(156),i(473),i(474),i(100)],void 0===(a=function(e,t,i,r,a,n,o,s,l,h,p,c,d,u,y,f,g,m,b,v,S,x,_,w,C,G,D,R,I,P,E,O,A,M,L,V,U,B,j,F,T,k,z,N,W,q,H,Y,X){Object.defineProperty(t,"__esModule",{value:!0});var Z=w.vec3f64.create(),J=C.create(),Q=c.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),K=function(e){function t(t){var i=e.call(this,t)||this;return i.propertiesPool=new q.PropertiesPool({computedExtent:r.Extent},i),i.computedExtent=null,i.currentRenderer=null,i.rendererHasGeometryOperations=!1,i.graphicStateTracking=null,i.symbolCreationContext=new U.Graphics3DSymbolCreationContext,i.graphics3DGraphics=new Map,i.stageLayer=null,i.stage=null,i.graphicsDrapedUids=new Set,i.graphicsBySymbol=new Map,i.symbolConversionCache=new Map,i.symbols=new Map,i.graphicsWithoutSymbol=new Map,i.graphicsWaitingForSymbol=new Set,i.handles=new p,i.suspendSymbolCleanup=!1,i._spatialReference=null,i.arcadeOnDemand=null,i.rendererChangeAbortController=null,i.elevationInfoChangeAbortController=null,i.setupAbortController=null,i.elevationAlignment=null,i.scaleVisibility=null,i.filterVisibility=null,i._spatialIndex=null,i._updatingPendingLoadedGraphicsChange=null,i.featureStore=null,i.deconflictor=null,i.labeler=null,i.objectStates=null,i.viewElevationProvider=null,i.stageLayerElevationProvider=null,i.sharedSymbolResourcesOwnerHandle=null,i.whenGraphics3DGraphicRequests={},i.pendingUpdates=new Map,i.numberOfGraphics=0,i.numberOfGraphicsProvidingElevation=0,i.pendingAdds=0,i.pendingRemoves=0,i.pendingUpdatesPool=new g({allocator:function(e){return e||{add:null,renderingInfo:null,abortController:null,state:0,remove:null}},deallocator:function(e){return e.add=null,e.renderingInfo=null,e.remove=null,e.state=0,e.abortController=null,e}}),i.symbolWarningLogged=!1,i.geometryWarningLogged=!1,i.objectIdInvisibleSet=new Set,i._whenSymbolRemoved=new g,i.preferredUpdatePolicy=0,i._asyncUpdates=!1,i.elevationFeatureExpressionEnabled=!0,i.owner=null,i.layer=null,i.hasDraped=!1,i.graphicSymbolSupported=!0,i.getRenderingInfoWithoutRenderer=!1,i.hasZ=null,i.hasM=null,i._usedMemory=0,i._visible=void 0,i._startCreateGraphics=!1,i.maxPendingUpdates=0,i}var o;return i.__extends(t,e),o=t,Object.defineProperty(t.prototype,"spatialIndex",{get:function(){if(!this._spatialIndex){this._spatialIndex=new k.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});var e=0,t=new Array(this.graphics3DGraphics.size);this.graphics3DGraphics.forEach((function(i){return t[e++]=i})),this._spatialIndex.addMany(t)}return this._spatialIndex},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"asyncUpdates",{get:function(){return this._asyncUpdates},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsWaitingForSymbol.size>0||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,a=this.maxSymbolComplexity,n=Math.max(t,Math.min(i,Math.ceil(r/Math.max(1,a?a.primitivesPerFeature:1)))),o=this._get("displayFeatureLimit");return o&&o.minimumTotalNumberOfFeatures===t&&o.maximumTotalNumberOfFeatures===i&&o.maximumTotalNumberOfPrimitives===r&&o.maximumSymbolComplexity===a&&o.maximumNumberOfFeatures===n?o:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,maximumSymbolComplexity:a,maximumNumberOfFeatures:n}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSymbolComplexity",{get:function(){for(var e=null,t=this.symbolComplexities,i=this._get("maxSymbolComplexity"),r=!1,a=0,n=t;a<n.length;a++){var o=n[a];(!e||0===e.primitivesPerCoordinate&&o.primitivesPerFeature>e.primitivesPerFeature||0!==e.primitivesPerCoordinate&&o.primitivesPerCoordinate>e.primitivesPerCoordinate)&&(e=o),r=r||o.estimated}return!e||r&&i&&(i.primitivesPerFeature>=e.primitivesPerFeature||i.primitivesPerCoordinate>=e.primitivesPerCoordinate)||i&&i.primitivesPerFeature===e.primitivesPerFeature&&i.primitivesPerCoordinate===e.primitivesPerCoordinate?i:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this._spatialReference},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemory",{get:function(){var e=this.maxSymbolComplexity&&this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemoryPerGraphic",{get:function(){if(this._usedMemory&&this.numberOfGraphics)return this._usedMemory/this.numberOfGraphics;if(this.maxSymbolComplexity){var e=this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.maxSymbolComplexity.memory.bytesPerFeature+e}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"symbolComplexities",{get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()},enumerable:!0,configurable:!0}),t.prototype.getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;var i=O.to3D(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&Q.error(i.error.message),this.symbolConversionCache.set(e.id,r),r},t.prototype.getSymbolComplexitiesUsedOrRenderer=function(e){if(y.isNone(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],a=this.getSymbolComplexityUsedOrRenderer(i);y.isSome(a)&&r.push(a);for(var n=0,o=t;n<o.length;n++){var s=o[n],l=this.getSymbolComplexityUsedOrRenderer(s);y.isSome(l)&&r.push(l)}return r},t.prototype.getSymbolComplexityUsedOrRenderer=function(e){if(y.isNone(e))return null;var t=this.symbols.get(e.id);if(y.isSome(t))return t.complexity;var i=this.getConvertedSymbol(e);return i?z.defaultSymbolComplexity(i):null},t.prototype.getSymbolComplexitiesUsed=function(){var e=[];return this.symbols.forEach((function(t){y.isSome(t)&&e.push(t.complexity)})),e},t.prototype.initialize=function(){var e=this;this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new L.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:function(){return e.spatialIndex},forAllGraphics:function(t){return e.graphics3DGraphics.forEach(t)}}))},t.prototype.setup=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,n,o,s=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.setupAbortController=m.createAbortController(),t=this.setupAbortController.signal,this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates),r=this.owner.view,this.viewElevationProvider=new A.ViewElevationProvider(this._spatialReference,r),this.initializeStage(r,this.layer.uid),this.symbolCreationContext.sharedResources=r.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=r.sharedSymbolResources.addGraphicsOwner(this.owner),y.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=r.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.localOriginFactory=new H,this.symbolCreationContext.elevationProvider=r.elevationProvider,this.symbolCreationContext.notifyGraphicUpdate=function(e,t){return s.notifyGraphicUpdate(e,t)},a=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),n=this.symbolCreationContext,[4,M.createContext(a,this._spatialReference,Q)];case 1:n.featureExpressionInfoContext=i.sent(),m.throwIfAborted(t),this.symbolCreationContext.screenSizePerspectiveEnabled=r.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,this.handles.add(this.owner.watch("suspended",(function(){return s.updateLayerVisibility()}))),o="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled",this.handles.add([this.owner.watch(o,(function(){var e=r.screenSizePerspectiveEnabled&&s.layer.screenSizePerspectiveEnabled;e!==s.symbolCreationContext.screenSizePerspectiveEnabled&&(s.symbolCreationContext.screenSizePerspectiveEnabled=e,s.recreateAllGraphics())})),v.init(this,"preferredUpdatePolicy",(function(){return s.updateUpdatePolicy()}),!0),this.owner.watch("slicePlaneEnabled",(function(e){return s.slicePlaneEnabledChange(!!e)})),this.owner.view.watch("pixelRatio",(function(){return s.pixelRatioChange()})),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",(function(e){return s.physicalBasedRenderingChange(e)})),v.when(r.basemapTerrain,"tilingScheme",(function(e){e.spatialReference.equals(s.symbolCreationContext.overlaySR)||(s.symbolCreationContext.overlaySR=r.basemapTerrain.spatialReference),s.handles.has("loaded-graphics")?s.recreateAllGraphics():s.handles.add([v.on(s.owner,"loadedGraphics","change",(function(e){return s.graphicsCollectionChanged(e)}),(function(){return s.recreateAllGraphics()})),v.on(s.owner,"loadedGraphics","after-changes",(function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()}),(function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()}))],"loaded-graphics")})),r.resourceController.scheduler.registerTask(X.Task.GRAPHICS_CORE,(function(e){return s.update(e)}),(function(){return s.needsUpdate()}))]),this.owner.layer&&"featureReduction"in this.owner.layer&&this.handles.add(this.owner.watch("layer.featureReduction",(function(){return s.deconflictor.featureReductionChange()}))),this.notifyChange("maxSymbolComplexity"),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.rendererChange(this.layer.renderer)];case 3:case 4:return i.sent(),[3,5];case 5:return m.throwIfAborted(t),this.setupAbortController=null,[2]}}))}))},t.prototype.abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)},t.prototype.destroy=function(){for(var e in this.abortSetup(),this.abortRendererChange(),this.abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null),this.clear(),y.isSome(this.graphicStateTracking)&&(this.graphicStateTracking.destroy(),this.graphicStateTracking=null),this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(0,this.stageLayer.id),this.stageLayer=null,this.stage=null),this.handles.destroy(),this.handles=null,this._spatialReference=null,this._set("owner",null),this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new h("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex&&(this._spatialIndex.destroy(),this._spatialIndex=null),this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))},t.prototype.clear=function(){this.objectStates&&this.objectStates.allGraphicsDeleted(),y.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),this._spatialIndex&&this._spatialIndex.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach((function(e){y.isSome(e)&&e.destroy()})),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this.pendingAdds=0,this.pendingRemoves=0,this._set("hasDraped",!1),this.notifyChange("updating"),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")},t.prototype.initializeStage=function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new Y(t,{isPickable:!this.owner.suspended},t),this.stage.add(0,this.stageLayer),this.stage.addToViewContent([this.stageLayer.id]),this.stageLayer.on("dirty",(function(e){if(i.graphicStateTracking)switch(e.dirtyType){case"objTransformation":case"objGeometryAdded":case"objGeometryRemoved":case"objGeometryReplaced":case"objGeometryTransformation":case"shaderTransformationChanged":case"vertexAttrsUpdated":var t=e.origin.metadata.graphicUid;i.notifyGraphicUpdate(t,2);break;case"visibilityChanged":t=e.origin.metadata.graphicUid,i.notifyGraphicUpdate(t,1)}}))},t.prototype.notifyGraphicUpdate=function(e,t){switch(t){case 1:this.notifyGraphicVisibilityChanged(e);break;case 2:this.notifyGraphicGeometryChanged(e)}},t.prototype.notifyGraphicGeometryChanged=function(e){if(!y.isNone(this.graphicStateTracking)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}},t.prototype.notifyGraphicVisibilityChanged=function(e){if(!y.isNone(this.graphicStateTracking)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}},t.prototype.updateLayerVisibility=function(){var e=!!this.owner.suspended,t=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*ie,i=!e&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())},t.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},t.prototype.getGraphics3DGraphicById=function(e){return this.graphics3DGraphics.get(e)},t.prototype.getGraphics3DGraphicByObjectId=function(e){var t=this;if(!this.owner.layer||!this.owner.layer.objectIdField)return null;var i=null;return d.someMap(this.graphics3DGraphics,(function(r){return t._getGraphicObjectID(r.graphic)!==e||(i=r,!1)})),i},t.prototype._getGraphicObjectID=function(e,t){return void 0===t&&(t=this.owner.layer&&this.owner.layer.objectIdField),R.getObjectId(e,t)},Object.defineProperty(t.prototype,"graphics3DGraphicsByObjectID",{get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var a=r.graphic,n=e._getGraphicObjectID(a,t);y.isSome(n)&&i.set(n,r)}})),i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelsEnabled",{get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())},enumerable:!0,configurable:!0}),t.prototype.updateLabelingInfo=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r;return i.__generator(this,(function(i){switch(i.label){case 0:return t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),r=this.labeler&&this.labeler.labelingInfoChange(e),[4,m.eachAlways([t,r])];case 1:return i.sent(),[2]}}))}))},t.prototype.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return d.someMap(this.symbols,(function(r,a){if(y.isSome(r)){var n=r.getFastUpdateStatus();if(n.loading>0)return!0;e.graphicsBySymbol.has(a)&&(i+=n.fast,t+=n.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"},enumerable:!0,configurable:!0}),t.prototype.needsUpdate=function(){return this.pendingUpdates.size>0},t.prototype.update=function(e){this._applyPendingUpdates(e),this.needsUpdate()||this.notifyChange("updating")},t.prototype.setObjectIdVisibility=function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);y.isSome(i)&&this._updateUserVisibility(i)},t.prototype._findGraphics3DGraphicByObjectId=function(e){var t,i=this;return d.someMap(this.graphics3DGraphics,(function(r){return i._getGraphicObjectID(r.graphic)===e&&(t=r,!0)})),t},t.prototype._updateUserVisibility=function(e){if(y.isNone(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(y.isNone(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)},t.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return m.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=m.createDeferred();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t.prototype.boundsForGraphics3DGraphic=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,a,n,o,s,l,h,p,c,d;return i.__generator(this,(function(i){switch(i.label){case 0:return r=this._spatialReference,a=this.owner.view.renderSpatialReference,n=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return W.bufferToBuffer(e,a,t,e,r,t,i)},s=function(e,t,i){return W.bufferToBuffer(e,n,t,e,r,t,i)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:y.isSome(t)&&t.useViewElevation,minDemResolution:y.isSome(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,e.getProjectedBoundingBox(o,s,l,y.get(t,"signal"))];case 1:return(h=i.sent())?(p=h.boundingBox,h.requiresDrapedElevation&&(c=this.symbolCreationContext.elevationProvider)&&(C.center(p,Z),d=c.getElevation(Z[0],Z[1],0,r)||0,p[2]=Math.min(p[2],d),p[5]=Math.max(p[5],d)),[2,{boundingBox:p,screenSpaceObjects:h.screenSpaceObjects}]):[2,null]}}))}))},t.prototype.whenGraphicBounds=function(e,t){var i=this;return v.whenOnce(this.owner,"loadedGraphics").then((function(){var t=i.owner.layer&&i.owner.layer.objectIdField,r=i.owner.loadedGraphics.find((function(i){return i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]}));if(r)return i.whenGraphics3DGraphic(r);throw new h("internal:graphic-not-part-of-view","Graphic is not part of this view")})).then((function(e){return i.boundsForGraphics3DGraphic(e,t)}))},t.prototype.computeAttachmentOrigin=function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var a=i.computeAttachmentOrigin();if(0===a.render.num&&0===a.draped.num)return null;_.vec3.set(re,0,0,0);var n=0;if(a.render.num>0){if(!W.vectorToVector(a.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ae,t))return null;_.vec3.add(re,re,ae),n++}if(a.draped.num>0){var o=a.draped.origin,s=o[0],l=o[1],h=this.viewElevationProvider.getElevation(s,l,"ground")||0;if(_.vec3.set(ae,s,l,h),!W.vectorToVector(ae,this.viewElevationProvider.spatialReference,ae,t))return null;_.vec3.add(re,re,ae),n++}return n>1&&_.vec3.scale(re,re,1/n),new r.Point({x:re[0],y:re[1],z:re[2],spatialReference:t})},t.prototype.getSymbolLayerSize=function(e,t){var i=this.symbols.get(e.id);if(y.isNone(i))throw new h("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new h("internal:missing-symbol-layer","Symbol layer is not in symbol");var a=i.getSymbolLayerSize(r);if(null==a)throw new h("internal:missing-size","Symbol layer has no valid size");return a},t.prototype.graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t),r=this.graphicsWithoutSymbol.get(t);if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e);break;case"attributes":break;default:l.neverReached(e)}},t.prototype.graphicUpdateGeometryHandler=function(e,t){var i=t.graphic.geometry;if(y.isNone(i))this.recreateGraphic(t.graphic);else if(y.isNone(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var a=this.symbols.get(r);if(y.isSome(a)&&0===a.loadStatus)return}this.recreateGraphic(t.graphic)}else e.graphics3DSymbol.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i)},t.prototype.graphicUpdateSymbolHandler=function(e,t){var i=t.graphic,r=y.isSome(e)?e.graphics3DSymbol:t.oldValue&&this.symbols.get(t.oldValue.id);if(y.isNone(r))this.recreateGraphic(i);else{var a=r.symbol,n=this.getConvertedSymbol(t.newValue);if(n.type===a.type&&"web-style"!==n.type&&"web-style"!==a.type){var o=this.graphicsBySymbol.get(a.id);if(o&&1!==o.size)this.recreateGraphic(i);else{var s=x.diff(a,n);if(y.isNone(s))this.updateSymbolMapping(a.id,n);else{var l={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),x.isEmpty(l.diff)){for(var h=0,p=l.symbolStatePatches;h<p.length;h++)(0,p[h])();var c=this._getRenderingInfo(i);if(y.isSome(e))for(var d=0,u=l.graphics3DGraphicPatches;d<u.length;d++)(0,u[d])(e,c);this.updateSymbolMapping(a.id,n)}else this.recreateGraphic(i)}}}else this.recreateGraphic(i)}},t.prototype.graphicUpdateVisibleHandler=function(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())},t.prototype.recreateGraphic=function(e){var t=[e];this.suspendSymbolCleanup=!0,this.remove(t),this.add(t),this.suspendSymbolCleanup=!1,this.asyncUpdates||this._cleanupSymbols()},t.prototype._beginGraphicUpdate=function(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),this._get("symbolsUpdating")||this._set("symbolsUpdating",!0)},t.prototype._endGraphicUpdate=function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))},t.prototype.expandComputedExtent=function(e){var t=J,i=e.spatialReference;R.computeAABB(e,t);var r=this._spatialReference,a=o.tmpVec;if(i.equals(r)||W.xyzToVector(t[0],t[1],0,i,a,r)&&(t[0]=a[0],t[1]=a[1],W.xyzToVector(t[3],t[4],0,i,a,r),t[3]=a[0],t[4]=a[1]),u.isFinite(t[0])&&u.isFinite(t[3])&&u.isFinite(t[1])&&u.isFinite(t[4])){var n=this.computedExtent,s=null,l=u.isFinite(t[2])&&u.isFinite(t[5]),h=l&&(!n||null==n.zmin||t[2]<n.zmin),p=l&&(!n||null==n.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||h||p)&&((s=this.propertiesPool.get("computedExtent")).xmin=Math.min(t[0],n.xmin),s.ymin=Math.min(t[1],n.ymin),s.xmax=Math.max(t[3],n.xmax),s.ymax=Math.max(t[4],n.ymax),s.spatialReference=r):((s=this.propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(h&&(s.zmin=t[2]),p&&(s.zmax=t[5]),this._set("computedExtent",s))}},t.prototype.updateHasDraped=function(){var e=this.graphicsDrapedUids.size>0;this._set("hasDraped",e)},t.prototype.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)},t.prototype.elevationInfoChange=function(){return i.__awaiter(this,void 0,void 0,(function(){var e,t,r,a=this;return i.__generator(this,(function(i){switch(i.label){case 0:return this.abortElevationInfoChange(),e=m.createAbortController(),this.elevationInfoChangeAbortController=e,t=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),r=this.symbolCreationContext,[4,M.createContext(t,this._spatialReference,Q)];case 1:return r.featureExpressionInfoContext=i.sent(),m.throwIfAborted(e),this.elevationInfoChangeAbortController=null,this.labeler&&this.labeler.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){for(var t=e.graphic,i=0,r=e.labelGraphics;i<r.length;i++){var a=r[i];a.graphics3DSymbolLayer.updateGraphicElevationContext(t,a)}})):a._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange(),[2]}}))}))},t.prototype.updateStageLayerElevationProvider=function(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new N.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))},t.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.filterVisibility&&this.filterVisibility.clear(),this.labeler&&this.labeler.reset(),this.deconflictor&&this.deconflictor.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)},t.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))},t.prototype._recreateSymbol=function(e){var t=this,i=this.graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var a=e.usedMemory;t._conditionalRemove(e,i),t._spatialIndex&&t._spatialIndex.remove(e),r.push(e.graphic),e.destroy(),t.removeGraphics3DGraphic(i,a),t.updateLayerVisibility(),t.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));var a=this.symbols.get(e);y.isSome(a)&&a.destroy(),this.symbols.delete(e),this.updateHasDraped(),this.add(r)},t.prototype._conditionalRemove=function(e,t){e.isDraped&&this.graphicsDrapedUids.delete(t),this.objectStates&&this.objectStates.removeGraphic(e),this.labeler&&this.labeler.removeGraphic(e),this.deconflictor&&this.deconflictor.removeGraphic(e),y.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)},t.prototype.add=function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this.asyncUpdates?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):Q.error("#add()","Cannot add graphics before terrain surface has been initialized"))},t.prototype._addImmediate=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,$.clear();for(var i=0,r=e;i<r.length;i++){var a=r[i];this._startAddGraphic(a,this._getRenderingInfo(a,Q),$)}$.forEach((function(e){return t._finishAddGraphics(e)})),$.clear(),this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()},t.prototype._addDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);n?n.add?0!==n.state&&n.abortController.abort():this.pendingAdds++:(n=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(a,n)),n.add=r}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.remove=function(e){this.asyncUpdates?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t.prototype._removeImmediate=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._removeGraphic(r)}this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t.prototype._removeDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);if(n)n.add&&(n.remove?n.add=null:this.pendingUpdates.delete(a),1===n.state&&n.abortController.abort(),this.pendingAdds--);else{var o=this.pendingUpdatesPool.pushNew();o.remove=r,this.pendingUpdates.set(a,o),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&Q.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0},t.prototype._applyPendingUpdates=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var i=2===e.state?1e3:100,r=0;$.clear(),d.someMap(this.pendingUpdates,(function(a,n){if(a.add&&0===a.state&&t._startAddRenderingInfo(a),!a.remove||a.add&&2!==a.state||(t.pendingRemoves--,t._removeGraphic(a.remove),a.remove=null),a.add)switch(a.state){case 2:t._startAddGraphic(a.add,a.renderingInfo,$)&&r++,a.add=null,t.pendingAdds--;break;case 3:a.add=null,t.pendingAdds--}return r>i&&($.forEach((function(e){return t._finishAddGraphics(e)})),$.clear(),r=0),null==a.remove&&null==a.add&&(t.pendingUpdates.delete(n),e.madeProgress()),e.done})),$.forEach((function(e){return t._finishAddGraphics(e)})),$.clear(),0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.updateHasDraped()},t.prototype._startAddRenderingInfo=function(e){var t=this;y.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(e.state=1,e.abortController=m.createAbortController(),this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal}).then((function(i){y.isNone(i)||y.isNone(i.symbol)?(Q&&!t.symbolWarningLogged&&(t.symbolWarningLogged=!0,Q.warn("Graphic in layer "+t.layer.id+" has no symbol and will not render")),e.renderingInfo=null):e.renderingInfo=i,e.state=2}),(function(t){e.abortController=null,m.isAbortError(t)?e.state=0:e.state=3}))):(e.renderingInfo=this._getRenderingInfo(e.add,Q),e.state=2)},t.prototype._startAddGraphic=function(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),!t||y.isNone(t.symbol)||!R.hasGeometry(e))return!1;var r=t.symbol,a=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(y.isNone(a))return!1;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);var n={graphic:e,renderingInfo:t,layer:this.layer},o=a.symbol.id,s=i.get(o);if(s)s.graphics.push(n);else{var l=te.acquire();l.clear(),l.push(n),i.set(o,{asyncSymbol:a,graphics:l})}return!0},t.prototype._finishAddGraphics=function(e){var t=this,i=!1,r=function(t){t===e.asyncSymbol.symbol.id&&(i=!0)};this._whenSymbolRemoved.push(r),e.asyncSymbol.load((function(){if(!t.destroyed){t._whenSymbolRemoved.removeUnordered(r),ee.clear();for(var a=0;a<e.graphics.length;a++){var n=e.graphics.data[a],o=n.graphic;if(!(i||e.asyncSymbol.destroyed||t.graphicSymbolSupported&&o.symbol&&o.symbol.id!==e.asyncSymbol.symbol.id)){if(t.graphicsWaitingForSymbol.has(o.uid)){var s=t.createGraphics3DGraphic(e.asyncSymbol,n);t._spatialIndex&&y.isSome(s)&&ee.push(s)}t._endGraphicUpdate(o)}--e.asyncSymbol.referenced}ee.length>0&&(t._spatialIndex.addMany(ee.data,ee.length),ee.clear()),t.featureStore.events.emit("changed"),e.graphics.clear(),te.release(e.graphics),t.labeler&&t.owner.view.labeler.setDirty()}}),(function(a){if(!t.destroyed){if(t._whenSymbolRemoved.removeUnordered(r),!i)if(m.isAbortError(a))t.add(e.graphics.map((function(e){return e.graphic})));else if(!e.asyncSymbol.destroyed)for(var n=0;n<e.graphics.length;n++)t._endGraphicUpdate(e.graphics.data[n].graphic);e.graphics.clear(),te.release(e.graphics)}}))},t.prototype._removeGraphic=function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){i.graphics3DSymbol.onRemoveGraphic(i);var r=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),this._spatialIndex&&this._spatialIndex.remove(i);var n=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(n).delete(t),this.graphicsWithoutSymbol.delete(t),this.removeGraphics3DGraphic(t,r,a),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t)},t.prototype.hasLabelingContext=function(e){if(e instanceof n.LabelSymbol3D||e instanceof n.TextSymbol){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1},t.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof n.LabelSymbol3D&&!this.hasLabelingContext(e)&&(Q.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))},t.prototype._getRenderingInfo=function(e,t){var i=e.geometry;if(y.isNone(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!W.canProject(i.spatialReference,this._spatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has incompatible spatial reference and will not render")),null;if(!this.graphicSymbolSupported&&y.isSome(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r,a=this.rendererHasGeometryOperations?R.hydrateGraphic(e,this.layer):e;return!(r=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||y.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,y.unwrap(this.arcadeOnDemand)):{symbol:a.symbol||E.getDefaultSymbol3D(a.geometry)})||y.isNone(r.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null):r},t.prototype._getRenderingInfoAsync=function(e,t){var i=e.geometry;if(y.isNone(i))return Q&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,Q.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&y.isSome(e.symbol))return Q&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,Q.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r=this.rendererHasGeometryOperations?R.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,y.unwrap(this.currentRenderer),y.unwrap(this.arcadeOnDemand),t)},t.prototype.createGraphics3DSymbol=function(e,t){var i=this;if(!this.hasValidSymbolCreationContext(e))return null;var r,a=this.getConvertedSymbol(e);if(!a)return null;if(y.isSome(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var n=O.to3D(t.backgroundFillSymbol,!1,!0);n.symbol&&"web-style"!==n.symbol.type&&(r=n.symbol.symbolLayers)}var o=B.make(a,this.symbolCreationContext,r);return o.load((function(){return i.notifyChange("maxSymbolComplexity")}),(function(){})),o},t.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof n.WebStyleSymbol?new j(e,(function(e){return i.createGraphics3DSymbol(e,t)})):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),y.isSome(r)&&++r.referenced,r},t.prototype.trackGraphicState=function(e){return y.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new F.GraphicStateTracking(this)),this.graphicStateTracking.add(e)},t.prototype.addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.removeGraphics3DGraphic=function(e,t,i){void 0===i&&(i=!1),this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.createGraphics3DGraphic=function(e,t){var i=t.graphic;if(this.graphicsWithoutSymbol.delete(i.uid),!this.symbols.has(e.symbol.id))return this.add([i]),null;if(this.graphics3DGraphics.has(i.uid))return null;var r=e.createGraphics3DGraphic(t);if(y.isNone(r))return null;this.addGraphics3DGraphic(r);var a=e.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map),this.graphicsBySymbol.get(a).set(i.uid,r),r.isDraped&&(this.graphicsDrapedUids.add(i.uid),this._set("hasDraped",!0)),r.centroid=null,y.isSome(i.geometry)&&"point"!==i.geometry.type&&r instanceof V&&(r.centroid=T.computeCentroid(i.geometry,this._spatialReference)),this._updateUserVisibility(r),this.scaleVisibility&&this.scaleVisibility.updateVisibility(r),this.filterVisibility&&this.filterVisibility.updateVisibility(r),this.deconflictor&&this.deconflictor.addGraphic(r),this.labeler&&this.labeler.addGraphic(r),this.objectStates&&this.objectStates.addGraphic(r),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),y.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(r);var n=this.whenGraphics3DGraphicRequests[i.uid];return n&&(delete this.whenGraphics3DGraphicRequests[i.uid],n.resolve(r)),r},t.prototype.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)},t.prototype.rendererChange=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r;return i.__generator(this,(function(i){switch(i.label){case 0:return this.abortRendererChange(),e===this.currentRenderer?[2]:(this.validateRenderer(e),I.isSupportedRenderer3D(e)?y.isSome(e)&&e.arcadeRequired?(t=m.createAbortController(),this.rendererChangeAbortController=t,[4,this.ensureArcade()]):[3,4]:(this.currentRendererChange(null,!1),[2]));case 1:return r=i.sent().arcadeUtils,m.throwIfAborted(t),r.hasGeometryOperations(e)?[4,r.enableGeometryOperations()]:[3,3];case 2:i.sent(),m.throwIfAborted(t),i.label=3;case 3:return this.rendererChangeAbortController=null,this.currentRendererChange(e,!0),[3,5];case 4:this.currentRendererChange(e,!1),i.label=5;case 5:return[2]}}))}))},t.prototype.ensureArcade=function(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return y.isNone(this.arcadeOnDemand)?(e=this,[4,P.loadArcade()]):[3,2];case 1:return e.arcadeOnDemand=t.sent(),[2,this.arcadeOnDemand];case 2:return[2,this.arcadeOnDemand]}}))}))},t.prototype.currentRendererChange=function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=y.unwrap(this.arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),y.isNone(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphics();var r=x.diff(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,y.isNone(r)||("complete"===r.type?this.recreateAllGraphics():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}},t.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},t.prototype.applySymbolSetDiff=function(e,t,i){var r=this;e=e||[];for(var a=[],n=function(t){var n=o.graphicsBySymbol.get(t.id);n&&n.forEach((function(o,s){var l=o.graphic,h=r.layer instanceof D?r.layer:null,p=y.unwrap(r.arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol(R.hydrateGraphic(l,h),{arcade:p})!==i.defaultSymbol){var c=o.usedMemory;e.length||i.defaultSymbol?a.push(l):r.graphicsWithoutSymbol.set(s,l);var d=r.graphics3DGraphics.get(s);r._conditionalRemove(d,s),o.destroy(),n.delete(s),r.removeGraphics3DGraphic(s,c),r.updateLayerVisibility()}})),o._whenSymbolRemoved.forEach((function(e){return e(t.id)}))},o=this,s=0,l=t=t||[];s<l.length;s++)n(l[s]);(e.length||a.length)&&(this.graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this.graphicsWithoutSymbol.clear(),this.add(a)),this.updateHasDraped(),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()},t.prototype.applyUniqueValueRendererDiff=function(e,t,i){var r=e.diff.defaultSymbol,a=e.diff.uniqueValueInfos;if(r||a){var n=a?a.added.map((function(e){return e.symbol})):[],o=a?a.removed.map((function(e){return e.symbol})):[];if(a)for(var s=0;s<a.changed.length;s++)n.push(a.changed[s].newValue.symbol),o.push(a.changed[s].oldValue.symbol);return r?(i.defaultSymbol&&o.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&o.push(t.defaultSymbol),this.applySymbolSetDiff(n,o,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t.prototype.calculateUnchangedSymbolMapping=function(e,t,i){var r=function(e){return y.isSome(e)?e.id:null};if(t instanceof a.UniqueValueRenderer&&i instanceof a.UniqueValueRenderer&&(y.isNone(e)||"partial"===e.type)){var n=e&&e.diff,o=n&&n.defaultSymbol,s=n&&n.uniqueValueInfos,l=void 0;return l=s?s.unchanged.map((function(e){return{oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}})):i.uniqueValueInfos.map((function(e,i){return{oldId:r(e.symbol),newId:r(t.uniqueValueInfos[i].symbol)}})),!o&&i.defaultSymbol&&l.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),l}return[]},t.prototype.updateSymbolMapping=function(e,t){var i=t?"string"==typeof t?t:t.id:null,r="string"==typeof t?null:t;if(e&&e!==i){var a=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==a&&this.graphicsBySymbol.set(i,a);var n=this.symbols.get(e);void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),y.isSome(n)&&(y.isSome(r)?n.symbol=r:n.symbol.id=i))}},t.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var r=0,a=this.calculateUnchangedSymbolMapping(e,t,i);r<a.length;r++){var n=a[r],o=n.oldId,s=n.newId;this.updateSymbolMapping(o,s)}},t.prototype.applyRendererDiff=function(e,t,i){var r=this;return!(this.diffHasSymbolChange(e)||!(t instanceof a.UniqueValueRenderer&&i instanceof a.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)&&d.someMap(this.graphicsBySymbol,(function(i,a){var n=r.symbols.get(a);return y.isSome(n)&&!n.applyRendererDiff(e,t)})))},t.prototype.opacityChange=function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this.updateStageLayerVisibility()},t.prototype.updateUpdatePolicy=function(){var e=y.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;this._asyncUpdates=1===this.preferredUpdatePolicy||e,this.symbolCreationContext.isAsync=this._asyncUpdates,this._asyncUpdates||this.update(X.noBudget)},t.prototype.slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())},t.prototype.physicalBasedRenderingChange=function(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("physicalBasedRenderingEnabled",t)})))},t.prototype.pixelRatioChange=function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))},t.prototype._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=b.schedule((function(){e._updatingPendingLoadedGraphicsChange=null}))},t.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,r=G.create();return W.extentToBoundingRect(e,r,t)?this.symbolCreationContext.clippingExtent=C.fromRect(C.create(),r):this.symbolCreationContext.clippingExtent=null,!C.equals(this.symbolCreationContext.clippingExtent,i)},t.prototype.modifyGraphics3DGraphicVisibilities=function(e){var t=!1;this.graphics3DGraphics.forEach((function(i){e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())},t.prototype.forEachGraphics3DSymbol=function(e){for(var t=0,i=s.keysOfMap(this.symbols);t<i.length;t++){var r=i[t],a=this.symbols.get(r);if(y.isNone(a))return;e(a,this.graphicsBySymbol.get(r)||ne,r)}},t.prototype.updateAllGraphicsVisibility=function(){var e=this;this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=e.scaleVisibility&&e.scaleVisibility.updateVisibility(t);return i||r}))},t.prototype.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(0,!1,0)}))},t.prototype.validateRenderer=function(e){var t=I.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";Q.warn(i,t.message)}},t.prototype.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset(),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t.prototype._cleanupSymbols=function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)){var t=!1;this.symbols.forEach((function(i,r){if(!(y.isNone(i)||i.referenced>0)){var a=e.graphicsBySymbol.get(r);a&&0!==a.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),i&&i.destroy(),t=!0)}})),t&&this.notifyChange("maxSymbolComplexity")}},t.prototype.snapshotInternals=function(){var e=this;return{graphics:s.keysOfMap(this.graphics3DGraphics).sort(),symbols:s.keysOfMap(this.symbols).sort(),graphicsBySymbol:s.keysOfMap(this.graphicsBySymbol).sort().map((function(t){return{symbolId:t,graphics:s.keysOfMap(e.graphicsBySymbol.get(t)).sort()}})),graphicsWithoutSymbol:s.keysOfMap(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:s.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}},Object.defineProperty(t.prototype,"test",{get:function(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"performanceInfo",{get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}},enumerable:!0,configurable:!0}),t.tmpVec=w.vec3f64.create(),i.__decorate([S.property({readOnly:!0})],t.prototype,"computedExtent",void 0),i.__decorate([S.property()],t.prototype,"currentRenderer",void 0),i.__decorate([S.property()],t.prototype,"rendererHasGeometryOperations",void 0),i.__decorate([S.property()],t.prototype,"rendererChangeAbortController",void 0),i.__decorate([S.property()],t.prototype,"elevationInfoChangeAbortController",void 0),i.__decorate([S.property()],t.prototype,"setupAbortController",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"elevationAlignment",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"scaleVisibility",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"filterVisibility",void 0),i.__decorate([S.property()],t.prototype,"_updatingPendingLoadedGraphicsChange",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"featureStore",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"deconflictor",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"labeler",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"objectStates",void 0),i.__decorate([S.property()],t.prototype,"preferredUpdatePolicy",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"elevationFeatureExpressionEnabled",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"owner",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"layer",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"hasDraped",void 0),i.__decorate([S.property({readOnly:!0})],t.prototype,"symbolsUpdating",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"graphicSymbolSupported",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"getRenderingInfoWithoutRenderer",void 0),i.__decorate([S.property({readOnly:!0,dependsOn:["elevationAlignment.updating","scaleVisibility.updating","filterVisibility.updating","rendererChangeAbortController","elevationInfoChangeAbortController","_updatingPendingLoadedGraphicsChange"]})],t.prototype,"updating",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"updatingRemaining",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"updatingTotal",null),i.__decorate([S.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],t.prototype,"displayFeatureLimit",null),i.__decorate([S.property({readOnly:!0})],t.prototype,"maxSymbolComplexity",null),i.__decorate([S.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i.__decorate([S.property({constructOnly:!0})],t.prototype,"hasM",void 0),o=i.__decorate([S.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],t)}(o);t.Graphics3DCore=K;var $=new Map,ee=new g,te=new f(g),ie=10,re=w.vec3f64.create(),ae=w.vec3f64.create(),ne=new Map}.apply(null,r))||(e.exports=a)},1476:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(9),i(17),i(2),i(1),i(314),i(100)],void 0===(a=function(e,t,i,r,a,n,o,s,l){var h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._scaleRangeActive=!1,t.layerScaleRangeVisibilityQuery=!1,t.handles=new a,t.layerView=null,t.layer=null,t.queryGraphicUIDsInExtent=null,t.extent=null,t.graphicsCore=null,t.basemapTerrain=null,t.layerScaleEnabled=!0,t.suspended=!1,t.updating=!0,t}return i.__extends(t,e),t.prototype.setup=function(e,t,i,r,a){var n=this;this.layerView=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=a,this.updateScaleRangeActive();var o=this.layerView.view.resourceController.scheduler;this.handles.add(o.registerTask(l.Task.SCALE_VISIBILITY,(function(){return n.update()}),(function(){return n.needsUpdate()})))},t.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null},t.prototype.needsUpdate=function(){return!(!this.layerView.view.basemapTerrain||!this.updating)},t.prototype._setDirty=function(){this.updating||this._set("updating",!0)},t.prototype.setExtent=function(e){this.extent=e,this._setDirty()},t.prototype.scaleRangeActive=function(){return this._scaleRangeActive},t.prototype.updateScaleRangeActive=function(){var e=this,t=this.layer,i=this.layerScaleEnabled&&p(t.minScale,t.maxScale);t.labelingInfo&&!i&&(i=t.labelingInfo.some((function(e){return e&&p(e.minScale,e.maxScale)})));var r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.handles.has(c)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(function(t){return e.scaleUpdateHandler(t)})),c),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(function(){return e._setDirty()})),c)):!i&&this.handles.has(c)&&this.handles.remove(c),r},t.prototype.update=function(){var e=this,t=this.layerView.view.basemapTerrain;this.extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,t.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,(function(t){return e.finishUpdate(t)}))):this.finishUpdate(!0)},t.prototype.finishUpdate=function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)},t.prototype.visibleAtLayerScale=function(e){return!this.layerScaleEnabled||s.scaleBoundsPredicate(e,this.layer.minScale||0,this.layer.maxScale||0)},t.prototype.visibleAtLabelScale=function(e,t){return s.scaleBoundsPredicate(e,t.minScale||0,t.maxScale||0)},t.prototype.graphicScale=function(e){var t;return n.isSome(e.centroid)?t=e.centroid:n.isSome(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(t):1:null},t.prototype.graphicVisible=function(e){if(!this.layerScaleEnabled)return!0;var t=this.graphicScale(e);return this.visibleAtLayerScale(t)},t.prototype.updateVisibility=function(e){if(this._scaleRangeActive){var t=this.graphicVisible(e);return e.setVisibilityFlag(1,t,0)}return!1},t.prototype.updateGraphicLabelScaleVisibility=function(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var t=this.graphicScale(e),i=this.updateLabelScaleVisibility(e,t);return i&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),i},t.prototype.updateLabelScaleVisibility=function(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this.visibleAtLabelScale(t,i);if(e.setVisibilityFlag(1,r,1))return!0}return!1},t.prototype.scaleUpdateHandler=function(e){var t=this;if(this._setDirty(),!this.layerView.suspended){var i=e.extent,r=e.scale,a=this.visibleAtLayerScale(r),o=!1;this.queryGraphicUIDsInExtent(i,e.spatialReference,(function(e){var s=t.graphicsCore.getGraphics3DGraphicById(e);if(s){var l=s.centroid;n.isSome(l)&&(i[0]>l.x||i[1]>l.y||i[2]<l.x||i[3]<l.y)||(s.setVisibilityFlag(1,a,0)&&(o=!0),t.updateLabelScaleVisibility(s,r)&&(o=!0))}})),o&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}},t.prototype.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(1)})):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()},i.__decorate([o.property({constructOnly:!0})],t.prototype,"layerScaleEnabled",void 0),i.__decorate([o.property({readOnly:!0})],t.prototype,"suspended",void 0),i.__decorate([o.property({readOnly:!0})],t.prototype,"updating",void 0),i.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],t)}(r);function p(e,t){return e>0||t>0}var c="terrain-events";return h}.apply(null,r))||(e.exports=a)},1645:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(30),i(57),i(1409)],void 0===(a=function(e,t,i,r,a,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){void 0===e&&(e=9),this.compareMinX=p,this.compareMinY=c,this.toBBox=function(e){return e},this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}return e.prototype.destroy=function(){this.clear(),m.prune(),b.prune(),v.prune(),S.prune()},e.prototype.all=function(e){this._all(this.data,e)},e.prototype.search=function(e,t){var i=this.data,r=this.toBBox;if(f(e,i))for(m.clear();i;){for(var a=0,n=i.children.length;a<n;a++){var o=i.children[a],s=i.leaf?r(o):o;f(e,s)&&(i.leaf?t(o):y(e,s)?this._all(o,t):m.push(o))}i=m.pop()}},e.prototype.collides=function(e){var t=this.data,i=this.toBBox;if(!f(e,t))return!1;for(m.clear();t;){for(var r=0,a=t.children.length;r<a;r++){var n=t.children[r],o=t.leaf?i(n):n;if(f(e,o)){if(t.leaf||y(e,o))return!0;m.push(n)}}t=m.pop()}return!1},e.prototype.load=function(e,t){if(void 0===t&&(t=e.length),!t)return this;if(t<this._minEntries){for(var i=0,r=t;i<r;i++)this.insert(e[i]);return this}var a=this._build(e.slice(0,t),0,t-1,0);if(this.data.children.length)if(this.data.height===a.height)this._splitRoot(this.data,a);else{if(this.data.height<a.height){var n=this.data;this.data=a,a=n}this._insert(a,this.data.height-a.height-1,!0)}else this.data=a;return this},e.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},e.prototype.clear=function(){return this.data=new w([]),this},e.prototype.remove=function(e){if(!e)return this;var t,i,a,n,o=this.data,s=this.toBBox(e);for(v.clear(),S.clear();o||v.length;){if(o||(o=v.pop(),t=v.data[v.length-1],i=S.pop(),a=!0),o.leaf&&-1!==(n=r.indexOf(o.children,e,o.children.length,o.indexHint)))return o.children.splice(n,1),v.push(o),this._condense(v),this;a||o.leaf||!y(o,s)?t?(i++,o=t.children[i],a=!1):o=null:(v.push(o),S.push(i),i=0,t=o,o=o.children[0])}return this},e.prototype.toJSON=function(){return this.data},e.prototype.fromJSON=function(e){return this.data=e,this},e.prototype._all=function(e,t){for(b.clear();e;){if(!0===e.leaf)for(var i=0,r=e.children;i<r.length;i++)t(r[i]);else b.pushArray(e.children);e=b.pop()}},e.prototype._build=function(e,t,i,r){var a=i-t+1,n=this._maxEntries;if(a<=n){var o=new w(e.slice(t,i+1));return s(o,this.toBBox),o}r||(r=Math.ceil(Math.log(a)/Math.log(n)),n=Math.ceil(a/Math.pow(n,r-1)));var l=new C([]);l.height=r;var h=Math.ceil(a/n),p=h*Math.ceil(Math.sqrt(n));g(e,t,i,p,this.compareMinX);for(var c=t;c<=i;c+=p){var d=Math.min(c+p-1,i);g(e,c,d,h,this.compareMinY);for(var u=c;u<=d;u+=h){var y=Math.min(u+h-1,d);l.children.push(this._build(e,u,y,r-1))}}return s(l,this.toBBox),l},e.prototype._chooseSubtree=function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){for(var a=1/0,n=1/0,o=void 0,s=0,l=t.children.length;s<l;s++){var h=t.children[s],p=d(h),c=(u=e,y=h,(Math.max(y.maxX,u.maxX)-Math.min(y.minX,u.minX))*(Math.max(y.maxY,u.maxY)-Math.min(y.minY,u.minY))-p);c<n?(n=c,a=p<a?p:a,o=h):c===n&&p<a&&(a=p,o=h)}t=o||t.children[0]}var u,y;return t},e.prototype._insert=function(e,t,i){var r=this.toBBox,a=i?e:r(e);v.clear();var n=this._chooseSubtree(a,this.data,t,v);for(n.children.push(e),h(n,a);t>=0&&v.data[t].children.length>this._maxEntries;)this._split(v,t),t--;this._adjustParentBBoxes(a,v,t)},e.prototype._split=function(e,t){var i=e.data[t],r=i.children.length,a=this._minEntries;this._chooseSplitAxis(i,a,r);var n=this._chooseSplitIndex(i,a,r),o=i.children.splice(n,i.children.length-n),l=i.leaf?new w(o):new C(o);l.height=i.height,s(i,this.toBBox),s(l,this.toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)},e.prototype._splitRoot=function(e,t){this.data=new C([e,t]),this.data.height=e.height+1,s(this.data,this.toBBox)},e.prototype._chooseSplitIndex=function(e,t,i){var r,a,n,o,s,h,p,c,u;r=a=1/0;for(var y=t;y<=i-t;y++){var f=l(e,0,y,this.toBBox),g=l(e,y,i,this.toBBox),m=(o=f,s=g,void 0,void 0,void 0,void 0,h=Math.max(o.minX,s.minX),p=Math.max(o.minY,s.minY),c=Math.min(o.maxX,s.maxX),u=Math.min(o.maxY,s.maxY),Math.max(0,c-h)*Math.max(0,u-p)),b=d(f)+d(g);m<r?(r=m,n=y,a=b<a?b:a):m===r&&b<a&&(a=b,n=y)}return n},e.prototype._chooseSplitAxis=function(e,t,i){var r=e.leaf?this.compareMinX:p,a=e.leaf?this.compareMinY:c;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,a)&&e.children.sort(r)},e.prototype._allDistMargin=function(e,t,i,r){e.children.sort(r);for(var a=this.toBBox,n=l(e,0,t,a),o=l(e,i-t,i,a),s=u(n)+u(o),p=t;p<i-t;p++){var c=e.children[p];h(n,e.leaf?a(c):c),s+=u(n)}for(p=i-t-1;p>=t;p--)c=e.children[p],h(o,e.leaf?a(c):c),s+=u(o);return s},e.prototype._adjustParentBBoxes=function(e,t,i){for(var r=i;r>=0;r--)h(t.data[r],e)},e.prototype._condense=function(e){for(var t=e.length-1;t>=0;t--){var i=e.data[t];if(0===i.children.length)if(t>0){var a=e.data[t-1],n=a.children;n.splice(r.indexOf(n,i,n.length,a.indexHint),1)}else this.clear();else s(i,this.toBBox)}},e.prototype._initFormat=function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")},e}();function s(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,a){a||(a=new w(null)),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(var n=t,o=void 0;n<i;n++)o=e.children[n],h(a,e.leaf?r(o):o);return a}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function p(e,t){return e.minX-t.minX}function c(e,t){return e.minY-t.minY}function d(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function u(e){return e.maxX-e.minX+(e.maxY-e.minY)}function y(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function f(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e,t,i,r,a){for(var o=[t,i];o.length;)if(!((i=o.pop())-(t=o.pop())<=r)){var s=t+Math.ceil((i-t)/r/2)*r;n(e,s,t,i,a),o.push(t,s,s,i)}}t.PooledRBush=o;var m=new a,b=new a,v=new a,S=new a({deallocator:null}),x=function(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0};t.BBox=x;var _=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.height=1,t.indexHint=new r.PositionHint,t}return i.__extends(t,e),t}(x),w=function(e){function t(t){var i=e.call(this)||this;return i.children=t,i.leaf=!0,i}return i.__extends(t,e),t}(_),C=function(e){function t(t){var i=e.call(this)||this;return i.children=t,i.leaf=!1,i}return i.__extends(t,e),t}(_);t.default=o}.apply(null,r))||(e.exports=a)},1985:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(24),i(11),i(2),i(733)],void 0===(a=function(e,t,i,r,a,n){function o(e){return a.isNone(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type}function s(e,t){if(!t)return null;var i;if((i=Array.isArray(t)?t:[t]).length>0){var a=i.map((function(e){return e.details.symbol.type||e.details.symbol.declaredClass})).filter((function(e){return!!e}));a.sort();var n=[];return a.forEach((function(e,t){0!==t&&e===a[t-1]||n.push(e)})),new r("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols ("+n.join(", ")+") which are not supported in 3D",{renderer:e,symbolErrors:i})}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedRenderer3D=o,t.validateTo3D=function(e){if(a.isNone(e))return null;if(!o(e))return new r("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '"+(e.type||e.declaredClass)+"'",{renderer:e});switch(e.type){case"simple":return function(e){return s(e,n.to3D(e.symbol).error)}(e);case"unique-value":return function(e){var t=e.uniqueValueInfos.map((function(e){return n.to3D(e.symbol).error})).filter((function(e){return!!e})),i=n.to3D(e.defaultSymbol);return i.error&&t.unshift(i.error),s(e,t)}(e);case"class-breaks":return function(e){var t=e.classBreakInfos.map((function(e){return n.to3D(e.symbol).error})).filter((function(e){return!!e})),i=n.to3D(e.defaultSymbol);return i.error&&t.unshift(i.error),s(e,t)}(e);case"dictionary":return null;default:i.neverReached(e)}return null}}.apply(null,r))||(e.exports=a)},1986:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(24),i(2),i(244),i(464),i(465),i(425),i(426),i(720),i(697)],void 0===(a=function(e,t,i,r,a,n,o,s,l,h,p){Object.defineProperty(t,"__esModule",{value:!0});var c=s.fromSimpleMarkerSymbol(h.defaultPointSymbol2D),d=n.fromSimpleLineSymbol(h.defaultPolylineSymbol2D),u=l.fromSimpleFillSymbol(h.defaultPolygonSymbol2D),y=new o({symbolLayers:[new a({material:{color:p.defaultColor},edges:{type:"solid",size:"1px",color:p.defaultOutlineColor}})]});t.getDefaultSymbol3D=function(e){if(r.isNone(e))return null;switch(e.type){case"mesh":return y;case"point":case"multipoint":return c;case"polyline":return d;case"polygon":case"extent":return u;default:i.neverReached(e)}return null}}.apply(null,r))||(e.exports=a)},1987:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(9),i(38),i(2),i(1),i(106),i(419),i(414),i(1429),i(36)],void 0===(a=function(e,t,i,r,a,n,o,s,l,h,p,c){Object.defineProperty(t,"__esModule",{value:!0});var d=function(e){function t(t){var i=e.call(this,t)||this;return i.events=new a,i.hasZ=null,i.hasM=null,i.objectIdField=null,i.spatialReference=null,i.featureAdapter={getAttribute:function(e,t){return"graphic"in e?e.graphic.attributes[t]:p.default.getAttribute(e,t)},getAttributes:function(e){return"graphic"in e?e.graphic.attributes:p.default.getAttributes(e)},getObjectId:function(e){return"graphic"in e?s.getObjectId(e.graphic,i.objectIdField):p.default.getObjectId(e)},getGeometry:function(e){return"graphic"in e?e.getAsOptimizedGeometry(i.hasZ,i.hasM):p.default.getGeometry(e)},getCentroid:function(e,t){if("graphic"in e){var r=null;n.isSome(e.centroid)?r=e.centroid:"point"===e.graphic.geometry.type&&c.pointToPoint(e.graphic.geometry,u,i.spatialReference)&&(r=u);var a=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return n.isNone(r)?(a[0]=0,a[1]=0,a[2]=0,a[3]=0):(a[0]=r.x,a[1]=r.y,t.hasZ&&(a[2]=r.hasZ?r.z:0),t.hasM&&(a[t.hasZ?3:2]=r.hasM?r.m:0)),new h.default([],a)}return p.default.getCentroid(e,t)},cloneWithGeometry:function(e,t){return"graphic"in e?new l.default(t,i.featureAdapter.getAttributes(e),null,i.featureAdapter.getObjectId(e)):p.default.cloneWithGeometry(e,t)}},i}return i.__extends(t,e),t.prototype.forEach=function(e){this.forAllGraphics((function(t){e(t)}))},t.prototype.forEachInBounds=function(e,t){this.getSpatialIndex().forEachInBounds(e,t)},t.prototype.forEachBounds=function(e,t,i){for(var r=this.getSpatialIndex(),a=0,o=e;a<o.length;a++){var s=o[a],l=this.featureAdapter.getObjectId(s);n.isSome(r.getBounds(l,i))&&t(i)}},i.__decorate([o.property({constructOnly:!0})],t.prototype,"getSpatialIndex",void 0),i.__decorate([o.property({constructOnly:!0})],t.prototype,"forAllGraphics",void 0),i.__decorate([o.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i.__decorate([o.property({constructOnly:!0})],t.prototype,"hasM",void 0),i.__decorate([o.property({constructOnly:!0})],t.prototype,"objectIdField",void 0),i.__decorate([o.property({constructOnly:!0})],t.prototype,"spatialReference",void 0),i.__decorate([o.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],t)}(r);t.Graphics3DFeatureStore=d;var u={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};t.default=d}.apply(null,r))||(e.exports=a)},1988:function(e,t,i){var r,a;r=[i.dj.c(e.i),t],void 0===(a=function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.Graphics3DSymbolCreationContext=function(){this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.layerView=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1};t.Graphics3DSymbolLayerCreationContext=function(){}}.apply(null,r))||(e.exports=a)},1989:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(1990),i(735)],void 0===(a=function(e,t,i,r){Object.defineProperty(t,"__esModule",{value:!0}),t.make=function(e,t,a){var n;switch(e.type){case"point-3d":n=i;break;default:n=r}return new n(e,t,a)}}.apply(null,r))||(e.exports=a)},1990:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(4),i(756),i(735)],void 0===(a=function(e,t,i,r,a,n){return function(e){function t(t,i,r){var n=e.call(this,t,i,r)||this;return n.calloutSymbolLayer=null,n.symbol.hasVisibleCallout()&&(n.calloutSymbolLayer=a.make(n.symbol,i)),n}return i.__extends(t,e),t.prototype.doLoad=function(t){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return[4,e.prototype.doLoad.call(this,t)];case 1:return i.sent(),this.calloutSymbolLayer?[4,this.calloutSymbolLayer.load()]:[3,3];case 2:i.sent(),i.label=3;case 3:if(r.isAborted(t))throw r.createAbortError();return[2]}}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.calloutSymbolLayer&&this.calloutSymbolLayer.destroy()},t.prototype.createGraphics3DGraphic=function(t,i){var r=e.prototype.createGraphics3DGraphic.call(this,t,i);if(this.calloutSymbolLayer){var a=this.createCalloutGraphic(t);a&&r.addAuxiliaryGraphic(a)}return r},t.prototype.globalPropertyChanged=function(t,i){var r=this;return!!e.prototype.globalPropertyChanged.call(this,t,i)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(t,i,(function(e){return r._getCalloutGraphicLayer(e)})))},t.prototype.updateGeometry=function(t,i){var r=e.prototype.updateGeometry.call(this,t,i);if(r&&this.calloutSymbolLayer){var a=this._getCalloutGraphicLayer(t);if(a)return this.calloutSymbolLayer.updateGeometry(a,i)}return r},t.prototype.createCalloutGraphic=function(e){var t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)},t.prototype._getCalloutGraphicLayer=function(e){for(var t=0,i=e._auxiliaryGraphics;t<i.length;t++){var r=i[t];if(r.graphics3DSymbolLayer===this.calloutSymbolLayer)return r}},t}(n)}.apply(null,r))||(e.exports=a)},1991:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(30),i(2),i(106)],void 0===(a=function(e,t,i,r,a){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){var t=this;this.graphicsCore=e,this.idToState=new Map,this.states=new Set;var i=e.owner.layer&&e.owner.layer.objectIdField;i?(this.getGraphicId=function(e){return a.getObjectId(e,i)},this.getGraphics3DGraphicById=function(e){return t.graphicsCore.getGraphics3DGraphicByObjectId(e)}):(this.getGraphicId=function(e){return e.uid},this.getGraphics3DGraphicById=function(e){return t.graphicsCore.getGraphics3DGraphicById(e)})}return e.prototype.destroy=function(){var e=this;this.idToState.clear(),this.states.forEach((function(t,i){return e.remove(i)}))},e.prototype.add=function(e){var t=this,i={remove:function(){return t.remove(e)}};if(this.states.has(e))return i;var a=this.getGraphicId(e.graphic),n=this.getGraphics3DGraphicById(a);return this.states.has(e)||this.states.add(e),this.ensureStateList(a).push(e),e.displaying=!!r.isSome(n)&&n.isVisible(),e.isDraped=!!r.isSome(n)&&n.isDraped,e.tracking=!0,i},e.prototype.remove=function(e){if(this.states.has(e)){if(this.idToState.size){var t=this.getGraphicId(e.graphic),r=this.idToState.get(t);r&&(i.remove(r,e),0===r.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}},e.prototype.addGraphic=function(e){this.forEachState(e,(function(t){t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))},e.prototype.removeGraphic=function(e){this.forEachState(e,(function(e){e.displaying=!1,e.isDraped=!1}))},e.prototype.updateGraphicGeometry=function(e){this.forEachState(e,(function(e){e.emit("changed",{})}))},e.prototype.updateGraphicVisibility=function(e){this.forEachState(e,(function(t){t.displaying=e.isVisible()}))},e.prototype.allGraphicsDeleted=function(){this.states.forEach((function(e){e.displaying=!1}))},e.prototype.ensureStateList=function(e){var t=this.idToState.get(e);if(t)return t;var i=new Array;return this.idToState.set(e,i),i},e.prototype.forEachState=function(e,t){if(0!==this.states.size&&0!==this.idToState.size){var i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}},e}();t.GraphicStateTracking=n}.apply(null,r))||(e.exports=a)},1992:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(9),i(25),i(1),i(1645),i(37),i(106)],void 0===(a=function(e,t,i,r,a,n,o,s,l){Object.defineProperty(t,"__esModule",{value:!0});var h=function(e){function t(t){var i=e.call(this,t)||this;return i.index=new o.default(9,a("csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),i.boundsByFeature=new Map,i.spatialReference=null,i.hasZ=null,i.hasM=null,i.objectIdField=null,i}return i.__extends(t,e),t.prototype.destroy=function(){this.index.destroy(),this.index=null,this.boundsByFeature.clear(),this.boundsByFeature=null},t.prototype.queryGraphicUIDsInExtent=function(e,t,i){t.equals(this.spatialReference)&&(p.minX=e[0],p.minY=e[1],p.maxX=e[2],p.maxY=e[3],this.index.search(p,(function(e){return i(e.graphic.uid)})))},t.prototype.add=function(e){e.computeExtent(this.spatialReference),this.index.insert(e);var t=l.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this.boundsByFeature.set(t,e.extent)},t.prototype.addMany=function(e,t){void 0===t&&(t=e.length);for(var i=this._get("objectIdField"),r=0;r<t;r++){var a=e[r];a.computeExtent(this.spatialReference);var n=l.getObjectId(a.graphic,i);null!=n&&this.boundsByFeature.set(n,a.extent)}this.index.load(e,t)},t.prototype.remove=function(e){this.index.remove(e);var t=l.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this.boundsByFeature.delete(t)},t.prototype.clear=function(){this.index.clear(),this.boundsByFeature.clear()},t.prototype.forEachInBounds=function(e,t){p.minX=e[0],p.minY=e[1],p.maxX=e[2],p.maxY=e[3],this.index.search(p,(function(e){t(e)}))},t.prototype.getBounds=function(e,t){var i=this.boundsByFeature.get(e);return i?s.fromRect(t,i):null},i.__decorate([n.property({constructOnly:!0})],t.prototype,"spatialReference",void 0),i.__decorate([n.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i.__decorate([n.property({constructOnly:!0})],t.prototype,"hasM",void 0),i.__decorate([n.property({constructOnly:!0})],t.prototype,"objectIdField",void 0),i.__decorate([n.subclass("esri.views.3d.layers.graphics.SpatialIndex2D")],t)}(r);t.SpatialIndex2D=h;var p={minX:0,minY:0,maxX:0,maxY:0};t.default=h}.apply(null,r))||(e.exports=a)},1993:function(e,t,i){var r,a;r=[i.dj.c(e.i),t,i(0),i(9),i(38),i(5),i(2),i(71),i(1),i(6),i(3),i(37),i(34),i(436),i(134)],void 0===(a=function(e,t,i,r,a,n,o,s,l,h,p,c,d,u,y){Object.defineProperty(t,"__esModule",{value:!0});var f=n.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider"),g=function(e){function t(t){var i=e.call(this,t)||this;return i.elevationOffset=0,i.layerDirtyNotificationHandle=null,i}return i.__extends(t,e),t.prototype.initialize=function(){var e=this;this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new y.Intersector(this.view.viewingMode),this.intersector.options.store=0;var t=this.computeLayerExtent(this.stageLayer);this.zmin=t[2],this.zmax=t[5],this.layerDirtyNotificationHandle=this.stageLayer.on("dirty",(function(t){return e.stageLayerChanged(t.origin,t.dirtyType,t.subObject)}))},t.prototype.dispose=function(){this.layerDirtyNotificationHandle.remove()},t.prototype.elevationInfoChanged=function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t=s.getMetersPerVerticalUnitForSR(this.layer.spatialReference),i=u.getMetersPerUnit(e.unit);this.elevationOffset=o.unwrapOr(e.offset,0)*i/t}else this.elevationOffset=0},t.prototype.getElevation=function(e,t,i,r){if(S[0]=e,S[1]=t,S[2]=i,!this.renderCoordsHelper.toRenderCoords(S,r,S))return f.error("could not project point for elevation alignment"),null;var a=this.elevationOffset,n=this.zmin+a,o=this.zmax+a;return h.vec3.copy(x,S),h.vec3.copy(_,S),this.renderCoordsHelper.setAltitude(o,x),this.renderCoordsHelper.setAltitude(n,_),this.intersector.reset(x,_),this.intersector.intersect(this.intersectLayers,null,null,1,null,(function(e){return e.metadata&&e.metadata.isElevationSource})),this.intersector.results.min.getIntersectionPoint(S)?this.renderCoordsHelper.getAltitude(S):null},t.prototype.stageLayerChanged=function(e,t,i){switch(t){case"layerObjectAdded":case"layerObjectRemoved":case"objGeometryAdded":(r=i).metadata&&r.metadata.isElevationSource&&this.objectChanged(r);break;case"objGeometryRemoved":case"objGeometryReplaced":case"objGeometryTransformation":case"vertexAttrsUpdated":case"objTransformation":var r;(r=e).metadata&&r.metadata.isElevationSource&&this.objectChanged(r)}},t.prototype.objectChanged=function(e){if(this.spatialReference){c.empty(m),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.bbMin,e.metadata.lastValidElevationBB.bbMax,m);var t=e.getBBMin(!1),i=e.getBBMax(!1);this.expandExtent(t,i,m),c.toRect(m,b),this.zmin=Math.min(this.zmin,m[2]),this.zmax=Math.max(this.zmax,m[5]),v.extent=b,v.spatialReference=this.spatialReference,this.emit("elevation-change",v),h.vec3.copy(e.metadata.lastValidElevationBB.bbMin,t),h.vec3.copy(e.metadata.lastValidElevationBB.bbMax,i)}},t.prototype.computeLayerExtent=function(e){c.empty(m);for(var t=0,i=e.getObjects();t<i.length;t++){var r=i[t];this.expandExtent(r.getBBMin(!1),r.getBBMax(!1),m)}return m},t.prototype.expandExtent=function(e,t,i){for(var r=0;r<8;++r)S[0]=1&r?e[0]:t[0],S[1]=2&r?e[1]:t[1],S[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(S,S,this.spatialReference),c.expand(i,S);return i},i.__decorate([l.property({constructOnly:!0})],t.prototype,"layer",void 0),i.__decorate([l.property({constructOnly:!0})],t.prototype,"stageLayer",void 0),i.__decorate([l.property({constructOnly:!0})],t.prototype,"view",void 0),i.__decorate([l.property({readOnly:!0,aliasOf:"view.spatialReference"})],t.prototype,"spatialReference",void 0),i.__decorate([l.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],t)}(a.EventedMixin(r));t.StageLayerElevationProvider=g;var m=c.empty(),b=d.empty(),v={spatialReference:null,extent:b,context:"scene"},S=p.vec3f64.create(),x=p.vec3f64.create(),_=p.vec3f64.create()}.apply(null,r))||(e.exports=a)}}]);